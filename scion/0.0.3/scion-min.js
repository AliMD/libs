(function(){if(!this.require){var a={},b={},c=function(f,g){var h=d(g,f),i=b[h],j;if(i)return i.exports;if(!(j=a[h]||a[h=d(h,"./index")]))throw"module '"+f+"' not found";i={id:h,exports:{}};try{return b[h]=i,j(i.exports,function(a){return c(a,e(h))},i),i.exports}catch(k){throw delete b[h],k}},d=function(a,b){var c=[],d,e;/^\.\.?(\/|$)/.test(b)?d=[a,b].join("/").split("/"):d=b.split("/");for(var f=0,g=d.length;f<g;f++)e=d[f],e==".."?c.pop():e!="."&&e!=""&&c.push(e);return c.join("/")},e=function(a){return a.split("/").slice(0,-1).join("/")};this.require=function(a){return c(a,"")},this.require.define=function(b){for(var c in b)a[c]=b[c]}}return this.require.define}).call(this)({scion:function(a,b,c){c.exports={annotator:b("./util/annotate-scxml-json"),json2model:b("./scxml/json2model"),scxml:b("./scxml/SCXML")}},"scxml/SCXML":function(exports,require,module){function create(a){var b;return Object.create?Object.create(a):(b=function(){},b.prototype=a,new b)}function getTransitionWithHigherSourceChildPriority(a){return function(b){var c=b[0],d=b[1];return a.getDepth(c.source)<a.getDepth(d.source)?d:a.getDepth(d.source)<a.getDepth(c.source)?c:c.documentOrder<d.documentOrder?c:d}}function SCXMLInterpreter(model,opts){model&&opts&&(this.model=model,this.opts=opts,this.opts.StateIdSet=this.opts.StateIdSet||ArraySet,this.opts.EventSet=this.opts.EventSet||ArraySet,this.opts.TransitionPairSet=this.opts.TransitionPairSet||ArraySet,this.opts.priorityComparisonFn=this.opts.priorityComparisonFn||getTransitionWithHigherSourceChildPriority(this.opts.model),this.opts.globalEval=this.opts.globalEval||eval,this._configuration=new this.opts.BasicStateSet,this._historyValue={},this._innerEventQueue=[],this._isInFinalState=!1,this._datamodel=create(this.model.datamodel),this._timeoutMap={})}function SimpleInterpreter(a,b){a&&b&&(this._isStepping=!1,this._send=b.send||this._send,this._cancel=b.cancel||this._cancel,SCXMLInterpreter.call(this,a,b))}function BrowserInterpreter(a,b){b=b||{},setupDefaultOpts(b),b.setTimeout||(b.setTimeout=function(a,b){return window.setTimeout(a,b)}),b.clearTimeout||(b.clearTimeout=function(a){return window.clearTimeout(a)}),SimpleInterpreter.call(this,a,b)}function NodeInterpreter(a,b){b=b||{},setupDefaultOpts(b),b.setTimeout=setTimeout,b.clearTimeout=clearTimeout,SimpleInterpreter.call(this,a,b)}var _=require("../util/underscore-wrapper"),ArraySet=require("./set/ArraySet"),stateKinds=require("./state-kinds-enum"),setupDefaultOpts=require("./setup-default-opts"),scxmlPrefixTransitionSelector=require("./scxml-dynamic-name-match-transition-selector");SCXMLInterpreter.prototype={start:function(){this.opts.printTrace&&console.log("performing initial big step"),this._configuration.add(this.model.root.initial),_(this.model.scripts).each(function(script){with(this._datamodel)this.opts.globalEval.call(null,script)},this);for(var k in this._datamodel){var v=this._datamodel[k];v&&(this._datamodel[k]=eval(v))}return this._performBigStep(),this.getConfiguration()},getConfiguration:function(){return new _.map(this._configuration.iter(),function(a){return a.id})},getFullConfiguration:function(){return _.chain(this._configuration.iter()).map(function(a){return[a].concat(this.opts.model.getAncestors(a))},this).flatten().map(function(a){return a.id}).uniq().value()},isIn:function(a){return _.contains(this.getFullConfiguration(),a)},_performBigStep:function(a){a&&this._innerEventQueue.push(new this.opts.EventSet([a]));var b=!0;while(b){var c=this._innerEventQueue.length?this._innerEventQueue.shift():new this.opts.EventSet,d={},e=this._performSmallStep(c,d);b=!e.isEmpty()}this._isInFinalState=_.every(this._configuration.iter(),function(a){return a.kind===stateKinds.FINAL})},_performSmallStep:function(a,b){this.opts.printTrace&&console.log("selecting transitions with eventSet: ",a);var c=this._selectTransitions(a,b);this.opts.printTrace&&console.log("selected transitions: ",c);if(!c.isEmpty()){this.opts.printTrace&&console.log("sorted transitions: ",c);var d=new this.opts.TransitionSet(_.filter(c.iter(),function(a){return a.targets})),e=this._getStatesExited(d),f=e[0],g=e[1],h=this._getStatesEntered(d),i=h[0],j=h[1];this.opts.printTrace&&console.log("basicStatesExited ",f),this.opts.printTrace&&console.log("basicStatesEntered ",i),this.opts.printTrace&&console.log("statesExited ",g),this.opts.printTrace&&console.log("statesEntered ",j);var k=new this.opts.EventSet;this.opts.printTrace&&console.log("executing state exit actions"),_.each(g,function(c){this.opts.printTrace&&console.log("exiting ",c),_.each(c.onexit,function(c){this._evaluateAction(c,a,b,k)},this);var d;c.history&&(c.history.isDeep?d=_.bind(function(a){return a.kind===stateKinds.BASIC&&_.contains(this.opts.model.getDescendants(c),a)},this):d=function(a){return a.parent===c},this._historyValue[c.history.id]=_.filter(g,d))},this);var l=c.iter().sort(function(a,b){return a.documentOrder-b.documentOrder});this.opts.printTrace&&console.log("executing transitition actions"),_.each(l,function(c){_.each(c.actions,function(c){this._evaluateAction(c,a,b,k)},this)},this),this.opts.printTrace&&console.log("executing state enter actions"),_.each(j,function(c){_.each(c.onentry,function(c){this._evaluateAction(c,a,b,k)},this)},this),this.opts.printTrace&&console.log("updating configuration "),this.opts.printTrace&&console.log("old configuration ",this._configuration),this._configuration.difference(f),this._configuration.union(i),this.opts.printTrace&&console.log("new configuration ",this._configuration),k.isEmpty()||(this.opts.printTrace&&console.log("adding triggered events to inner queue ",k),this._innerEventQueue.push(k)),this.opts.printTrace&&console.log("updating datamodel for next small step :");for(var m in b)this.opts.printTrace&&console.log("key ",m),m in this._datamodel?this.opts.printTrace&&console.log("old value ",this._datamodel[m]):this.opts.printTrace&&console.log("old value is null"),this.opts.printTrace&&console.log("new value ",b[m]),this._datamodel[m]=b[m]}return c},_evaluateAction:function(a,b,c,d){var e=_.bind(function(){var d={};return a.content?d=a.content:(a.namelist&&_.each(a.namelist,function(a){d[a]=this._datamodel[a]},this),_.each(a.params,function(a){a.expr?d[a.name]=this._eval(a.expr,c,b):a.location&&(d[a.name]=this._datamodel[a.location])},this)),d},this);switch(a.type){case"raise":this.opts.printTrace&&console.log("sending event",a.event,"with content",a.contentexpr),d.add({name:a.event});break;case"assign":this._datamodel[a.location]=this._eval(a,c,b);break;case"script":this._eval(a,c,b,!0);break;case"log":console.log(this._eval(a,c,b));break;case"send":this._send&&this._send({target:a.targetexpr?this._eval(a.targetexpr,c,b):a.target,name:a.eventexpr?this._eval(a.eventexpr,c,b):a.event,data:e(),origin:this.opts.origin,type:a.typeexpr?this._eval(a.typeexpr,c,b):a.sendType},{delay:a.delayexpr?this._eval(a.delayexpr,c,b):a.delay,sendId:a.idlocation?this._datamodel[a.idlocation]:a.id});break;case"cancel":this._cancel&&this._cancel(a.sendid);break;default:}},_eval:function(a,b,c,d){var e=this._getScriptingInterface(b,c,d);return a.evaluate.call(this.opts.evaluationContext,e.getData,e.setData,e.In,e.events,this._datamodel)},_getScriptingInterface:function(a,b,c){return{setData:c?function(b,c){return a[b]=c}:function(){},getData:_.bind(function(a){return this._datamodel[a]},this),In:_.bind(function(a){return this.isIn(a)},this),events:b.iter()}},_getStatesExited:function(a){var b=new this.opts.StateSet,c=new this.opts.BasicStateSet;_.each(a.iter(),function(a){var d=this.opts.model.getLCA(a),e=this.opts.model.getDescendants(d);_.each(this._configuration.iter(),function(a){_.contains(e,a)&&(c.add(a),b.add(a),_.each(this.opts.model.getAncestors(a,d),function(a){b.add(a)}))},this)},this);var d=b.iter().sort(_.bind(function(a,b){return this.opts.model.getDepth(b)-this.opts.model.getDepth(a)},this));return[c,d]},_getStatesEntered:function(a){var b=_.chain(a.iter()).map(function(a){return a.targets}).flatten().value();this.opts.printTrace&&console.log("statesToRecursivelyAdd :",b);var c=new this.opts.StateSet,d=new this.opts.BasicStateSet;while(b.length){_.each(b,function(a){this._recursiveAddStatesToEnter(a,c,d)},this);var e=_.chain(c.iter()).filter(function(a){return a.kind===stateKinds.PARALLEL}).map(function(a){return a.children}).flatten().value();b=_.filter(e,function(a){return a.kind!==stateKinds.HISTORY&&!c.contains(a)})}var f=c.iter().sort(_.bind(function(a,b){return this.opts.model.getDepth(a)-this.opts.model.getDepth(b)},this));return[d,f]},_recursiveAddStatesToEnter:function(a,b,c){a.kind===stateKinds.HISTORY?a.id in this._historyValue?_.each(this._historyValue[a.id],function(a){this._recursiveAddStatesToEnter(a,b,c)},this):(b.add(a),c.add(a)):(b.add(a),a.kind===stateKinds.PARALLEL?_.each(a.children,function(a){a.kind!==stateKinds.HISTORY&&this._recursiveAddStatesToEnter(a,b,c)},this):a.kind===stateKinds.COMPOSITE?this._recursiveAddStatesToEnter(a.initial,b,c):(a.kind===stateKinds.INITIAL||a.kind===stateKinds.BASIC||a.kind===stateKinds.FINAL)&&c.add(a))},_selectTransitions:function(a,b){if(this.opts.onlySelectFromBasicStates)var c=this._configuration.iter();else{var d=new this.opts.StateSet;_.each(this._configuration.iter(),function(a){d.add(a),_.each(this.opts.model.getAncestors(a),function(a){d.add(a)})},this),c=d.iter()}var e=this._getScriptingInterface(b,a),f=_.bind(function(a){return a.evaluateCondition.call(this.opts.evaluationContext,e.getData,e.setData,e.In,e.events,this._datamodel)},this),g=_.map(a.iter(),function(a){return a.name}),h=_(g).filter(function(a){return a.search(".")}).length,i=h?scxmlPrefixTransitionSelector:this.opts.transitionSelector,j=new this.opts.TransitionSet;_.each(c,function(a){_.each(i(a,g,f),function(a){j.add(a)})});var k=this._selectPriorityEnabledTransitions(j);return this.opts.printTrace&&console.log("priorityEnabledTransitions",k),k},_selectPriorityEnabledTransitions:function(a){var b=new this.opts.TransitionSet,c=this._getInconsistentTransitions(a),d=c[0],e=c[1];b.union(d),this.opts.printTrace&&console.log("enabledTransitions",a),this.opts.printTrace&&console.log("consistentTransitions",d),this.opts.printTrace&&console.log("inconsistentTransitionsPairs",e),this.opts.printTrace&&console.log("priorityEnabledTransitions",b);while(!e.isEmpty())a=new this.opts.TransitionSet(_.map(e.iter(),function(a){return this.opts.priorityComparisonFn(a)},this)),c=this._getInconsistentTransitions(a),d=c[0],e=c[1],b.union(d),this.opts.printTrace&&console.log("enabledTransitions",a),this.opts.printTrace&&console.log("consistentTransitions",d),this.opts.printTrace&&console.log("inconsistentTransitionsPairs",e),this.opts.printTrace&&console.log("priorityEnabledTransitions",b);return b},_getInconsistentTransitions:function(a){var b=new this.opts.TransitionSet,c=new this.opts.TransitionPairSet,d=a.iter();this.opts.printTrace&&console.log("transitions",d);for(var e=0;e<d.length;e++)for(var f=e+1;f<d.length;f++){var g=d[e],h=d[f];this._conflicts(g,h)&&(b.add(g),b.add(h),c.add([g,h]))}var i=a.difference(b);return[i,c]},_conflicts:function(a,b){return!this._isArenaOrthogonal(a,b)},_isArenaOrthogonal:function(a,b){var c=a.targets?this.opts.model.getLCA(a):a.source,d=b.targets?this.opts.model.getLCA(b):b.source,e=this.opts.model.isOrthogonalTo(c,d);return this.opts.printTrace&&(console.log("transition LCAs",c.id,d.id),console.log("transition LCAs are orthogonal?",e)),e}},SimpleInterpreter.prototype=new SCXMLInterpreter,_.extend(SimpleInterpreter.prototype,{gen:function(a){if(a===undefined)throw new Error("gen must be passed an event object.");if(this._isStepping)throw new Error("gen called before previous call to gen could complete. if executed in single-threaded environment, this means it was called recursively, which is illegal, as it would break SCION step semantics.");return this._isStepping=!0,this._performBigStep(a),this._isStepping=!1,this.getConfiguration()},_send:function(a,b){var c,d,e=this;if(!this.opts.setTimeout)throw new Error("setTimeout function not set");this.opts.printTrace&&console.log("sending event",a.name,"with content",a.data,"after delay",b.delay),c=function(){return e.gen(a)},d=this.opts.setTimeout(c,b.delay);if(b.sendid)return this._timeoutMap[b.sendid]=d},_cancel:function(a){if(!this.opts.clearTimeout)throw new Error("clearTimeout function not set");if(a in this._timeoutMap)return this.opts.printTrace&&console.log("cancelling ",a," with timeout id ",this._timeoutMap[a]),this.opts.clearTimeout(this._timeoutMap[a])}}),BrowserInterpreter.prototype=new SimpleInterpreter,NodeInterpreter.prototype=new SimpleInterpreter,module.exports={SCXMLInterpreter:SCXMLInterpreter,SimpleInterpreter:SimpleInterpreter,BrowserInterpreter:BrowserInterpreter,NodeInterpreter:NodeInterpreter}},"scxml/default-transition-selector":function(a,b,c){var d=b("../util/underscore-wrapper");c.exports=function(a,b,c){return d.filter(a.transitions,function(a){return!a.event||d.contains(b,a.event)&&(!a.cond||c(a))})}},"scxml/json2model":function(a,b,c){function e(a){return a?a.slice(-2)==="ms"?parseFloat(a.slice(0,-2)):a.slice(-1)==="s"?parseFloat(a.slice(0,-1))*1e3:parseFloat(a):0}function f(a,b){return new Function("getData","setData","In","_events","datamodel","var _event = _events[0]; with(datamodel){"+(b?"return":"")+" "+a+"}")}var d=b("../util/underscore-wrapper");c.exports=function(a){function b(a){return c[a]}var c={};return d.forEach(a.states,function(a){c[a.id]=a}),d.forEach(a.transitions,function(a){a.evaluateCondition=f(a.cond,!0)}),d.forEach(a.states,function(g){g.transitions=d.map(g.transitions,function(b){return a.transitions[b]});var h=g.onentry.concat(g.onexit);d.forEach(g.transitions,function(a){d.forEach(a.actions,function(a){h.push(a)}),a.lca&&(a.lca=c[a.lca])}),d.forEach(h,function(a){switch(a.type){case"script":a.evaluate=f(a.script);break;case"assign":a.evaluate=f(a.expr,!0);break;case"send":d.forEach(["contentexpr","eventexpr","targetexpr","typeexpr","delayexpr"],function(b){a[b]&&(a[b]={evaluate:f(a[b],!0)})}),d.forEach(a.params,function(a){a.expr&&(a.expr={evaluate:f(a.expr,!0)})});break;case"log":a.evaluate=f(a.expr,!0);break;default:}a.type==="send"&&a.delay&&(a.delay=e(a.delay))}),g.initial=c[g.initial],g.history=c[g.history],g.children=d.map(g.children,b),g.parent=c[g.parent],g.ancestors&&(g.ancestors=d.map(g.ancestors,b)),g.descendants&&(g.descendants=d.map(g.descendants,b)),d.forEach(g.transitions,function(a){a.source=c[a.source],a.targets=a.targets&&d.map(a.targets,b)})}),a.root=c[a.root],a}},"scxml/model":function(a,b,c){var d=b("../util/underscore-wrapper"),e=b("./state-kinds-enum");c.exports={getDepth:function(a){var b,c;if(a.depth!==undefined)return a.depth;b=0,c=a.parent;while(c)b+=1,c=c.parent;return b},getAncestors:function(a,b){var c,e,f;if(a.ancestors)return d.contains(a.ancestors,b)?a.ancestors.slice(0,e):a.ancestors;c=[],f=a.parent;while(f&&f!==b)c.push(f),f=f.parent;return c},getAncestorsOrSelf:function(a,b){return[a].concat(this.getAncestors(a,b))},getDescendants:function(a){var b,c,d,e,f,g,h;if(a.descendants)return a.descendants;c=[],d=a.children.slice();while(d.length)e=d.shift(),c.push(e),d.push.apply(d,e.children);return c},getDescendantsOrSelf:function(a){return[a].concat(this.getDescendants(a))},isOrthogonalTo:function(a,b){return!this.isAncestrallyRelatedTo(a,b)&&this.getLCA(a,b).kind===e.PARALLEL},isAncestrallyRelatedTo:function(a,b){return d.contains(this.getAncestorsOrSelf(b),a)||d.contains(this.getAncestorsOrSelf(a),b)},getLCA:function(a,b){if(a.lca)return a.lca;if(arguments.length===1){var c=a;return this.getLCA(c.source,c.targets[0])}var e=a,f=d.filter(this.getAncestors(e),d.bind(function(a){return d.contains(this.getDescendants(a),b)},this));return f[0]}}},"scxml/scxml-dynamic-name-match-transition-selector":function(a,b,c){function f(a){return new RegExp("^"+a.replace(/\./g,"\\.")+"(\\.[0-9a-zA-Z]+)*$")}function g(a){return e[a]?e[a]:e[a]=f(a)}function h(a,b){var c=a.events,e=d.contains(c,"*")?function(){return!0}:function(a){return d(c).filter(function(b){return g(b).test(a)}).length};return d(b).filter(e).length}var d=b("../util/underscore-wrapper"),e={};c.exports=function(a,b,c){return d(a.transitions).filter(function(a){return(!a.events||h(a,b))&&(!a.cond||c(a))})}},"scxml/set/ArraySet":function(a,b,c){var d=b("../../util/underscore-wrapper");c.exports=function(a){a=a||[],this.o=[],d.each(a,function(a){this.add(a)},this)},c.exports.prototype={add:function(a){if(!this.contains(a))return this.o.push(a)},remove:function(a){var b=d.indexOf(this.o,a);return b===-1?!1:(this.o.splice(b,1),!0)},union:function(a){return a=a.iter?a.iter():a,d.each(a,function(a){this.add(a)},this),this},difference:function(a){return a=a.iter?a.iter():a,d.each(a,function(a){this.remove(a)},this),this},contains:function(a){return d.indexOf(this.o,a)>=0},iter:function(){return this.o},isEmpty:function(){return!this.o.length},equals:function(a){var b=a.iter();return d.difference(this.o,b).length===0},toString:function(){return"Set("+this.o.toString()+")"}}},"scxml/setup-default-opts":function(a,b,c){var d=b("./scxml-dynamic-name-match-transition-selector"),e=b("./set/ArraySet"),f=b("./model");c.exports=function(a){return a=a||{},a.TransitionSet=a.TransitionSet||e,a.StateSet=a.StateSet||e,a.BasicStateSet=a.BasicStateSet||e,a.transitionSelector=a.transitionSelector||d,a.model=a.model||f,a}},"scxml/state-kinds-enum":function(a,b,c){c.exports={BASIC:0,COMPOSITE:1,PARALLEL:2,HISTORY:3,INITIAL:4,FINAL:5}},"util/annotate-scxml-json":function(a,b,c){function q(a){var b=[];return d(a).forEach(function(a){var c=s(a),e=c[0],f=c[1],g=c[2];e==="script"&&d.chain(g).filter(function(a){return typeof a=="string"}).forEach(function(a){b.push(a)})}),b}function r(a){var b,c,d;c=0,d={};for(b in a)d[b]={name:b,documentOrder:c++};return d}function s(a,b){var c,e,f,g,h;return h=a[0],g=a[1],g&&typeof g=="object"&&!d.isArray(g)&&typeof g!="string"?(c=g,f=a.slice(2)):(c={},f=a.slice(1)),b&&(f=d(f).filter(function(a){return typeof a!="string"})),[h,c,f]}function u(a,b,c,e,f,g){var h=s(a,!0),i=h[0],l=h[1],m=h[2];if(l.event){var n;l.event==="*"?n=[l.event]:n=d(l.event.trim().split(/\s+/)).map(function(a){var b=a.match(t);if(b){var c=b[1];if(!b||!c)throw new Error("Unable to parse event: "+a);return c}}),d.chain(n).filter(function(a){return a!=="*"}).forEach(function(a){j[a]=!0})}var o={documentOrder:k.length,id:k.length,source:b.id,cond:l.cond,events:n,actions:d(m).map(function(a){return w(a)}),targets:l&&l.target&&l.target.trim().split(/\s+/)};return k.push(o),o}function v(a){var b=s(a),c=b[0],d=b[1],e=b[2];return{name:d.name,expr:d.expr,location:d.location}}function w(a){var b=s(a),c=b[0],e=b[1],f=b[2];switch(c){case"if":return{type:"if",cond:e.cond,actions:d(f).map(function(a){return w(a)})};case"elseif":return{type:"elseif",cond:e.cond,actions:d(f).map(function(a){return w(a)})};case"else":return{type:"else",actions:d(f).map(function(a){return w(a)})};case"log":return{type:"log",expr:e.expr,label:e.label};case"script":return{type:"script",script:f.join("\n")};case"send":return{type:"send",sendType:e.type,delay:e.delay,id:e.id,event:e.event,target:e.target,idlocation:e.idlocation,namelist:e&&e.namelist&&e.namelist.trim().split(/ +/),params:d.chain(f).filter(function(a){return a[0]==="param"}).map(function(a){return v(a)}).value(),content:d.chain(f).filter(function(a){return a[0]==="content"}).map(function(a){return s(a)[2][0]}).first().value(),eventexpr:e.eventexpr,targetexpr:e.targetexpr,typeexpr:e.typeexpr,delayexpr:e.delayexpr};case"cancel":return{type:"cancel",sendid:e.sendid};case"assign":return{type:"assign",location:e.location,expr:e.expr};case"raise":return{type:"raise",event:e.event};case"invoke":throw new Error("Element "+c+" not yet supported");case"finalize":throw new Error("Element "+c+" not yet supported");default:return null}}function x(a,b,c,e,f,g){var h=s(a,!0),i=h[0],j=h[1],k=h[2];d.chain(k).filter(function(a){return a[0]==="data"}).forEach(function(a){var b=s(a,!0),c=b[0],d=b[1],e=b[2];d.id&&(n[d.id]=d.expr||null)})}function y(a,b,c,j,k,m){var n=s(a,!0),o=n[0],p=n[1],q=n[2],r=p&&p.id||B(o),t;switch(o){case"state":d.chain(q).filter(function(a){return d.contains(g,a[0])}).isEmpty().value()?t=e.BASIC:t=e.COMPOSITE;break;case"scxml":t=e.COMPOSITE;break;case"initial":t=e.INITIAL;break;case"parallel":t=e.PARALLEL;break;case"final":t=e.FINAL;break;case"history":t=e.HISTORY;break;default:}var v={id:r,kind:t,descendants:[]};l[r]=v,b.length&&(v.parent=b[b.length-1]),t===e.HISTORY&&(v.isDeep=p.type==="deep"?!0:!1),v.documentOrder=h.length,h.push(v);if(t===e.BASIC||t===e.INITIAL||t===e.HISTORY)v.basicDocumentOrder=i.length,i.push(v);c&&(v.depth=b.length);if(j||m)v.ancestors=b.slice();(k||m)&&d(b).forEach(function(a){l[a].descendants.push(v.id)});var z=[],A=[],C=[],D=[],E=b.concat(v.id),F=!1,G=null,H=function(a){var b=y(a,E,c,j,k,m);return v.initial=b.id,D.push(b),F=!0};d(q).filter(function(a){return d.isArray(a)}).forEach(function(a){var b=s(a,!0),e=b[0],g=b[1],h=b[2];switch(e){case"transition":C.push(u(a,v));break;case"onentry":d(h).forEach(function(a){A.push(w(a))});break;case"onexit":d(h).forEach(function(a){z.push(w(a))});break;case"initial":if(!!F)throw new Error("Encountered duplicate initial states in state "+v.id);H(a);break;case"history":var i=y(a,E,c,j,k,m);v.history=i.id,D.push(i);break;case"datamodel":x(a,E,c,j,k,m);break;default:if(d.contains(f,e)){var l=y(a,E,c,j,k,m);G===null&&(G=l),D.push(l)}}});if(!F&&o!=="parallel"){var I=p&&p.initial;function J(a){var b;return b=["initial",["transition",{target:a}]],H(b)}I?J(p.initial):G&&J(G.id)}return v.onexit=z,v.onentry=A,v.transitions=d(C).map(function(a){return a.documentOrder}),v.children=d(D).map(function(a){return a.id}),v}function B(a){return A[a]=A[a]||0,""+z+"-"+a+"-"+A[a]++}function C(a,b){var c,e,f,g,h,i,j;f=[],d(a.ancestors).forEach(function(a){e=l[a],d.contains(e.descendants,b.id)&&f.push(a)});if(d.isEmpty(f))throw new Error("Could not find LCA for states.");return f[0]}var d=b("./underscore-wrapper"),e=b("../scxml/state-kinds-enum"),f=["state","parallel","history","final","initial"],g=f.concat("scxml"),h,i,j,k,l,m,n,o=a.transformAndSerialize=o=function(a,b,c,d,e){return JSON.stringify(p(a,b,c,d,e))},p=a.transform=function(a,b,c,e,f){h=[],i=[],j={},k=[],l={},m=[],n={};var g=y(a,[],b,c,e,f),o=s(a),p=o[0],t=o[1],u=o[2];return(c||f)&&d.forEach(h,function(a){a.ancestors.reverse()}),(e||f)&&d.forEach(h,function(a){a.descendants.reverse()}),f&&d.chain(k).filter(function(a){return a.targets}).forEach(function(a){var b=l[a.source],c=d(a.targets).map(function(a){return l[a]});if(!b)throw new Error("source missing");if(!c.length)throw new Error("target missing");a.lca=C(b,c[0])}),{states:h,transitions:k,root:g.id,events:r(j),scripts:q(u),profile:t.profile,version:t.version,datamodel:n}},t=/^((([_a-zA-Z0-9]+)\.)*([_a-zA-Z0-9]+))(\.\*)?$/,z="$generated",A={};if(b.main===c){var D=process.argv[2],E=process.argv[3];function F(a){var c,d,e;return e=JSON.parse(a),d=o(e,!0,!0,!0,!0),E==="-"?process.stdout.write(d):(c=b("fs"),c.writeFileSync(E,d,"utf-8"))}if(!D||D==="-"){process.stdin.resume(),process.stdin.setEncoding("utf-8");var G="";process.stdin.on("data",function(a){return G+=a}),process.stdin.on("end",function(){return F(G)})}else{var H=b("fs"),I=H.readFileSync(D,"utf-8");F(I)}}},"util/browser/parsePage":function(a,b,c){var d=b("../../scion"),e=b("../underscore-wrapper");c.exports=function(){var a=document.getElementsByTagName("scxml");e(a).forEach(function(a){console.log("scxml",a);var b=a.parentNode;console.log("domNodeToHookUp",b);var c="http://www.w3.org/2005/07/scxml",f=document.implementation.createDocument(c,"scxml",null),g=f.importNode(a.cloneNode(!0),!0);f.replaceChild(g,f.documentElement),console.log("newNode",g);var h=JsonML.parseDOM(f)[1];console.log("scxmlJson",h);var i=d.annotator.transform(h,!0,!0,!0,!0);console.log("annotatedScxmlJson",i);var j=d.json2model(i);console.log("model",j);var k=new d.scxml.BrowserInterpreter(j,{evaluationContext:b});console.log("interpreter",k);var l="https://github.com/jbeard4/SCION";if(a.hasAttributeNS(l,"domEventsToConnect")){var m=a.getAttributeNS(l,"domEventsToConnect"),n=m.split(/\s*,\s*/);e(n).forEach(function(a){b.addEventListener(a,function(b){b.preventDefault(),k.gen({name:a,data:b})},!1)})}k.start()})}},"util/underscore-wrapper":function(a,b,c){c.exports=this._||b("underscore")}});