// jquery.pjax.js
// copyright chris wanstrath
// https://github.com/defunkt/jquery-pjax
(function(a){function b(b,d,e){var f=this;return this.on("click.pjax",b,function(b){var g=a.extend({},m(d,e));g.container||(g.container=a(this).attr("data-pjax")||f),c(b,g)})}function c(b,c,d){d=m(c,d);var f=b.currentTarget;if("A"!==f.tagName.toUpperCase())throw"$.fn.pjax or $.pjax.click requires an anchor element";if(!(b.which>1||b.metaKey||b.ctrlKey||b.shiftKey||b.altKey||location.protocol!==f.protocol||location.host!==f.host||f.hash&&f.href.replace(f.hash,"")===location.href.replace(location.hash,"")||f.href===location.href+"#")){var g={url:f.href,container:a(f).attr("data-pjax"),target:f,fragment:null};e(a.extend({},g,d)),b.preventDefault()}}function d(b,c,d){d=m(c,d);var f=b.currentTarget;if("FORM"!==f.tagName.toUpperCase())throw"$.pjax.submit requires a form element";var g={type:f.method,url:f.action,data:a(f).serializeArray(),container:a(f).attr("data-pjax"),target:f,fragment:null};e(a.extend({},g,d)),b.preventDefault()}function e(b){function h(b,d){var e=a.Event(b,{relatedTarget:c});return f.trigger(e,d),!e.isDefaultPrevented()}b=a.extend(!0,{},a.ajaxSettings,e.defaults,b),a.isFunction(b.url)&&(b.url=b.url());var c=b.target,d=l(b.url).hash,f=b.context=n(b.container);b.data||(b.data={}),b.data._pjax=f.selector;var i;b.beforeSend=function(a,c){return"GET"!==c.type&&(c.timeout=0),a.setRequestHeader("X-PJAX","true"),a.setRequestHeader("X-PJAX-Container",f.selector),h("pjax:beforeSend",[a,c])?(c.timeout>0&&(i=setTimeout(function(){h("pjax:timeout",[a,b])&&a.abort("timeout")},c.timeout),c.timeout=0),b.requestUrl=l(c.url).href,void 0):!1},b.complete=function(a,c){i&&clearTimeout(i),h("pjax:complete",[a,c,b]),h("pjax:end",[a,b])},b.error=function(a,c,d){var e=p("",a,b),f=h("pjax:error",[a,c,d,b]);"GET"==b.type&&"abort"!==c&&f&&g(e.url)},b.success=function(c,i,k){var m=p(c,k,b);if(!m.contents)return g(m.url),void 0;if(e.state={id:b.id||j(),url:m.url,title:m.title,container:f.selector,fragment:b.fragment,timeout:b.timeout},(b.push||b.replace)&&window.history.replaceState(e.state,m.title,m.url),m.title&&(document.title=m.title),f.html(m.contents),"number"==typeof b.scrollTo&&a(window).scrollTop(b.scrollTo),(b.replace||b.push)&&window._gaq&&_gaq.push(["_trackPageview"]),""!==d){var n=l(m.url);n.hash=d,e.state.url=n.href,window.history.replaceState(e.state,m.title,n.href);var o=a(n.hash);o.length&&a(window).scrollTop(o.offset().top)}h("pjax:success",[c,i,k,b])},e.state||(e.state={id:j(),url:window.location.href,title:document.title,container:f.selector,fragment:b.fragment,timeout:b.timeout},window.history.replaceState(e.state,document.title));var m=e.xhr;m&&4>m.readyState&&(m.onreadystatechange=a.noop,m.abort()),e.options=b;var m=e.xhr=a.ajax(b);return m.readyState>0&&(b.push&&!b.replace&&(t(e.state.id,f.clone().contents()),window.history.pushState(null,"",k(b.requestUrl))),h("pjax:start",[m,b]),h("pjax:send",[m,b])),e.xhr}function f(b,c){var d={url:window.location.href,push:!1,replace:!0,scrollTo:!1};return e(a.extend(d,m(b,c)))}function g(a){window.history.replaceState(null,"","#"),window.location.replace(a)}function h(b){var c=b.state;if(c&&c.container){var d=a(c.container);if(d.length){var f=q[c.id];if(!e.state)return e.state=c,void 0;var h=e.state.id<c.id?"forward":"back";u(h,e.state.id,d.clone().contents());var i=a.Event("pjax:popstate",{state:c,direction:h});d.trigger(i);var j={id:c.id,url:c.url,container:d,push:!1,fragment:c.fragment,timeout:c.timeout,scrollTo:!1};f?(d.trigger("pjax:start",[null,j]),c.title&&(document.title=c.title),d.html(f),e.state=c,d.trigger("pjax:end",[null,j])):e(j),d[0].offsetHeight}else g(location.href)}}function i(b){var c=a.isFunction(b.url)?b.url():b.url,d=b.type?b.type.toUpperCase():"GET",e=a("<form>",{method:"GET"===d?"GET":"POST",action:c,style:"display:none"});"GET"!==d&&"POST"!==d&&e.append(a("<input>",{type:"hidden",name:"_method",value:d.toLowerCase()}));var f=b.data;if("string"==typeof f)a.each(f.split("&"),function(b,c){var d=c.split("=");e.append(a("<input>",{type:"hidden",name:d[0],value:d[1]}))});else if("object"==typeof f)for(key in f)e.append(a("<input>",{type:"hidden",name:key,value:f[key]}));a(document.body).append(e),e.submit()}function j(){return(new Date).getTime()}function k(a){return a.replace(/\?_pjax=[^&]+&?/,"?").replace(/_pjax=[^&]+&?/,"").replace(/[\?&]$/,"")}function l(a){var b=document.createElement("a");return b.href=a,b}function m(b,c){return b&&c?c.container=b:c=a.isPlainObject(b)?b:{container:b},c.container&&(c.container=n(c.container)),c}function n(b){if(b=a(b),b.length){if(""!==b.selector&&b.context===document)return b;if(b.attr("id"))return a("#"+b.attr("id"));throw"cant get selector for pjax container!"}throw"no pjax container for "+b.selector}function o(a,b){return a.filter(b).add(a.find(b))}function p(b,c,d){var e={};if(e.url=k(c.getResponseHeader("X-PJAX-URL")||d.requestUrl),/<html/i.test(b))var f=a(b.match(/<head[^>]*>([\s\S.]*)<\/head>/i)[0]),g=a(b.match(/<body[^>]*>([\s\S.]*)<\/body>/i)[0]);else var f=g=a(b);if(0===g.length)return e;if(e.title=o(f,"title").last().text(),d.fragment){if("body"===d.fragment)var h=g;else var h=o(g,d.fragment).first();h.length&&(e.contents=h.contents(),e.title||(e.title=h.attr("title")||h.data("title")))}else/<html/i.test(b)||(e.contents=g);return e.contents&&(e.contents=e.contents.not("title"),e.contents.find("title").remove()),e.title&&(e.title=a.trim(e.title)),e}function t(a,b){for(q[a]=b,s.push(a);r.length;)delete q[r.shift()];for(;s.length>e.defaults.maxCacheLength;)delete q[s.shift()]}function u(a,b,c){var d,e;q[b]=c,"forward"===a?(d=s,e=r):(d=r,e=s),d.push(b),(b=e.pop())&&delete q[b]}function v(){a.fn.pjax=b,a.pjax=e,a.pjax.enable=a.noop,a.pjax.disable=w,a.pjax.click=c,a.pjax.submit=d,a.pjax.reload=f,a.pjax.defaults={timeout:650,push:!0,replace:!1,type:"GET",dataType:"html",scrollTo:0,maxCacheLength:20},a(window).bind("popstate.pjax",h)}function w(){a.fn.pjax=function(){return this},a.pjax=i,a.pjax.enable=v,a.pjax.disable=a.noop,a.pjax.click=a.noop,a.pjax.submit=a.noop,a.pjax.reload=function(){window.location.reload()},a(window).unbind("popstate.pjax",h)}var q={},r=[],s=[];0>a.inArray("state",a.event.props)&&a.event.props.push("state"),a.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),a.support.pjax?v():w()})(jQuery);