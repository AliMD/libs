/*!
 * backbone.layoutmanager.js v0.8.2
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */
(function(a){"use strict";var b,c=a.Backbone,d=a._,e=a.$,f=c.View.prototype._configure;c.View.prototype.render;var h=Array.prototype.push,i=Array.prototype.concat,j=Array.prototype.splice,k=c.View.extend({constructor:function(a){a=a||{},k.setupView(this,a),c.View.call(this,a)},insertView:function(a,b){return b?this.setView(a,b,!0):this.setView(a,!0)},insertViews:function(a){return d.isArray(a)?this.setViews({"":a}):(d.each(a,function(b,c){a[c]=d.isArray(b)?b:[b]}),this.setViews(a))},getView:function(a){return"function"!=typeof a&&"string"!=typeof a&&(a=arguments[1]),this.getViews(a).first().value()},getViews:function(a){var b=d.chain(this.views).map(function(a){return d.isArray(a)?a:[a]},this).flatten().value();return"string"==typeof a?d.chain([this.views[a]]).flatten():"object"==typeof a?d.chain([d.where(b,a)]).flatten():d.chain("function"==typeof a?d.filter(b,a):b)},removeView:function(a){return this.getViews(a).each(function(a){a.remove()})},setView:function(a,b,c){var e,f,g,h=this;if("string"!=typeof a&&(c=b,b=a,a=""),this.views=this.views||{},e=b.__manager__,f=this.views[a],!e)throw Error("Please set `View#manage` property with selector '"+a+"' to `true`.");return g=b.getAllOptions(),e.parent=h,e.selector=a,b.on("all",function(a){"beforeRender"!==a&&"afterRender"!==a&&h.trigger.apply(h,arguments)},b),c?(this.views[a]=i.call([],f||[],b),e.insert=!0,b):(e.hasRendered&&g.partial(h.$el,b.$el,h.__manager__,e),f&&d.each(i.call([],f),function(a){a.remove()}),this.views[a]=b)},setViews:function(a){return d.each(a,function(a,b){return d.isArray(a)?d.each(a,function(a){this.insertView(b,a)},this):(this.setView(b,a),void 0)},this),this},render:function(){function i(){function i(){var c=b.afterRender;c&&c.call(a,a),a.trigger("afterRender",a)}var d;return e&&(b.contains(e.el,a.el)||b.partial(e.$el,a.$el,f,c)),a.delegateEvents(),c.hasRendered=!0,(d=c.queue.shift())?d():delete c.queue,f&&f.queue?e.once("afterRender",i):i(),g.resolveWith(a,[a])}function j(){var b=a.getAllOptions(),c=a.__manager__,e=c.parent;e&&e.__manager__,a._render(k._viewRender,b).done(function(){if(!d.keys(a.views).length)return i();var c=d.map(a.views,function(a){var b=d.isArray(a);return b&&a.length?d.reduce(a.slice(1),function(a,b){return a.then(function(){return b.render()})},a[0].render()):b?a:a.render()});b.when(c).done(i)})}var a=this,b=a.getAllOptions(),c=a.__manager__,e=c.parent,f=e&&e.__manager__,g=b.deferred();return c.queue?h.call(c.queue,j):(c.queue=[],j(a,g)),g.view=a,g},remove:function(){return k._removeView(this,!0),this._remove.apply(this,arguments)},getAllOptions:function(){return d.extend({},this,k.prototype.options,this.options)}},{_cache:{},_makeAsync:function(a,b){var c=a.deferred();return c.async=function(){return c._isAsync=!0,b},c},_viewRender:function(a,b){function h(c){c&&(g.noel?a.setElement(c,!1):b.html(a.$el,c)),f.resolveWith(a,[a])}function i(a,d){var e,f=k._makeAsync(b,function(a){h(a)});k.cache(c,d),d&&(e=b.render.call(f,d,a)),f._isAsync||h(e)}var c,e,f,g=a.__manager__;return{render:function(){var g=a.serialize||b.serialize,h=a.template||b.template;return d.isFunction(g)&&(g=g.call(a)),f=k._makeAsync(b,function(a){i(g,a)}),"string"==typeof h&&(c=b.prefix+h),(e=k.cache(c))?(i(g,e,c),f):("string"==typeof h?e=b.fetch.call(f,b.prefix+h):"function"==typeof h?e=h:null!=h&&(e=b.fetch.call(f,h)),f._isAsync||i(g,e),f)}}},_removeViews:function(a,b){"boolean"==typeof a&&(b=a,a=this),a=a||this,a.getViews().each(function(a){(a.__manager__.hasRendered||b)&&k._removeView(a,b)})},_removeView:function(a,b){var c,e=a.__manager__,f="boolean"==typeof a.keep?a.keep:a.options.keep;if(!f&&(e.insert===!0||b)){if(k.cleanViews(a),a._removeViews(!0),a.$el.remove(),!e.parent)return;if(c=e.parent.views[e.selector],d.isArray(c))return d.each(d.clone(c),function(a,b){a&&a.__manager__===e&&j.call(c,b,1)});delete e.parent.views[e.selector]}},cache:function(a,b){return a in this._cache&&null==b?this._cache[a]:null!=a&&null!=b?this._cache[a]=b:void 0},cleanViews:function(a){d.each(i.call([],a),function(a){a.unbind(),a.model instanceof c.Model&&a.model.off(null,null,a),a.collection instanceof c.Collection&&a.collection.off(null,null,a),a.stopListening(),d.result(a,"cleanup")})},configure:function(a){d.extend(k.prototype.options,a),a.manage&&(c.View.prototype.manage=!0),a.el===!1&&(c.View.prototype.el=!1)},setupView:function(a,e){d.each(i.call([],a),function(a){if(!a.__manager__){var f,g,h,j=k.prototype,l=d.pick(a,b);d.defaults(a,{views:{},__manager__:{},_removeViews:k._removeViews,_removeView:k._removeView},k.prototype),e=a.options=d.defaults(e||{},a.options,j.options),h=d.pick(e,i.call(["events"],d.values(e.events))),d.extend(a,h),(l.render===k.prototype.render||l.render===c.View.prototype.render)&&delete l.render,d.extend(e,l),a._remove=c.View.prototype.remove,a._render=function(a,b){var c=this,d=c.__manager__,e=b.beforeRender;return d.hasRendered&&this._removeViews(),e&&e.call(this,this),this.trigger("beforeRender",this),a(this,b).render()},a.render=k.prototype.render,a.remove!==j.remove&&(a._remove=a.remove,a.remove=j.remove),f=e.views||a.views,d.keys(f).length&&(g=f,a.views={},a.setViews(g)),a.options.template?a.options.template=e.template:a.template&&(e.template=a.template,delete a.template)}})}});c.Layout=k,k.VERSION="0.8.2",c.View.prototype._configure=function(a){var b,c;return("el"in a?a.el===!1:this.el===!1)&&(b=!0),c=f.apply(this,arguments),(a.manage||this.manage)&&k.setupView(this),this.__manager__&&(this.__manager__.noel=b),c},k.prototype.options={prefix:"",deferred:function(){return e.Deferred()},fetch:function(a){return d.template(e(a).html())},partial:function(a,b,c,d){d.selector&&(a=a[c.noel?"filter":"find"](d.selector)),d.insert?this.insert(a,b):this.html(a,b)},html:function(a,b){a.html(b)},insert:function(a,b){a.append(b)},when:function(a){return e.when.apply(null,a)},render:function(a,b){return a(b)},contains:function(a,b){return e.contains(a,b)}},b=d.keys(k.prototype.options)})("object"==typeof global?global:this);