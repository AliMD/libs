/*!
 * backbone.layoutmanager.js v0.8.8
 * Copyright 2013, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */
(function(a){"use strict";var b,c=a.Backbone,d=a._,e=c.$,f=a.console&&a.console.warn,g=a.console&&a.console.trace,h=c.View.prototype._configure;c.View.prototype.render;var j=Array.prototype.push,k=Array.prototype.concat,l=Array.prototype.splice,m=c.View.extend({constructor:function(a){a=a||{},m.setupView(this,a),c.View.call(this,a)},insertView:function(a,b){return b?this.setView(a,b,!0):this.setView(a,!0)},insertViews:function(a){return d.isArray(a)?this.setViews({"":a}):(d.each(a,function(b,c){a[c]=d.isArray(b)?b:[b]}),this.setViews(a))},getView:function(a){return null==a&&(a=arguments[1]),this.getViews(a).first().value()},getViews:function(a){var b;return"string"==typeof a?(b=this.views[a]||[],d.chain([].concat(b))):(b=d.chain(this.views).map(function(a){return d.isArray(a)?a:[a]},this).flatten(),"object"==typeof a?b.where(a):"function"==typeof a?b.filter(a):b)},removeView:function(a){return this.getViews(a).each(function(a){a.remove()})},setView:function(a,b,c){var e,f,g,h=this;if("string"!=typeof a&&(c=b,b=a,a=""),this.views=this.views||{},e=b.__manager__,f=this.views[a],!e)throw Error("Please set `View#manage` property with selector '"+a+"' to `true`.");return g=b.getAllOptions(),e.parent=h,e.selector=a,b.on("all",function(a){"beforeRender"!==a&&"afterRender"!==a&&h.trigger.apply(h,arguments)},b),c?(this.views[a]=k.call([],f||[],b),e.insert=!0,b):(e.hasRendered&&g.partial(h.$el,b.$el,h.__manager__,e),f&&d.each(k.call([],f),function(a){a.remove()}),this.views[a]=b)},setViews:function(a){return d.each(a,function(a,b){return d.isArray(a)?d.each(a,function(a){this.insertView(b,a)},this):(this.setView(b,a),void 0)},this),this},render:function(){function l(){function l(){var d=c.afterRender;d&&d.call(b,b),b.trigger("afterRender",b),e.noel&&b.$el.length>1&&f&&!c.suppressWarnings&&(a.console.warn("Using `el: false` with multiple top level elements is not supported."),g&&a.console.trace())}var d;return h&&(c.contains(h.el,b.el)||c.partial(h.$el,b.$el,i,e)),b.delegateEvents(),e.hasRendered=!0,(d=e.queue.shift())?d():delete e.queue,i&&i.queue?h.once("afterRender",l):l(),k.resolveWith(b,[b])}function n(){var a=b.getAllOptions(),c=b.__manager__,e=c.parent;e&&e.__manager__,b._render(m._viewRender,a).done(function(){if(!d.keys(b.views).length)return l();var c=d.map(b.views,function(a){var b=d.isArray(a);return b&&a.length?d.reduce(a.slice(1),function(a,b){return a.then(function(){return b.render()})},a[0].render()):b?a:a.render()});a.when(c).done(l)})}var b=this,c=b.getAllOptions(),e=b.__manager__,h=e.parent,i=h&&h.__manager__,k=c.deferred();return e.queue?j.call(e.queue,n):(e.queue=[],n(b,k)),k.view=b,k},remove:function(){return m._removeView(this,!0),this._remove.apply(this,arguments)},getAllOptions:function(){return d.extend({},this,m.prototype.options,this.options)}},{_cache:{},_makeAsync:function(a,b){var c=a.deferred();return c.async=function(){return c._isAsync=!0,b},c},_viewRender:function(a,b){function j(c){d.isString(c)&&(i.noel?(c=e.trim(c),h=e(c),a.$el.slice(1).remove(),a.$el.replaceWith(h),a.setElement(h,!1)):b.html(a.$el,c)),g.resolveWith(a,[a])}function k(a,d){var e,f=m._makeAsync(b,function(a){j(a)});m.cache(c,d),d&&(e=b.render.call(f,d,a)),f._isAsync||j(e)}var c,f,g,h,i=a.__manager__;return{render:function(){var e=a.serialize||b.serialize,h=a.template||b.template;return d.isFunction(e)&&(e=e.call(a)),g=m._makeAsync(b,function(a){k(e,a)}),"string"==typeof h&&(c=b.prefix+h),(f=m.cache(c))?(k(e,f,c),g):("string"==typeof h?f=b.fetch.call(g,b.prefix+h):"function"==typeof h?f=h:null!=h&&(f=b.fetch.call(g,h)),g._isAsync||k(e,f),g)}}},_removeViews:function(a,b){"boolean"==typeof a&&(b=a,a=this),a=a||this,a.getViews().each(function(a){(a.__manager__.hasRendered||b)&&m._removeView(a,b)})},_removeView:function(a,b){var c,e=a.__manager__,f="boolean"==typeof a.keep?a.keep:a.options.keep;if(!f&&e.insert===!0||b){if(m.cleanViews(a),a._removeViews(!0),a.$el.remove(),!e.parent)return;if(c=e.parent.views[e.selector],d.isArray(c))return d.each(d.clone(c),function(a,b){a&&a.__manager__===e&&l.call(c,b,1)});delete e.parent.views[e.selector]}},cache:function(a,b){return a in this._cache&&null==b?this._cache[a]:null!=a&&null!=b?this._cache[a]=b:void 0},cleanViews:function(a){d.each(k.call([],a),function(a){var b;a.unbind(),a.model instanceof c.Model&&a.model.off(null,null,a),a.collection instanceof c.Collection&&a.collection.off(null,null,a),a.stopListening(),b=a.getAllOptions().cleanup,d.isFunction(b)&&b.call(a)})},configure:function(a){d.extend(m.prototype.options,a),a.manage&&(c.View.prototype.manage=!0),a.el===!1&&(c.View.prototype.el=!1),a.suppressWarnings===!0&&(c.View.prototype.suppressWarnings=!0)},setupView:function(a,e){d.each(k.call([],a),function(a){if(!a.__manager__){var f,g,h,i=m.prototype,j=d.pick(a,b);d.defaults(a,{views:{},__manager__:{},_removeViews:m._removeViews,_removeView:m._removeView},m.prototype),e=a.options=d.defaults(e||{},a.options,i.options),h=d.pick(e,k.call(["events"],d.values(e.events))),d.extend(a,h),(j.render===m.prototype.render||j.render===c.View.prototype.render)&&delete j.render,d.extend(e,j),a._remove=c.View.prototype.remove,a._render=function(a,b){var c=this,d=c.__manager__,e=b.beforeRender;return d.hasRendered&&this._removeViews(),e&&e.call(this,this),this.trigger("beforeRender",this),a(this,b).render()},a.render=m.prototype.render,a.remove!==i.remove&&(a._remove=a.remove,a.remove=i.remove),f=e.views||a.views,d.keys(f).length&&(g=f,a.views={},a.setViews(g)),a.options.template?a.options.template=e.template:a.template&&(e.template=a.template)}})}});c.Layout=m,m.VERSION="0.8.8",c.View.prototype._configure=function(a){var b,c;return("el"in a?a.el===!1:this.el===!1)&&(b=!0),c=h.apply(this,arguments),(a.manage||this.manage)&&m.setupView(this),this.__manager__&&(this.__manager__.noel=b,this.__manager__.suppressWarnings=a.suppressWarnings),c},m.prototype.options={prefix:"",deferred:function(){return e.Deferred()},fetch:function(a){return d.template(e(a).html())},partial:function(a,b,c,d){if(d.selector)if(c.noel){var e=a.filter(d.selector);a=e.length?e:a.find(d.selector)}else a=a.find(d.selector);d.insert?this.insert(a,b):this.html(a,b)},html:function(a,b){a.html(b)},insert:function(a,b){a.append(b)},when:function(a){return e.when.apply(null,a)},render:function(a,b){return a(b)},contains:function(a,b){return e.contains(a,b)}},b=d.keys(m.prototype.options)})("object"==typeof global?global:this);