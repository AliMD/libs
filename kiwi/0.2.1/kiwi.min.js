/*! Coolony's Kiwi | Copyright Â©2012 Pierre Matri <pierre.matri@coolony.com> | MIT Licensed */
(function(){function e(t){var n=e.resolve(t),r=e.modules[n];if(!r)throw new Error('failed to require "'+t+'"');return r.exports||(r.exports={},r.call(r.exports,r,r.exports,e.relative(n))),r.exports}e.modules={},e.resolve=function(t){var n=t,r=t+".js",i=t+"/index.js";return e.modules[r]&&r||e.modules[i]&&i||n},e.register=function(t,n){e.modules[t]=n},e.relative=function(t){return function(n){if("."!=n.charAt(0))return e(n);var r=t.split("/"),i=n.split("/");r.pop();for(var s=0;s<i.length;s++){var o=i[s];".."==o?r.pop():"."!=o&&r.push(o)}return e(r.join("/"))}},e.register("cache.js",function(e,t,n){function r(){this._cache={}}r.prototype.cache=function(e,t){if(_.isUndefined(t))return;this._cache[e]=t},r.prototype.get=function(e){return this._cache[e]},e.exports=r}),e.register("compiler.js",function(e,t,n){var r=n("./token"),i=n("./utils"),s="{{",o="}}",u=s.length,a=/^(\/)?\s*([^\s\}\(]*)/,f=e.exports=function(e){this.template=e,this.source=e.template,this.options=e.options,this.helpers={},this.__compilationEnd=[]};f.prototype.compile=function(e){function n(n,r){if(n)return e(n);t._tokenize(r,s)}function s(n,r){if(n)return e(n);r.compile(t,o)}function o(n,r){if(n)return e(n);var i=new Function("$template","$tools","_","$data","$helpers","$callback",r);i.$helpers=t.helpers,e(null,i)}var t=this;i.applyAll(this.source,r.tagBeforeProcessors,[this],n)},f.prototype._tokenize=function(e,t){var n=e,i=new r.RootToken,a=i,f=!1,l;for(;;){var c=n.search(f?o:s);if(c===-1){this._pushLiteralToken(a,i,n);break}f&&(c+=u),l=n.slice(0,c),n=n.slice(c);if(!f)this._pushLiteralToken(a,i,l);else{l=l.slice(2,-2);try{i=this._pushToken(a,i,l)}catch(h){return t(h)}}f=!f}if(a!==i)return t(new Error("Tokenization error: unexpected end of file, expected `"+i.tag.tagName+"`."));t(null,a)},f.prototype._pushLiteralToken=function(e,t,n){if(!n.length)return;t.children.push(new r.LiteralToken(n,e))},f.prototype._pushToken=function(e,t,n){var i=n.match(a),s=i[2],o=i[1]!=="/",u=t.lookupTag(s),f;if(!u)throw new Error("Tokenization error: Unknown tag `"+s+"`.");if(u.isIntermediate)return t.tagType.isIntermediate&&(t=t.parent),f=new r.IntermediateToken(n,u,e,t,[],this.options),t.intermediate.push(f),f;if(u.isBlock){if(o)return f=new r.BlockToken(n,u,e,t,[],this.options),t.children.push(f),f;if(!t.parent)throw new Error("Tokenization error: unexpected `"+s+"` tag at root level.");t.tagType.isIntermediate&&(t=t.parent);if(t.tagType.tagName!==s)throw new Error("Tokenization error: unexpected `"+s+"` tag, expected `"+t.tag.tagName+"`.");return t.parent}if(!o)throw new Error("Tokenization error: `"+s+"` is not a block tag.");return f=new r.LeafToken(n,u,e,t,this.options),t.children.push(f),t},f.prototype.registerTemplateHelper=function(e,t){this.helpers[e]=t}}),e.register("filter.js",function(e,t,n){function r(t,n){var r;n.forEach(function(n){var i=[];_.isArray(n)&&(i=n.slice(1),n=n[0]);var s=e.exports.filters[n];if(!s)return r=n,!1;t=s.apply(this,[t].concat(i))});if(r)throw new Error("Rendering error: Unknown filter `"+r+"`.");return t}function s(e){e=e||frame.files.requireDir(__dirname+"/filters/");for(var t in e){var n=e[t];for(var r in n)i[r]=n[r]}}e.exports=r;var i=e.exports.filters={},o=["base","datetime"],u={};_.each(o,function(e){u[e]=n("./filters/"+e)}),s(u)}),e.register("filters/base.js",function(e,t,n){var r=n("../tools"),i=n("../utils");t.escape=function(e){if(e===null||e===undefined)return"";if(i.isIterable(e)){var n={};return _.each(e,function(e,r){n[r]=t.escape(e)}),n}return r.escape(e)},t.escapeIfUnsafe=function(e){if(e===null||e===undefined)return"";if(i.isIterable(e)){var n={};return _.each(e,function(e,r){n[r]=t.escapeIfUnsafe(e)}),n}return r.escapeIfUnsafe(e)},t.capitalize=function(e){if(i.isIterable(e)){var n={};return _.each(e,function(e,r){n[r]=t.capitalize(e)}),n}return e=e.toString(),e.charAt(0).toUpperCase()+e.slice(1)},t.upper=function(e){if(i.isIterable(e)){var n={};return _.each(e,function(e,r){n[r]=t.upper(e)}),n}return e.toString().toUpperCase()},t.lower=function(e){if(i.isIterable(e)){var n={};return _.each(e,function(e,r){n[r]=t.lower(e)}),n}return e.toString().toLowerCase()},t.json=function(e){return JSON.stringify(e)},t.add=function(e,n){if(typeof e=="object"){var r={};return _.each(e,function(e,i){r[i]=t.add(e,n)}),r}return parseFloat(e)+parseFloat(n)},t.subtract=function(e,n){return t.add(e,-parseInt(n,10))},t.mul=function(e,n){if(typeof e=="object"){var r={};return _.each(e,function(e,i){r[i]=t.mul(e,n)}),r}return parseFloat(e)*parseFloat(n)},t.div=function(e,n){if(typeof e=="object"){var r={};return _.each(e,function(e,i){r[i]=t.div(e,n)}),r}return parseFloat(e)/parseFloat(n)},t.incr=function(e,n){return t.add(e,1)},t.decr=function(e,n){return t.add(e,-1)},t.round=function(e){if(typeof e=="object"){var n={};return _.each(e,function(e,r){n[r]=t.round(e)}),n}return Math.round(e)},t.floor=function(e){if(typeof e=="object"){var n={};return _.each(e,function(e,r){n[r]=t.floor(e)}),n}return Math.floor(e)},t.ceil=function(e){if(typeof e=="object"){var n={};return _.each(e,function(e,r){n[r]=t.ceil(e)}),n}return Math.ceil(e)},t.cut=function(e,n){if(typeof e=="object"){var r={};return _.each(e,function(e,i){r[i]=t.cut(e,n)}),r}return e.toString().replace(n,"")},t.addslashes=function(e){if(i.isIterable(e)){var n={};return _.each(e,function(e,r){n[r]=t.capitalize(e)}),n}return e.toString().replace(/\\/g,"\\\\").replace(/\'/g,"\\'").replace(/\"/g,'\\"').replace(/\0/g,"\\0")},t.stripslashes=function(e){if(i.isIterable(e)){var n={};return _.each(e,function(e,r){n[r]=t.capitalize(e)}),n}return e.toString().replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\0/g,"\0").replace(/\\\\/g,"\\")},t.first=function(e){return typeof e=="object"&&!_.isArray(e)?"":_.isString(e)?e.substr(0,1):_.first(e)},t.last=function(e){return typeof e=="object"&&!_.isArray(e)?"":_.isString(e)?e.slice(-1):_.last(e)},t.length=function(e){return typeof e=="object"?_.keys(e).length:e.length},t.reverse=function(e){return _.isArray(e)?e.reverse():e},t.join=function(e,t){if(_.isArray(e))return e.join(t);if(typeof e=="object"){var n=[];return _.each(e,function(e,t){n.push(e)}),n.join(t)}return e},t.urlencode=function(e){return encodeURIComponent(e)},t.urldecode=function(e){return decodeURIComponent(e)},t.replace=function(e,t,n,r){return e.replace(new RegExp(t,r),n)},e.exports=t}),e.register("filters/datetime.js",function(e,t,n){t.timeago=function(e){return moment(e).fromNow()},t.relativedate=function(e){return moment(e).calendar()},t.date=function(e,t){return moment(e).format(t)},e.exports=t}),e.register("kiwi.js",function(e,t,n){var r=t.Template=n("./template");t.tools=n("./tools"),t.version="0.2.1",e.exports=t}),e.register("tags/as.js",function(e,t,n){var r=/^as\s+([^\s]+)$/;e.exports.tags={};var i=e.exports.tags.as={};i.isBlock=!0,i.compile=function(e,t,n,i,s){var o=e.tag.match(r);if(!o)return s(new Error("Compilation error: Unable to parse tag `"+e.tag+"`."));var u=o[1],a="(function(parentAcc) {var __acc = [];"+t+'var __joined = __acc.join("");'+'$data["'+u+'"] = $tools.tools.safe(__joined);'+"})(__acc);";s(null,a)}}),e.register("tags/block.js",function(e,t,n){var r=/^block\s+([^\s]+)(?:\s+(append|prepend))?$/;e.exports.tags={};var i=e.exports.tags.block={},s=e.exports.tags.parent={};i.isBlock=!0,i.compile=function(e,t,n,i,s){var o=e.tag.match(r);if(!o)return s(new Error("Compilation error: Unable to parse tag `"+e.tag+"`."));var u=o[1],a=o[2],f="(function(__parentAcc) {var __acc = [];"+t+'var __currentBlock = __acc.join("");'+'if(!_.isUndefined(__blocks["'+u+'"])) {'+'__tmp = new String(__blocks["'+u+'"].replace('+"/\\{\\{parent\\}\\}/g, __currentBlock"+"));"+'if(__blocks["'+u+'"].mode) {'+'__tmp.mode = __blocks["'+u+'"].mode;'+"}"+'__blocks["'+u+'"] = __tmp;'+"}"+"var __acc = [];"+'if(_.isUndefined(__blocks["'+u+'"]) ||'+'__blocks["'+u+'"].mode) {'+'if(__blocks["'+u+'"] &&'+'__blocks["'+u+'"].mode == "append") {'+'__acc.push(__blocks["'+u+'"]);'+"}"+"__acc.push(__currentBlock);"+'if(__blocks["'+u+'"] &&'+'__blocks["'+u+'"].mode == "prepend") {'+'__acc.push(__blocks["'+u+'"]);'+"}"+"} else {"+'__acc.push(__blocks["'+u+'"]);'+"}"+'var __joined = new String(__acc.join(""));'+(a?'__joined.mode = "'+a+'";':"")+"__parentAcc.push(__joined);"+'__blocks["'+u+'"] = __joined;'+"})(__acc);";s(null,f)},s.compile=function(e,t,n,r){if(!e.parent.tagType||e.parent.tagType.tagName!=="block")return r(new Error("Compilation error: `parent` must be immediate child of a `block` tag."));e.parent.hasParentTag=!0,r(null,'__acc.push("{{parent}}");')}}),e.register("tags/comment.js",function(e,t,n){var r=/\{\{\s*comment\s*\}\}((.|\n)*?)\{\{\s*\/\s*comment\s*\}\}/g;e.exports.tags={};var i=e.exports.tags["#"]={};i.isBlock=!1,i.compile=function(e,t,n,r){r(null,"")},i.beforeProcessor=function(e,t,n){e=e.replace(r,""),n(null,e)}}),e.register("tags/each.js",function(e,t,n){var r=/^each(?:\(([^\)\s]+)\s*\,\s*([^\)\s]+)\s*\))?\s+(.*)$/;e.exports.tags={};var i=e.exports.tags.each={},s=i.intermediateTags={},o=s.empty={};i.isBlock=!0,i.headDeclarations="var $each = undefined;",i.compile=function(e,t,n,i,s){var o=e.tag.match(r);if(!o)return s(new Error("Compilation error: Unable to parse tag `"+e.tag+"`."));var u=o[1]||"$value",a=o[2]||"$index",f=o[3],l;if(n.length){if(n.length>1)return s(new Error("Compilation Error: Too many intermediate tags for `each`."));if(e.intermediate[0].tag!=="empty")return s(new Error("Compilation Error: Unexpected tag `"+e.intermediate[0].tag+"`."));l=n[0]}var c="(function(__parentEachLoop) {";e.options.strict?c+="__tmp = "+f+";":c+="try {__tmp = "+f+"} catch(__err) {"+"if(__err instanceof ReferenceError) {"+"__tmp = [];"+"} else {"+"throw __err;"+"}"+"}",c+="var __eachLoopLength = _.size(__tmp);var _eachLoop, $each;",l&&(c+="if(__eachLoopLength) {"),e.options.eachCounters?c+="var __eachLoopCounter = 0;_.each(__tmp, function("+u+","+a+"){"+"$each = _eachLoop = {"+"size: __eachLoopLength,"+"counter0: __eachLoopCounter,"+"counter: __eachLoopCounter + 1,"+"revcounter0: __eachLoopLength - __eachLoopCounter - 1,"+"revcounter: __eachLoopLength - __eachLoopCounter,"+"first: __eachLoopCounter === 0,"+"last: __eachLoopCounter + 1 === __eachLoopLength,"+"parentLoop: __parentEachLoop,"+"parent: __parentEachLoop,"+"_index: "+a+","+"_value: "+u+"};"+"if(__parentEachLoop) {"+"$each.parentIndex = __parentEachLoop._index;"+"$each.parentValue = __parentEachLoop._value;"+"}"+t+"__eachLoopCounter++;"+"});":c+="_.each(__tmp, function("+u+","+a+") {"+t+"});",l&&(c+="} else {"+l+"}"),c+="})($each);",s(null,c)}}),e.register("tags/extend.js",function(e,t,n){var r=n("../utils"),i=/^extend\s+(.+)$/;e.exports.tags={};var s=e.exports.tags.extend={},o=e.exports.helpers={};s.isBlock=!1,s.compile=function(e,t,n,r){if(e.root.children[0]!==e)return r(new Error("Compilation error: Extend tag must be defined at the very beginning of the template."));var s=e.tag.match(i);if(!s)return r(new Error("Compilation error: Unable to parse tag `"+e.tag+"`."));var o=s[1],u="var __originalCallback = $callback;$callback = function(err, compiled) {$helpers.extend("+o+", __compiled, $template,"+"$data, __originalCallback);"+"};";r(null,u)},o.extend=function(e,t,n,r,i){function s(e,t){if(e)return i(e);i(null,t)}n._renderRelative(e,r,t,s)}}),e.register("tags/filter.js",function(e,t,n){var r=n("../utils"),i=/^filter\s+(.+)$/;e.exports.tags={};var s=e.exports.tags.filter={};s.isBlock=!0,s.compile=function(e,t,n,s,o){var u=e.tag.match(i);if(!u)return o(new Error("Compilation error: Unable to parse tag `"+e.tag+"`."));var a;try{a=r.parseFilters(u[1])}catch(f){return o(f)}var l=u[1],c="(function(__parentAcc) {var __acc = [];"+t+"__parentAcc.push("+"$tools.filter("+'__acc.join(""),'+"["+a.join(",")+"]"+")"+");"+"})(__acc);";o(null,c)}}),e.register("tags/if.js",function(e,t,n){function a(e,t){var n;return t?n="if("+e+")":n="try {__tmp = "+e+"} catch(__err) {"+"if(__err instanceof ReferenceError) {"+"__tmp = false;"+"} else {"+"throw __err;"+"}"+"}"+"if(__tmp)",n}var r=/^if\s+(.*)$/,i=/^else(?:\s+(.*))?$/;e.exports.tags={};var s=e.exports.tags["if"]={},o=s.intermediateTags={},u=o["else"]={};s.isBlock=!0,s.compile=function(e,t,n,s,o){var u=e.tag.match(r);if(!u)return o(new Error("Compilation error: Unable to parse tag `"+e.tag+"`."));var f=u[1],l=["}"],c=a(f,e.options.strict);c+="{"+t;var h;_.each(e.intermediate,function(t,r){var s=t.tag,o=n[r],u=s.match(i);if(!u){h=new Error("Compilation error: Unable to parse tag `"+e.tag+"`.");return}var f=u[1];f?(l.push("}"),c+="} else {"+a(f,e.options.strict)+"{"):c+="} else {",c+=n[r]});if(h)return o(h);c+=l.join(""),o(null,c)}}),e.register("tags/ifblock.js",function(e,t,n){var r=/^ifblock\s+([^\s]+)$/;e.exports.tags={};var i=e.exports.tags.ifblock={};i.isBlock=!0,i.compile=function(e,t,n,i,s){var o=e.tag.match(r);if(!o)return s(new Error("Compilation error: Unable to parse tag `"+e.tag+"`."));var u=o[1],a='if(!_.isUndefined(__blocks["'+u+'"])) {'+t+"}";s(null,a)}}),e.register("tags/include.js",function(e,t,n){var r=n("../utils"),i=/^include\s+(.+)$/;e.exports.tags={};var s=e.exports.tags.include={},o=e.exports.helpers={};s.isBlock=!1,s.compile=function(e,t,n,r){var s=e.tag.match(i);if(!s)return r(new Error("Compilation error: Unable to parse tag `"+e.tag+"`."));var o=s[1];n.__compilationEnd.unshift("});");var u="$helpers.include("+o+", $template,"+"$data, function(err, rendered) {"+"__acc.push(rendered);";r(null,u)},o.include=function(e,t,n,r){function i(e,t){if(e)return r(e);r(null,t)}t._renderRelative(e,n,null,i)}}),e.register("tags/print.js",function(e,t,n){function c(e){var t=function(t,n,r,s){var u=t.tag.match(o);if(!u)return s(new Error("Compilation error: Unable to parse tag `"+t.tag+"`."));if(u[1]){var a=parseInt(u[1],10)-1;t.__originalTag=r.__print[a]}var f=u[2],l;try{l=u[3]?i.parseFilters(u[3],e):e}catch(c){return s(c)}f="$tools.filter("+f+", "+"["+l.join(",")+"]"+")";var h;t.options.strict?h="__acc.push("+f+");":h="try {var __tmp = "+f+";"+"} catch(__err) {"+"if(__err instanceof ReferenceError) {"+'__tmp = "";'+"} else {"+"throw __err;"+"}"+"}"+"__acc.push(__tmp);",s(null,h)};return t.untokenize=function(e,t){return e.__originalTag?e.__originalTag:"{{"+e.tag+"}}"},t}var r=n("../filter"),i=n("../utils"),s=/\$\{([^\}]*)\}/g,o=/^(?:=|html)\s+(?:\:(\d+)\s+)?([^|]+)(?:\|(.*))?$/,u=["escapeIfUnsafe"].map(JSON.stringify),a=[];e.exports.tags={};var f=e.exports.tags["="]={},l=e.exports.tags.html={};f.isBlock=!1,l.isBlock=!1,f.beforeProcessor=function(e,t,n){t.__print=[],e=e.replace(s,function(e,n){return t.__print.push(e),"{{= :"+t.__print.length+" "+n+"}}"}),n(null,e)},f.compile=c(u),l.compile=c(a)}),e.register("tags/raw.js",function(e,t,n){var r=n("../utils"),i=new RegExp("\\{\\{\\s*verbatim\\s*\\}\\}((?:.|\\n)*?)\\{\\{\\s*\\/\\s*verbatim\\s*\\}\\}|{\\{\\s*raw\\s*\\}\\}((?:.|\\n)*?)\\{\\{\\s*\\/\\s*raw\\s*\\}\\}","g");e.exports.tags={};var s=e.exports.tags.verbatim={};s.isBlock=!1,s.compile=function(e,t,n,i){var s=parseInt(e.tag.split(" ")[1],10)-1;i(null,'__acc.push("'+r.escapeCompiledString(n.__verbatim[s])+'");')},s.beforeProcessorPrepend=!0,s.beforeProcessor=function(e,t,n){t.__verbatim=[],e=e.replace(i,function(n,r,i){return t.__verbatim.push(r||i),"{{verbatim "+t.__verbatim.length+"}}"}),n(null,e)}}),e.register("tags/tmpl.js",function(e,t,n){var r=n("../utils"),i=/^tmpl\s+(.*)$/;e.exports.tags={};var s=e.exports.tags.tmpl={};s.isBlock=!1,s.compile=function(e,t,n,r){var s=e.tag.match(i);if(!s)return r(new Error("Compilation error: Unable to parse tag `"+e.tag+"`."));var o=s[1];n.__compilationEnd.unshift("});"),r(null,"$template._nest("+o+", $data, "+"function(err, rendered){"+"__acc.push(rendered);")}}),e.register("template.js",function(e,t,n){function h(e,t){_.isObject(e)&&!t&&(t=e,e=null),t=t?_.clone(t):{},t=_.defaults(t,l),t.cacheContext=t.cacheContext||h,this.template=e,this.options=t,this._compiled=null;if(t.cache&&!(this._getCache()instanceof t.cacheHandler)){var n=[t.cacheHandler].concat(t.cacheOptions);t.cacheContext[t._cacheProp]=typeof window!="undefined"?new t.cacheHandler:construct.apply(this,n)}}var r=n("./cache"),i=r,s=n("./utils"),o=n("./token"),u=n("./tools"),a=n("./compiler"),f=n("./filter"),l={lookup:s.lookupTemplate,load:s.loadTemplate,path:null,cache:!0,cacheHandler:r,cacheOptions:[],lookupPaths:[],cacheTmplHandler:i,cacheTmplOptions:[1e3],useIsolatedTmplCache:!0,cacheContext:null,strict:!0,eachCounters:!0,_parent:null,_cacheAttachment:"_cache",_cacheTmplAttachment:"_nestCache"},c={filter:f,utils:s,tools:u};h.prototype._getCache=function(){return this.options.cacheContext[this.options._cacheProp]},h.prototype.loadFile=function(e,t){t(new Error("Client mode does not support reading from file."))},h.prototype.render=function(e,t){_.isFunction(e)&&!t&&(t=e,e={}),e||(e={});var n="template::"+this._cacheKey();!this.compiled&&this.options.cache&&(this._compiled=this._getCache().get(n));if(this._compiled)return this._renderCompiled(e,t);var r=this;this._compile(function(n){if(n)return t(n);r._renderCompiled(e,t)})},h.prototype.loadAndRender=function(e,t,n){n(new Error("Client mode does not support reading from file."))},h.prototype._renderCompiled=function(t,n){try{this._compiled.call(this._compiled,this,c,_,t,o.helpers,n)}catch(r){n(r)}},h.prototype._compile=function(e){var t=this;if(!_.isString(this.template))return e(new Error("Template contents not set"));(new a(this)).compile(function(n,r){if(n)return e(n);t._compiled=r;var i="template::"+t._cacheKey();t.options.cache&&t._getCache().cache(i,r),e(null,r)})},h.prototype._nest=function(e,t,n){var r=_.clone(this.options);r.useIsolatedTmplCache&&(r._cacheAttachment=r._cacheTmplAttachment,r.cacheHandler=r.cacheTmplHandler,r.cacheOptions=r.cacheTmplOptions),(new h(e,r)).render(t,function(t,r){if(t)return n(t);n(null,r)})},h.prototype._renderRelative=function(e,t,n,r){function a(e,t){if(e)return r(e);i.options.cache&&i._getCache().cache(s,t),u.loadFile(t,f)}function f(e,n){if(e)return r(e);u.render(t,l)}function l(e,t){if(e)return r(e);r(null,t)}var i=this,s,o,u;if(e instanceof h)u=e,u.options._parent=n,u.render(t,l);else{var c=_.clone(this.options);c._parent=n,u=new h(c),s="path::"+this._cacheKey()+"::"+e,this.options.cache&&(o=this._getCache().get(s)),o?u.loadFile(o,f):this.options.lookup(e,this,a)}},h.prototype._cacheKey=function(){return this.options.path||this.template||null},e.exports=h}),e.register("token.js",function(e,t,n){function c(e,t,n){this.parent=t,this.children=[],this.tag=null,this.tagType=null,this.options=n,this.root=e}function h(e,t,n,r){h._superclass.call(this,t,n,r),this.literal=e}function p(e,t){p._superclass.call(this,this,null,t),e||(e=[]),this.head=[],this.children=e}function d(e,t,n,r,i,s){d._superclass.call(this,n,r,s),this.tag=e,this.tagType=t,i||(i=[]),this.children=i,this.intermediate=[]}function v(e,t,n,r,i){v._superclass.call(this,n,r,i),this.tag=e,this.tagType=t}function m(e,t,n,r,i,s){m._superclass.call(this,e,t,n,r,i,s)}function g(e,t){t.beforeProcessor&&(t.beforeProcessorPrepend?f.unshift(t.beforeProcessor):f.push(t.beforeProcessor)),t.headDeclarations&&o.push(t.headDeclarations),t.footDeclarations&&u.push(t.footDeclarations);if(t.helpers)for(var n in t.helpers)y(n,t.helpers[n]);a[e]=t,t.tagName=e}function y(e,t){l[e]=t}function b(e){e=e||r.files.requireDir(__dirname+"/tags/");for(var t in e){var n=e[t].tags,i=e[t].helpers;for(var s in n)g(s,n[s]);if(i)for(var o in i)y(o,i[o])}}var r,i=n("./utils"),s=r?r.classes.extend:i.inherits,o=[],u=[],a={},f=[],l={};c.prototype.compile=function(e,t){t(new Error("Stub method BaseToken#compile must be overloaded"))},c.prototype.lookupTag=function(e){if(a[e])return a[e];if(this.tagType&&this.tagType.intermediateTags&&this.tagType.intermediateTags[e])return this.tagType.intermediateTags[e].isIntermediate=!0,this.tagType.intermediateTags[e]},s(h,c),h.prototype.compile=function(e,t){this._compiled='__acc.push("'+i.escapeCompiledString(this.literal)+'");',t(null,this._compiled)},s(p,c),p.prototype.compile=function(e,t){function r(r,i){if(r)return t(r);i="var __this = this;var __acc = [];var __blocks = {};if($template.options && $template.options._parent) {__blocks = $template.options._parent.blocks;}var __tmp;var __err;$data = $data || {};"+o.join("")+"with($data) {"+i+u.join("")+'var __compiled = new String(__acc.join(""));'+"__compiled.blocks = __blocks;"+"$callback(null, __compiled);"+e.__compilationEnd.join("")+"}",n._compiled=i,t(null,i)}var n=this;i.compileTokens(this.children,e,r)},s(d,c),d.prototype.compile=function(e,t){function a(s,o){if(s)return t(s);r=o,i.compileTokenArray(n.intermediate,e,f)}function f(i,u){if(i)return t(i);s=u,o(n,r,s,e,l)}function l(e,r){if(e)return t(e);n._compiled=r,t(null,r)}var n=this,r,s,o=this.tagType.compile,u=o.joinCompilationResult!==!1?"compileTokens":"compileTokenArray";i[u](this.children,e,a)},s(v,c),v.prototype.compile=function(e,t){function r(e,r){if(e)return t(e);n._compiled=r,t(null,r)}var n=this,i=this.tagType.compile(this,null,e,r)},v.prototype.untokenize=function(e){return this.tagType.compile.untokenize?this.tagType.compile.untokenize(this,e):"{{"+this.tag+"}}"},s(m,d),m.prototype.compile=function(e,t){function r(e,n){if(e)return t(e);t(null,n)}var n=this;i.compileTokens(this.children,e,r)},m.prototype.lookupTag=function(e){return this.parent.lookupTag(e)},e.exports={BaseToken:c,RootToken:p,BlockToken:d,IntermediateToken:m,LeafToken:v,LiteralToken:h,headDeclarations:o,footDeclarations:u,tags:a,tagBeforeProcessors:f,helpers:l,registerTag:g,registerHelper:y};var w=["block","comment","each","if","print","raw","tmpl","ifblock","as","include","extend"],E={};_.each(w,function(e){E[e]=n("./tags/"+e)}),b(E)}),e.register("tools.js",function(e,t,n){var r=n("./token"),i=n("./filter"),s=n("./utils"),o=/\s+(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/g,u=/^\w+$/,a=u;t.createSimpleTag=function(t,n){if(!t.match(a))throw new Error("Error:`"+t+"` is not a valid tag name.");r.helpers[t]=n,r.tags[t]={compile:function(e,n,r,i){var s=e.tag.split(o);s[0]="$data";var u=s.join(","),a='__acc.push($tools.tools.escapeIfUnsafe($helpers["'+t+'"]('+u+")"+"));";i(null,a)}}},t.createFilter=function(t,n){if(!t.match(u))throw new Error("Error:`"+t+"` is not a valid filter name.");i.filters[t]=n};var f=t.escape=function(e){return e.toString().replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#146;")},l=t.SafeString=String;t.safe=function(e){return e instanceof l||(e=new l(e)),e},t.escapeIfUnsafe=function(e){return e instanceof l?e:f(e)},t.registerTag=r.registerTag,t.registerHelper=r.registerHelpers,t.escapeCompiledString=s.escapeCompiledString,t.applyAll=s.applyAll,t.safeString=String,e.exports=t}),e.register("utils.js",function(e,t,n){function a(e,t,n,r){function i(t){if(t)return r(t);e.length>0?setTimeout(s,0):r()}function s(){var r=e.shift();t.apply(this,[r].concat(n).concat([i]))}typeof n=="function"&&!r&&(r=n,n=null),n||(n=[]),e=e.slice(0),e.length>0?setTimeout(s,0):r()}function c(e,t,n){function s(e,n){e.compile(t,function(t,i){if(t)return n(t);r.push(i),n(null,i)}),i++}function o(e){if(e)return n(e);n(null,r)}var r=[],i=0;f(e,s,o)}var r,i=".kiwi",s=/\|(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/g,o=/\,(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/g,u=/^(\w+)\s*(?:\((.*)\))?$/i,f=r?r.asyncForEach:a,l=t.apply=function(e,t,n,r){function i(e,t){if(e)return r(e);r(null,t)}typeof n=="function"&&!r&&(r=n,n=null),t.apply(this,[e].concat(n||[]).concat([i]))};t.applyAll=function(e,t,n,r){function i(t,r){l(e,t,n||[],function(n,i){if(n)return r(n);e=i,r()})}function s(t){if(t)return r(t);r(null,e)}typeof n=="function"&&!r&&(r=n,n=null),f(t,i,s)},t.compileTokenArray=c,t.compileTokens=function(e,t,n){c(e,t,function(e,t){if(e)return n(e);n(null,t.join(""))})},t.escapeCompiledString=function(e){return e.replace(/([\\"])/g,"\\$1").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t")},t.isIterable=function(e){return typeof e=="object"&&!(e instanceof String)},t.parseFilters=function(e,t){var n=!1;t=t||[];var r=e.split(s);if(!r)throw new Error("Compilation error: Unable to parse filters `"+e+"`.");var i=r.filter(function(t){return t==="raw"?(n=!0,!1):!0}).map(function(t){var n=t.match(u);if(!n)throw new Error("Compilation error: Unable to parse filter `"+t+"`.");n[1]=n[1].replace('"','"');if(!n[2])return'"'+n[1]+'"';var r=n[2].split(o);return'["'+n[1]+'", '+r.join(",")+"]"});return n||(i=i.concat(t)),_.uniq(i)},t.inherits=function(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e,e._superclass=t,e._superproto=t.prototype},e.exports=t}),window.kiwi=e("kiwi")})();