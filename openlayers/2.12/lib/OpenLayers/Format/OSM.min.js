OpenLayers.Format.OSM=OpenLayers.Class(OpenLayers.Format.XML,{checkTags:!1,interestingTagsExclude:null,areaTags:null,initialize:function(e){var t={interestingTagsExclude:["source","source_ref","source:ref","history","attribution","created_by"],areaTags:["area","building","leisure","tourism","ruins","historic","landuse","military","natural","sport"]};t=OpenLayers.Util.extend(t,e);for(var i={},n=0;t.interestingTagsExclude.length>n;n++)i[t.interestingTagsExclude[n]]=!0;t.interestingTagsExclude=i;for(var r={},n=0;t.areaTags.length>n;n++)r[t.areaTags[n]]=!0;t.areaTags=r,this.externalProjection=new OpenLayers.Projection("EPSG:4326"),OpenLayers.Format.XML.prototype.initialize.apply(this,[t])},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));for(var t=this.getNodes(e),i=this.getWays(e),n=Array(i.length),r=0;i.length>r;r++){for(var o=Array(i[r].nodes.length),s=this.isWayArea(i[r])?1:0,a=0;i[r].nodes.length>a;a++){var l=t[i[r].nodes[a]],h=new OpenLayers.Geometry.Point(l.lon,l.lat);h.osm_id=parseInt(i[r].nodes[a]),o[a]=h,l.used=!0}var c=null;c=s?new OpenLayers.Geometry.Polygon(new OpenLayers.Geometry.LinearRing(o)):new OpenLayers.Geometry.LineString(o),this.internalProjection&&this.externalProjection&&c.transform(this.externalProjection,this.internalProjection);var u=new OpenLayers.Feature.Vector(c,i[r].tags);u.osm_id=parseInt(i[r].id),u.fid="way."+u.osm_id,n[r]=u}for(var d in t){var l=t[d];if(!l.used||this.checkTags){var p=null;if(this.checkTags){var f=this.getTags(l.node,!0);if(l.used&&!f[1])continue;p=f[0]}else p=this.getTags(l.node);var u=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(l.lon,l.lat),p);this.internalProjection&&this.externalProjection&&u.geometry.transform(this.externalProjection,this.internalProjection),u.osm_id=parseInt(d),u.fid="node."+u.osm_id,n.push(u)}l.node=null}return n},getNodes:function(e){for(var t=e.getElementsByTagName("node"),i={},n=0;t.length>n;n++){var r=t[n],o=r.getAttribute("id");i[o]={lat:r.getAttribute("lat"),lon:r.getAttribute("lon"),node:r}}return i},getWays:function(e){for(var t=e.getElementsByTagName("way"),i=[],n=0;t.length>n;n++){var r=t[n],o={id:r.getAttribute("id")};o.tags=this.getTags(r);var s=r.getElementsByTagName("nd");o.nodes=Array(s.length);for(var a=0;s.length>a;a++)o.nodes[a]=s[a].getAttribute("ref");i.push(o)}return i},getTags:function(e,t){for(var i=e.getElementsByTagName("tag"),n={},r=!1,o=0;i.length>o;o++){var s=i[o].getAttribute("k");n[s]=i[o].getAttribute("v"),t&&(this.interestingTagsExclude[s]||(r=!0))}return t?[n,r]:n},isWayArea:function(e){var t=!1,i=!1;if(e.nodes[0]==e.nodes[e.nodes.length-1]&&(t=!0),this.checkTags)for(var n in e.tags)if(this.areaTags[n]){i=!0;break}return t&&(this.checkTags?i:!0)},write:function(e){OpenLayers.Util.isArray(e)||(e=[e]),this.osm_id=1,this.created_nodes={};var t=this.createElementNS(null,"osm");t.setAttribute("version","0.5"),t.setAttribute("generator","OpenLayers "+OpenLayers.VERSION_NUMBER);for(var i=e.length-1;i>=0;i--)for(var n=this.createFeatureNodes(e[i]),r=0;n.length>r;r++)t.appendChild(n[r]);return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFeatureNodes:function(e){var t=[],i=e.geometry.CLASS_NAME,n=i.substring(i.lastIndexOf(".")+1);n=n.toLowerCase();var r=this.createXML[n];return r&&(t=r.apply(this,[e])),t},createXML:{point:function(e){var t=null,i=e.geometry?e.geometry:e;this.internalProjection&&this.externalProjection&&(i=i.clone(),i.transform(this.internalProjection,this.externalProjection));var n=!1;if(e.osm_id?(t=e.osm_id,this.created_nodes[t]&&(n=!0)):(t=-this.osm_id,this.osm_id++),n)r=this.created_nodes[t];else var r=this.createElementNS(null,"node");return this.created_nodes[t]=r,r.setAttribute("id",t),r.setAttribute("lon",i.x),r.setAttribute("lat",i.y),e.attributes&&this.serializeTags(e,r),this.setState(e,r),n?[]:[r]},linestring:function(e){var t,i=[],n=e.geometry;e.osm_id?t=e.osm_id:(t=-this.osm_id,this.osm_id++);var r=this.createElementNS(null,"way");r.setAttribute("id",t);for(var o=0;n.components.length>o;o++){var s=this.createXML.point.apply(this,[n.components[o]]);if(s.length){s=s[0];var a=s.getAttribute("id");i.push(s)}else a=n.components[o].osm_id,s=this.created_nodes[a];this.setState(e,s);var l=this.createElementNS(null,"nd");l.setAttribute("ref",a),r.appendChild(l)}return this.serializeTags(e,r),i.push(r),i},polygon:function(e){var t=OpenLayers.Util.extend({area:"yes"},e.attributes),i=new OpenLayers.Feature.Vector(e.geometry.components[0],t);return i.osm_id=e.osm_id,this.createXML.linestring.apply(this,[i])}},serializeTags:function(e,t){for(var i in e.attributes){var n=this.createElementNS(null,"tag");n.setAttribute("k",i),n.setAttribute("v",e.attributes[i]),t.appendChild(n)}},setState:function(e,t){if(e.state){var i=null;switch(e.state){case OpenLayers.State.UPDATE:i="modify";case OpenLayers.State.DELETE:i="delete"}i&&t.setAttribute("action",i)}},CLASS_NAME:"OpenLayers.Format.OSM"});