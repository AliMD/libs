OpenLayers.Format.CQL=function(){function e(e,t){return t instanceof RegExp?t.exec(e):t(e)}function t(t,i){var n,r,s=i.length;for(n=0;s>n;n++){r=i[n];var a=o[r],l=e(t,a);if(l){var h=l[0],c=t.substr(h.length).replace(/^\s*/,"");return{type:r,text:h,remainder:c}}}var u="ERROR: In parsing: ["+t+"], expected one of: ";for(n=0;s>n;n++)r=i[n],u+="\n    "+r+": "+o[r];throw Error(u)}function i(e){var i,n=[],r=["NOT","GEOMETRY","SPATIAL","PROPERTY","LPAREN"];do{if(i=t(e,r),e=i.remainder,r=s[i.type],"END"!=i.type&&!r)throw Error("No follows list for "+i.type);n.push(i)}while("END"!=i.type);return n}function n(e){function t(){var e=n.pop();switch(e.type){case"LOGICAL":var i=t(),r=t();return new OpenLayers.Filter.Logical({filters:[r,i],type:h[e.text.toUpperCase()]});case"NOT":var o=t();return new OpenLayers.Filter.Logical({filters:[o],type:OpenLayers.Filter.Logical.NOT});case"BETWEEN":var s,l,c;return n.pop(),l=t(),s=t(),c=t(),new OpenLayers.Filter.Comparison({property:c,lowerBoundary:s,upperBoundary:l,type:OpenLayers.Filter.Comparison.BETWEEN});case"COMPARISON":var u=t(),c=t();return new OpenLayers.Filter.Comparison({property:c,value:u,type:a[e.text.toUpperCase()]});case"VALUE":return/^'.*'$/.test(e.text)?e.text.substr(1,e.text.length-2):Number(e.text);case"SPATIAL":switch(e.text.toUpperCase()){case"BBOX":var d=t(),p=t(),f=t(),m=t(),g=t();return new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,property:g,value:OpenLayers.Bounds.fromArray([m,f,p,d])});case"INTERSECTS":var u=t(),c=t();return new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:c,value:u});case"WITHIN":var u=t(),c=t();return new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.WITHIN,property:c,value:u});case"CONTAINS":var u=t(),c=t();return new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.CONTAINS,property:c,value:u});case"DWITHIN":var y=t(),u=t(),c=t();return new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN,value:u,property:c,distance:Number(y)})}case"GEOMETRY":return OpenLayers.Geometry.fromWKT(e.text);default:return e.text}}for(var i=[],n=[];e.length;){var r=e.shift();switch(r.type){case"PROPERTY":case"GEOMETRY":case"VALUE":n.push(r);break;case"COMPARISON":case"BETWEEN":case"LOGICAL":for(var o=u[r.type];i.length>0&&o>=u[i[i.length-1].type];)n.push(i.pop());i.push(r);break;case"SPATIAL":case"NOT":case"LPAREN":i.push(r);break;case"RPAREN":for(;i.length>0&&"LPAREN"!=i[i.length-1].type;)n.push(i.pop());i.pop(),i.length>0&&"SPATIAL"==i[i.length-1].type&&n.push(i.pop());case"COMMA":case"END":break;default:throw Error("Unknown token type "+r.type)}}for(;i.length>0;)n.push(i.pop());var s=t();if(n.length>0){for(var l="Remaining tokens after building AST: \n",c=n.length-1;c>=0;c--)l+=n[c].type+": "+n[c].text+"\n";throw Error(l)}return s}var r,o={PROPERTY:/^[_a-zA-Z]\w*/,COMPARISON:/^(=|<>|<=|<|>=|>|LIKE)/i,COMMA:/^,/,LOGICAL:/^(AND|OR)/i,VALUE:/^('\w+'|\d+(\.\d*)?|\.\d+)/,LPAREN:/^\(/,RPAREN:/^\)/,SPATIAL:/^(BBOX|INTERSECTS|DWITHIN|WITHIN|CONTAINS)/i,NOT:/^NOT/i,BETWEEN:/^BETWEEN/i,GEOMETRY:function(e){var t=/^(POINT|LINESTRING|POLYGON|MULTIPOINT|MULTILINESTRING|MULTIPOLYGON|GEOMETRYCOLLECTION)/.exec(e);if(t){var i=e.length,n=e.indexOf("(",t[0].length);if(n>-1)for(var r=1;i>n&&r>0;)switch(n++,e.charAt(n)){case"(":r++;break;case")":r--;break;default:}return[e.substr(0,n+1)]}},END:/^$/},s={LPAREN:["GEOMETRY","SPATIAL","PROPERTY","VALUE","LPAREN"],RPAREN:["NOT","LOGICAL","END","RPAREN"],PROPERTY:["COMPARISON","BETWEEN","COMMA"],BETWEEN:["VALUE"],COMPARISON:["VALUE"],COMMA:["GEOMETRY","VALUE","PROPERTY"],VALUE:["LOGICAL","COMMA","RPAREN","END"],SPATIAL:["LPAREN"],LOGICAL:["NOT","VALUE","SPATIAL","PROPERTY","LPAREN"],NOT:["PROPERTY","LPAREN"],GEOMETRY:["COMMA","RPAREN"]},a={"=":OpenLayers.Filter.Comparison.EQUAL_TO,"<>":OpenLayers.Filter.Comparison.NOT_EQUAL_TO,"<":OpenLayers.Filter.Comparison.LESS_THAN,"<=":OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO,">":OpenLayers.Filter.Comparison.GREATER_THAN,">=":OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,LIKE:OpenLayers.Filter.Comparison.LIKE,BETWEEN:OpenLayers.Filter.Comparison.BETWEEN},l={},h={AND:OpenLayers.Filter.Logical.AND,OR:OpenLayers.Filter.Logical.OR},c={},u={RPAREN:3,LOGICAL:2,COMPARISON:1};for(r in a)a.hasOwnProperty(r)&&(l[a[r]]=r);for(r in h)h.hasOwnProperty(r)&&(c[h[r]]=r);return OpenLayers.Class(OpenLayers.Format,{read:function(e){var t=n(i(e));return this.keepData&&(this.data=t),t},write:function(e){if(e instanceof OpenLayers.Geometry)return""+e;switch(e.CLASS_NAME){case"OpenLayers.Filter.Spatial":switch(e.type){case OpenLayers.Filter.Spatial.BBOX:return"BBOX("+e.property+","+e.value.toBBOX()+")";case OpenLayers.Filter.Spatial.DWITHIN:return"DWITHIN("+e.property+", "+this.write(e.value)+", "+e.distance+")";case OpenLayers.Filter.Spatial.WITHIN:return"WITHIN("+e.property+", "+this.write(e.value)+")";case OpenLayers.Filter.Spatial.INTERSECTS:return"INTERSECTS("+e.property+", "+this.write(e.value)+")";case OpenLayers.Filter.Spatial.CONTAINS:return"CONTAINS("+e.property+", "+this.write(e.value)+")";default:throw Error("Unknown spatial filter type: "+e.type)}case"OpenLayers.Filter.Logical":if(e.type==OpenLayers.Filter.Logical.NOT)return"NOT ("+this.write(e.filters[0])+")";for(var t="(",i=!0,n=0;e.filters.length>n;n++)i?i=!1:t+=") "+c[e.type]+" (",t+=this.write(e.filters[n]);return t+")";case"OpenLayers.Filter.Comparison":return e.type==OpenLayers.Filter.Comparison.BETWEEN?e.property+" BETWEEN "+this.write(e.lowerBoundary)+" AND "+this.write(e.upperBoundary):e.property+" "+l[e.type]+" "+this.write(e.value);case void 0:if("string"==typeof e)return"'"+e+"'";if("number"==typeof e)return e+"";default:throw Error("Can't encode: "+e.CLASS_NAME+" "+e)}},CLASS_NAME:"OpenLayers.Format.CQL"})}();