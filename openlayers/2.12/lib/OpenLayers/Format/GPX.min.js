OpenLayers.Format.GPX=OpenLayers.Class(OpenLayers.Format.XML,{defaultDesc:"No description available",extractWaypoints:!0,extractTracks:!0,extractRoutes:!0,extractAttributes:!0,namespaces:{gpx:"http://www.topografix.com/GPX/1/1",xsi:"http://www.w3.org/2001/XMLSchema-instance"},schemaLocation:"http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",creator:"OpenLayers",initialize:function(e){this.externalProjection=new OpenLayers.Projection("EPSG:4326"),OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var t=[];if(this.extractTracks)for(var i=e.getElementsByTagName("trk"),n=0,r=i.length;r>n;n++){var o={};this.extractAttributes&&(o=this.parseAttributes(i[n]));for(var s=this.getElementsByTagNameNS(i[n],i[n].namespaceURI,"trkseg"),a=0,l=s.length;l>a;a++){var h=this.extractSegment(s[a],"trkpt");t.push(new OpenLayers.Feature.Vector(h,o))}}if(this.extractRoutes)for(var c=e.getElementsByTagName("rte"),u=0,d=c.length;d>u;u++){var o={};this.extractAttributes&&(o=this.parseAttributes(c[u]));var p=this.extractSegment(c[u],"rtept");t.push(new OpenLayers.Feature.Vector(p,o))}if(this.extractWaypoints)for(var f=e.getElementsByTagName("wpt"),m=0,r=f.length;r>m;m++){var o={};this.extractAttributes&&(o=this.parseAttributes(f[m]));var g=new OpenLayers.Geometry.Point(f[m].getAttribute("lon"),f[m].getAttribute("lat"));t.push(new OpenLayers.Feature.Vector(g,o))}if(this.internalProjection&&this.externalProjection)for(var y=0,v=t.length;v>y;y++)t[y].geometry.transform(this.externalProjection,this.internalProjection);return t},extractSegment:function(e,t){for(var i=this.getElementsByTagNameNS(e,e.namespaceURI,t),n=[],r=0,o=i.length;o>r;r++)n.push(new OpenLayers.Geometry.Point(i[r].getAttribute("lon"),i[r].getAttribute("lat")));return new OpenLayers.Geometry.LineString(n)},parseAttributes:function(e){for(var t,i,n={},r=e.firstChild;r;)1==r.nodeType&&r.firstChild&&(t=r.firstChild,(3==t.nodeType||4==t.nodeType)&&(i=r.prefix?r.nodeName.split(":")[1]:r.nodeName,"trkseg"!=i&&"rtept"!=i&&(n[i]=t.nodeValue))),r=r.nextSibling;return n},write:function(e,t){e=OpenLayers.Util.isArray(e)?e:[e];var i=this.createElementNS(this.namespaces.gpx,"gpx");i.setAttribute("version","1.1"),i.setAttribute("creator",this.creator),this.setAttributes(i,{"xsi:schemaLocation":this.schemaLocation}),t&&"object"==typeof t&&i.appendChild(this.buildMetadataNode(t));for(var n=0,r=e.length;r>n;n++)i.appendChild(this.buildFeatureNode(e[n]));return OpenLayers.Format.XML.prototype.write.apply(this,[i])},buildMetadataNode:function(e){for(var t=["name","desc","author"],i=this.createElementNSPlus("gpx:metadata"),n=0;t.length>n;n++){var r=t[n];if(e[r]){var o=this.createElementNSPlus("gpx:"+r);o.appendChild(this.createTextNode(e[r])),i.appendChild(o)}}return i},buildFeatureNode:function(e){var t=e.geometry;if(t=t.clone(),this.internalProjection&&this.externalProjection&&t.transform(this.internalProjection,this.externalProjection),"OpenLayers.Geometry.Point"==t.CLASS_NAME){var i=this.buildWptNode(t);return this.appendAttributesNode(i,e),i}var n=this.createElementNSPlus("gpx:trk");this.appendAttributesNode(n,e);var r=this.buildTrkSegNode(t);r=OpenLayers.Util.isArray(r)?r:[r];for(var o=0,s=r.length;s>o;o++)n.appendChild(r[o]);return n},buildTrkSegNode:function(e){var t,i,n,r,o;if("OpenLayers.Geometry.LineString"==e.CLASS_NAME||"OpenLayers.Geometry.LinearRing"==e.CLASS_NAME){for(t=this.createElementNSPlus("gpx:trkseg"),i=0,n=e.components.length;n>i;i++)r=e.components[i],t.appendChild(this.buildTrkPtNode(r));return t}for(o=[],i=0,n=e.components.length;n>i;i++)o.push(this.buildTrkSegNode(e.components[i]));return o},buildTrkPtNode:function(e){var t=this.createElementNSPlus("gpx:trkpt");return t.setAttribute("lon",e.x),t.setAttribute("lat",e.y),t},buildWptNode:function(e){var t=this.createElementNSPlus("gpx:wpt");return t.setAttribute("lon",e.x),t.setAttribute("lat",e.y),t},appendAttributesNode:function(e,t){var i=this.createElementNSPlus("gpx:name");i.appendChild(this.createTextNode(t.attributes.name||t.id)),e.appendChild(i);var n=this.createElementNSPlus("gpx:desc");n.appendChild(this.createTextNode(t.attributes.description||this.defaultDesc)),e.appendChild(n)},CLASS_NAME:"OpenLayers.Format.GPX"});