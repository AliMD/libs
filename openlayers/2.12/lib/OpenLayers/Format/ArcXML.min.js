OpenLayers.Format.ArcXML=OpenLayers.Class(OpenLayers.Format.XML,{fontStyleKeys:["antialiasing","blockout","font","fontcolor","fontsize","fontstyle","glowing","interval","outline","printmode","shadow","transparency"],request:null,response:null,initialize:function(e){if(this.request=new OpenLayers.Format.ArcXML.Request,this.response=new OpenLayers.Format.ArcXML.Response,e)if("feature"==e.requesttype){this.request.get_image=null;var t=this.request.get_feature.query;this.addCoordSys(t.featurecoordsys,e.featureCoordSys),this.addCoordSys(t.filtercoordsys,e.filterCoordSys),e.polygon?(t.isspatial=!0,t.spatialfilter.polygon=e.polygon):e.envelope&&(t.isspatial=!0,t.spatialfilter.envelope={minx:0,miny:0,maxx:0,maxy:0},this.parseEnvelope(t.spatialfilter.envelope,e.envelope))}else if("image"==e.requesttype){this.request.get_feature=null;var i=this.request.get_image.properties;this.parseEnvelope(i.envelope,e.envelope),this.addLayers(i.layerlist,e.layers),this.addImageSize(i.imagesize,e.tileSize),this.addCoordSys(i.featurecoordsys,e.featureCoordSys),this.addCoordSys(i.filtercoordsys,e.filterCoordSys)}else this.request=null;OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},parseEnvelope:function(e,t){t&&4==t.length&&(e.minx=t[0],e.miny=t[1],e.maxx=t[2],e.maxy=t[3])},addLayers:function(e,t){for(var i=0,n=t.length;n>i;i++)e.push(t[i])},addImageSize:function(e,t){null!==t&&(e.width=t.w,e.height=t.h,e.printwidth=t.w,e.printheight=t.h)},addCoordSys:function(e,t){"string"==typeof t?(e.id=parseInt(t),e.string=t):"object"==typeof t&&null!==t.proj?(e.id=t.proj.srsProjNumber,e.string=t.proj.srsCode):e=t},iserror:function(e){var t=null;if(e){e=OpenLayers.Format.XML.prototype.read.apply(this,[e]);var i=e.documentElement.getElementsByTagName("ERROR");t=null!==i&&i.length>0}else t=""!==this.response.error;return t},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var t=null;if(e&&e.documentElement&&(t="ARCXML"==e.documentElement.nodeName?e.documentElement:e.documentElement.getElementsByTagName("ARCXML")[0]),!t||"parsererror"===t.firstChild.nodeName){var i,n;try{i=e.firstChild.nodeValue,n=e.firstChild.childNodes[1].firstChild.nodeValue}catch(r){}throw{message:"Error parsing the ArcXML request",error:i,source:n}}var o=this.parseResponse(t);return o},write:function(e){e||(e=this.request);var t=this.createElementNS("","ARCXML");t.setAttribute("version","1.1");var i=this.createElementNS("","REQUEST");if(null!=e.get_image){var n=this.createElementNS("","GET_IMAGE");i.appendChild(n);var r=this.createElementNS("","PROPERTIES");n.appendChild(r);var o=e.get_image.properties;if(null!=o.featurecoordsys){var s=this.createElementNS("","FEATURECOORDSYS");r.appendChild(s),0===o.featurecoordsys.id?s.setAttribute("string",o.featurecoordsys.string):s.setAttribute("id",o.featurecoordsys.id)}if(null!=o.filtercoordsys){var a=this.createElementNS("","FILTERCOORDSYS");r.appendChild(a),0===o.filtercoordsys.id?a.setAttribute("string",o.filtercoordsys.string):a.setAttribute("id",o.filtercoordsys.id)}if(null!=o.envelope){var l=this.createElementNS("","ENVELOPE");r.appendChild(l),l.setAttribute("minx",o.envelope.minx),l.setAttribute("miny",o.envelope.miny),l.setAttribute("maxx",o.envelope.maxx),l.setAttribute("maxy",o.envelope.maxy)}var h=this.createElementNS("","IMAGESIZE");if(r.appendChild(h),h.setAttribute("height",o.imagesize.height),h.setAttribute("width",o.imagesize.width),(o.imagesize.height!=o.imagesize.printheight||o.imagesize.width!=o.imagesize.printwidth)&&(h.setAttribute("printheight",o.imagesize.printheight),h.setArrtibute("printwidth",o.imagesize.printwidth)),null!=o.background){var c=this.createElementNS("","BACKGROUND");r.appendChild(c),c.setAttribute("color",o.background.color.r+","+o.background.color.g+","+o.background.color.b),null!==o.background.transcolor&&c.setAttribute("transcolor",o.background.transcolor.r+","+o.background.transcolor.g+","+o.background.transcolor.b)}if(null!=o.layerlist&&o.layerlist.length>0){var u=this.createElementNS("","LAYERLIST");r.appendChild(u);for(var d=0;o.layerlist.length>d;d++){var p=this.createElementNS("","LAYERDEF");if(u.appendChild(p),p.setAttribute("id",o.layerlist[d].id),p.setAttribute("visible",o.layerlist[d].visible),"object"==typeof o.layerlist[d].query){var f=o.layerlist[d].query;if(0>f.where.length)continue;var m=null;m="boolean"==typeof f.spatialfilter&&f.spatialfilter?this.createElementNS("","SPATIALQUERY"):this.createElementNS("","QUERY"),m.setAttribute("where",f.where),"number"==typeof f.accuracy&&f.accuracy>0&&m.setAttribute("accuracy",f.accuracy),"number"==typeof f.featurelimit&&2e3>f.featurelimit&&m.setAttribute("featurelimit",f.featurelimit),"string"==typeof f.subfields&&"#ALL#"!=f.subfields&&m.setAttribute("subfields",f.subfields),"string"==typeof f.joinexpression&&f.joinexpression.length>0&&m.setAttribute("joinexpression",f.joinexpression),"string"==typeof f.jointables&&f.jointables.length>0&&m.setAttribute("jointables",f.jointables),p.appendChild(m)}"object"==typeof o.layerlist[d].renderer&&this.addRenderer(p,o.layerlist[d].renderer)}}}else if(null!=e.get_feature){var n=this.createElementNS("","GET_FEATURES");if(n.setAttribute("outputmode","newxml"),n.setAttribute("checkesc","true"),e.get_feature.geometry?n.setAttribute("geometry",e.get_feature.geometry):n.setAttribute("geometry","false"),e.get_feature.compact&&n.setAttribute("compact",e.get_feature.compact),"number"==e.get_feature.featurelimit&&n.setAttribute("featurelimit",e.get_feature.featurelimit),n.setAttribute("globalenvelope","true"),i.appendChild(n),null!=e.get_feature.layer&&e.get_feature.layer.length>0){var g=this.createElementNS("","LAYER");g.setAttribute("id",e.get_feature.layer),n.appendChild(g)}var y=e.get_feature.query;if(null!=y){var v=null;if(v=y.isspatial?this.createElementNS("","SPATIALQUERY"):this.createElementNS("","QUERY"),n.appendChild(v),"number"==typeof y.accuracy&&v.setAttribute("accuracy",y.accuracy),null!=y.featurecoordsys){var b=this.createElementNS("","FEATURECOORDSYS");0==y.featurecoordsys.id?b.setAttribute("string",y.featurecoordsys.string):b.setAttribute("id",y.featurecoordsys.id),v.appendChild(b)}if(null!=y.filtercoordsys){var L=this.createElementNS("","FILTERCOORDSYS");0===y.filtercoordsys.id?L.setAttribute("string",y.filtercoordsys.string):L.setAttribute("id",y.filtercoordsys.id),v.appendChild(L)}if(y.buffer>0){var x=this.createElementNS("","BUFFER");x.setAttribute("distance",y.buffer),v.appendChild(x)}if(y.isspatial){var C=this.createElementNS("","SPATIALFILTER");if(C.setAttribute("relation",y.spatialfilter.relation),v.appendChild(C),y.spatialfilter.envelope){var w=this.createElementNS("","ENVELOPE");w.setAttribute("minx",y.spatialfilter.envelope.minx),w.setAttribute("miny",y.spatialfilter.envelope.miny),w.setAttribute("maxx",y.spatialfilter.envelope.maxx),w.setAttribute("maxy",y.spatialfilter.envelope.maxy),C.appendChild(w)}else"object"==typeof y.spatialfilter.polygon&&C.appendChild(this.writePolygonGeometry(y.spatialfilter.polygon))}null!=y.where&&y.where.length>0&&v.setAttribute("where",y.where)}}return t.appendChild(i),OpenLayers.Format.XML.prototype.write.apply(this,[t])},addGroupRenderer:function(e,t){var i=this.createElementNS("","GROUPRENDERER");e.appendChild(i);for(var n=0;t.length>n;n++){var r=t[n];this.addRenderer(i,r)}},addRenderer:function(e,t){if(OpenLayers.Util.isArray(t))this.addGroupRenderer(e,t);else{var i=this.createElementNS("",t.type.toUpperCase()+"RENDERER");e.appendChild(i),"VALUEMAPRENDERER"==i.tagName?this.addValueMapRenderer(i,t):"VALUEMAPLABELRENDERER"==i.tagName?this.addValueMapLabelRenderer(i,t):"SIMPLELABELRENDERER"==i.tagName?this.addSimpleLabelRenderer(i,t):"SCALEDEPENDENTRENDERER"==i.tagName&&this.addScaleDependentRenderer(i,t)}},addScaleDependentRenderer:function(e,t){("string"==typeof t.lower||"number"==typeof t.lower)&&e.setAttribute("lower",t.lower),("string"==typeof t.upper||"number"==typeof t.upper)&&e.setAttribute("upper",t.upper),this.addRenderer(e,t.renderer)},addValueMapLabelRenderer:function(e,t){if(e.setAttribute("lookupfield",t.lookupfield),e.setAttribute("labelfield",t.labelfield),"object"==typeof t.exacts)for(var i=0,n=t.exacts.length;n>i;i++){var r=t.exacts[i],o=this.createElementNS("","EXACT");if("string"==typeof r.value&&o.setAttribute("value",r.value),"string"==typeof r.label&&o.setAttribute("label",r.label),"string"==typeof r.method&&o.setAttribute("method",r.method),e.appendChild(o),"object"==typeof r.symbol){var s=null;if("text"==r.symbol.type&&(s=this.createElementNS("","TEXTSYMBOL")),null!=s){for(var a=this.fontStyleKeys,l=0,h=a.length;h>l;l++){var c=a[l];r.symbol[c]&&s.setAttribute(c,r.symbol[c])}o.appendChild(s)}}}},addValueMapRenderer:function(e,t){if(e.setAttribute("lookupfield",t.lookupfield),"object"==typeof t.ranges)for(var i=0,n=t.ranges.length;n>i;i++){var r=t.ranges[i],o=this.createElementNS("","RANGE");if(o.setAttribute("lower",r.lower),o.setAttribute("upper",r.upper),e.appendChild(o),"object"==typeof r.symbol){var s=null;"simplepolygon"==r.symbol.type&&(s=this.createElementNS("","SIMPLEPOLYGONSYMBOL")),null!=s&&("string"==typeof r.symbol.boundarycolor&&s.setAttribute("boundarycolor",r.symbol.boundarycolor),"string"==typeof r.symbol.fillcolor&&s.setAttribute("fillcolor",r.symbol.fillcolor),"number"==typeof r.symbol.filltransparency&&s.setAttribute("filltransparency",r.symbol.filltransparency),o.appendChild(s))}}else if("object"==typeof t.exacts)for(var a=0,l=t.exacts.length;l>a;a++){var h=t.exacts[a],c=this.createElementNS("","EXACT");if("string"==typeof h.value&&c.setAttribute("value",h.value),"string"==typeof h.label&&c.setAttribute("label",h.label),"string"==typeof h.method&&c.setAttribute("method",h.method),e.appendChild(c),"object"==typeof h.symbol){var s=null;"simplemarker"==h.symbol.type&&(s=this.createElementNS("","SIMPLEMARKERSYMBOL")),null!=s&&("string"==typeof h.symbol.antialiasing&&s.setAttribute("antialiasing",h.symbol.antialiasing),"string"==typeof h.symbol.color&&s.setAttribute("color",h.symbol.color),"string"==typeof h.symbol.outline&&s.setAttribute("outline",h.symbol.outline),"string"==typeof h.symbol.overlap&&s.setAttribute("overlap",h.symbol.overlap),"string"==typeof h.symbol.shadow&&s.setAttribute("shadow",h.symbol.shadow),"number"==typeof h.symbol.transparency&&s.setAttribute("transparency",h.symbol.transparency),"string"==typeof h.symbol.usecentroid&&s.setAttribute("usecentroid",h.symbol.usecentroid),"number"==typeof h.symbol.width&&s.setAttribute("width",h.symbol.width),c.appendChild(s))}}},addSimpleLabelRenderer:function(e,t){e.setAttribute("field",t.field);for(var i=["featureweight","howmanylabels","labelbufferratio","labelpriorities","labelweight","linelabelposition","rotationalangles"],n=0,r=i.length;r>n;n++){var o=i[n];t[o]&&e.setAttribute(o,t[o])}if("text"==t.symbol.type){var s=t.symbol,a=this.createElementNS("","TEXTSYMBOL");e.appendChild(a);for(var i=this.fontStyleKeys,n=0,r=i.length;r>n;n++){var o=i[n];s[o]&&a.setAttribute(o,t[o])}}},writePolygonGeometry:function(e){if(!(e instanceof OpenLayers.Geometry.Polygon))throw{message:"Cannot write polygon geometry to ArcXML with an "+e.CLASS_NAME+" object.",geometry:e};for(var t=this.createElementNS("","POLYGON"),i=0,n=e.components.length;n>i;i++){for(var r=e.components[i],o=this.createElementNS("","RING"),s=0,a=r.components.length;a>s;s++){var l=r.components[s],h=this.createElementNS("","POINT");h.setAttribute("x",l.x),h.setAttribute("y",l.y),o.appendChild(h)}t.appendChild(o)}return t},parseResponse:function(e){if("string"==typeof e){var t=new OpenLayers.Format.XML;e=t.read(e)}var i=new OpenLayers.Format.ArcXML.Response,n=e.getElementsByTagName("ERROR");if(null!=n&&n.length>0)i.error=this.getChildValue(n,"Unknown error.");else{var r=e.getElementsByTagName("RESPONSE");if(null==r||0==r.length)return i.error="No RESPONSE tag found in ArcXML response.",i;var o=r[0].firstChild.nodeName;if("#text"==o&&(o=r[0].firstChild.nextSibling.nodeName),"IMAGE"==o){var s=e.getElementsByTagName("ENVELOPE"),a=e.getElementsByTagName("OUTPUT");if(null==s||0==s.length)i.error="No ENVELOPE tag found in ArcXML response.";else if(null==a||0==a.length)i.error="No OUTPUT tag found in ArcXML response.";else{var l=this.parseAttributes(s[0]),h=this.parseAttributes(a[0]);i.image="string"==typeof h.type?{envelope:l,output:{type:h.type,data:this.getChildValue(a[0])}}:{envelope:l,output:h}}}else if("FEATURES"==o){var c=r[0].getElementsByTagName("FEATURES"),u=c[0].getElementsByTagName("FEATURECOUNT");if(i.features.featurecount=u[0].getAttribute("count"),i.features.featurecount>0){var d=c[0].getElementsByTagName("ENVELOPE");i.features.envelope=this.parseAttributes(d[0],"number");for(var p=c[0].getElementsByTagName("FEATURE"),f=0;p.length>f;f++){for(var m=new OpenLayers.Feature.Vector,g=p[f].getElementsByTagName("FIELD"),y=0;g.length>y;y++){var v=g[y].getAttribute("name"),b=g[y].getAttribute("value");m.attributes[v]=b}var L=p[f].getElementsByTagName("POLYGON");if(L.length>0){for(var x=L[0].getElementsByTagName("RING"),C=[],w=0;x.length>w;w++){var S=[];S.push(this.parsePointGeometry(x[w]));for(var O=x[w].getElementsByTagName("HOLE"),_=0;O.length>_;_++)S.push(this.parsePointGeometry(O[_]));O=null,C.push(new OpenLayers.Geometry.Polygon(S)),S=null}x=null,m.geometry=1==C.length?C[0]:new OpenLayers.Geometry.MultiPolygon(C)}i.features.feature.push(m)}}}else i.error="Unidentified response type."}return i},parseAttributes:function(e,t){for(var i={},n=0;e.attributes.length>n;n++)i[e.attributes[n].nodeName]="number"==t?parseFloat(e.attributes[n].nodeValue):e.attributes[n].nodeValue;return i},parsePointGeometry:function(e){var t=[],i=e.getElementsByTagName("COORDS");if(i.length>0){var n=this.getChildValue(i[0]);n=n.split(/;/);for(var r=0;n.length>r;r++){var o=n[r].split(/ /);t.push(new OpenLayers.Geometry.Point(o[0],o[1]))}i=null}else{var s=e.getElementsByTagName("POINT");if(s.length>0)for(var a=0;s.length>a;a++)t.push(new OpenLayers.Geometry.Point(parseFloat(s[a].getAttribute("x")),parseFloat(s[a].getAttribute("y"))));s=null}return new OpenLayers.Geometry.LinearRing(t)},CLASS_NAME:"OpenLayers.Format.ArcXML"}),OpenLayers.Format.ArcXML.Request=OpenLayers.Class({initialize:function(){var e={get_image:{properties:{background:null,draw:!0,envelope:{minx:0,miny:0,maxx:0,maxy:0},featurecoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},filtercoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},imagesize:{height:0,width:0,dpi:96,printheight:0,printwidth:0,scalesymbols:!1},layerlist:[],output:{baseurl:"",legendbaseurl:"",legendname:"",legendpath:"",legendurl:"",name:"",path:"",type:"jpg",url:""}}},get_feature:{layer:"",query:{isspatial:!1,featurecoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},filtercoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},buffer:0,where:"",spatialfilter:{relation:"envelope_intersection",envelope:null}}},environment:{separators:{cs:" ",ts:";"}},layer:[],workspaces:[]};return OpenLayers.Util.extend(this,e)},CLASS_NAME:"OpenLayers.Format.ArcXML.Request"}),OpenLayers.Format.ArcXML.Response=OpenLayers.Class({initialize:function(){var e={image:{envelope:null,output:""},features:{featurecount:0,envelope:null,feature:[]},error:""};return OpenLayers.Util.extend(this,e)},CLASS_NAME:"OpenLayers.Format.ArcXML.Response"});