OpenLayers.Format.GML=OpenLayers.Class(OpenLayers.Format.XML,{featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",extractAttributes:!0,xy:!0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));for(var t=this.getElementsByTagNameNS(e.documentElement,this.gmlns,this.featureName),i=[],n=0;t.length>n;n++){var r=this.parseFeature(t[n]);r&&i.push(r)}return i},parseFeature:function(e){for(var t,i,n,r,o=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],s=0;o.length>s;++s)if(t=o[s],i=this.getElementsByTagNameNS(e,this.gmlns,t),i.length>0){if(r=this.parseGeometry[t.toLowerCase()],!r)throw new TypeError("Unsupported geometry type: "+t);n=r.apply(this,[i[0]]),this.internalProjection&&this.externalProjection&&n.transform(this.externalProjection,this.internalProjection);break}var a,l=this.getElementsByTagNameNS(e,this.gmlns,"Box");for(s=0;l.length>s;++s){var h=l[s],c=this.parseGeometry.box.apply(this,[h]),u=h.parentNode,d=u.localName||u.nodeName.split(":").pop();"boundedBy"===d?a=c:n=c.toGeometry()}var p;this.extractAttributes&&(p=this.parseAttributes(e));var f=new OpenLayers.Feature.Vector(n,p);f.bounds=a,f.gml={featureType:e.firstChild.nodeName.split(":")[1],featureNS:e.firstChild.namespaceURI,featureNSPrefix:e.firstChild.prefix};for(var m,g=e.firstChild;g&&(1!=g.nodeType||!(m=g.getAttribute("fid")||g.getAttribute("id")));)g=g.nextSibling;return f.fid=m,f},parseGeometry:{point:function(e){var t,i,n=[],t=this.getElementsByTagNameNS(e,this.gmlns,"pos");if(t.length>0&&(i=t[0].firstChild.nodeValue,i=i.replace(this.regExes.trimSpace,""),n=i.split(this.regExes.splitSpace)),0==n.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),t.length>0&&(i=t[0].firstChild.nodeValue,i=i.replace(this.regExes.removeSpace,""),n=i.split(","))),0==n.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coord"),t.length>0)){var r=this.getElementsByTagNameNS(t[0],this.gmlns,"X"),o=this.getElementsByTagNameNS(t[0],this.gmlns,"Y");r.length>0&&o.length>0&&(n=[r[0].firstChild.nodeValue,o[0].firstChild.nodeValue])}return 2==n.length&&(n[2]=null),this.xy?new OpenLayers.Geometry.Point(n[0],n[1],n[2]):new OpenLayers.Geometry.Point(n[1],n[0],n[2])},multipoint:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Point"),i=[];if(t.length>0)for(var n,r=0;t.length>r;++r)n=this.parseGeometry.point.apply(this,[t[r]]),n&&i.push(n);return new OpenLayers.Geometry.MultiPoint(i)},linestring:function(e,t){var i,n,r=[],o=[];if(i=this.getElementsByTagNameNS(e,this.gmlns,"posList"),i.length>0){n=this.getChildValue(i[0]),n=n.replace(this.regExes.trimSpace,""),r=n.split(this.regExes.splitSpace);for(var s,a,l,h,c=parseInt(i[0].getAttribute("dimension")),u=0;r.length/c>u;++u)s=u*c,a=r[s],l=r[s+1],h=2==c?null:r[s+2],this.xy?o.push(new OpenLayers.Geometry.Point(a,l,h)):o.push(new OpenLayers.Geometry.Point(l,a,h))}if(0==r.length&&(i=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),i.length>0)){n=this.getChildValue(i[0]),n=n.replace(this.regExes.trimSpace,""),n=n.replace(this.regExes.trimComma,",");for(var d=n.split(this.regExes.splitSpace),u=0;d.length>u;++u)r=d[u].split(","),2==r.length&&(r[2]=null),this.xy?o.push(new OpenLayers.Geometry.Point(r[0],r[1],r[2])):o.push(new OpenLayers.Geometry.Point(r[1],r[0],r[2]))}var p=null;return 0!=o.length&&(p=t?new OpenLayers.Geometry.LinearRing(o):new OpenLayers.Geometry.LineString(o)),p},multilinestring:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LineString"),i=[];if(t.length>0)for(var n,r=0;t.length>r;++r)n=this.parseGeometry.linestring.apply(this,[t[r]]),n&&i.push(n);return new OpenLayers.Geometry.MultiLineString(i)},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LinearRing"),i=[];if(t.length>0)for(var n,r=0;t.length>r;++r)n=this.parseGeometry.linestring.apply(this,[t[r],!0]),n&&i.push(n);return new OpenLayers.Geometry.Polygon(i)},multipolygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Polygon"),i=[];if(t.length>0)for(var n,r=0;t.length>r;++r)n=this.parseGeometry.polygon.apply(this,[t[r]]),n&&i.push(n);return new OpenLayers.Geometry.MultiPolygon(i)},envelope:function(e){var t,i,n=[],r=this.getElementsByTagNameNS(e,this.gmlns,"lowerCorner");if(r.length>0){var o=[];if(r.length>0&&(t=r[0].firstChild.nodeValue,t=t.replace(this.regExes.trimSpace,""),o=t.split(this.regExes.splitSpace)),2==o.length&&(o[2]=null),this.xy)var s=new OpenLayers.Geometry.Point(o[0],o[1],o[2]);else var s=new OpenLayers.Geometry.Point(o[1],o[0],o[2])}var a=this.getElementsByTagNameNS(e,this.gmlns,"upperCorner");if(a.length>0){var o=[];if(a.length>0&&(t=a[0].firstChild.nodeValue,t=t.replace(this.regExes.trimSpace,""),o=t.split(this.regExes.splitSpace)),2==o.length&&(o[2]=null),this.xy)var l=new OpenLayers.Geometry.Point(o[0],o[1],o[2]);else var l=new OpenLayers.Geometry.Point(o[1],o[0],o[2])}if(s&&l){n.push(new OpenLayers.Geometry.Point(s.x,s.y)),n.push(new OpenLayers.Geometry.Point(l.x,s.y)),n.push(new OpenLayers.Geometry.Point(l.x,l.y)),n.push(new OpenLayers.Geometry.Point(s.x,l.y)),n.push(new OpenLayers.Geometry.Point(s.x,s.y));var h=new OpenLayers.Geometry.LinearRing(n);i=new OpenLayers.Geometry.Polygon([h])}return i},box:function(e){var t,i,n=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),r=null,o=null;return n.length>0&&(t=n[0].firstChild.nodeValue,i=t.split(" "),2==i.length&&(r=i[0].split(","),o=i[1].split(","))),null!==r&&null!==o?new OpenLayers.Bounds(parseFloat(r[0]),parseFloat(r[1]),parseFloat(o[0]),parseFloat(o[1])):void 0}},parseAttributes:function(e){for(var t,i,n,r,o,s,a,l={},h=e.firstChild;h;){if(1==h.nodeType){for(t=h.childNodes,i=0;t.length>i;++i)n=t[i],1==n.nodeType&&(r=n.childNodes,1==r.length?(o=r[0],(3==o.nodeType||4==o.nodeType)&&(s=n.prefix?n.nodeName.split(":")[1]:n.nodeName,a=o.nodeValue.replace(this.regExes.trimSpace,""),l[s]=a)):l[n.nodeName.split(":").pop()]=null);break}h=h.nextSibling}return l},write:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=this.createElementNS("http://www.opengis.net/wfs","wfs:"+this.collectionName),i=0;e.length>i;i++)t.appendChild(this.createFeatureXML(e[i]));return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFeatureXML:function(e){var t=e.geometry,i=this.buildGeometryNode(t),n=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.geometryName);n.appendChild(i);var r=this.createElementNS(this.gmlns,"gml:"+this.featureName),o=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.layerName),s=e.fid||e.id;o.setAttribute("fid",s),o.appendChild(n);for(var a in e.attributes){var l=this.createTextNode(e.attributes[a]),h=a.substring(a.lastIndexOf(":")+1),c=this.createElementNS(this.featureNS,this.featurePrefix+":"+h);c.appendChild(l),o.appendChild(c)}return r.appendChild(o),r},buildGeometryNode:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection));var t=e.CLASS_NAME,i=t.substring(t.lastIndexOf(".")+1),n=this.buildGeometry[i.toLowerCase()];return n.apply(this,[e])},buildGeometry:{point:function(e){var t=this.createElementNS(this.gmlns,"gml:Point");return t.appendChild(this.buildCoordinatesNode(e)),t},multipoint:function(e){for(var t,i,n=this.createElementNS(this.gmlns,"gml:MultiPoint"),r=e.components,o=0;r.length>o;o++)t=this.createElementNS(this.gmlns,"gml:pointMember"),i=this.buildGeometry.point.apply(this,[r[o]]),t.appendChild(i),n.appendChild(t);return n},linestring:function(e){var t=this.createElementNS(this.gmlns,"gml:LineString");return t.appendChild(this.buildCoordinatesNode(e)),t},multilinestring:function(e){for(var t,i,n=this.createElementNS(this.gmlns,"gml:MultiLineString"),r=e.components,o=0;r.length>o;++o)t=this.createElementNS(this.gmlns,"gml:lineStringMember"),i=this.buildGeometry.linestring.apply(this,[r[o]]),t.appendChild(i),n.appendChild(t);return n},linearring:function(e){var t=this.createElementNS(this.gmlns,"gml:LinearRing");return t.appendChild(this.buildCoordinatesNode(e)),t},polygon:function(e){for(var t,i,n,r=this.createElementNS(this.gmlns,"gml:Polygon"),o=e.components,s=0;o.length>s;++s)n=0==s?"outerBoundaryIs":"innerBoundaryIs",t=this.createElementNS(this.gmlns,"gml:"+n),i=this.buildGeometry.linearring.apply(this,[o[s]]),t.appendChild(i),r.appendChild(t);return r},multipolygon:function(e){for(var t,i,n=this.createElementNS(this.gmlns,"gml:MultiPolygon"),r=e.components,o=0;r.length>o;++o)t=this.createElementNS(this.gmlns,"gml:polygonMember"),i=this.buildGeometry.polygon.apply(this,[r[o]]),t.appendChild(i),n.appendChild(t);return n},bounds:function(e){var t=this.createElementNS(this.gmlns,"gml:Box");return t.appendChild(this.buildCoordinatesNode(e)),t}},buildCoordinatesNode:function(e){var t=this.createElementNS(this.gmlns,"gml:coordinates");t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," ");var i=[];if(e instanceof OpenLayers.Bounds)i.push(e.left+","+e.bottom),i.push(e.right+","+e.top);else for(var n=e.components?e.components:[e],r=0;n.length>r;r++)i.push(n[r].x+","+n[r].y);var o=this.createTextNode(i.join(" "));return t.appendChild(o),t},CLASS_NAME:"OpenLayers.Format.GML"});