OpenLayers.Format.Atom=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{atom:"http://www.w3.org/2005/Atom",georss:"http://www.georss.org/georss"},feedTitle:"untitled",defaultEntryTitle:"untitled",gmlParser:null,xy:!1,read:function(e){return"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e])),this.parseFeatures(e)},write:function(e){var t;if(OpenLayers.Util.isArray(e)){t=this.createElementNSPlus("atom:feed"),t.appendChild(this.createElementNSPlus("atom:title",{value:this.feedTitle}));for(var i=0,n=e.length;n>i;i++)t.appendChild(this.buildEntryNode(e[i]))}else t=this.buildEntryNode(e);return OpenLayers.Format.XML.prototype.write.apply(this,[t])},buildContentNode:function(e){var t=this.createElementNSPlus("atom:content",{attributes:{type:e.type||null}});if(e.src)t.setAttribute("src",e.src);else if("text"==e.type||null==e.type)t.appendChild(this.createTextNode(e.value));else if("html"==e.type){if("string"!=typeof e.value)throw"HTML content must be in form of an escaped string";t.appendChild(this.createTextNode(e.value))}else"xhtml"==e.type?t.appendChild(e.value):"xhtml"==e.type||e.type.match(/(\+|\/)xml$/)?t.appendChild(e.value):t.appendChild(this.createTextNode(e.value));return t},buildEntryNode:function(e){var t=e.attributes,i=t.atom||{},n=this.createElementNSPlus("atom:entry");if(i.authors)for(var r=OpenLayers.Util.isArray(i.authors)?i.authors:[i.authors],o=0,s=r.length;s>o;o++)n.appendChild(this.buildPersonConstructNode("author",r[o]));if(i.categories)for(var a,l=OpenLayers.Util.isArray(i.categories)?i.categories:[i.categories],o=0,s=l.length;s>o;o++)a=l[o],n.appendChild(this.createElementNSPlus("atom:category",{attributes:{term:a.term,scheme:a.scheme||null,label:a.label||null}}));if(i.content&&n.appendChild(this.buildContentNode(i.content)),i.contributors)for(var h=OpenLayers.Util.isArray(i.contributors)?i.contributors:[i.contributors],o=0,s=h.length;s>o;o++)n.appendChild(this.buildPersonConstructNode("contributor",h[o]));if(e.fid&&n.appendChild(this.createElementNSPlus("atom:id",{value:e.fid})),i.links)for(var c,u=OpenLayers.Util.isArray(i.links)?i.links:[i.links],o=0,s=u.length;s>o;o++)c=u[o],n.appendChild(this.createElementNSPlus("atom:link",{attributes:{href:c.href,rel:c.rel||null,type:c.type||null,hreflang:c.hreflang||null,title:c.title||null,length:c.length||null}}));if(i.published&&n.appendChild(this.createElementNSPlus("atom:published",{value:i.published})),i.rights&&n.appendChild(this.createElementNSPlus("atom:rights",{value:i.rights})),(i.summary||t.description)&&n.appendChild(this.createElementNSPlus("atom:summary",{value:i.summary||t.description})),n.appendChild(this.createElementNSPlus("atom:title",{value:i.title||t.title||this.defaultEntryTitle})),i.updated&&n.appendChild(this.createElementNSPlus("atom:updated",{value:i.updated})),e.geometry){var d=this.createElementNSPlus("georss:where");d.appendChild(this.buildGeometryNode(e.geometry)),n.appendChild(d)}return n},initGmlParser:function(){this.gmlParser=new OpenLayers.Format.GML.v3({xy:this.xy,featureNS:"http://example.com#feature",internalProjection:this.internalProjection,externalProjection:this.externalProjection})},buildGeometryNode:function(e){this.gmlParser||this.initGmlParser();var t=this.gmlParser.writeNode("feature:_geometry",e);return t.firstChild},buildPersonConstructNode:function(e,t){var i=["uri","email"],n=this.createElementNSPlus("atom:"+e);n.appendChild(this.createElementNSPlus("atom:name",{value:t.name}));for(var r=0,o=i.length;o>r;r++)t[i[r]]&&n.appendChild(this.createElementNSPlus("atom:"+i[r],{value:t[i[r]]}));return n},getFirstChildValue:function(e,t,i,n){var r,o=this.getElementsByTagNameNS(e,t,i);return r=o&&o.length>0?this.getChildValue(o[0],n):n},parseFeature:function(e){var t={},i=null,n=null,r=null,o=this.namespaces.atom;this.parsePersonConstructs(e,"author",t),n=this.getElementsByTagNameNS(e,o,"category"),n.length>0&&(t.categories=[]);for(var s=0,a=n.length;a>s;s++)i={},i.term=n[s].getAttribute("term"),r=n[s].getAttribute("scheme"),r&&(i.scheme=r),r=n[s].getAttribute("label"),r&&(i.label=r),t.categories.push(i);n=this.getElementsByTagNameNS(e,o,"content"),n.length>0&&(i={},r=n[0].getAttribute("type"),r&&(i.type=r),r=n[0].getAttribute("src"),r?i.src=r:(i.value="text"==i.type||"html"==i.type||null==i.type?this.getFirstChildValue(e,o,"content",null):"xhtml"==i.type||i.type.match(/(\+|\/)xml$/)?this.getChildEl(n[0]):this.getFirstChildValue(e,o,"content",null),t.content=i)),this.parsePersonConstructs(e,"contributor",t),t.id=this.getFirstChildValue(e,o,"id",null),n=this.getElementsByTagNameNS(e,o,"link"),n.length>0&&(t.links=Array(n.length));for(var l=["rel","type","hreflang","title","length"],s=0,a=n.length;a>s;s++){i={},i.href=n[s].getAttribute("href");for(var h=0,c=l.length;c>h;h++)r=n[s].getAttribute(l[h]),r&&(i[l[h]]=r);t.links[s]=i}i=this.getFirstChildValue(e,o,"published",null),i&&(t.published=i),i=this.getFirstChildValue(e,o,"rights",null),i&&(t.rights=i),i=this.getFirstChildValue(e,o,"summary",null),i&&(t.summary=i),t.title=this.getFirstChildValue(e,o,"title",null),t.updated=this.getFirstChildValue(e,o,"updated",null);var u={title:t.title,description:t.summary,atom:t},d=this.parseLocations(e)[0],p=new OpenLayers.Feature.Vector(d,u);return p.fid=t.id,p},parseFeatures:function(e){var t=[],i=this.getElementsByTagNameNS(e,this.namespaces.atom,"entry");0==i.length&&(i=[e]);for(var n=0,r=i.length;r>n;n++)t.push(this.parseFeature(i[n]));return t},parseLocations:function(e){var t=this.namespaces.georss,i={components:[]},n=this.getElementsByTagNameNS(e,t,"where");if(n&&n.length>0){this.gmlParser||this.initGmlParser();for(var r=0,o=n.length;o>r;r++)this.gmlParser.readChildNodes(n[r],i)}var s=i.components,a=this.getElementsByTagNameNS(e,t,"point");if(a&&a.length>0)for(var r=0,o=a.length;o>r;r++){var l=OpenLayers.String.trim(a[r].firstChild.nodeValue).split(/\s+/);2!=l.length&&(l=OpenLayers.String.trim(a[r].firstChild.nodeValue).split(/\s*,\s*/)),s.push(new OpenLayers.Geometry.Point(l[1],l[0]))}var h=this.getElementsByTagNameNS(e,t,"line");if(h&&h.length>0)for(var c,u,d,r=0,o=h.length;o>r;r++){c=OpenLayers.String.trim(h[r].firstChild.nodeValue).split(/\s+/),d=[];for(var p=0,f=c.length;f>p;p+=2)u=new OpenLayers.Geometry.Point(c[p+1],c[p]),d.push(u);s.push(new OpenLayers.Geometry.LineString(d))}var m=this.getElementsByTagNameNS(e,t,"polygon");if(m&&m.length>0)for(var c,u,d,r=0,o=m.length;o>r;r++){c=OpenLayers.String.trim(m[r].firstChild.nodeValue).split(/\s+/),d=[];for(var p=0,f=c.length;f>p;p+=2)u=new OpenLayers.Geometry.Point(c[p+1],c[p]),d.push(u);s.push(new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(s)]))}if(this.internalProjection&&this.externalProjection)for(var r=0,o=s.length;o>r;r++)s[r]&&s[r].transform(this.externalProjection,this.internalProjection);return s},parsePersonConstructs:function(e,t,i){for(var n=[],r=this.namespaces.atom,o=this.getElementsByTagNameNS(e,r,t),s=["uri","email"],a=0,l=o.length;l>a;a++){var h={};h.name=this.getFirstChildValue(o[a],r,"name",null);for(var c=0,u=s.length;u>c;c++){var d=this.getFirstChildValue(o[a],r,s[c],null);d&&(h[s[c]]=d)}n.push(h)}n.length>0&&(i[t+"s"]=n)},CLASS_NAME:"OpenLayers.Format.Atom"});