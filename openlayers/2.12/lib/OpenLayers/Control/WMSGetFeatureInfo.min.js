OpenLayers.Control.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:!1,drillDown:!1,maxFeatures:10,clickCallback:"click",output:"features",layers:null,queryVisible:!1,url:null,layerUrls:null,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handlerOptions:null,handler:null,hoverRequest:null,initialize:function(e){if(e=e||{},e.handlerOptions=e.handlerOptions||{},OpenLayers.Control.prototype.initialize.apply(this,[e]),this.format||(this.format=new OpenLayers.Format.WMSGetFeatureInfo(e.formatOptions)),this.drillDown===!0&&(this.hover=!1),this.hover)this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250}));else{var t={};t[this.clickCallback]=this.getInfoForClick,this.handler=new OpenLayers.Handler.Click(this,t,this.handlerOptions.click||{})}},getInfoForClick:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy}),OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait"),this.request(e.xy,{})},getInfoForHover:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy}),this.request(e.xy,{hover:!0})},cancelHover:function(){this.hoverRequest&&(this.hoverRequest.abort(),this.hoverRequest=null)},findLayers:function(){for(var e,t,i=this.layers||this.map.layers,n=[],r=i.length-1;r>=0;--r)e=i[r],e instanceof OpenLayers.Layer.WMS&&(!this.queryVisible||e.getVisibility())&&(t=OpenLayers.Util.isArray(e.url)?e.url[0]:e.url,this.drillDown!==!1||this.url||(this.url=t),(this.drillDown===!0||this.urlMatches(t))&&n.push(e));return n},urlMatches:function(e){var t=OpenLayers.Util.isEquivalentUrl(this.url,e);if(!t&&this.layerUrls)for(var i=0,n=this.layerUrls.length;n>i;++i)if(OpenLayers.Util.isEquivalentUrl(this.layerUrls[i],e)){t=!0;break}return t},buildWMSOptions:function(e,t,i,n){for(var r=[],o=[],s=0,a=t.length;a>s;s++)null!=t[s].params.LAYERS&&(r=r.concat(t[s].params.LAYERS),o=o.concat(this.getStyleNames(t[s])));var l=t[0],h=this.map.getProjection(),c=l.projection;c&&c.equals(this.map.getProjectionObject())&&(h=c.getCode());var u=OpenLayers.Util.extend({service:"WMS",version:l.params.VERSION,request:"GetFeatureInfo",exceptions:l.params.EXCEPTIONS,bbox:this.map.getExtent().toBBOX(null,l.reverseAxisOrder()),feature_count:this.maxFeatures,height:this.map.getSize().h,width:this.map.getSize().w,format:n,info_format:l.params.INFO_FORMAT||this.infoFormat},parseFloat(l.params.VERSION)>=1.3?{crs:h,i:parseInt(i.x),j:parseInt(i.y)}:{srs:h,x:parseInt(i.x),y:parseInt(i.y)});return 0!=r.length&&(u=OpenLayers.Util.extend({layers:r,query_layers:r,styles:o},u)),OpenLayers.Util.applyDefaults(u,this.vendorParams),{url:e,params:OpenLayers.Util.upperCaseObject(u),callback:function(t){this.handleResponse(i,t,e)},scope:this}},getStyleNames:function(e){var t;return t=e.params.STYLES?e.params.STYLES:OpenLayers.Util.isArray(e.params.LAYERS)?Array(e.params.LAYERS.length):e.params.LAYERS.replace(/[^,]/g,"")},request:function(e,t){var i=this.findLayers();if(0==i.length)return this.events.triggerEvent("nogetfeatureinfo"),OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"),void 0;if(t=t||{},this.drillDown===!1){var n=this.buildWMSOptions(this.url,i,e,i[0].params.FORMAT),r=OpenLayers.Request.GET(n);t.hover===!0&&(this.hoverRequest=r)}else{this._requestCount=0,this._numRequests=0,this.features=[];for(var o,s={},a=0,l=i.length;l>a;a++){var h=i[a];o=OpenLayers.Util.isArray(h.url)?h.url[0]:h.url,o in s?s[o].push(h):(this._numRequests++,s[o]=[h])}var i;for(var o in s){i=s[o];var n=this.buildWMSOptions(o,i,e,i[0].params.FORMAT);OpenLayers.Request.GET(n)}}},triggerGetFeatureInfo:function(e,t,i){this.events.triggerEvent("getfeatureinfo",{text:e.responseText,features:i,request:e,xy:t}),OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")},handleResponse:function(e,t,i){var n=t.responseXML;n&&n.documentElement||(n=t.responseText);var r=this.format.read(n);this.drillDown===!1?this.triggerGetFeatureInfo(t,e,r):(this._requestCount++,this._features="object"===this.output?(this._features||[]).concat({url:i,features:r}):(this._features||[]).concat(r),this._requestCount===this._numRequests&&(this.triggerGetFeatureInfo(t,e,this._features.concat()),delete this._features,delete this._requestCount,delete this._numRequests))},CLASS_NAME:"OpenLayers.Control.WMSGetFeatureInfo"});