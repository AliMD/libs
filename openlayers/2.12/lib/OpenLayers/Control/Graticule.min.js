OpenLayers.Control.Graticule=OpenLayers.Class(OpenLayers.Control,{autoActivate:!0,intervals:[45,30,20,10,5,2,1,.5,.2,.1,.05,.01,.005,.002,.001],displayInLayerSwitcher:!0,visible:!0,numPoints:50,targetSize:200,layerName:null,labelled:!0,labelFormat:"dm",lineSymbolizer:{strokeColor:"#333",strokeWidth:1,strokeOpacity:.5},labelSymbolizer:{},gratLayer:null,initialize:function(e){e=e||{},e.layerName=e.layerName||OpenLayers.i18n("Graticule"),OpenLayers.Control.prototype.initialize.apply(this,[e]),this.labelSymbolizer.stroke=!1,this.labelSymbolizer.fill=!1,this.labelSymbolizer.label="${label}",this.labelSymbolizer.labelAlign="${labelAlign}",this.labelSymbolizer.labelXOffset="${xOffset}",this.labelSymbolizer.labelYOffset="${yOffset}"},destroy:function(){this.deactivate(),OpenLayers.Control.prototype.destroy.apply(this,arguments),this.gratLayer&&(this.gratLayer.destroy(),this.gratLayer=null)},draw:function(){if(OpenLayers.Control.prototype.draw.apply(this,arguments),!this.gratLayer){var e=new OpenLayers.Style({},{rules:[new OpenLayers.Rule({symbolizer:{Point:this.labelSymbolizer,Line:this.lineSymbolizer}})]});this.gratLayer=new OpenLayers.Layer.Vector(this.layerName,{styleMap:new OpenLayers.StyleMap({"default":e}),visibility:this.visible,displayInLayerSwitcher:this.displayInLayerSwitcher})}return this.div},activate:function(){return OpenLayers.Control.prototype.activate.apply(this,arguments)?(this.map.addLayer(this.gratLayer),this.map.events.register("moveend",this,this.update),this.update(),!0):!1},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this,arguments)?(this.map.events.unregister("moveend",this,this.update),this.map.removeLayer(this.gratLayer),!0):!1},update:function(){var e=this.map.getExtent();if(e){this.gratLayer.destroyFeatures();var t=new OpenLayers.Projection("EPSG:4326"),i=this.map.getProjectionObject(),n=this.map.getResolution();i.proj&&"longlat"==i.proj.projName&&(this.numPoints=1);var r=this.map.getCenter(),o=new OpenLayers.Pixel(r.lon,r.lat);OpenLayers.Projection.transform(o,i,t);var s=this.targetSize*n;s*=s;for(var a,l=0;this.intervals.length>l;++l){a=this.intervals[l];var h=a/2,c=o.offset({x:-h,y:-h}),u=o.offset({x:h,y:h});OpenLayers.Projection.transform(c,t,i),OpenLayers.Projection.transform(u,t,i);var d=(c.x-u.x)*(c.x-u.x)+(c.y-u.y)*(c.y-u.y);if(s>=d)break}o.x=Math.floor(o.x/a)*a,o.y=Math.floor(o.y/a)*a;var p,f=0,m=[o.clone()],g=o.clone();do g=g.offset({x:0,y:a}),p=OpenLayers.Projection.transform(g.clone(),t,i),m.unshift(g);while(e.containsPixel(p)&&1e3>++f);g=o.clone();do g=g.offset({x:0,y:-a}),p=OpenLayers.Projection.transform(g.clone(),t,i),m.push(g);while(e.containsPixel(p)&&1e3>++f);f=0;var y=[o.clone()];g=o.clone();do g=g.offset({x:-a,y:0}),p=OpenLayers.Projection.transform(g.clone(),t,i),y.unshift(g);while(e.containsPixel(p)&&1e3>++f);g=o.clone();do g=g.offset({x:a,y:0}),p=OpenLayers.Projection.transform(g.clone(),t,i),y.push(g);while(e.containsPixel(p)&&1e3>++f);for(var v=[],l=0;y.length>l;++l){for(var b=y[l].x,L=[],x=null,C=Math.min(m[0].y,90),w=Math.max(m[m.length-1].y,-90),S=(C-w)/this.numPoints,O=w,_=0;this.numPoints>=_;++_){var E=new OpenLayers.Geometry.Point(b,O);E.transform(t,i),L.push(E),O+=S,E.y>=e.bottom&&!x&&(x=E)}if(this.labelled){var T=new OpenLayers.Geometry.Point(x.x,e.bottom),k={value:b,label:this.labelled?OpenLayers.Util.getFormattedLonLat(b,"lon",this.labelFormat):"",labelAlign:"cb",xOffset:0,yOffset:2};this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(T,k))}var P=new OpenLayers.Geometry.LineString(L);v.push(new OpenLayers.Feature.Vector(P))}for(var _=0;m.length>_;++_)if(O=m[_].y,!(-90>O||O>90)){for(var L=[],A=y[0].x,M=y[y.length-1].x,N=(M-A)/this.numPoints,b=A,x=null,l=0;this.numPoints>=l;++l){var E=new OpenLayers.Geometry.Point(b,O);E.transform(t,i),L.push(E),b+=N,E.x<e.right&&(x=E)}if(this.labelled){var T=new OpenLayers.Geometry.Point(e.right,x.y),k={value:O,label:this.labelled?OpenLayers.Util.getFormattedLonLat(O,"lat",this.labelFormat):"",labelAlign:"rb",xOffset:-2,yOffset:2};this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(T,k))}var P=new OpenLayers.Geometry.LineString(L);v.push(new OpenLayers.Feature.Vector(P))}this.gratLayer.addFeatures(v)}},CLASS_NAME:"OpenLayers.Control.Graticule"});