OpenLayers.Renderer.SVG=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",MAX_PIXEL:15e3,translationParameters:null,symbolMetrics:null,initialize:function(){this.supported()&&(OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments),this.translationParameters={x:0,y:0},this.symbolMetrics={})},supported:function(){var e="http://www.w3.org/TR/SVG11/feature#";return document.implementation&&(document.implementation.hasFeature("org.w3c.svg","1.0")||document.implementation.hasFeature(e+"SVG","1.1")||document.implementation.hasFeature(e+"BasicStructure","1.1"))},inValidRange:function(e,t,i){var n=e+(i?0:this.translationParameters.x),r=t+(i?0:this.translationParameters.y);return n>=-this.MAX_PIXEL&&this.MAX_PIXEL>=n&&r>=-this.MAX_PIXEL&&this.MAX_PIXEL>=r},setExtent:function(e,t){var i=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),n=this.getResolution(),r=-e.left/n,s=e.top/n;if(t){this.left=r,this.top=s;var o="0 0 "+this.size.w+" "+this.size.h;return this.rendererRoot.setAttributeNS(null,"viewBox",o),this.translate(this.xOffset,0),!0}var a=this.translate(r-this.left+this.xOffset,s-this.top);return a||this.setExtent(e,!0),i&&a},translate:function(e,t){if(this.inValidRange(e,t,!0)){var i="";return(e||t)&&(i="translate("+e+","+t+")"),this.root.setAttributeNS(null,"transform",i),this.translationParameters={x:e,y:t},!0}return!1},setSize:function(){OpenLayers.Renderer.prototype.setSize.apply(this,arguments),this.rendererRoot.setAttributeNS(null,"width",this.size.w),this.rendererRoot.setAttributeNS(null,"height",this.size.h)},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"image":this.isComplexSymbol(t.graphicName)?"svg":"circle";break;case"OpenLayers.Geometry.Rectangle":i="rect";break;case"OpenLayers.Geometry.LineString":i="polyline";break;case"OpenLayers.Geometry.LinearRing":i="polygon";break;case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":i="path";break;default:}return i},setStyle:function(e,t,i){t=t||e._style,i=i||e._options;var n,r=parseFloat(e.getAttributeNS(null,"r")),s=1;if("OpenLayers.Geometry.Point"==e._geometryClass&&r){if(e.style.visibility="",t.graphic===!1)e.style.visibility="hidden";else if(t.externalGraphic){if(n=this.getPosition(e),t.graphicTitle){e.setAttributeNS(null,"title",t.graphicTitle);var o=e.getElementsByTagName("title");if(o.length>0)o[0].firstChild.textContent=t.graphicTitle;else{var a=this.nodeFactory(null,"title");a.textContent=t.graphicTitle,e.appendChild(a)}}t.graphicWidth&&t.graphicHeight&&e.setAttributeNS(null,"preserveAspectRatio","none");var l=t.graphicWidth||t.graphicHeight,h=t.graphicHeight||t.graphicWidth;l=l?l:2*t.pointRadius,h=h?h:2*t.pointRadius;var c=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*l),u=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*h),d=t.graphicOpacity||t.fillOpacity;e.setAttributeNS(null,"x",(n.x+c).toFixed()),e.setAttributeNS(null,"y",(n.y+u).toFixed()),e.setAttributeNS(null,"width",l),e.setAttributeNS(null,"height",h),e.setAttributeNS(this.xlinkns,"href",t.externalGraphic),e.setAttributeNS(null,"style","opacity: "+d),e.onclick=OpenLayers.Renderer.SVG.preventDefault}else if(this.isComplexSymbol(t.graphicName)){var p=3*t.pointRadius,f=2*p,m=this.importSymbol(t.graphicName);n=this.getPosition(e),s=3*this.symbolMetrics[m.id][0]/f;var g=e.parentNode,y=e.nextSibling;g&&g.removeChild(e),e.firstChild&&e.removeChild(e.firstChild),e.appendChild(m.firstChild.cloneNode(!0)),e.setAttributeNS(null,"viewBox",m.getAttributeNS(null,"viewBox")),e.setAttributeNS(null,"width",f),e.setAttributeNS(null,"height",f),e.setAttributeNS(null,"x",n.x-p),e.setAttributeNS(null,"y",n.y-p),y?g.insertBefore(e,y):g&&g.appendChild(e)}else e.setAttributeNS(null,"r",t.pointRadius);var v=t.rotation;if((void 0!==v||void 0!==e._rotation)&&n)if(e._rotation=v,v|=0,"svg"!==e.nodeName)e.setAttributeNS(null,"transform","rotate("+v+" "+n.x+" "+n.y+")");else{var b=this.symbolMetrics[m.id];e.firstChild.setAttributeNS(null,"transform","rotate("+v+" "+b[1]+" "+b[2]+")")}}return i.isFilled?(e.setAttributeNS(null,"fill",t.fillColor),e.setAttributeNS(null,"fill-opacity",t.fillOpacity)):e.setAttributeNS(null,"fill","none"),i.isStroked?(e.setAttributeNS(null,"stroke",t.strokeColor),e.setAttributeNS(null,"stroke-opacity",t.strokeOpacity),e.setAttributeNS(null,"stroke-width",t.strokeWidth*s),e.setAttributeNS(null,"stroke-linecap",t.strokeLinecap||"round"),e.setAttributeNS(null,"stroke-linejoin","round"),t.strokeDashstyle&&e.setAttributeNS(null,"stroke-dasharray",this.dashStyle(t,s))):e.setAttributeNS(null,"stroke","none"),t.pointerEvents&&e.setAttributeNS(null,"pointer-events",t.pointerEvents),null!=t.cursor&&e.setAttributeNS(null,"cursor",t.cursor),e},dashStyle:function(e,t){var i=e.strokeWidth*t,n=e.strokeDashstyle;switch(n){case"solid":return"none";case"dot":return[1,4*i].join();case"dash":return[4*i,4*i].join();case"dashdot":return[4*i,4*i,1,4*i].join();case"longdash":return[8*i,4*i].join();case"longdashdot":return[8*i,4*i,1,4*i].join();default:return OpenLayers.String.trim(n).replace(/\s+/g,",")}},createNode:function(e,t){var i=document.createElementNS(this.xmlns,e);return t&&i.setAttributeNS(null,"id",t),i},nodeTypeCompare:function(e,t){return t==e.nodeName},createRenderRoot:function(){var e=this.nodeFactory(this.container.id+"_svgRoot","svg");return e.style.display="block",e},createRoot:function(e){return this.nodeFactory(this.container.id+e,"g")},createDefs:function(){var e=this.nodeFactory(this.container.id+"_defs","defs");return this.rendererRoot.appendChild(e),e},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){var n=this.getResolution(),r=(t.x-this.featureDx)/n+this.left,s=this.top-t.y/n;return this.inValidRange(r,s)?(e.setAttributeNS(null,"cx",r),e.setAttributeNS(null,"cy",s),e.setAttributeNS(null,"r",i),e):!1},drawLineString:function(e,t){var i=this.getComponentsString(t.components);return i.path?(e.setAttributeNS(null,"points",i.path),i.complete?e:null):!1},drawLinearRing:function(e,t){var i=this.getComponentsString(t.components);return i.path?(e.setAttributeNS(null,"points",i.path),i.complete?e:null):!1},drawPolygon:function(e,t){for(var i,n,r="",s=!0,o=!0,a=0,l=t.components.length;l>a;a++)r+=" M",i=this.getComponentsString(t.components[a].components," "),n=i.path,n?(r+=" "+n,o=i.complete&&o):s=!1;return r+=" z",s?(e.setAttributeNS(null,"d",r),e.setAttributeNS(null,"fill-rule","evenodd"),o?e:null):!1},drawRectangle:function(e,t){var i=this.getResolution(),n=(t.x-this.featureDx)/i+this.left,r=this.top-t.y/i;return this.inValidRange(n,r)?(e.setAttributeNS(null,"x",n),e.setAttributeNS(null,"y",r),e.setAttributeNS(null,"width",t.width/i),e.setAttributeNS(null,"height",t.height/i),e):!1},drawText:function(e,t,i){var n=!!t.labelOutlineWidth;if(n){var r=OpenLayers.Util.extend({},t);r.fontColor=r.labelOutlineColor,r.fontStrokeColor=r.labelOutlineColor,r.fontStrokeWidth=t.labelOutlineWidth,delete r.labelOutlineWidth,this.drawText(e,r,i)}var s=this.getResolution(),o=(i.x-this.featureDx)/s+this.left,a=i.y/s-this.top,l=n?this.LABEL_OUTLINE_SUFFIX:this.LABEL_ID_SUFFIX,h=this.nodeFactory(e+l,"text");h.setAttributeNS(null,"x",o),h.setAttributeNS(null,"y",-a),t.fontColor&&h.setAttributeNS(null,"fill",t.fontColor),t.fontStrokeColor&&h.setAttributeNS(null,"stroke",t.fontStrokeColor),t.fontStrokeWidth&&h.setAttributeNS(null,"stroke-width",t.fontStrokeWidth),t.fontOpacity&&h.setAttributeNS(null,"opacity",t.fontOpacity),t.fontFamily&&h.setAttributeNS(null,"font-family",t.fontFamily),t.fontSize&&h.setAttributeNS(null,"font-size",t.fontSize),t.fontWeight&&h.setAttributeNS(null,"font-weight",t.fontWeight),t.fontStyle&&h.setAttributeNS(null,"font-style",t.fontStyle),t.labelSelect===!0?(h.setAttributeNS(null,"pointer-events","visible"),h._featureId=e):h.setAttributeNS(null,"pointer-events","none");var c=t.labelAlign||OpenLayers.Renderer.defaultSymbolizer.labelAlign;h.setAttributeNS(null,"text-anchor",OpenLayers.Renderer.SVG.LABEL_ALIGN[c[0]]||"middle"),OpenLayers.IS_GECKO===!0&&h.setAttributeNS(null,"dominant-baseline",OpenLayers.Renderer.SVG.LABEL_ALIGN[c[1]]||"central");for(var u=t.label.split("\n"),d=u.length;h.childNodes.length>d;)h.removeChild(h.lastChild);for(var p=0;d>p;p++){var f=this.nodeFactory(e+l+"_tspan_"+p,"tspan");if(t.labelSelect===!0&&(f._featureId=e,f._geometry=i,f._geometryClass=i.CLASS_NAME),OpenLayers.IS_GECKO===!1&&f.setAttributeNS(null,"baseline-shift",OpenLayers.Renderer.SVG.LABEL_VSHIFT[c[1]]||"-35%"),f.setAttribute("x",o),0==p){var m=OpenLayers.Renderer.SVG.LABEL_VFACTOR[c[1]];null==m&&(m=-.5),f.setAttribute("dy",m*(d-1)+"em")}else f.setAttribute("dy","1em");f.textContent=""===u[p]?" ":u[p],f.parentNode||h.appendChild(f)}h.parentNode||this.textRoot.appendChild(h)},getComponentsString:function(e,t){for(var i,n,r=[],s=!0,o=e.length,a=[],l=0;o>l;l++)n=e[l],r.push(n),i=this.getShortString(n),i?a.push(i):(l>0&&this.getShortString(e[l-1])&&a.push(this.clipLine(e[l],e[l-1])),o-1>l&&this.getShortString(e[l+1])&&a.push(this.clipLine(e[l],e[l+1])),s=!1);return{path:a.join(t||","),complete:s}},clipLine:function(e,t){if(t.equals(e))return"";var i,n=this.getResolution(),r=this.MAX_PIXEL-this.translationParameters.x,s=this.MAX_PIXEL-this.translationParameters.y,o=(t.x-this.featureDx)/n+this.left,a=this.top-t.y/n,l=(e.x-this.featureDx)/n+this.left,h=this.top-e.y/n;return(-r>l||l>r)&&(i=(h-a)/(l-o),l=0>l?-r:r,h=a+(l-o)*i),(-s>h||h>s)&&(i=(l-o)/(h-a),h=0>h?-s:s,l=o+(h-a)*i),l+","+h},getShortString:function(e){var t=this.getResolution(),i=(e.x-this.featureDx)/t+this.left,n=this.top-e.y/t;return this.inValidRange(i,n)?i+","+n:!1},getPosition:function(e){return{x:parseFloat(e.getAttributeNS(null,"cx")),y:parseFloat(e.getAttributeNS(null,"cy"))}},importSymbol:function(e){this.defs||(this.defs=this.createDefs());var t=this.container.id+"-"+e,i=document.getElementById(t);if(null!=i)return i;var n=OpenLayers.Renderer.symbol[e];if(!n)throw Error(e+" is not a valid symbol name");var r=this.nodeFactory(t,"symbol"),s=this.nodeFactory(null,"polygon");r.appendChild(s);for(var o,a,l=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),h=[],c=0;n.length>c;c+=2)o=n[c],a=n[c+1],l.left=Math.min(l.left,o),l.bottom=Math.min(l.bottom,a),l.right=Math.max(l.right,o),l.top=Math.max(l.top,a),h.push(o,",",a);s.setAttributeNS(null,"points",h.join(" "));var u=l.getWidth(),d=l.getHeight(),p=[l.left-u,l.bottom-d,3*u,3*d];return r.setAttributeNS(null,"viewBox",p.join(" ")),this.symbolMetrics[t]=[Math.max(u,d),l.getCenterLonLat().lon,l.getCenterLonLat().lat],this.defs.appendChild(r),r},getFeatureIdFromEvent:function(e){var t=OpenLayers.Renderer.Elements.prototype.getFeatureIdFromEvent.apply(this,arguments);if(!t){var i=e.target;t=i.parentNode&&i!=this.rendererRoot?i.parentNode._featureId:void 0}return t},CLASS_NAME:"OpenLayers.Renderer.SVG"}),OpenLayers.Renderer.SVG.LABEL_ALIGN={l:"start",r:"end",b:"bottom",t:"hanging"},OpenLayers.Renderer.SVG.LABEL_VSHIFT={t:"-70%",b:"0"},OpenLayers.Renderer.SVG.LABEL_VFACTOR={t:0,b:-1},OpenLayers.Renderer.SVG.preventDefault=function(e){e.preventDefault&&e.preventDefault()};