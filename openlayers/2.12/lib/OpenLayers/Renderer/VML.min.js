OpenLayers.Renderer.VML=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(){if(this.supported()){if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);for(var e=document.createStyleSheet(),t=["shape","rect","oval","fill","stroke","imagedata","group","textbox"],i=0,n=t.length;n>i;i++)e.addRule("olv\\:"+t[i],"behavior: url(#default#VML); position: absolute; display: inline-block;")}OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments)}},supported:function(){return!!document.namespaces},setExtent:function(e,t){var i=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),n=this.getResolution(),r=0|e.left/n,s=0|e.top/n-this.size.h;t||!this.offset?(this.offset={x:r,y:s},r=0,s=0):(r-=this.offset.x,s-=this.offset.y);var o=r-this.xOffset+" "+s;this.root.coordorigin=o;for(var a,l=[this.root,this.vectorRoot,this.textRoot],h=0,c=l.length;c>h;++h){a=l[h];var u=this.size.w+" "+this.size.h;a.coordsize=u}return this.root.style.flip="y",i},setSize:function(){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);for(var e,t=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot],i=this.size.w+"px",n=this.size.h+"px",r=0,s=t.length;s>r;++r)e=t[r],e.style.width=i,e.style.height=n},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"olv:rect":this.isComplexSymbol(t.graphicName)?"olv:shape":"olv:oval";break;case"OpenLayers.Geometry.Rectangle":i="olv:rect";break;case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.LinearRing":case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":i="olv:shape";break;default:}return i},setStyle:function(e,t,i,n){t=t||e._style,i=i||e._options;var r=t.fillColor;if("OpenLayers.Geometry.Point"===e._geometryClass)if(t.externalGraphic){i.isFilled=!0,t.graphicTitle&&(e.title=t.graphicTitle);var s=t.graphicWidth||t.graphicHeight,o=t.graphicHeight||t.graphicWidth;s=s?s:2*t.pointRadius,o=o?o:2*t.pointRadius;var a=this.getResolution(),l=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*s),h=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*o);e.style.left=(0|(n.x-this.featureDx)/a-this.offset.x+l)+"px",e.style.top=(0|n.y/a-this.offset.y-(h+o))+"px",e.style.width=s+"px",e.style.height=o+"px",e.style.flip="y",r="none",i.isStroked=!1}else if(this.isComplexSymbol(t.graphicName)){var c=this.importSymbol(t.graphicName);e.path=c.path,e.coordorigin=c.left+","+c.bottom;var u=c.size;e.coordsize=u+","+u,this.drawCircle(e,n,t.pointRadius),e.style.flip="y"}else this.drawCircle(e,n,t.pointRadius);i.isFilled?e.fillcolor=r:e.filled="false";var d=e.getElementsByTagName("fill"),p=0==d.length?null:d[0];i.isFilled?(p||(p=this.createNode("olv:fill",e.id+"_fill")),p.opacity=t.fillOpacity,"OpenLayers.Geometry.Point"===e._geometryClass&&t.externalGraphic&&(t.graphicOpacity&&(p.opacity=t.graphicOpacity),p.src=t.externalGraphic,p.type="frame",t.graphicWidth&&t.graphicHeight||(p.aspect="atmost")),p.parentNode!=e&&e.appendChild(p)):p&&e.removeChild(p);var f=t.rotation;(void 0!==f||void 0!==e._rotation)&&(e._rotation=f,t.externalGraphic?(this.graphicRotate(e,l,h,t),p.opacity=0):"OpenLayers.Geometry.Point"===e._geometryClass&&(e.style.rotation=f||0));var m=e.getElementsByTagName("stroke"),g=0==m.length?null:m[0];return i.isStroked?(g||(g=this.createNode("olv:stroke",e.id+"_stroke"),e.appendChild(g)),g.on=!0,g.color=t.strokeColor,g.weight=t.strokeWidth+"px",g.opacity=t.strokeOpacity,g.endcap="butt"==t.strokeLinecap?"flat":t.strokeLinecap||"round",t.strokeDashstyle&&(g.dashstyle=this.dashStyle(t))):(e.stroked=!1,g&&(g.on=!1)),"inherit"!=t.cursor&&null!=t.cursor&&(e.style.cursor=t.cursor),e},graphicRotate:function(e,t,i,n){var r,s,n=n||e._style,o=n.rotation||0;if(!n.graphicWidth||!n.graphicHeight){var a=new Image;return a.onreadystatechange=OpenLayers.Function.bind(function(){("complete"==a.readyState||"interactive"==a.readyState)&&(r=a.width/a.height,s=Math.max(2*n.pointRadius,n.graphicWidth||0,n.graphicHeight||0),t*=r,n.graphicWidth=s*r,n.graphicHeight=s,this.graphicRotate(e,t,i,n))},this),a.src=n.externalGraphic,void 0}s=Math.max(n.graphicWidth,n.graphicHeight),r=n.graphicWidth/n.graphicHeight;var l=Math.round(n.graphicWidth||s*r),h=Math.round(n.graphicHeight||s);e.style.width=l+"px",e.style.height=h+"px";var c=document.getElementById(e.id+"_image");c||(c=this.createNode("olv:imagedata",e.id+"_image"),e.appendChild(c)),c.style.width=l+"px",c.style.height=h+"px",c.src=n.externalGraphic,c.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='', sizingMethod='scale')";var u=o*Math.PI/180,d=Math.sin(u),p=Math.cos(u),f="progid:DXImageTransform.Microsoft.Matrix(M11="+p+",M12="+-d+",M21="+d+",M22="+p+",SizingMethod='auto expand')\n",m=n.graphicOpacity||n.fillOpacity;m&&1!=m&&(f+="progid:DXImageTransform.Microsoft.BasicImage(opacity="+m+")\n"),e.style.filter=f;var g=new OpenLayers.Geometry.Point(-t,-i),y=new OpenLayers.Bounds(0,0,l,h).toGeometry();y.rotate(n.rotation,g);var v=y.getBounds();e.style.left=Math.round(parseInt(e.style.left)+v.left)+"px",e.style.top=Math.round(parseInt(e.style.top)-v.bottom)+"px"},postDraw:function(e){e.style.visibility="visible";var t=e._style.fillColor,i=e._style.strokeColor;"none"==t&&e.fillcolor!=t&&(e.fillcolor=t),"none"==i&&e.strokecolor!=i&&(e.strokecolor=i)},setNodeDimension:function(e,t){var i=t.getBounds();if(i){var n=this.getResolution(),r=new OpenLayers.Bounds(0|(i.left-this.featureDx)/n-this.offset.x,0|i.bottom/n-this.offset.y,0|(i.right-this.featureDx)/n-this.offset.x,0|i.top/n-this.offset.y);e.style.left=r.left+"px",e.style.top=r.top+"px",e.style.width=r.getWidth()+"px",e.style.height=r.getHeight()+"px",e.coordorigin=r.left+" "+r.top,e.coordsize=r.getWidth()+" "+r.getHeight()}},dashStyle:function(e){var t=e.strokeDashstyle;switch(t){case"solid":case"dot":case"dash":case"dashdot":case"longdash":case"longdashdot":return t;default:var i=t.split(/[ ,]/);return 2==i.length?1*i[0]>=2*i[1]?"longdash":1==i[0]||1==i[1]?"dot":"dash":4==i.length?1*i[0]>=2*i[1]?"longdashdot":"dashdot":"solid"}},createNode:function(e,t){var i=document.createElement(e);return t&&(i.id=t),i.unselectable="on",i.onselectstart=OpenLayers.Function.False,i},nodeTypeCompare:function(e,t){var i=t,n=i.indexOf(":");-1!=n&&(i=i.substr(n+1));var r=e.nodeName;return n=r.indexOf(":"),-1!=n&&(r=r.substr(n+1)),i==r},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_vmlRoot","div")},createRoot:function(e){return this.nodeFactory(this.container.id+e,"olv:group")},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){if(!isNaN(t.x)&&!isNaN(t.y)){var n=this.getResolution();e.style.left=(0|(t.x-this.featureDx)/n-this.offset.x)-i+"px",e.style.top=(0|t.y/n-this.offset.y)-i+"px";var r=2*i;return e.style.width=r+"px",e.style.height=r+"px",e}return!1},drawLineString:function(e,t){return this.drawLine(e,t,!1)},drawLinearRing:function(e,t){return this.drawLine(e,t,!0)},drawLine:function(e,t,i){this.setNodeDimension(e,t);for(var n,r,s,o=this.getResolution(),a=t.components.length,l=Array(a),h=0;a>h;h++)n=t.components[h],r=0|(n.x-this.featureDx)/o-this.offset.x,s=0|n.y/o-this.offset.y,l[h]=" "+r+","+s+" l ";var c=i?" x e":" e";return e.path="m"+l.join("")+c,e},drawPolygon:function(e,t){this.setNodeDimension(e,t);var i,n,r,s,o,a,l,h,c,u,d,p,f=this.getResolution(),m=[];for(i=0,n=t.components.length;n>i;i++){for(m.push("m"),r=t.components[i].components,s=0===i,o=null,a=null,l=0,h=r.length;h>l;l++)c=r[l],d=0|(c.x-this.featureDx)/f-this.offset.x,p=0|c.y/f-this.offset.y,u=" "+d+","+p,m.push(u),0==l&&m.push(" l"),s||(o?o!=u&&(a?a!=u&&(s=!0):a=u):o=u);m.push(s?" x ":" ")}return m.push("e"),e.path=m.join(""),e},drawRectangle:function(e,t){var i=this.getResolution();return e.style.left=(0|(t.x-this.featureDx)/i-this.offset.x)+"px",e.style.top=(0|t.y/i-this.offset.y)+"px",e.style.width=(0|t.width/i)+"px",e.style.height=(0|t.height/i)+"px",e},drawText:function(e,t,i){var n=this.nodeFactory(e+this.LABEL_ID_SUFFIX,"olv:rect"),r=this.nodeFactory(e+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox"),s=this.getResolution();n.style.left=(0|(i.x-this.featureDx)/s-this.offset.x)+"px",n.style.top=(0|i.y/s-this.offset.y)+"px",n.style.flip="y",r.innerText=t.label,"inherit"!=t.cursor&&null!=t.cursor&&(r.style.cursor=t.cursor),t.fontColor&&(r.style.color=t.fontColor),t.fontOpacity&&(r.style.filter="alpha(opacity="+100*t.fontOpacity+")"),t.fontFamily&&(r.style.fontFamily=t.fontFamily),t.fontSize&&(r.style.fontSize=t.fontSize),t.fontWeight&&(r.style.fontWeight=t.fontWeight),t.fontStyle&&(r.style.fontStyle=t.fontStyle),t.labelSelect===!0&&(n._featureId=e,r._featureId=e,r._geometry=i,r._geometryClass=i.CLASS_NAME),r.style.whiteSpace="nowrap",r.inset="1px,0px,0px,0px",n.parentNode||(n.appendChild(r),this.textRoot.appendChild(n));var o=t.labelAlign||"cm";1==o.length&&(o+="m");var a=r.clientWidth*OpenLayers.Renderer.VML.LABEL_SHIFT[o.substr(0,1)],l=r.clientHeight*OpenLayers.Renderer.VML.LABEL_SHIFT[o.substr(1,1)];n.style.left=parseInt(n.style.left)-a-1+"px",n.style.top=parseInt(n.style.top)+l+"px"},moveRoot:function(e){var t=this.map.getLayer(e.container.id);t instanceof OpenLayers.Layer.Vector.RootContainer&&(t=this.map.getLayer(this.container.id)),t&&t.renderer.clear(),OpenLayers.Renderer.Elements.prototype.moveRoot.apply(this,arguments),t&&t.redraw()},importSymbol:function(e){var t=this.container.id+"-"+e,i=this.symbolCache[t];if(i)return i;var n=OpenLayers.Renderer.symbol[e];if(!n)throw Error(e+" is not a valid symbol name");for(var r=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),s=["m"],o=0;n.length>o;o+=2){var a=n[o],l=n[o+1];r.left=Math.min(r.left,a),r.bottom=Math.min(r.bottom,l),r.right=Math.max(r.right,a),r.top=Math.max(r.top,l),s.push(a),s.push(l),0==o&&s.push("l")}s.push("x e");var h=s.join(" "),c=(r.getWidth()-r.getHeight())/2;return c>0?(r.bottom=r.bottom-c,r.top=r.top+c):(r.left=r.left+c,r.right=r.right-c),i={path:h,size:r.getWidth(),left:r.left,bottom:r.bottom},this.symbolCache[t]=i,i},CLASS_NAME:"OpenLayers.Renderer.VML"}),OpenLayers.Renderer.VML.LABEL_SHIFT={l:0,c:.5,r:1,t:0,m:.5,b:1};