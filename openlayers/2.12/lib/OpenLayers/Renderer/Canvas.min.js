OpenLayers.Renderer.Canvas=OpenLayers.Class(OpenLayers.Renderer,{hitDetection:!0,hitOverflow:0,canvas:null,features:null,pendingRedraw:!1,cachedSymbolBounds:{},initialize:function(){OpenLayers.Renderer.prototype.initialize.apply(this,arguments),this.root=document.createElement("canvas"),this.container.appendChild(this.root),this.canvas=this.root.getContext("2d"),this.features={},this.hitDetection&&(this.hitCanvas=document.createElement("canvas"),this.hitContext=this.hitCanvas.getContext("2d"))},setExtent:function(){return OpenLayers.Renderer.prototype.setExtent.apply(this,arguments),!1},eraseGeometry:function(e,t){this.eraseFeatures(this.features[t][0])},supported:function(){return OpenLayers.CANVAS_SUPPORTED},setSize:function(e){this.size=e.clone();var t=this.root;if(t.style.width=e.w+"px",t.style.height=e.h+"px",t.width=e.w,t.height=e.h,this.resolution=null,this.hitDetection){var i=this.hitCanvas;i.style.width=e.w+"px",i.style.height=e.h+"px",i.width=e.w,i.height=e.h}},drawFeature:function(e,t){var i;if(e.geometry){t=this.applyDefaultSymbolizer(t||e.style);var n,r=e.geometry.getBounds();this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(n=this.map.getMaxExtent());var s=r&&r.intersectsBounds(this.extent,{worldBounds:n});i="none"!==t.display&&!!r&&s,i?this.features[e.id]=[e,t]:delete this.features[e.id],this.pendingRedraw=!0}return this.pendingRedraw&&!this.locked&&(this.redraw(),this.pendingRedraw=!1),i},drawGeometry:function(e,t,i){var n=e.CLASS_NAME;if("OpenLayers.Geometry.Collection"!=n&&"OpenLayers.Geometry.MultiPoint"!=n&&"OpenLayers.Geometry.MultiLineString"!=n&&"OpenLayers.Geometry.MultiPolygon"!=n)switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":this.drawPoint(e,t,i);break;case"OpenLayers.Geometry.LineString":this.drawLineString(e,t,i);break;case"OpenLayers.Geometry.LinearRing":this.drawLinearRing(e,t,i);break;case"OpenLayers.Geometry.Polygon":this.drawPolygon(e,t,i);break;default:}else for(var r=0;e.components.length>r;r++)this.drawGeometry(e.components[r],t,i)},drawExternalGraphic:function(e,t,i){var n=new Image;t.graphicTitle&&(n.title=t.graphicTitle);var r=t.graphicWidth||t.graphicHeight,s=t.graphicHeight||t.graphicWidth;r=r?r:2*t.pointRadius,s=s?s:2*t.pointRadius;var o=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*r),a=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*s),l=t.graphicOpacity||t.fillOpacity,h=function(){if(this.features[i]){var t=this.getLocalXY(e),h=t[0],c=t[1];if(!isNaN(h)&&!isNaN(c)){var u=0|h+o,d=0|c+a,p=this.canvas;p.globalAlpha=l;var f=OpenLayers.Renderer.Canvas.drawImageScaleFactor||(OpenLayers.Renderer.Canvas.drawImageScaleFactor=/android 2.1/.test(navigator.userAgent.toLowerCase())?320/window.screen.width:1);p.drawImage(n,u*f,d*f,r*f,s*f),this.hitDetection&&(this.setHitContextStyle("fill",i),this.hitContext.fillRect(u,d,r,s))}}};n.onload=OpenLayers.Function.bind(h,this),n.src=t.externalGraphic},drawNamedSymbol:function(e,t,i){var n,r,s,o,a,l,h,c,u,d=Math.PI/180,p=OpenLayers.Renderer.symbol[t.graphicName];if(!p)throw Error(t.graphicName+" is not a valid symbol name");if(p.length&&!(2>p.length)){var f=this.getLocalXY(e),m=f[0],g=f[1];if(!isNaN(m)&&!isNaN(g)){if(this.canvas.lineCap="round",this.canvas.lineJoin="round",this.hitDetection&&(this.hitContext.lineCap="round",this.hitContext.lineJoin="round"),t.graphicName in this.cachedSymbolBounds)l=this.cachedSymbolBounds[t.graphicName];else{for(l=new OpenLayers.Bounds,a=0;p.length>a;a+=2)l.extend(new OpenLayers.LonLat(p[a],p[a+1]));this.cachedSymbolBounds[t.graphicName]=l}if(this.canvas.save(),this.hitDetection&&this.hitContext.save(),this.canvas.translate(m,g),this.hitDetection&&this.hitContext.translate(m,g),c=d*t.rotation,isNaN(c)||(this.canvas.rotate(c),this.hitDetection&&this.hitContext.rotate(c)),h=2*t.pointRadius/Math.max(l.getWidth(),l.getHeight()),this.canvas.scale(h,h),this.hitDetection&&this.hitContext.scale(h,h),s=l.getCenterLonLat().lon,o=l.getCenterLonLat().lat,this.canvas.translate(-s,-o),this.hitDetection&&this.hitContext.translate(-s,-o),u=t.strokeWidth,t.strokeWidth=u/h,t.fill!==!1){for(this.setCanvasStyle("fill",t),this.canvas.beginPath(),a=0;p.length>a;a+=2)n=p[a],r=p[a+1],0==a&&this.canvas.moveTo(n,r),this.canvas.lineTo(n,r);if(this.canvas.closePath(),this.canvas.fill(),this.hitDetection){for(this.setHitContextStyle("fill",i,t),this.hitContext.beginPath(),a=0;p.length>a;a+=2)n=p[a],r=p[a+1],0==a&&this.canvas.moveTo(n,r),this.hitContext.lineTo(n,r);this.hitContext.closePath(),this.hitContext.fill()}}if(t.stroke!==!1){for(this.setCanvasStyle("stroke",t),this.canvas.beginPath(),a=0;p.length>a;a+=2)n=p[a],r=p[a+1],0==a&&this.canvas.moveTo(n,r),this.canvas.lineTo(n,r);if(this.canvas.closePath(),this.canvas.stroke(),this.hitDetection){for(this.setHitContextStyle("stroke",i,t,h),this.hitContext.beginPath(),a=0;p.length>a;a+=2)n=p[a],r=p[a+1],0==a&&this.hitContext.moveTo(n,r),this.hitContext.lineTo(n,r);this.hitContext.closePath(),this.hitContext.stroke()}}t.strokeWidth=u,this.canvas.restore(),this.hitDetection&&this.hitContext.restore(),this.setCanvasStyle("reset")}}},setCanvasStyle:function(e,t){"fill"===e?(this.canvas.globalAlpha=t.fillOpacity,this.canvas.fillStyle=t.fillColor):"stroke"===e?(this.canvas.globalAlpha=t.strokeOpacity,this.canvas.strokeStyle=t.strokeColor,this.canvas.lineWidth=t.strokeWidth):(this.canvas.globalAlpha=0,this.canvas.lineWidth=1)},featureIdToHex:function(e){var t=Number(e.split("_").pop())+1;t>=16777216&&(this.hitOverflow=t-16777215,t=t%16777216+1);var i="000000"+t.toString(16),n=i.length;return i="#"+i.substring(n-6,n)},setHitContextStyle:function(e,t,i,n){var r=this.featureIdToHex(t);"fill"==e?(this.hitContext.globalAlpha=1,this.hitContext.fillStyle=r):"stroke"==e?(this.hitContext.globalAlpha=1,this.hitContext.strokeStyle=r,n===void 0?this.hitContext.lineWidth=i.strokeWidth+2:isNaN(n)||(this.hitContext.lineWidth=i.strokeWidth+2/n)):(this.hitContext.globalAlpha=0,this.hitContext.lineWidth=1)},drawPoint:function(e,t,i){if(t.graphic!==!1)if(t.externalGraphic)this.drawExternalGraphic(e,t,i);else if(t.graphicName&&"circle"!=t.graphicName)this.drawNamedSymbol(e,t,i);else{var n=this.getLocalXY(e),r=n[0],s=n[1];if(!isNaN(r)&&!isNaN(s)){var o=2*Math.PI,a=t.pointRadius;t.fill!==!1&&(this.setCanvasStyle("fill",t),this.canvas.beginPath(),this.canvas.arc(r,s,a,0,o,!0),this.canvas.fill(),this.hitDetection&&(this.setHitContextStyle("fill",i,t),this.hitContext.beginPath(),this.hitContext.arc(r,s,a,0,o,!0),this.hitContext.fill())),t.stroke!==!1&&(this.setCanvasStyle("stroke",t),this.canvas.beginPath(),this.canvas.arc(r,s,a,0,o,!0),this.canvas.stroke(),this.hitDetection&&(this.setHitContextStyle("stroke",i,t),this.hitContext.beginPath(),this.hitContext.arc(r,s,a,0,o,!0),this.hitContext.stroke()),this.setCanvasStyle("reset"))}}},drawLineString:function(e,t,i){t=OpenLayers.Util.applyDefaults({fill:!1},t),this.drawLinearRing(e,t,i)},drawLinearRing:function(e,t,i){t.fill!==!1&&(this.setCanvasStyle("fill",t),this.renderPath(this.canvas,e,t,i,"fill"),this.hitDetection&&(this.setHitContextStyle("fill",i,t),this.renderPath(this.hitContext,e,t,i,"fill"))),t.stroke!==!1&&(this.setCanvasStyle("stroke",t),this.renderPath(this.canvas,e,t,i,"stroke"),this.hitDetection&&(this.setHitContextStyle("stroke",i,t),this.renderPath(this.hitContext,e,t,i,"stroke"))),this.setCanvasStyle("reset")},renderPath:function(e,t,i,n,r){var s=t.components,o=s.length;e.beginPath();var a=this.getLocalXY(s[0]),l=a[0],h=a[1];if(!isNaN(l)&&!isNaN(h)){e.moveTo(a[0],a[1]);for(var c=1;o>c;++c){var u=this.getLocalXY(s[c]);e.lineTo(u[0],u[1])}"fill"===r?e.fill():e.stroke()}},drawPolygon:function(e,t,i){var n=e.components,r=n.length;this.drawLinearRing(n[0],t,i);for(var s=1;r>s;++s)this.canvas.globalCompositeOperation="destination-out",this.hitDetection&&(this.hitContext.globalCompositeOperation="destination-out"),this.drawLinearRing(n[s],OpenLayers.Util.applyDefaults({stroke:!1,fillOpacity:1},t),i),this.canvas.globalCompositeOperation="source-over",this.hitDetection&&(this.hitContext.globalCompositeOperation="source-over"),this.drawLinearRing(n[s],OpenLayers.Util.applyDefaults({fill:!1},t),i)},drawText:function(e,t){var i=this.getLocalXY(e);this.setCanvasStyle("reset"),this.canvas.fillStyle=t.fontColor,this.canvas.globalAlpha=t.fontOpacity||1;var n=[t.fontStyle?t.fontStyle:"normal","normal",t.fontWeight?t.fontWeight:"normal",t.fontSize?t.fontSize:"1em",t.fontFamily?t.fontFamily:"sans-serif"].join(" "),r=t.label.split("\n"),s=r.length;if(this.canvas.fillText){this.canvas.font=n,this.canvas.textAlign=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[0]]||"center",this.canvas.textBaseline=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[1]]||"middle";var o=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]];null==o&&(o=-.5);var a=this.canvas.measureText("Mg").height||this.canvas.measureText("xx").width;i[1]+=a*o*(s-1);for(var l=0;s>l;l++)t.labelOutlineWidth&&(this.canvas.save(),this.canvas.strokeStyle=t.labelOutlineColor,this.canvas.lineWidth=t.labelOutlineWidth,this.canvas.strokeText(r[l],i[0],i[1]+a*l+1),this.canvas.restore()),this.canvas.fillText(r[l],i[0],i[1]+a*l)}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=n;var h=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[0]];null==h&&(h=-.5);var o=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]];null==o&&(o=-.5);var a=this.canvas.mozMeasureText("xx");i[1]+=a*(1+o*s);for(var l=0;s>l;l++){var c=i[0]+h*this.canvas.mozMeasureText(r[l]),u=i[1]+l*a;this.canvas.translate(c,u),this.canvas.mozDrawText(r[l]),this.canvas.translate(-c,-u)}}this.setCanvasStyle("reset")},getLocalXY:function(e){var t=this.getResolution(),i=this.extent,n=(e.x-this.featureDx)/t+-i.left/t,r=i.top/t-e.y/t;return[n,r]},clear:function(){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e),this.features={},this.hitDetection&&this.hitContext.clearRect(0,0,t,e)},getFeatureIdFromEvent:function(e){var t,i;if(this.hitDetection&&"none"!==this.root.style.display&&!this.map.dragging){var n=e.xy,r=0|n.x,s=0|n.y,o=this.hitContext.getImageData(r,s,1,1).data;if(255===o[3]){var a=o[2]+256*(o[1]+256*o[0]);if(a){t="OpenLayers.Feature.Vector_"+(a-1+this.hitOverflow);try{i=this.features[t][0]}catch(l){}}}}return i},eraseFeatures:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0;e.length>t;++t)delete this.features[e[t].id];this.redraw()},redraw:function(){if(!this.locked){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e),this.hitDetection&&this.hitContext.clearRect(0,0,t,e);var i,n,r,s=[],o=this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent();for(var a in this.features)this.features.hasOwnProperty(a)&&(i=this.features[a][0],n=i.geometry,this.calculateFeatureDx(n.getBounds(),o),r=this.features[a][1],this.drawGeometry(n,r,i.id),r.label&&s.push([i,r]));for(var l,h=0,c=s.length;c>h;++h)l=s[h],this.drawText(l[0].geometry.getCentroid(),l[1])}},CLASS_NAME:"OpenLayers.Renderer.Canvas"}),OpenLayers.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right",t:"top",b:"bottom"},OpenLayers.Renderer.Canvas.LABEL_FACTOR={l:0,r:-1,t:0,b:-1},OpenLayers.Renderer.Canvas.drawImageScaleFactor=null;