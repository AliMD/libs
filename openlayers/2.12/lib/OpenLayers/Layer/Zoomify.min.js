OpenLayers.Layer.Zoomify=OpenLayers.Class(OpenLayers.Layer.Grid,{size:null,isBaseLayer:!0,standardTileSize:256,tileOriginCorner:"tl",numberOfTiers:0,tileCountUpToTier:null,tierSizeInTiles:null,tierImageSize:null,initialize:function(e,t,i,n){this.initializeZoomify(i),OpenLayers.Layer.Grid.prototype.initialize.apply(this,[e,t,i,{},n])},initializeZoomify:function(e){var t=e.clone(),i=new OpenLayers.Size(Math.ceil(t.w/this.standardTileSize),Math.ceil(t.h/this.standardTileSize));for(this.tierSizeInTiles=[i],this.tierImageSize=[t];t.w>this.standardTileSize||t.h>this.standardTileSize;)t=new OpenLayers.Size(Math.floor(t.w/2),Math.floor(t.h/2)),i=new OpenLayers.Size(Math.ceil(t.w/this.standardTileSize),Math.ceil(t.h/this.standardTileSize)),this.tierSizeInTiles.push(i),this.tierImageSize.push(t);this.tierSizeInTiles.reverse(),this.tierImageSize.reverse(),this.numberOfTiers=this.tierSizeInTiles.length,this.tileCountUpToTier=[0];for(var n=1;this.numberOfTiers>n;n++)this.tileCountUpToTier.push(this.tierSizeInTiles[n-1].w*this.tierSizeInTiles[n-1].h+this.tileCountUpToTier[n-1])},destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments),this.tileCountUpToTier.length=0,this.tierSizeInTiles.length=0,this.tierImageSize.length=0},clone:function(e){return null==e&&(e=new OpenLayers.Layer.Zoomify(this.name,this.url,this.size,this.options)),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},getURL:function(e){e=this.adjustBounds(e);var t=this.map.getResolution(),i=Math.round((e.left-this.tileOrigin.lon)/(t*this.tileSize.w)),n=Math.round((this.tileOrigin.lat-e.top)/(t*this.tileSize.h)),r=this.map.getZoom(),s=i+n*this.tierSizeInTiles[r].w+this.tileCountUpToTier[r],o="TileGroup"+Math.floor(s/256)+"/"+r+"-"+i+"-"+n+".jpg",a=this.url;return OpenLayers.Util.isArray(a)&&(a=this.selectUrl(o,a)),a+o},getImageSize:function(){if(arguments.length>0){var e=this.adjustBounds(arguments[0]),t=this.map.getResolution(),i=Math.round((e.left-this.tileOrigin.lon)/(t*this.tileSize.w)),n=Math.round((this.tileOrigin.lat-e.top)/(t*this.tileSize.h)),r=this.map.getZoom(),s=this.standardTileSize,o=this.standardTileSize;if(i==this.tierSizeInTiles[r].w-1)var s=this.tierImageSize[r].w%this.standardTileSize;if(n==this.tierSizeInTiles[r].h-1)var o=this.tierImageSize[r].h%this.standardTileSize;return new OpenLayers.Size(s,o)}return this.tileSize},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments),this.tileOrigin=new OpenLayers.LonLat(this.map.maxExtent.left,this.map.maxExtent.top)},calculateGridLayout:function(e,t,i){var n=i*this.tileSize.w,r=i*this.tileSize.h,s=e.left-t.lon,o=Math.floor(s/n)-this.buffer,a=s/n-o,l=-a*this.tileSize.w,h=t.lon+o*n,c=t.lat-e.top+r,u=Math.floor(c/r)-this.buffer,d=u-c/r,p=d*this.tileSize.h,f=t.lat-r*u;return{tilelon:n,tilelat:r,tileoffsetlon:h,tileoffsetlat:f,tileoffsetx:l,tileoffsety:p}},CLASS_NAME:"OpenLayers.Layer.Zoomify"});