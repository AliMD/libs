OpenLayers.Layer.ArcGISCache=OpenLayers.Class(OpenLayers.Layer.XYZ,{url:null,tileOrigin:null,tileSize:new OpenLayers.Size(256,256),useArcGISServer:!0,type:"png",useScales:!1,overrideDPI:!1,initialize:function(){if(OpenLayers.Layer.XYZ.prototype.initialize.apply(this,arguments),this.resolutions&&(this.serverResolutions=this.resolutions,this.maxExtent=this.getMaxExtentForResolution(this.resolutions[0])),this.layerInfo){var e=this.layerInfo,t=new OpenLayers.Bounds(e.fullExtent.xmin,e.fullExtent.ymin,e.fullExtent.xmax,e.fullExtent.ymax);if(this.projection="EPSG:"+e.spatialReference.wkid,this.sphericalMercator=102100==e.spatialReference.wkid,this.units="esriFeet"==e.units?"ft":"m",e.tileInfo){this.tileSize=new OpenLayers.Size(e.tileInfo.width||e.tileInfo.cols,e.tileInfo.height||e.tileInfo.rows),this.tileOrigin=new OpenLayers.LonLat(e.tileInfo.origin.x,e.tileInfo.origin.y);var i=new OpenLayers.Geometry.Point(t.left,t.top),n=new OpenLayers.Geometry.Point(t.right,t.bottom);this.useScales?this.scales=[]:this.resolutions=[],this.lods=[];for(var r in e.tileInfo.lods)if(e.tileInfo.lods.hasOwnProperty(r)){var s=e.tileInfo.lods[r];this.useScales?this.scales.push(s.scale):this.resolutions.push(s.resolution);var o=this.getContainingTileCoords(i,s.resolution);s.startTileCol=o.x,s.startTileRow=o.y;var a=this.getContainingTileCoords(n,s.resolution);s.endTileCol=a.x,s.endTileRow=a.y,this.lods.push(s)}this.maxExtent=this.calculateMaxExtentWithLOD(this.lods[0]),this.serverResolutions=this.resolutions,this.overrideDPI&&e.tileInfo.dpi&&(OpenLayers.DOTS_PER_INCH=e.tileInfo.dpi)}}},getContainingTileCoords:function(e,t){return new OpenLayers.Pixel(Math.max(Math.floor((e.x-this.tileOrigin.lon)/(this.tileSize.w*t)),0),Math.max(Math.floor((this.tileOrigin.lat-e.y)/(this.tileSize.h*t)),0))},calculateMaxExtentWithLOD:function(e){var t=e.endTileCol-e.startTileCol+1,i=e.endTileRow-e.startTileRow+1,n=this.tileOrigin.lon+e.startTileCol*this.tileSize.w*e.resolution,r=n+t*this.tileSize.w*e.resolution,s=this.tileOrigin.lat-e.startTileRow*this.tileSize.h*e.resolution,o=s-i*this.tileSize.h*e.resolution;return new OpenLayers.Bounds(n,o,r,s)},calculateMaxExtentWithExtent:function(e,t){var i=new OpenLayers.Geometry.Point(e.left,e.top),n=new OpenLayers.Geometry.Point(e.right,e.bottom),r=this.getContainingTileCoords(i,t),s=this.getContainingTileCoords(n,t),o={resolution:t,startTileCol:r.x,startTileRow:r.y,endTileCol:s.x,endTileRow:s.y};return this.calculateMaxExtentWithLOD(o)},getUpperLeftTileCoord:function(e){var t=new OpenLayers.Geometry.Point(this.maxExtent.left,this.maxExtent.top);return this.getContainingTileCoords(t,e)},getLowerRightTileCoord:function(e){var t=new OpenLayers.Geometry.Point(this.maxExtent.right,this.maxExtent.bottom);return this.getContainingTileCoords(t,e)},getMaxExtentForResolution:function(e){var t=this.getUpperLeftTileCoord(e),i=this.getLowerRightTileCoord(e),n=i.x-t.x+1,r=i.y-t.y+1,s=this.tileOrigin.lon+t.x*this.tileSize.w*e,o=s+n*this.tileSize.w*e,a=this.tileOrigin.lat-t.y*this.tileSize.h*e,l=a-r*this.tileSize.h*e;return new OpenLayers.Bounds(s,l,o,a)},clone:function(e){return null==e&&(e=new OpenLayers.Layer.ArcGISCache(this.name,this.url,this.options)),OpenLayers.Layer.XYZ.prototype.clone.apply(this,[e])},getMaxExtent:function(){var e=this.map.getResolution();return this.maxExtent=this.getMaxExtentForResolution(e)},getTileOrigin:function(){var e=this.getMaxExtent();return new OpenLayers.LonLat(e.left,e.bottom)},getURL:function(e){var t=this.getResolution(),i=this.tileOrigin.lon+t*this.tileSize.w/2,n=this.tileOrigin.lat-t*this.tileSize.h/2,r=e.getCenterLonLat();({x:r.lon,y:r.lat});var s=Math.round(Math.abs((r.lon-i)/(t*this.tileSize.w))),o=Math.round(Math.abs((n-r.lat)/(t*this.tileSize.h))),a=this.map.getZoom();if(this.lods){var l=this.lods[this.map.getZoom()];if(l.startTileCol>s||s>l.endTileCol||l.startTileRow>o||o>l.endTileRow)return null}else{var h=this.getUpperLeftTileCoord(t),c=this.getLowerRightTileCoord(t);if(h.x>s||s>=c.x||h.y>o||o>=c.y)return null}var u=this.url,d=""+s+o+a;return OpenLayers.Util.isArray(u)&&(u=this.selectUrl(d,u)),this.useArcGISServer?u+="/tile/${z}/${y}/${x}":(s="C"+this.zeroPad(s,8,16),o="R"+this.zeroPad(o,8,16),a="L"+this.zeroPad(a,2,16),u=u+"/${z}/${y}/${x}."+this.type),u=OpenLayers.String.format(u,{x:s,y:o,z:a}),OpenLayers.Util.urlAppend(u,OpenLayers.Util.getParameterString(this.params))},zeroPad:function(e,t,i){for(var n=e.toString(i||10);t>n.length;)n="0"+n;return n},CLASS_NAME:"OpenLayers.Layer.ArcGISCache"});