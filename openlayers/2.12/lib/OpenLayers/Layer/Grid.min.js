OpenLayers.Layer.Grid=OpenLayers.Class(OpenLayers.Layer.HTTPRequest,{tileSize:null,tileOriginCorner:"bl",tileOrigin:null,tileOptions:null,tileClass:OpenLayers.Tile.Image,grid:null,singleTile:!1,ratio:1.5,buffer:0,transitionEffect:null,numLoadingTiles:0,tileLoadingDelay:85,serverResolutions:null,moveTimerId:null,deferMoveGriddedTiles:null,tileQueueId:null,tileQueue:null,loading:!1,backBuffer:null,gridResolution:null,backBufferResolution:null,backBufferLonLat:null,backBufferTimerId:null,removeBackBufferDelay:null,className:null,initialize:function(){OpenLayers.Layer.HTTPRequest.prototype.initialize.apply(this,arguments),this.grid=[],this.tileQueue=[],null===this.removeBackBufferDelay&&(this.removeBackBufferDelay=this.singleTile?0:2500),null===this.className&&(this.className=this.singleTile?"olLayerGridSingleTile":"olLayerGrid"),OpenLayers.Animation.isNative||(this.deferMoveGriddedTiles=OpenLayers.Function.bind(function(){this.moveGriddedTiles(!0),this.moveTimerId=null},this))},setMap:function(e){OpenLayers.Layer.HTTPRequest.prototype.setMap.call(this,e),OpenLayers.Element.addClass(this.div,this.className)},removeMap:function(){null!==this.moveTimerId&&(window.clearTimeout(this.moveTimerId),this.moveTimerId=null),this.clearTileQueue(),null!==this.backBufferTimerId&&(window.clearTimeout(this.backBufferTimerId),this.backBufferTimerId=null)},destroy:function(){this.removeBackBuffer(),this.clearGrid(),this.grid=null,this.tileSize=null,OpenLayers.Layer.HTTPRequest.prototype.destroy.apply(this,arguments)},clearGrid:function(){if(this.clearTileQueue(),this.grid){for(var e=0,t=this.grid.length;t>e;e++)for(var i=this.grid[e],n=0,r=i.length;r>n;n++){var s=i[n];this.destroyTile(s)}this.grid=[],this.gridResolution=null}},clone:function(e){return null==e&&(e=new OpenLayers.Layer.Grid(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.HTTPRequest.prototype.clone.apply(this,[e]),null!=this.tileSize&&(e.tileSize=this.tileSize.clone()),e.grid=[],e.gridResolution=null,e.backBuffer=null,e.backBufferTimerId=null,e.tileQueue=[],e.tileQueueId=null,e.loading=!1,e.moveTimerId=null,e},moveTo:function(e,t,i){if(OpenLayers.Layer.HTTPRequest.prototype.moveTo.apply(this,arguments),e=e||this.map.getExtent(),null!=e){var n=!this.grid.length||t,r=this.getTilesBounds(),s=this.map.getResolution(),o=this.getServerResolution(s);if(this.singleTile)(n||!i&&!r.containsBounds(e))&&(t&&"resize"!==this.transitionEffect&&this.removeBackBuffer(),t&&"resize"!==this.transitionEffect||this.applyBackBuffer(o),this.initSingleTile(e));else{if(n=n||!r.intersectsBounds(e,{worldBounds:this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent()}),s!==o){if(e=this.map.calculateBounds(null,o),n){var a=o/s;this.transformDiv(a)}}else this.div.style.width="100%",this.div.style.height="100%",this.div.style.left="0%",this.div.style.top="0%";n?(t&&"resize"===this.transitionEffect&&this.applyBackBuffer(o),this.initGriddedTiles(e)):this.moveGriddedTiles()}}},getTileData:function(e){var t=null,i=e.lon,n=e.lat,r=this.grid.length;if(this.map&&r){var s=this.map.getResolution(),o=this.tileSize.w,a=this.tileSize.h,l=this.grid[0][0].bounds,h=l.left,c=l.top;if(h>i&&this.map.baseLayer.wrapDateLine){var u=this.map.getMaxExtent().getWidth(),d=Math.ceil((h-i)/u);i+=u*d}var p=(i-h)/(s*o),f=(c-n)/(s*a),m=Math.floor(p),g=Math.floor(f);if(g>=0&&r>g){var y=this.grid[g][m];y&&(t={tile:y,i:Math.floor((p-m)*o),j:Math.floor((f-g)*a)})}}return t},queueTileDraw:function(e){var t=e.object;return~OpenLayers.Util.indexOf(this.tileQueue,t)||this.tileQueue.push(t),this.tileQueueId||(this.tileQueueId=OpenLayers.Animation.start(OpenLayers.Function.bind(this.drawTileFromQueue,this),null,this.div)),!1},drawTileFromQueue:function(){0===this.tileQueue.length?this.clearTileQueue():this.tileQueue.shift().draw(!0)},clearTileQueue:function(){OpenLayers.Animation.stop(this.tileQueueId),this.tileQueueId=null,this.tileQueue=[]},destroyTile:function(e){this.removeTileMonitoringHooks(e),e.destroy()},getServerResolution:function(e){if(e=e||this.map.getResolution(),this.serverResolutions&&-1===OpenLayers.Util.indexOf(this.serverResolutions,e)){var t,i;for(t=this.serverResolutions.length-1;t>=0;t--)if(i=this.serverResolutions[t],i>e){e=i;break}if(-1===t)throw"no appropriate resolution in serverResolutions"}return e},getServerZoom:function(){var e=this.getServerResolution();return this.serverResolutions?OpenLayers.Util.indexOf(this.serverResolutions,e):this.map.getZoomForResolution(e)+(this.zoomOffset||0)},transformDiv:function(e){this.div.style.width=100*e+"%",this.div.style.height=100*e+"%";var t=this.map.getSize(),i=parseInt(this.map.layerContainerDiv.style.left,10),n=parseInt(this.map.layerContainerDiv.style.top,10),r=(i-t.w/2)*(e-1),s=(n-t.h/2)*(e-1);this.div.style.left=r+"%",this.div.style.top=s+"%"},getResolutionScale:function(){return parseInt(this.div.style.width,10)/100},applyBackBuffer:function(e){null!==this.backBufferTimerId&&this.removeBackBuffer();var t=this.backBuffer;if(!t){if(t=this.createBackBuffer(),!t)return;this.div.insertBefore(t,this.div.firstChild),this.backBuffer=t;var i=this.grid[0][0].bounds;this.backBufferLonLat={lon:i.left,lat:i.top},this.backBufferResolution=this.gridResolution}var n=t.style,r=this.backBufferResolution/e;n.width=100*r+"%",n.height=100*r+"%";var s=this.getViewPortPxFromLonLat(this.backBufferLonLat,e),o=parseInt(this.map.layerContainerDiv.style.left,10),a=parseInt(this.map.layerContainerDiv.style.top,10);t.style.left=Math.round(s.x-o)+"%",t.style.top=Math.round(s.y-a)+"%"},createBackBuffer:function(){var e;if(this.grid.length>0){e=document.createElement("div"),e.id=this.div.id+"_bb",e.className="olBackBuffer",e.style.position="absolute",e.style.width="100%",e.style.height="100%";for(var t=0,i=this.grid.length;i>t;t++)for(var n=0,r=this.grid[t].length;r>n;n++){var s=this.grid[t][n].createBackBuffer();s&&(s.style.top=t*this.tileSize.h+"%",s.style.left=n*this.tileSize.w+"%",e.appendChild(s))}}return e},removeBackBuffer:function(){this.backBuffer&&(this.div.removeChild(this.backBuffer),this.backBuffer=null,this.backBufferResolution=null,null!==this.backBufferTimerId&&(window.clearTimeout(this.backBufferTimerId),this.backBufferTimerId=null))},moveByPx:function(){this.singleTile||this.moveGriddedTiles()},setTileSize:function(e){this.singleTile&&(e=this.map.getSize(),e.h=parseInt(e.h*this.ratio),e.w=parseInt(e.w*this.ratio)),OpenLayers.Layer.HTTPRequest.prototype.setTileSize.apply(this,[e])},getTilesBounds:function(){var e=null,t=this.grid.length;if(t){var i=this.grid[t-1][0].bounds,n=this.grid[0].length*i.getWidth(),r=this.grid.length*i.getHeight();e=new OpenLayers.Bounds(i.left,i.bottom,i.left+n,i.bottom+r)}return e},initSingleTile:function(e){this.clearTileQueue();var t=e.getCenterLonLat(),i=e.getWidth()*this.ratio,n=e.getHeight()*this.ratio,r=new OpenLayers.Bounds(t.lon-i/2,t.lat-n/2,t.lon+i/2,t.lat+n/2),s=this.map.getLayerPxFromLonLat({lon:r.left,lat:r.top});this.grid.length||(this.grid[0]=[]);var o=this.grid[0][0];o?o.moveTo(r,s):(o=this.addTile(r,s),this.addTileMonitoringHooks(o),o.draw(),this.grid[0][0]=o),this.removeExcessTiles(1,1),this.gridResolution=this.getServerResolution()},calculateGridLayout:function(e,t,i){var n=i*this.tileSize.w,r=i*this.tileSize.h,s=e.left-t.lon,o=Math.floor(s/n)-this.buffer,a=s/n-o,l=-a*this.tileSize.w,h=t.lon+o*n,c=e.top-(t.lat+r),u=Math.ceil(c/r)+this.buffer,d=u-c/r,p=-d*this.tileSize.h,f=t.lat+u*r;return{tilelon:n,tilelat:r,tileoffsetlon:h,tileoffsetlat:f,tileoffsetx:l,tileoffsety:p}},getTileOrigin:function(){var e=this.tileOrigin;if(!e){var t=this.getMaxExtent(),i={tl:["left","top"],tr:["right","top"],bl:["left","bottom"],br:["right","bottom"]}[this.tileOriginCorner];e=new OpenLayers.LonLat(t[i[0]],t[i[1]])}return e},initGriddedTiles:function(e){this.clearTileQueue();var t=this.map.getSize(),i=Math.ceil(t.h/this.tileSize.h)+Math.max(1,2*this.buffer),n=Math.ceil(t.w/this.tileSize.w)+Math.max(1,2*this.buffer),r=this.getTileOrigin(),s=this.getServerResolution(),o=this.calculateGridLayout(e,r,s),a=Math.round(o.tileoffsetx),l=Math.round(o.tileoffsety),h=o.tileoffsetlon,c=o.tileoffsetlat,u=o.tilelon,d=o.tilelat,p=a,f=h,m=0,g=parseInt(this.map.layerContainerDiv.style.left),y=parseInt(this.map.layerContainerDiv.style.top),v=[],b=this.map.getCenter();do{var L=this.grid[m++];L||(L=[],this.grid.push(L)),h=f,a=p;var x=0;do{var C=new OpenLayers.Bounds(h,c,h+u,c+d),w=a;w-=g;var S=l;S-=y;var O=new OpenLayers.Pixel(w,S),_=L[x++];_?_.moveTo(C,O,!1):(_=this.addTile(C,O),this.addTileMonitoringHooks(_),L.push(_));var E=C.getCenterLonLat();v.push({tile:_,distance:Math.pow(E.lon-b.lon,2)+Math.pow(E.lat-b.lat,2)}),h+=u,a+=this.tileSize.w}while(e.right+u*this.buffer>=h||n>x);c-=d,l+=this.tileSize.h}while(c>=e.bottom-d*this.buffer||i>m);this.removeExcessTiles(m,x),this.gridResolution=this.getServerResolution(),v.sort(function(e,t){return e.distance-t.distance});for(var T=0,k=v.length;k>T;++T)v[T].tile.draw()},getMaxExtent:function(){return this.maxExtent},addTile:function(e,t){var i=new this.tileClass(this,t,e,null,this.tileSize,this.tileOptions);return i.events.register("beforedraw",this,this.queueTileDraw),i},addTileMonitoringHooks:function(e){e.onLoadStart=function(){this.loading===!1&&(this.loading=!0,this.events.triggerEvent("loadstart")),this.events.triggerEvent("tileloadstart",{tile:e}),this.numLoadingTiles++},e.onLoadEnd=function(){this.numLoadingTiles--,this.events.triggerEvent("tileloaded",{tile:e}),0===this.tileQueue.length&&0===this.numLoadingTiles&&(this.loading=!1,this.events.triggerEvent("loadend"),this.backBuffer&&(this.backBufferTimerId=window.setTimeout(OpenLayers.Function.bind(this.removeBackBuffer,this),this.removeBackBufferDelay)))},e.onLoadError=function(){this.events.triggerEvent("tileerror",{tile:e})},e.events.on({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,loaderror:e.onLoadError,scope:this})},removeTileMonitoringHooks:function(e){e.unload(),e.events.un({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,loaderror:e.onLoadError,scope:this})},moveGriddedTiles:function(e){if(!e&&!OpenLayers.Animation.isNative)return null!=this.moveTimerId&&window.clearTimeout(this.moveTimerId),this.moveTimerId=window.setTimeout(this.deferMoveGriddedTiles,this.tileLoadingDelay),void 0;for(var t=this.buffer||1,i=this.getResolutionScale();;){var n={x:this.grid[0][0].position.x*i+parseInt(this.div.style.left,10)+parseInt(this.map.layerContainerDiv.style.left),y:this.grid[0][0].position.y*i+parseInt(this.div.style.top,10)+parseInt(this.map.layerContainerDiv.style.top)},r={w:this.tileSize.w*i,h:this.tileSize.h*i};if(n.x>-r.w*(t-1))this.shiftColumn(!0);else if(n.x<-r.w*t)this.shiftColumn(!1);else if(n.y>-r.h*(t-1))this.shiftRow(!0);else{if(!(n.y<-r.h*t))break;this.shiftRow(!1)}}},shiftRow:function(e){for(var t=e?0:this.grid.length-1,i=this.grid,n=i[t],r=this.getServerResolution(),s=e?-this.tileSize.h:this.tileSize.h,o=r*-s,a=e?i.pop():i.shift(),l=0,h=n.length;h>l;l++){var c=n[l],u=c.bounds.clone(),d=c.position.clone();u.bottom=u.bottom+o,u.top=u.top+o,d.y=d.y+s,a[l].moveTo(u,d)}e?i.unshift(a):i.push(a)},shiftColumn:function(e){for(var t=e?-this.tileSize.w:this.tileSize.w,i=this.getServerResolution(),n=i*t,r=0,s=this.grid.length;s>r;r++){var o=this.grid[r],a=e?0:o.length-1,l=o[a],h=l.bounds.clone(),c=l.position.clone();h.left=h.left+n,h.right=h.right+n,c.x=c.x+t;var u=e?this.grid[r].pop():this.grid[r].shift();u.moveTo(h,c),e?o.unshift(u):o.push(u)}},removeExcessTiles:function(e,t){for(var i,n;this.grid.length>e;){var r=this.grid.pop();for(i=0,n=r.length;n>i;i++){var s=r[i];this.destroyTile(s)}}for(i=0,n=this.grid.length;n>i;i++)for(;this.grid[i].length>t;){var r=this.grid[i],s=r.pop();this.destroyTile(s)}},onMapResize:function(){this.singleTile&&(this.clearGrid(),this.setTileSize())},getTileBounds:function(e){var t=this.maxExtent,i=this.getResolution(),n=i*this.tileSize.w,r=i*this.tileSize.h,s=this.getLonLatFromViewPortPx(e),o=t.left+n*Math.floor((s.lon-t.left)/n),a=t.bottom+r*Math.floor((s.lat-t.bottom)/r);return new OpenLayers.Bounds(o,a,o+n,a+r)},CLASS_NAME:"OpenLayers.Layer.Grid"});