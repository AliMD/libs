OpenLayers.Layer.WMTS=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,version:"1.0.0",requestEncoding:"KVP",url:null,layer:null,matrixSet:null,style:null,format:"image/jpeg",tileOrigin:null,tileFullExtent:null,formatSuffix:null,matrixIds:null,dimensions:null,params:null,zoomOffset:0,serverResolutions:null,formatSuffixMap:{"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"},matrix:null,initialize:function(e){var t={url:!0,layer:!0,style:!0,matrixSet:!0};for(var i in t)if(!(i in e))throw Error("Missing property '"+i+"' in layer configuration.");e.params=OpenLayers.Util.upperCaseObject(e.params);var n=[e.name,e.url,e.params,e];if(OpenLayers.Layer.Grid.prototype.initialize.apply(this,n),this.formatSuffix||(this.formatSuffix=this.formatSuffixMap[this.format]||this.format.split("/").pop()),this.matrixIds){var r=this.matrixIds.length;if(r&&"string"==typeof this.matrixIds[0]){var s=this.matrixIds;this.matrixIds=Array(r);for(var o=0;r>o;++o)this.matrixIds[o]={identifier:s[o]}}}},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments),this.updateMatrixProperties()},updateMatrixProperties:function(){this.matrix=this.getMatrix(),this.matrix&&(this.matrix.topLeftCorner&&(this.tileOrigin=this.matrix.topLeftCorner),this.matrix.tileWidth&&this.matrix.tileHeight&&(this.tileSize=new OpenLayers.Size(this.matrix.tileWidth,this.matrix.tileHeight)),this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top)),this.tileFullExtent||(this.tileFullExtent=this.maxExtent))},moveTo:function(e,t){return(t||!this.matrix)&&this.updateMatrixProperties(),OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments)},clone:function(e){return null==e&&(e=new OpenLayers.Layer.WMTS(this.options)),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},getIdentifier:function(){return this.getServerZoom()},getMatrix:function(){var e;if(this.matrixIds&&0!==this.matrixIds.length)if("scaleDenominator"in this.matrixIds[0])for(var t,i=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]*this.getServerResolution()/28e-5,n=Number.POSITIVE_INFINITY,r=0,s=this.matrixIds.length;s>r;++r)t=Math.abs(1-this.matrixIds[r].scaleDenominator/i),n>t&&(n=t,e=this.matrixIds[r]);else e=this.matrixIds[this.getIdentifier()];else e={identifier:this.getIdentifier()};return e},getTileInfo:function(e){var t=this.getServerResolution(),i=(e.lon-this.tileOrigin.lon)/(t*this.tileSize.w),n=(this.tileOrigin.lat-e.lat)/(t*this.tileSize.h),r=Math.floor(i),s=Math.floor(n);return{col:r,row:s,i:Math.floor((i-r)*this.tileSize.w),j:Math.floor((n-s)*this.tileSize.h)}},getURL:function(e){e=this.adjustBounds(e);var t="";if(!this.tileFullExtent||this.tileFullExtent.intersectsBounds(e)){var i=e.getCenterLonLat(),n=this.getTileInfo(i);this.matrix.identifier;var r,s=this.dimensions;if("REST"===this.requestEncoding.toUpperCase())if(r=this.params,"string"==typeof this.url&&-1!==this.url.indexOf("{")){var o=this.url.replace(/\{/g,"${"),a={style:this.style,Style:this.style,TileMatrixSet:this.matrixSet,TileMatrix:this.matrix.identifier,TileRow:n.row,TileCol:n.col};if(s){var l,h;for(h=s.length-1;h>=0;--h)l=s[h],a[l]=r[l.toUpperCase()]}t=OpenLayers.String.format(o,a)}else{var c=this.version+"/"+this.layer+"/"+this.style+"/";if(s)for(var h=0;s.length>h;h++)r[s[h]]&&(c=c+r[s[h]]+"/");c=c+this.matrixSet+"/"+this.matrix.identifier+"/"+n.row+"/"+n.col+"."+this.formatSuffix,t=OpenLayers.Util.isArray(this.url)?this.selectUrl(c,this.url):this.url,t.match(/\/$/)||(t+="/"),t+=c}else"KVP"===this.requestEncoding.toUpperCase()&&(r={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,TILEROW:n.row,TILECOL:n.col,FORMAT:this.format},t=OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[r]))}return t},mergeNewParams:function(e){return"KVP"===this.requestEncoding.toUpperCase()?OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,[OpenLayers.Util.upperCaseObject(e)]):void 0},CLASS_NAME:"OpenLayers.Layer.WMTS"});