(function(e){"object"==typeof exports?module.exports=e():"function"==typeof define?define(e):breeze=e()})(function(){function e(e,t){for(var n in e)P.call(e,n)&&t(n,e[n])}function t(e,t){for(var n in e)if(P.call(e,n)){var r=e[n];if(t(n,r))return{key:n,value:r}}return null}function n(e,t){var n=[];for(var r in e)if(P.call(e,r)){var i=t(r,e[r]);i&&n.push(i)}return n}function r(e,t){return function(n){return n[e]===t}}function i(e){return function(t){return t[e]}}function o(e){var t=[];for(var n in e)P.call(e,n)&&t.push(e[n]);return t}function a(e,t){if(!t)return e;for(var n in t)P.call(t,n)&&(e[n]=t[n]);return e}function s(e,t){var n={};for(var r in e)if(P.call(e,r)&&"_"!=r.substr(0,1)){var i=e[r];if(x(i))continue;"object"==typeof i?i&&i.parentEnum&&(n[r]=i.name):n[r]=i}return t&&t.forEach(function(t){n[t]=e[t]}),n}function c(e,t){for(var n=0,r=e.length;r>n;n++)if(t(e[n]))return e[n];return null}function l(e,t){for(var n=0,r=e.length;r>n;n++)if(t(e[n]))return n;return-1}function u(e,t){for(var n=x(t)?t:void 0,r=e.length,i=0;r>i;i++)if(n?n(e[i]):e[i]===t)return e.splice(i,1),i;return-1}function d(e,t,n){for(var r=[],i=Math.min(e.length,t.length),o=0;i>o;++o)r.push(n(e[o],t[o]));return r}function h(e,t,n){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0;e.length>r;r++)if(Array.isArray(e[r])){if(!h(e[r],t[r]))return!1}else if(n){if(!n(e[r],t[r]))return!1}else if(e[r]!=t[r])return!1;return!0}function p(e,t){for(var n=e.split(";"),r=0,i=n.length;i>r;r++){var o=g(n[r]);if(o)return o}throw Error("Unable to initialize "+e+".  "+t||"")}function g(e){var t=window[e];return t?t:(window.require&&(t=window.require(e)),t?t:null)}function f(e,t,n,r){var i=e[t];if(n===i)return r();e[t]=n;try{return r()}finally{e[t]=i}}function m(e,t,n){var r;try{return r=e(),n()}catch(i){throw"object"==typeof r&&(r.error=i),i}finally{t(r)}}function _(e){return function(){for(var t=Array.prototype.slice.call(arguments),n="",r=t.length,i=null;r--;)i=t[r],n+=i===Object(i)?JSON.stringify(i):i,e.memoize||(e.memoize={});return n in e.memoize?e.memoize[n]:e.memoize[n]=e.apply(this,t)}}function y(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),n="x"==e?t:8|3&t;return n.toString(16)})}function b(e){if("string"!=typeof e)throw Error("Invalid ISO8601 duration '"+e+"'");var t=/^P((\d+Y)?(\d+M)?(\d+D)?)?(T(\d+H)?(\d+M)?(\d+S)?)?$/.exec(e);if(!t)throw Error("Invalid ISO8601 duration '"+e+"'");for(var n=[2,3,4,6,7,8],r=[31104e3,2592e3,86400,3600,60,1],i=0,o=0;6>o;o++){var a=t[n[o]];a=a?+a.replace(/[A-Za-z]+/g,""):0,i+=a*r[o]}return i}function v(e){return null===e?"null":void 0===e?"undefined":Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function w(e){return"date"===v(e)&&!isNaN(e.getTime())}function x(e){return"function"===v(e)}function k(e){return"string"==typeof e&&/[a-fA-F\d]{8}-(?:[a-fA-F\d]{4}-){3}[a-fA-F\d]{12}/.test(e)}function E(e){return"string"==typeof e&&/^(-|)?P([0-9]+Y|)?([0-9]+M|)?([0-9]+D|)?T?([0-9]+H|)?([0-9]+M|)?([0-9]+S|)?/.test(e)}function A(e){if(null===e||void 0===e)return!0;for(var t in e)if(P.call(e,t))return!1;return!0}function C(e){return!isNaN(parseFloat(e))&&isFinite(e)}function S(e,t){return e&&t?0===e.indexOf(t,0):!1}function F(e,t){return e&&t?-1!==e.indexOf(t,e.length-t.length):!1}function T(e){var t=arguments,n=RegExp("%([1-"+(arguments.length-1)+"])","g");return e.replace(n,function(e,n){return t[n]})}function D(e){switch(e){case K.String:return Y.string;case K.Int64:return Y.int64;case K.Int32:return Y.int32;case K.Int16:return Y.int16;case K.Decimal:return Y.number;case K.Double:return Y.number;case K.Single:return Y.number;case K.DateTime:return Y.date;case K.Boolean:return Y.bool;case K.Guid:return Y.guid;case K.Byte:return Y.byte;case K.Binary:return Y.none;case K.Time:return Y.duration;case K.Undefined:return Y.none}}function $(e,t,n){var r=n(),i=e.dataType;if(i&&i.parse&&(t=i.parse(t,typeof t)),t!==r){var o,a,s=this,c=e.name,l=this.entityAspect;l?(a=l,o=c):(a=this.complexAspect,l=a.entityAspect,o=a.parent?a.propertyPath+"."+c:c);var u=l._inProcess;if(u){if(u.indexOf(e)>=0)return;u.push(e)}else u=[e],l._inProcess=u;var d=l.entity;try{var h=l.entityManager;if(l.entityState.isUnchangedOrModified()&&void 0===a.originalValues[c]&&e.isDataProperty&&!e.isComplexProperty&&(a.originalValues[c]=void 0!==r?r:e.defaultValue),e.isNavigationProperty){if(!e.isScalar)throw Error("Nonscalar navigation properties are readonly - entities can be added or removed but the collection may not be changed.");var p,g=e.inverse;if(t){if(h){if(t.entityAspect.entityState.isDetached())h.isLoading||h.attachEntity(t,X.Added);else if(t.entityAspect.entityManager!==h)throw Error("An Entity cannot be attached to an entity in another EntityManager. One of the two entities must be detached first.")}else if(t.entityAspect&&t.entityAspect.entityManager){h=t.entityAspect.entityManager;var f=h.isLoading?X.Unchanged:X.Added;h.attachEntity(l.entity,f)}if(g)if(g.isScalar)r&&r.setProperty(g.name,null),t.setProperty(g.name,this);else{if(r){p=r.getProperty(g.name);var m=p.indexOf(this);-1!==m&&p.splice(m,1)}var _=t.getProperty(g.name);_.push(this)}}else if(g)if(g.isScalar)r&&r.setProperty(g.name,null);else if(r){p=r.getProperty(g.name);var m=p.indexOf(this);-1!==m&&p.splice(m,1)}if(n(t),h&&!h.isLoading&&(l.entityState.isUnchanged()&&!e.isUnmapped&&l.setModified(),h.validationOptions.validateOnPropertyChange&&l._validateProperty(t,{entity:this,property:e,propertyName:o,oldValue:r})),e.relatedDataProperties&&!l.entityState.isDeleted()){var y=e.entityType.keyProperties;y.forEach(function(n,r){var i=t?t.getProperty(n.name):n.defaultValue;s.setProperty(e.relatedDataProperties[r].name,i)})}}else if(e.isComplexProperty){if(!t)throw Error(T("You cannot set the '%1' property to null because it's datatype is the ComplexType: '%2'",e.name,e.dataType.name));if(!r){var b=i.getCtor();r=new b,n(r)}i.dataProperties.forEach(function(e){var n=e.name,i=t.getProperty(n);r.setProperty(n,i)})}else{if(e.isPartOfKey&&h&&!h.isLoading){var v=this.entityType.keyProperties,w=v.map(function(n){return n==e?t:this.getProperty(n.name)},this),x=new nt(this.entityType,w);if(h.findEntityByKey(x))throw Error("An entity with this key is already in the cache: "+(""+x));var k=this.entityAspect.getKey(),E=h.findEntityGroup(this.entityType);E._replaceKey(k,x)}if(n(t),h&&!h.isLoading&&(l.entityState.isUnchanged()&&!e.isUnmapped&&l.setModified(),h.validationOptions.validateOnPropertyChange&&l._validateProperty(t,{entity:d,property:e,propertyName:o,oldValue:r})),e.relatedNavigationProperty&&h){var A=e.relatedNavigationProperty;if(t){var C=new nt(A.entityType,[t]),S=h.findEntityByKey(C);S?this.setProperty(A.name,S):h._unattachedChildrenMap.addChild(C,A,this)}else this.setProperty(A.name,null)}e.isPartOfKey&&(r&&!l.entityState.isDetached()&&(l.primaryKeyWasChanged=!0),this.entityType.navigationProperties.forEach(function(n){var r=n.inverse;if(r&&0!==r.foreignKeyNames.length){var i=s.getProperty(n.name),o=s.entityType.keyProperties.indexOf(e),a=r.foreignKeyNames[o];if(n.isScalar){if(!i)return;i.setProperty(a,t)}else i.forEach(function(e){e.setProperty(a,t)})}}),l.getKey(!0))}var F={entity:d,property:e,propertyName:o,oldValue:r,newValue:t};h?h.isLoading||h.isRejectingChanges||(l.propertyChanged.publish(F),h.entityChanged.publish({entityAction:Z.PropertyChange,entity:d,args:F})):l.propertyChanged.publish(F)}finally{u.pop()}}}function L(e){return e.indexOf(":#")>=0}function N(e,t){return e+":#"+t}function O(e,t){if(!e)return null;if(S(e,at.ANONTYPE_PREFIX))return{shortTypeName:e,namespace:"",typeName:e,isAnon:!0};var n=e.split(",")[0],r=n.split(".");if(r.length>1){var i,o=r[r.length-1];if(t)i=R(o,t);else{var a=r.slice(0,r.length-1);i=a.join(".")}return{shortTypeName:o,namespace:i,typeName:N(o,i)}}return{shortTypeName:e,namespace:"",typeName:e}}function R(e,t){var n,r=t.cSpaceOSpaceMapping;if(r){var i=r[t.namespace+"."+e];n=i&&i.substr(0,i.length-(e.length+1))}return n||t.namespace}function B(e,t){var n;if(n=Array.isArray(t)?t:t.split("."),1===n.length)return e.getProperty(t);for(var r=e,i=0;n.length>i&&(r=r.getProperty(n[i]),null!=r);i++);return r}function M(e){return e===K.DateTime?function(e){return e&&e.getTime()}:e===K.Time?function(e){return e&&b(e)}:function(e){return e}}var I={version:"1.2.5"};I.entityModel=I,I.entityTracking_backingStore="backingStore",I.entityTracking_ko="ko",I.entityTracking_backbone="backbone",I.remoteAccess_odata="odata",I.remoteAccess_webApi="webApi";var P=Object.prototype.hasOwnProperty;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var q={};q.getOwnPropertyValues=o,q.objectForEach=e,q.objectMapToArray=n,q.objectFirst=t,q.extend=a,q.propEq=r,q.pluck=i,q.arrayEquals=h,q.arrayFirst=c,q.arrayIndexOf=l,q.arrayRemoveItem=u,q.arrayZip=d,q.requireLib=p,q.using=f,q.wrapExecution=m,q.memoize=_,q.getUuid=y,q.durationToSeconds=b,q.isDate=w,q.isGuid=k,q.isDuration=E,q.isFunction=x,q.isEmpty=A,q.isNumeric=C,q.stringStartsWith=S,q.stringEndsWith=F,q.formatString=T,q.parent=I,I.core=q;var j=function(){function e(e,t){return null==t?!1:"string"==typeof t&&t.length>0}function t(e,t){return null==t?!1:typeof t===e.typeName?!0:!1}function n(e,t){return null==t?!1:t instanceof e.type}function r(e,t){return null==t?!1:void 0!==t[e.propertyName]}function i(e,t){return null==t?!1:e.enumType.contains(t)}function o(e,t){return e.allowNull?void 0!==t:null!=t}function s(e,t){if(null==t)return!0;var n=e.prevContext;return n?n.fn(n,t):!0}function c(e,t){var n=e.prevContext,r=n?" or it "+d(n,t):"";return"is optional"+r}function l(e,t){if(!Array.isArray(t))return!1;if(e.mustNotBeEmpty&&0===t.length)return!1;var n=e.prevContext;return n?t.every(function(e){return n.fn(n,e)}):!0}function u(e,t){var n=e.mustNotBeEmpty?"a nonEmpty array":"an array",r=e.prevContext,i=r?" where each element "+d(r,t):"";return" must be "+n+i}function d(e,t){var n=e.msg;return"function"==typeof n&&(n=n(e,t)),n}function h(e,t){if(e._context){for(var n=e._context;null!=n.prevContext;)n=n.prevContext;if(null===n.prevContext)return n.prevContext=t,e;if(null!==t.prevContext)throw Error("Illegal construction - use 'or' to combine checks");t.prevContext=e._context}return p(e,t)}function p(e,t){return e._contexts[e._contexts.length-1]=t,e._context=t,e}function g(e){var t=e._contexts;return null==t[t.length-1]&&t.pop(),0===t.length?void 0:t.some(function(t){return t.fn(t,e.v)})}var f=function(e,t){this.v=e,this.name=t,this._contexts=[null]},m=f.prototype;return m.isObject=function(){return this.isTypeOf("object")},m.isBoolean=function(){return this.isTypeOf("boolean")},m.isString=function(){return this.isTypeOf("string")},m.isNonEmptyString=function(){return h(this,{fn:e,msg:"must be a nonEmpty string"})},m.isNumber=function(){return this.isTypeOf("number")},m.isFunction=function(){return this.isTypeOf("function")},m.isTypeOf=function(e){return h(this,{fn:t,typeName:e,msg:T("must be a '%1'",e)})},m.isInstanceOf=function(e,t){return h(this,{fn:n,type:e,typeName:t||e.prototype._$typeName,msg:T("must be an instance of '%1'",t)})},m.hasProperty=function(e){return h(this,{fn:r,propertyName:e,msg:T("must have a '%1' property ",e)})},m.isEnumOf=function(e){return h(this,{fn:i,enumType:e,msg:T("must be an instance of the '%1' enumeration",e.name)})},m.isRequired=function(e){return h(this,{fn:o,allowNull:e,msg:"is required"})},m.isOptional=function(){var e={fn:s,prevContext:null,msg:c};return h(this,e)},m.isNonEmptyArray=function(){return this.isArray(!0)},m.isArray=function(e){var t={fn:l,mustNotBeEmpty:e,prevContext:null,msg:u};return h(this,t)},m.or=function(){return this._contexts.push(null),this._context=null,this},m.check=function(e){var t=g(this);if(void 0!==t){if(!t)throw Error(this.getMessage());return void 0!==this.v?this.v:e}},m._addContext=function(e){return h(this,e)},m.getMessage=function(){var e=this,t=this._contexts.map(function(t){return d(t,e.v)}).join(", or it ");return T(this.MESSAGE_PREFIX,this.name)+" "+t},m.withDefault=function(e){return this.defaultValue=e,this},m.whereParam=function(e){return this.parent.whereParam(e)},m.applyAll=function(e,t){t=null==t?!0:t;var n=a({},this.parent.config);if(this.parent.params.forEach(function(r){t&&delete n[r.name],r._applyOne(e)}),t)for(var r in n)if(void 0!==n[r])throw Error("Invalid property in config: "+r)},m._applyOne=function(e){this.check(),void 0!==this.v?e[this.name]=this.v:void 0!==this.defaultValue&&(e[this.name]=this.defaultValue)},m.MESSAGE_PREFIX="The '%1' parameter ",f}(),z=function(e,t){return new j(e,t)},H=function(){var e=function(e){if("object"!=typeof e)throw Error("Configuration parameter should be an object, instead it is a: "+typeof e);this.config=e,this.params=[]},t=e.prototype;return t.whereParam=function(e){var t=new j(this.config[e],e);return t.parent=this,this.params.push(t),t},e}(),U=function(e){return new H(e)};q.Param=j,q.assertParam=z,q.assertConfig=U;var W=function(){function e(){}var t=function(t,n){this.name=t;var r=new e(n);r.parentEnum=this,this._symbolPrototype=r,n&&Object.keys(n).forEach(function(e){r[e]=n[e]})},n=t.prototype;return t.isSymbol=function(t){return t instanceof e},n.fromName=function(e){return this[e]},n.addSymbol=function(e){var t=Object.create(this._symbolPrototype);return e&&Object.keys(e).forEach(function(n){t[n]=e[n]}),setTimeout(function(){t.getName()},0),t},n.seal=function(){this.getSymbols().forEach(function(e){return e.getName()})},n.getSymbols=function(){return this.getNames().map(function(e){return this[e]},this)},n.getNames=function(){var e=[];for(var t in this)this.hasOwnProperty(t)&&("name"==t||"_"===t.substr(0,1)||x(this[t])||e.push(t));return e},n.contains=function(t){return t instanceof e?this[t.getName()]===t:!1},e.prototype.getName=function(){if(!this.name){var e=this;this.name=c(this.parentEnum.getNames(),function(t){return e.parentEnum[t]===e})}return this.name},e.prototype.toString=function(){return this.getName()},e.prototype.toJSON=function(){return{_$typeName:this.parentEnum.name,name:this.name}},t}();q.Enum=W;var G=function(){function e(e,t,r){var i=e._subscribers;return i?(i.forEach(function(i){try{i.callback(t)}catch(o){o.context="unable to publish on topic: "+e.name,r?r(o):e._defaultErrorCallback?e._defaultErrorCallback(o):n(o)}}),void 0):!0}function t(e){if(r[e])return e;var t=c(Object.keys(r),function(t){return 0===t.indexOf(e)});if(!t)throw Error("Unable to find any registered event that matches: "+e);return t}function n(){}var r={},i=function(e,t,n){z(e,"eventName").isNonEmptyString().check(),z(t,"publisher").isObject().check(),this.name=e,r[e]=!0,this.publisher=t,this._nextUnsubKey=1,n&&(this._defaultErrorCallback=n)},o=i.prototype;return o.publish=function(t,n,r){return i._isEnabled(this.name,this.publisher)?(n===!0?setTimeout(e,0,this,t,r):e(this,t,r),!0):!1},o.publishAsync=function(e,t){this.publish(e,!0,t)},o.subscribe=function(e){this._subscribers||(this._subscribers=[]);var t=this._nextUnsubKey;return this._subscribers.push({unsubKey:t,callback:e}),++this._nextUnsubKey,t},o.unsubscribe=function(e){if(!this._subscribers)return!1;var t=this._subscribers,n=l(t,function(t){return t.unsubKey===e});return-1!==n?(t.splice(n,1),0===t.length&&(this._subscribers=null),!0):!1},o.clear=function(){this._subscribers=null},i.bubbleEvent=function(e,t){e._getEventParent=t},i.enable=function(e,n,r){z(e,"eventName").isNonEmptyString().check(),z(n,"obj").isObject().check(),z(r,"isEnabled").isBoolean().isOptional().or().isFunction().check(),e=t(e),n._$eventMap||(n._$eventMap={}),n._$eventMap[e]=r},i._enableFast=function(e,t,n){t._$eventMap||(t._$eventMap={}),t._$eventMap[e.name]=n},i.isEnabled=function(e,n){if(z(e,"eventName").isNonEmptyString().check(),z(n,"obj").isObject().check(),!n._getEventParent)throw Error("This object does not support event enabling/disabling");return i._isEnabled(n,t(e))},i._isEnabled=function(e,t){var n=null,r=t._$eventMap;if(r&&(n=r[e]),null!=n)return"function"==typeof n?n(t):!!n;var o=t._getEventParent&&t._getEventParent();return o?i._isEnabled(e,o):!0},i}();q.Event=G;var V=function(){function e(e,t,n){var r=t.defaultInstance;return r||(r=new t.ctor,t.defaultInstance=r,r._$impl=t),r.initialize(),n&&(e.defaultInstance=r),i.interfaceInitialized.publish({interfaceName:e.name,instance:r,isDefault:!0}),r.checkForRecomposition&&i.interfaceInitialized.subscribe(function(e){r.checkForRecomposition(e)}),r}function r(e){var n=e.toLowerCase(),r=t(i.interfaceRegistry||{},function(e){return e.toLowerCase()===n});if(!r)throw Error("Unknown interface name: "+e);return r.value}var i={};i.functionRegistry={},i.typeRegistry={},i.objectRegistry={},i.interfaceInitialized=new G("interfaceInitialized_config",i);var o=function(e){this.name=e,this.defaultInstance=null,this._implMap={}};return o.prototype.registerCtor=function(e,t){this._implMap[e.toLowerCase()]={ctor:t,defaultInstance:null}},o.prototype.getImpl=function(e){return this._implMap[e.toLowerCase()]},o.prototype.getFirstImpl=function(){var e=t(this._implMap,function(){return!0});return e?e.value:null},i.interfaceRegistry={ajax:new o("ajax"),modelLibrary:new o("modelLibrary"),dataService:new o("dataService")},i.interfaceRegistry.modelLibrary.getDefaultInstance=function(){if(!this.defaultInstance)throw Error("Unable to locate the default implementation of the '"+this.name+"' interface.  Possible options are 'ko', 'backingStore' or 'backbone'. See the breeze.config.initializeAdapterInstances method.");return this.defaultInstance},i.setProperties=function(e){U(e).whereParam("remoteAccessImplementation").isOptional().whereParam("trackingImplementation").isOptional().whereParam("ajaxImplementation").isOptional().applyAll(e),e.remoteAccessImplementation&&i.initializeAdapterInstance("dataService",e.remoteAccessImplementation),e.trackingImplementation&&i.initializeAdapterInstance("modelLibrary",e.trackingImplementation),e.ajaxImplementation&&i.initializeAdapterInstance("ajax",e.ajaxImplementation)},i.registerAdapter=function(e,t){z(e,"interfaceName").isNonEmptyString().check(),z(t,"adapterCtor").isFunction().check();var n=new t,i=n.name;if(!i)throw Error("Unable to locate a 'name' property on the constructor passed into the 'registerAdapter' call.");var o=r(e);o.registerCtor(i,t)},i.getAdapter=function(e,t){var n=r(e);if(t){var i=n.getImpl(t);return i?i.ctor:null}return n.defaultInstance?n.defaultInstance._$impl.ctor:null},i.initializeAdapterInstances=function(e){return U(e).whereParam("dataService").isOptional().whereParam("modelLibrary").isOptional().whereParam("ajax").isOptional(),n(e,i.initializeAdapterInstance)},i.initializeAdapterInstance=function(t,n,i){i=void 0===i?!0:i,z(t,"interfaceName").isNonEmptyString().check(),z(n,"adapterName").isNonEmptyString().check(),z(i,"isDefault").isBoolean().check();var o=r(t),a=o.getImpl(n);if(!a)throw Error("Unregistered adapter.  Interface: "+t+" AdapterName: "+n);return e(o,a,i)},i.getAdapterInstance=function(t,n){var i,o=r(t);return n&""!==n?(i=o.getImpl(n),i?i.defaultInstance:null):o.defaultInstance?o.defaultInstance:(i=o.getFirstImpl(),i.defaultInstance?i.defaultInstance:e(o,i,!0))},i.registerFunction=function(e,t){z(e,"fn").isFunction().check(),z(t,"fnName").isString().check(),e.prototype._$fnName=t,i.functionRegistry[t]=e},i._storeObject=function(e,t,n){var r=("string"==typeof t?t:t.prototype._$typeName)+"."+n;i.objectRegistry[r]=e},i._fetchObject=function(e,t){if(!t)return void 0;var n=("string"==typeof e?e:e.prototype._$typeName)+"."+t,r=i.objectRegistry[n];if(!r)throw Error("Unable to locate a registered object by the name: "+n);return r},i.registerType=function(e,t){z(e,"ctor").isFunction().check(),z(t,"typeName").isString().check(),e.prototype._$typeName=t,i.typeRegistry[t]=e},i.stringifyPad="  ",i}(),J=V.interfaceRegistry.modelLibrary;q.config=V,I.config=V;var K=function(){var e={},t=function(e){return null==e?e:""+e},n=function(e,t){if("string"===t){var n=parseInt(e,10);return isNaN(n)?e:n}return"number"===t?Math.round(e):e},r=function(e,t){if("string"===t){var n=parseFloat(e);return isNaN(n)?e:n}return e},i=function(e,t){if("string"===t){var n=new Date(Date.parse(e));return w(n)?n:e}if("number"===t){var n=new Date(e);return w(n)?n:e}return e},o=function(e,t){if("string"===t){var n=e.trim().toLowerCase();return"false"===n?!1:"true"===n?!0:e}return e},a=new W("DataType",e);a.String=a.addSymbol({defaultValue:"",parse:t}),a.Int64=a.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:n}),a.Int32=a.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:n}),a.Int16=a.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:n}),a.Decimal=a.addSymbol({defaultValue:0,isNumeric:!0,parse:r}),a.Double=a.addSymbol({defaultValue:0,isNumeric:!0,parse:r}),a.Single=a.addSymbol({defaultValue:0,isNumeric:!0,parse:r}),a.DateTime=a.addSymbol({defaultValue:new Date(1900,0,1),parse:i}),a.Time=a.addSymbol({defaultValue:"PT0S"}),a.Boolean=a.addSymbol({defaultValue:!1,parse:o}),a.Guid=a.addSymbol({defaultValue:"00000000-0000-0000-0000-000000000000"}),a.Byte=a.addSymbol({defaultValue:0}),a.Binary=a.addSymbol({defaultValue:null}),a.Undefined=a.addSymbol({defaultValue:void 0}),a.seal(),a.fromEdmDataType=function(e){var t=null,n=e.split(".");if(n.length>1){var r=n[1];"image"===r?t=a.Byte:2==n.length?(t=a.fromName(r),t||(t="DateTimeOffset"===r?a.DateTime:a.Undefined)):t=a.String}return t},a.fromValue=function(e){if(w(e))return a.DateTime;switch(typeof e){case"string":return k(e)?a.Guid:E(e)?a.Time:a.String;case"boolean":return a.Boolean;case"number":return a.Int32}return a.Undefined};var s=/.\d{3}$/;return a.parseDateAsUTC=function(e){if("string"==typeof e){var t=s.test(e);e=t?e+"Z":e}return e=new Date(Date.parse(e))},a.parseDateFromServer=a.parseDateAsUTC,a}();I.DataType=K;var Y=function(){function t(e,t,n){return t?e.replace(/%([^%]+)%/g,function(e,r){var i;return i=n?t.hasOwnProperty(r)?t[r]:"":t[r],i?x(i)?i(t):i:""}):e}function n(e,t,n,r){return d.messageTemplates[e]=T("'%displayName%' must be an integer between the values of %1 and %2",t,n),function(){var i=function(e,r){return null==e?!0:("string"==typeof e&&r&&r.allowString&&(e=parseInt(e,0)),"number"!=typeof e||isNaN(e)||Math.floor(e)!==e?!1:null!=t&&t>e?!1:null!=n&&e>n?!1:!0)};return new d(e,i,r)}}var r=-32768,i=32767,o=-2147483648,s=2147483647,c=0,l=255,u={displayName:function(e){return e.property?e.property.displayName||e.propertyName||e.property.name:"Value"}},d=function(e,t,n){this._baseContext=n||{},this._baseContext.validatorName=e,n=a(Object.create(u),this._baseContext),n.messageTemplate=n.messageTemplate||d.messageTemplates[e],this.name=e,this.valFn=t,this.context=n},h=d.prototype;return h._$typeName="Validator",h.validate=function(e,t){var n;return n=t?a(Object.create(this.context),t):this.context,this.currentContext=n,this.valFn(e,n)?null:(n.value=e,new Q(this,n,this.getMessage()))},h.getMessage=function(){try{var e=this.currentContext,n=e.message;return n?"function"==typeof n?n(e):n:e.messageTemplate?t(e.messageTemplate,e):"invalid value: "+this.validatorName||"{unnamed validator}"}catch(r){return"Unable to format error message"+(""+r)}},h.toJSON=function(){return this._baseContext},d.fromJSON=function(e){var t="Validator."+e.validatorName,n=V.functionRegistry[t];if(!n)throw Error("Unable to locate a validator named:"+e.validatorName);return n(e)},d.register=function(e){V.registerFunction(function(){return e},"Validator."+e.name)},d.registerFactory=function(e,t){V.registerFunction(e,"Validator."+t)},d.messageTemplates={required:"'%displayName%' is required",date:"'%displayName%' must be a date",string:"'%displayName%' must be a string",bool:"'%displayName%' must be a 'true' or 'false' value",guid:"'%displayName%' must be a GUID",duration:"'%displayName%' must be a ISO8601 duration string, such as 'P3H24M60S'",number:"'%displayName%' must be a number",integer:"'%displayName%' must be an integer",integerRange:"'%displayName%' must be an integer between the values of %minValue% and %maxValue%",maxLength:"'%displayName%' must be a string with less than %maxLength% characters",stringLength:"'%displayName%' must be a string with between %minLength% and %maxLength% characters"},d.required=function(){var e=function(e,t){return"string"==typeof e?t&&t.allowEmptyStrings?!0:e.length>0:null!=e};return new d("required",e)},d.maxLength=function(e){var t=function(e,t){return null==e?!0:"string"!=typeof e?!1:e.length<=t.maxLength};return new d("maxLength",t,e)},d.stringLength=function(e){var t=function(e,t){return null==e?!0:"string"!=typeof e?!1:null!=t.minLength&&e.length<t.minLength?!1:null!=t.maxLength&&e.length>t.maxLength?!1:!0};return new d("stringLength",t,e)},d.string=function(){var e=function(e){return null==e?!0:"string"==typeof e};return new d("string",e)},d.guid=function(){var e=function(e){return null==e?!0:k(e)};return new d("guid",e)},d.duration=function(){var e=function(e){return null==e?!0:E(e)};return new d("duration",e)},d.number=d.double=d.single=function(e){var t=function(e,t){return null==e?!0:("string"==typeof e&&t&&t.allowString&&(e=parseInt(e,10)),"number"==typeof e&&!isNaN(e))};return new d("number",t,e)},d.integer=d.int64=function(e){var t=function(e,t){return null==e?!0:("string"==typeof e&&t&&t.allowString&&(e=parseInt(e,10)),"number"==typeof e&&!isNaN(e)&&Math.floor(e)===e)};return new d("integer",t,e)},d.int32=function(e){return n("int32",o,s,e)()},d.int16=function(e){return n("int16",r,i,e)()},d.byte=function(e){return n("byte",c,l,e)()},d.bool=function(){var e=function(e){return null==e?!0:e===!0||e===!1};return new d("bool",e)},d.none=function(){var e=function(){return!0};return new d("none",e)},d.date=function(){var e=function(e){if(null==e)return!0;if("string"!=typeof e)return w(e);try{return!isNaN(Date.parse(e))}catch(t){return!1}};return new d("date",e)},e(d,function(e,t){"function"==typeof t&&"fromJSON"!==e&&"register"!==e&&"registerFactory"!==e&&V.registerFunction(t,"Validator."+e)}),d}(),Q=function(){var e=function(e,t,n){z(e,"validator").isString().or().isInstanceOf(Y).check(),this.validator=e,t=t||{},this.context=t,this.property=t.property,this.property&&(this.propertyName=t.propertyName||t.property.name),this.errorMessage=n,this.key=Q.getKey(e,this.propertyName)};return e.getKey=function(e,t){return(t||"")+":"+e.name},e}();K.getSymbols().forEach(function(e){e.validatorCtor=D(e)}),I.Validator=Y,I.ValidationError=Q;var X=function(){var e={isUnchanged:function(){return this===t.Unchanged},isAdded:function(){return this===t.Added},isModified:function(){return this===t.Modified},isDeleted:function(){return this===t.Deleted},isDetached:function(){return this===t.Detached},isUnchangedOrModified:function(){return this===t.Unchanged||this===t.Modified},isAddedModifiedOrDeleted:function(){return this===t.Added||this===t.Modified||this===t.Deleted}},t=new W("EntityState",e);return t.Unchanged=t.addSymbol(),t.Added=t.addSymbol(),t.Modified=t.addSymbol(),t.Deleted=t.addSymbol(),t.Detached=t.addSymbol(),t.seal(),t}(),Z=function(){var e={isAttach:function(){return!!this.isAttach},isDetach:function(){return!!this.isDetach},isModification:function(){return!!this.isModification}},t=new W("EntityAction",e);return t.Attach=t.addSymbol({isAttach:!0}),t.AttachOnQuery=t.addSymbol({isAttach:!0}),t.AttachOnImport=t.addSymbol({isAttach:!0}),t.Detach=t.addSymbol({isDetach:!0}),t.MergeOnQuery=t.addSymbol({isModification:!0}),t.MergeOnImport=t.addSymbol({isModification:!0}),t.MergeOnSave=t.addSymbol({isModification:!0}),t.PropertyChange=t.addSymbol({isModification:!0}),t.EntityStateChange=t.addSymbol(),t.AcceptChanges=t.addSymbol(),t.RejectChanges=t.addSymbol({isModification:!0}),t.Clear=t.addSymbol({isDetach:!0}),t.seal(),t}(),et=function(){function t(e){var n=e.entityAspect||e.complexAspect,r=e.entityType||e.complexType,i=n.originalValues;for(var o in i)e.setProperty(o,i[o]);r.complexProperties.forEach(function(n){var r=e.getProperty(n.name);t(r)})}function n(e){var t=e.entityAspect||e.complexAspect;t.originalValues={};var r=e.entityType||e.complexType;r.complexProperties.forEach(function(t){var r=e.getProperty(t.name);n(r)})}function r(e){var t=!0,n=e.entityType||e.complexType,o=e.entityAspect||e.complexAspect,a=e.entityAspect||e.complexAspect.entityAspect;return n.getProperties().forEach(function(n){var i=e.getProperty(n.name),s=o.propertyPath?o.propertyPath+"."+n.name:n.name;if(n.validators.length>0){var c={entity:a.entity,property:n,propertyName:s};t=a._validateProperty(i,c)&&t}n.isComplexProperty&&(t=r(i)&&t)}),n.validators.forEach(function(e){t=i(a,e,o.entity)&&t}),t}function i(e,t,n,r){var i=t.validate(n,r);return i?(e._addValidationError(i),!1):(e._removeValidationError(t,r?r.propertyName:null),!0)}var a=function(e){if(null===e){var t=et._nullInstance;if(t)return t;et._nullInstance=this}else{if(void 0===e)throw Error("The EntityAspect ctor requires an entity as its only argument.");if(e.entityAspect)return e.entityAspect}if(!(this instanceof et))return new et(e);if(this.entity=e,this.entityGroup=null,this.entityManager=null,this.entityState=X.Detached,this.isBeingSaved=!1,this.originalValues={},this._validationErrors={},this.validationErrorsChanged=new G("validationErrorsChanged_entityAspect",this),this.propertyChanged=new G("propertyChanged_entityAspect",this),null!=e){e.entityAspect=this;var n=e.entityType;if(!n){var r=e.prototype._$typeName;throw r?Error("Metadata for this entityType has not yet been resolved: "+r):Error("This entity is not registered as a valid EntityType")}var i=n.getEntityCtor();J.getDefaultInstance().startTracking(e,i.prototype)}},s=a.prototype;return s._postInitialize=function(){var e=this.entity,t=e.entityType.getEntityCtor(),n=t._$initializationFn;n&&("string"==typeof n&&(n=e[n]),n(e))},G.bubbleEvent(s,function(){return this.entityManager}),s.getKey=function(e){if(e=z(e,"forceRefresh").isBoolean().isOptional().check(!1),e||!this._entityKey){var t=this.entity.entityType,n=t.keyProperties,r=n.map(function(e){return this.entity.getProperty(e.name)},this);this._entityKey=new nt(t,r)}return this._entityKey},s.acceptChanges=function(){var e=this.entityManager;this.entityState.isDeleted()?e.detachEntity(this.entity):this.setUnchanged(),e.entityChanged.publish({entityAction:Z.AcceptChanges,entity:this.entity})},s.rejectChanges=function(){var e=this.entity,n=this.entityManager;f(n,"isRejectingChanges",!0,function(){t(e)}),this.entityState.isAdded()?(n.detachEntity(e),n._notifyStateChange(e,!1)):(this.entityState.isDeleted()&&this.entityManager._linkRelatedEntities(e),this.setUnchanged(),this.propertyChanged.publish({entity:e,propertyName:null}),this.entityManager.entityChanged.publish({entityAction:Z.RejectChanges,entity:e}))},s.setUnchanged=function(){n(this.entity),delete this.hasTempKey,this.entityState=X.Unchanged,this.entityManager._notifyStateChange(this.entity,!1)},s.setModified=function(){this.entityState=X.Modified,this.entityManager._notifyStateChange(this.entity,!0)},s.setDeleted=function(){var e=this.entityManager;this.entityState.isAdded()?(e.detachEntity(this.entity),e._notifyStateChange(this.entity,!1)):(this.entityState=X.Deleted,this._removeFromRelations(),e._notifyStateChange(this.entity,!0))},s.validateEntity=function(){var e=!0;return this._processValidationOpAndPublish(function(t){e=r(t.entity)}),e},s.validateProperty=function(e,t){var n=this.getPropertyValue(e);return n.complexAspect?r(n):(t=t||{},t.entity=this.entity,"string"==typeof e?(t.property=this.entity.entityType.getProperty(e,!0),t.propertyName=e):(t.property=e,t.propertyName=e.name),this._validateProperty(n,t))},s.getValidationErrors=function(e){z(e,"property").isOptional().isEntityProperty().or().isString().check();var t=o(this._validationErrors);if(e){var n="string"==typeof e?e:e.name;t=t.filter(function(e){return e.property.name===n})}return t},s.addValidationError=function(e){z(e,"validationError").isInstanceOf(Q).check(),this._processValidationOpAndPublish(function(t){t._addValidationError(e)})},s.removeValidationError=function(e,t){z(e,"validator").isString().or().isInstanceOf(Y).check(),z(t,"property").isOptional().isEntityProperty().check(),this._processValidationOpAndPublish(function(n){n._removeValidationError(e,t&&t.name)
})},s.clearValidationErrors=function(){this._processValidationOpAndPublish(function(t){e(t._validationErrors,function(e,n){n&&(delete t._validationErrors[e],t._pendingValidationResult.removed.push(n))})})},s.getParentKey=function(e){var t=e.foreignKeyNames;if(0===t.length)return null;var n=this,r=t.map(function(e){return n.entity.getProperty(e)});return new nt(e.entityType,r)},s.getPropertyValue=function(e){z(e,"property").isString().or().isEntityProperty().check();var t;if("string"==typeof e){var n=e.trim().split("."),r=n.shift();for(t=this.entity,t=t.getProperty(r);n.length>0;)r=n.shift(),t=t.getProperty(r)}else{if(!(e.parentType instanceof lt))throw Error("The validateProperty method does not accept a 'property' parameter whose parentType is a ComplexType; Pass a 'property path' string as the 'property' paramter instead ");t=this.entity.getProperty(e.name)}return t},s._detach=function(){this.entityGroup=null,this.entityManager=null,this.entityState=X.Detached,this.originalValues={},this._validationErrors={},this.validationErrorsChanged.clear(),this.propertyChanged.clear()},s._removeFromRelations=function(){var e=this.entity;e.entityType.navigationProperties.forEach(function(t){var n=t.inverse;if(n){var r=e.getProperty(t.name);if(t.isScalar){if(r){if(n.isScalar)r.setProperty(n.name,null);else{var i=r.getProperty(n.name);i.length&&u(i,e)}e.setProperty(t.name,null)}}else r.slice(0).forEach(function(e){n.isScalar&&e.setProperty(n.name,null)}),r.length=0}})},s._validateProperty=function(e,t){var n=!0;return this._processValidationOpAndPublish(function(r){t.property.validators.forEach(function(o){n=n&&i(r,o,e,t)})}),n},s._processValidationOpAndPublish=function(e){if(this._pendingValidationResult)e(this);else try{this._pendingValidationResult={entity:this.entity,added:[],removed:[]},e(this),(this._pendingValidationResult.added.length>0||this._pendingValidationResult.removed.length>0)&&this.validationErrorsChanged.publish(this._pendingValidationResult)}finally{this._pendingValidationResult=void 0}},s._addValidationError=function(e){this._validationErrors[e.key]=e,this._pendingValidationResult.added.push(e)},s._removeValidationError=function(e,t){var n=Q.getKey(e,t),r=this._validationErrors[n];r&&(delete this._validationErrors[n],this._pendingValidationResult.removed.push(r))},a}(),tt=function(){var e=function(e,t,n){if(!e)throw Error("The  ComplexAspect ctor requires an entity as its only argument.");if(e.complexAspect)return e.complexAspect;if(!(this instanceof tt))return new tt(e,t,n);if(this.complexObject=e,e.complexAspect=this,this.originalValues={},null==t)this.entityAspect=new et(null);else{this.parent=t,this.parentProperty=n,this.propertyPath=n;for(var r=t;r.complexType;)this.propertyPath=r.complexAspect.propertyPath+"."+this.propertyPath,r=r.complexType.parent;this.entityAspect=r.entityAspect}var i=e.complexType;if(!i){var o=e.prototype._$typeName;throw o?Error("Metadata for this complexType has not yet been resolved: "+o):Error("This entity is not registered as a valid ComplexType")}var a=i.getCtor();J.getDefaultInstance().startTracking(e,a.prototype)},t=e.prototype;return t._postInitialize=function(){var e=this.complexObject,t=e.complexType.getCtor(),n=t._$initializationFn;n&&("string"==typeof n?e[n](e):t._$initializationFn(e))},e}(),nt=function(){function e(e){return e.join(t)}var t=":::",n=function(t,n){Array.isArray(n)||(n=Array.prototype.slice.call(arguments,1)),this.entityType=t,this.values=n,this._keyInGroup=e(n)};n._$typeName="EntityKey";var r=n.prototype;return r.toJSON=function(){return{entityType:this.entityType.name,values:this.values}},n.fromJSON=function(e,t){var n=t.getEntityType(e.entityType,!0);return new nt(n,e.values)},r.equals=function(e){return e instanceof nt?this.entityType===e.entityType&&h(this.values,e.values):!1},r.toString=function(){return this.entityType.name+"-"+this._keyInGroup},n.equals=function(e,t){return e instanceof nt?e.equals(t):!1},r._isEmpty=function(){return 0===this.values.join("").length},n._fromRawEntity=function(e,t){var n=t.keyProperties.map(function(t){return e[t.nameOnServer]});return new nt(t,n)},n}();I.EntityAspect=et,I.ComplexAspect=tt,I.EntityState=X,I.EntityAction=Z,I.EntityKey=nt;var rt=p("Q","See https://github.com/kriskowal/q "),it=function(){var e=function(e){U(e||{}).whereParam("name").isOptional().isString().whereParam("isCaseSensitive").isOptional().isBoolean().withDefault(!1).whereParam("usesSql92CompliantStringComparison").isBoolean().withDefault(!0).applyAll(this),this.name||(this.name=y()),V._storeObject(this,t._$typeName,this.name)},t=e.prototype;return t._$typeName="LocalQueryComparisonOptions",e.caseInsensitiveSQL=new e({name:"caseInsensitiveSQL",isCaseSensitive:!1,usesSql92CompliantStringComparison:!0}),e.defaultInstance=e.caseInsensitiveSQL,t.setAsDefault=function(){return e.defaultInstance=this,this},e}(),ot=function(){var e=function(e){U(e||{}).whereParam("name").isOptional().isString().whereParam("serverPropertyNameToClient").isFunction().whereParam("clientPropertyNameToServer").isFunction().applyAll(this),this.name||(this.name=y()),V._storeObject(this,t._$typeName,this.name)},t=e.prototype;return t._$typeName="NamingConvention",e.none=new e({name:"noChange",serverPropertyNameToClient:function(e){return e},clientPropertyNameToServer:function(e){return e}}),e.camelCase=new e({name:"camelCase",serverPropertyNameToClient:function(e){return e.substr(0,1).toLowerCase()+e.substr(1)},clientPropertyNameToServer:function(e){return e.substr(0,1).toUpperCase()+e.substr(1)}}),e.defaultInstance=e.none,t.setAsDefault=function(){return e.defaultInstance=this,this},e}(),at=function(){function t(){return function(){}}function r(e,t,n,r){var i=l(e,n,!1),o=t[i];if(!o){if(r)return null;throw Error("Unable to locate a 'Type' by the name: "+n)}if(o.length){var a=o.join(",");throw Error("There are multiple types with this 'shortName': "+a)}return o}function o(e){var t=[];for(var n in e){var r=e[n];n===r.name&&t.push(e[n])}return t}function s(e,t){var n=e._typeRegistry[t.name]||e._typeRegistry[t.shortName];n&&(n.prototype._$typeName=t.name,t._setCtor(n),e._structuralTypeMap[t.name]=t)}function l(e,t,n){if(L(t))return t;var r=e._shortNameMap[t];if(!r&&n)throw Error("Unable to locate 'entityTypeName' of: "+t);return r}function u(e,t,n){var r=e.name,o=R(r,t),a=new lt({shortName:r,namespace:o}),s=v(e.key.propertyRef).map(i("name"));return v(e.property).forEach(function(e){h(a,e,t,s)}),v(e.navigationProperty).forEach(function(e){_(a,e,t)}),n.addEntityType(a),a}function d(e,t,n){var r=e.name,i=R(r,t),o=new ut({shortName:r,namespace:i});return v(e.property).forEach(function(e){h(o,e,t)}),n.addEntityType(o),o}function h(e,t,n,r){var i,o=t.type.split(".");return 2==o.length?i=g(e,t,r):p(t,n)?(i=g(e,t,r),i&&(i.enumType=t.type)):i=f(e,t,n),i&&(e.addProperty(i),m(i)),i}function p(e,t){if(!t.enumType)return!1;var n=v(t.enumType),r=e.type.split("."),i=r[r.length-1];return n.some(function(e){return e.name===i})}function g(e,t,n){var r=K.fromEdmDataType(t.type);if(null==r)return e.warnings.push("Unable to recognize DataType for property: "+t.name+" DateType: "+t.type),null;var i="true"===t.nullable||null==t.nullable,o=t.fixedLength?t.fixedLength===!0:void 0,a=null!=n&&n.indexOf(t.name)>=0;e.autoGeneratedKeyType==pt.None&&y(t)&&(e.autoGeneratedKeyType=pt.Identity);var s=t.maxLength;s=null==s||"Max"===s?null:parseInt(s);var c=new dt({nameOnServer:t.name,dataType:r,isNullable:i,isPartOfKey:a,maxLength:s,fixedLength:o,concurrencyMode:t.concurrencyMode});return r===K.Undefined&&(c.rawTypeName=t.type),c}function f(e,t,n){var r=O(t.type,n).typeName,i=new dt({nameOnServer:t.name,complexTypeName:r,isNullable:!1});return i}function m(e){var t;if(e.isNullable||e.validators.push(Y.required()),!e.isComplexProperty){if(e.dataType===K.String)if(e.maxLength){var n={maxLength:e.maxLength};t=Y.maxLength(n)}else t=Y.string();else t=e.dataType.validatorCtor();e.validators.push(t)}}function _(e,t,n){var r=b(t,n),o=c(r.end,function(e){return e.role===t.toRole}),a=!("*"===o.multiplicity),s=O(o.type,n).typeName,l=[];if(o&&a){var u=r.referentialConstraint;if(u){var d,h=u.principal,p=u.dependent;d=t.fromRole===h.role?v(h.propertyRef):v(p.propertyRef),l=d.map(i("name"))}}var g=new ht({nameOnServer:t.name,entityTypeName:s,isScalar:a,associationName:r.name,foreignKeyNamesOnServer:l});return e.addProperty(g),g}function y(e){var t=c(Object.keys(e),function(e){return e.indexOf("StoreGeneratedPattern")>=0});if(t)return"Identity"===e[t];var n=e.extensions;if(!n)return!1;var r=c(n,function(e){return"StoreGeneratedPattern"===e.name&&"Identity"===e.value});return!!r}function b(e,t){var n=O(e.relationship,t).shortTypeName,r=t.association;if(!r)return null;Array.isArray(r)||(r=[r]);var i=c(r,function(e){return e.name===n});return i}function v(e){return e?Array.isArray(e)?e:[e]:[]}var w=0,x=function(e){e=e||{},U(e).whereParam("namingConvention").isOptional().isInstanceOf(ot).withDefault(ot.defaultInstance).whereParam("localQueryComparisonOptions").isOptional().isInstanceOf(it).withDefault(it.defaultInstance).applyAll(this),this.dataServices=[],this._resourceEntityTypeMap={},this._entityTypeResourceMap={},this._structuralTypeMap={},this._shortNameMap={},this._id=w++,this._typeRegistry={},this._incompleteTypeMap={}},k=x.prototype;return k._$typeName="MetadataStore",x.ANONTYPE_PREFIX="_IB_",k.addDataService=function(e){z(e,"dataService").isInstanceOf(st).check();var t=this.dataServices.some(function(t){return e.serviceName===t.serviceName});if(t)throw Error("A dataService with this name '"+e.serviceName+"' already exists in this MetadataStore");this.dataServices.push(e)},k.addEntityType=function(e){if(this.getEntityType(e.name,!0),e.metadataStore=this,!e.isAnonymous&&(this._structuralTypeMap[e.name]=e,this._shortNameMap[e.shortName]=e.name,e instanceof lt)){var t=this._entityTypeResourceMap[e.name];t&&(e.defaultResourceName=t)}e._fixup(),e.getProperties().forEach(function(t){t.isUnmapped||e._mappedPropertiesCount++})},k.exportMetadata=function(){var e=JSON.stringify(this,function(e,t){return"metadataStore"===e?null:"adapterInstance"===e?null:"namingConvention"===e||"localQueryComparisonOptions"===e?t.name:t},V.stringifyPad);return e},k.importMetadata=function(t){var n=JSON.parse(t),r=n.namingConvention,i=n.localQueryComparisonOptions;if(delete n.namingConvention,delete n.localQueryComparisonOptions,this.isEmpty())this.namingConvention=V._fetchObject(ot,r),this.localQueryComparisonOptions=V._fetchObject(it,i);else{if(this.namingConvention.name!==r)throw Error("Cannot import metadata with a different 'namingConvention' from the current MetadataStore");if(this.localQueryComparisonOptions.name!==i)throw Error("Cannot import metadata with different 'localQueryComparisonOptions' from the current MetadataStore")}var o={},c=this;return e(n._structuralTypeMap,function(e,t){o[e]=c._structuralTypeFromJson(t),s(c,o[e])}),n._structuralTypeMap=o,a(this,n),this},x.importMetadata=function(e){var t=new at;return t.importMetadata(e),t},k.hasMetadataFor=function(e){return!!this.getDataService(e)},k.getDataService=function(e){return z(e,"serviceName").isString().check(),e=st._normalizeServiceName(e),c(this.dataServices,function(t){return t.serviceName===e})},k.fetchMetadata=function(e,t,n){if(z(e,"dataService").isString().or().isInstanceOf(st).check(),z(t,"callback").isFunction().isOptional().check(),z(n,"errorCallback").isFunction().isOptional().check(),"string"==typeof e&&(e=this.getDataService(e)||new st({serviceName:e})),this.hasMetadataFor(e.serviceName))throw Error("Metadata for a specific serviceName may only be fetched once per MetadataStore. ServiceName: "+e.serviceName);var r=rt.defer();return e.adapterInstance.fetchMetadata(this,e,r.resolve,r.reject),r.promise.then(function(e){return t&&t(e),rt.resolve(e)},function(e){return n&&n(e),rt.reject(e)})},k.trackUnmappedType=function(e,t){z(e,"entityCtor").isFunction().check(),z(t,"interceptor").isFunction().isOptional().check();var n=new lt(this);n._setCtor(e,t)},k.registerEntityTypeCtor=function(e,n,r){z(e,"structuralTypeName").isString().check(),z(n,"aCtor").isFunction().isOptional().check(),z(r,"initializationFn").isOptional().isFunction().or().isString().check(),n||(n=t());var i,o=l(this,e,!1);if(o){var a=this._structuralTypeMap[o];a&&a._setCtor(n),i=o}else i=e;n.prototype._$typeName=i,this._typeRegistry[i]=n,r&&(n._$initializationFn=r)},k.isEmpty=function(){return 0===this.dataServices.length},k.getEntityType=function(e,t){return z(e,"structuralTypeName").isString().check(),z(t,"okIfNotFound").isBoolean().isOptional().check(!1),r(this,this._structuralTypeMap,e,t)},k.getEntityTypes=function(){return o(this._structuralTypeMap)},k.getIncompleteNavigationProperties=function(){return n(this._structuralTypeMap,function(e,t){if(t instanceof ut)return null;var n=t.navigationProperties.filter(function(e){return!e.entityType});return 0===n.length?null:n})},k.getEntityTypeNameForResourceName=function(e){return z(e,"resourceName").isString().check(),this._resourceEntityTypeMap[e]},k.setEntityTypeForResourceName=function(e,t){z(e,"resourceName").isString().check(),z(t,"entityTypeOrName").isInstanceOf(lt).or().isString().check();var n;n=t instanceof lt?t.name:l(this,t,!0),this._resourceEntityTypeMap[e]=n,this._entityTypeResourceMap[n]=e;var r=this.getEntityType(n,!0);r&&(r.defaultResourceName=r.defaultResourceName||e)},k._structuralTypeFromJson=function(e){var t=this.getEntityType(e.name,!0);if(t)return t;var n={shortName:e.shortName,namespace:e.namespace},r=!!e.navigationProperties;return t=r?new lt(n):new ut(n),e.validators=e.validators.map(Y.fromJSON),e.dataProperties=e.dataProperties.map(function(e){return dt.fromJSON(e,t)}),r&&(e.autoGeneratedKeyType=pt.fromName(e.autoGeneratedKeyType),e.navigationProperties=e.navigationProperties.map(function(e){return ht.fromJSON(e,t)})),t=a(t,e),this.addEntityType(t),t},k._checkEntityType=function(e){if(!e.entityType){var t=e.prototype._$typeName;if(!t)throw Error("This entity has not been registered. See the MetadataStore.registerEntityTypeCtor method");var n=this.getEntityType(t);n&&(e.entityType=n)}},k._parseODataMetadata=function(e,t){var n=this;v(t).forEach(function(e){if(e.cSpaceOSpaceMapping){var t=JSON.parse(e.cSpaceOSpaceMapping),r={};t.forEach(function(e){r[e[0]]=e[1]}),e.cSpaceOSpaceMapping=r}e.entityContainer&&v(e.entityContainer).forEach(function(t){v(t.entitySet).forEach(function(t){var r=O(t.entityType,e).typeName;n.setEntityTypeForResourceName(t.name,r)})}),e.complexType&&v(e.complexType).forEach(function(t){var r=d(t,e,n);s(n,r)}),e.entityType&&v(e.entityType).forEach(function(t){var r=u(t,e,n);s(n,r)})});var r=this.getIncompleteNavigationProperties();if(r.length>0)throw Error("Bad nav properties")},x}(),st=function(){var e=function(e){if(1!=arguments.length)throw Error("The DataService ctor should be called with a single argument that is a configuration object.");U(e).whereParam("serviceName").isNonEmptyString().whereParam("adapterName").isString().isOptional().withDefault(null).whereParam("hasServerMetadata").isBoolean().isOptional().withDefault(!0).whereParam("jsonResultsAdapter").isInstanceOf(ct).isOptional().withDefault(null).applyAll(this),this.serviceName=st._normalizeServiceName(this.serviceName),this.adapterInstance=V.getAdapterInstance("dataService",this.adapterName),this.jsonResultsAdapter||(this.jsonResultsAdapter=this.adapterInstance.jsonResultsAdapter)},t=e.prototype;return t._$typeName="DataService",e._normalizeServiceName=function(e){return e=e.trim(),"/"!==e.substr(-1)?e+"/":e},t.toJSON=function(){var e=s(this);return e.jsonResultsAdapter=this.jsonResultsAdapter.name,e},e.fromJSON=function(e){return e.jsonResultsAdapter=V._fetchObject(ct,e.jsonResultsAdapter),new st(e)},e}(),ct=function(){function e(e){return e.results}var t=function(t){if(1!=arguments.length)throw Error("The JsonResultsAdapter ctor should be called with a single argument that is a configuration object.");U(t).whereParam("name").isNonEmptyString().whereParam("extractResults").isFunction().isOptional().withDefault(e).whereParam("visitNode").isFunction().applyAll(this),V._storeObject(this,n._$typeName,this.name)},n=t.prototype;return n._$typeName="JsonResultsAdapter",t}(),lt=function(){function t(){return function(){}}function n(t){var r=t.metadataStore._incompleteTypeMap,i=r[t.name];return A(i)?(delete r[t.name],void 0):(i&&e(i,function(e,r){r.entityType||r.entityTypeName===t.name&&(r.entityType=t,delete i[e],n(r.parentType))}),void 0)}function o(e){if(!e.foreignKeyProperties){var t=a(e);t&&t.forEach(function(t){t.relatedNavigationProperty=e,e.parentType.foreignKeyProperties.push(t),e.relatedDataProperties?e.relatedDataProperties.push(t):e.relatedDataProperties=[t]})}}function a(e){var t=e.foreignKeyNames,n=0==t.length;if(n&&(t=e.foreignKeyNamesOnServer,0==t.length))return e.foreignKeyProperties=[],e.foreignKeyProperties;var r=!0,o=e.parentType,a=t.map(function(e){var t=o.getDataProperty(e,n);return r=r&&!!t,t});return r?(n&&(e.foreignKeyNames=a.map(i("name"))),e.foreignKeyProperties=a,a):null}function l(e){var t=e.parentType.metadataStore,n=t._incompleteTypeMap,r=t.getEntityType(e.entityTypeName,!0);r&&(e.entityType=r);var i=n[e.entityTypeName];if(i){var o=i[e.associationName];o?d(n,e,o):u(n,e)}else u(n,e)}function u(e,t){if(!t.entityType){var n=e[t.entityTypeName];n||(n={},e[t.entityTypeName]=n),n[t.associationName]=t}var r=e[t.parentType.name];r||(r={},e[t.parentType.name]=r),r[t.associationName]=t}function d(e,t,n){t.inverse=n;var r=e[t.entityTypeName];if(delete r[t.associationName],A(r)&&delete e[t.entityTypeName],!n.inverse){n.inverse=t,null==n.entityType&&(n.entityType=t.parentType);var i=e[t.parentType.name];i&&(delete i[t.associationName],A(i)&&delete e[t.parentType.name])}}function h(e,t){var n=e.getPropertyNames(),r=J.getDefaultInstance().getTrackablePropertyNames(t);r.forEach(function(t){if(-1==n.indexOf(t)){var r=new dt({name:t,dataType:K.Undefined,isNullable:!0,isUnmapped:!0});e.addProperty(r)}})}var p=0,g=function(e){if(arguments.length>1)throw Error("The EntityType ctor has a single argument that is either a 'MetadataStore' or a configuration object.");"MetadataStore"===e._$typeName?(this.metadataStore=e,this.shortName="Anon_"+ ++p,this.namespace="",this.isAnonymous=!0):U(e).whereParam("shortName").isNonEmptyString().whereParam("namespace").isString().isOptional().withDefault("").whereParam("autoGeneratedKeyType").isEnumOf(pt).isOptional().withDefault(pt.None).whereParam("defaultResourceName").isNonEmptyString().isOptional().withDefault(null).applyAll(this),this.name=N(this.shortName,this.namespace),this.dataProperties=[],this.navigationProperties=[],this.complexProperties=[],this.keyProperties=[],this.foreignKeyProperties=[],this.concurrencyProperties=[],this.unmappedProperties=[],this.validators=[],this.warnings=[],this._mappedPropertiesCount=0},f=g.prototype;return f._$typeName="EntityType",f.setProperties=function(e){U(e).whereParam("autoGeneratedKeyType").isEnumOf(pt).isOptional().whereParam("defaultResourceName").isString().isOptional().applyAll(this),e.defaultResourceName&&(this.defaultResourceName=e.defaultResourceName)},f.addProperty=function(e){if(z(e,"dataProperty").isInstanceOf(dt).or().isInstanceOf(ht).check(),this.metadataStore&&!e.isUnmapped)throw Error("The '"+this.name+"' EntityType has already been added to a MetadataStore and therefore no additional properties may be added to it.");if(e.parentType){if(e.parentType!==this)throw Error("This dataProperty has already been added to "+e.parentType.name);return this}return e.parentType=this,e.isDataProperty?this._addDataProperty(e):this._addNavigationProperty(e),this},f.createEntity=function(t){var n=this._createEntityCore();return t&&e(t,function(e,t){n.setProperty(e,t)}),n.entityAspect._postInitialize(),n},f._createEntityCore=function(){var e=this.getEntityCtor(),t=new e;return new et(t),t},f.getEntityCtor=function(){if(this._ctor)return this._ctor;var e=this.metadataStore._typeRegistry,n=e[this.name]||e[this.shortName];if(!n){var r=J.getDefaultInstance().createCtor;n=r?r(this):t()}return this._setCtor(n),n},f._setCtor=function(e,t){var n=new e,r=e.prototype;"EntityType"==this._$typeName?(h(this,n),r.entityType=this):(h(this,n),r.complexType=this),r._$interceptor=t?t:$,J.getDefaultInstance().initializeEntityPrototype(r),this._ctor=e},f.addValidator=function(e,t){z(e,"validator").isInstanceOf(Y).check(),z(t,"property").isOptional().isString().or().isEntityProperty().check(),t?("string"==typeof t&&(t=this.getProperty(t,!0)),t.validators.push(e)):this.validators.push(e)},f.getProperties=function(){return this.dataProperties.concat(this.navigationProperties)},f.getPropertyNames=function(){return this.getProperties().map(i("name"))},f.getDataProperty=function(e,t){var n=t?"nameOnServer":"name";return c(this.dataProperties,r(n,e))},f.getNavigationProperty=function(e,t){var n=t?"nameOnServer":"name";return c(this.navigationProperties,r(n,e))},f.getProperty=function(e,t){t=t||!1;var n=Array.isArray(e)?e:e.trim().split("."),i=n[0],o=c(this.getProperties(),r("name",i));if(1===n.length){if(o)return o;if(t)throw Error("unable to locate property: "+i+" on entityType: "+this.name);return null}if(o){n.shift();var a=o.isNavigationProperty?o.entityType:o.dataType;if(a)return a.getProperty(n,t);throw Error("should not get here - unknown property type for: "+o.name)}if(t)throw Error("unable to locate property: "+i+" on type: "+this.name);return null},f.toString=function(){return this.name},f.toJSON=function(){return s(this,["dataProperties","navigationProperties","validators"])},f._clientPropertyPathToServer=function(e){var t=this.metadataStore.namingConvention.clientPropertyNameToServer,n=this,r=e.split(".").map(function(e){var r=n.getProperty(e);return t(e,r)}).join("/");return r},f._updateProperty=function(e){var t,n,r=this.metadataStore.namingConvention,i=e.nameOnServer;if(i){if(t=r.serverPropertyNameToClient(i,e),n=r.clientPropertyNameToServer(t,e),i!==n)throw Error("NamingConvention for this server property name does not roundtrip properly:"+i+"-->"+n);e.name=t}else{if(t=e.name,i=r.clientPropertyNameToServer(t,e),n=r.serverPropertyNameToClient(i,e),t!==n)throw Error("NamingConvention for this client property name does not roundtrip properly:"+t+"-->"+n);e.nameOnServer=i}if(e.isComplexProperty){var a=this.metadataStore.getEntityType(e.complexTypeName,!1);if(!(a&&a instanceof ut))throw Error("Unable to resolve ComplexType with the name: "+e.complexTypeName+" for the property: "+e.name);e.dataType=a,e.defaultValue=null}else e.isNavigationProperty&&(o(e),l(e))},g._getNormalizedTypeName=_(function(e){return e&&O(e).typeName}),f._checkNavProperty=function(e){if(e.isNavigationProperty){if(e.parentType!=this)throw Error(T("The navigationProperty '%1' is not a property of entity type '%2'",e.name,this.name));return e}if("string"==typeof e){var t=this.getProperty(e);if(t&&t.isNavigationProperty)return t}throw Error("The 'navigationProperty' parameter must either be a NavigationProperty or the name of a NavigationProperty")},f._addDataProperty=function(e){this.dataProperties.push(e),e.isPartOfKey&&this.keyProperties.push(e),e.isComplexProperty&&this.complexProperties.push(e),e.concurrencyMode&&"None"!==e.concurrencyMode&&this.concurrencyProperties.push(e),e.isUnmapped&&this.unmappedProperties.push(e)},f._addNavigationProperty=function(e){this.navigationProperties.push(e),L(e.entityTypeName)||(e.entityTypeName=N(e.entityTypeName,this.namespace))},f._fixup=function(){var e=this;this.getProperties().forEach(function(t){e._updateProperty(t)}),n(this)},g}(),ut=function(){var t=function(e){if(arguments.length>1)throw Error("The ComplexType ctor has a single argument that is a configuration object.");U(e).whereParam("shortName").isNonEmptyString().whereParam("namespace").isString().isOptional().withDefault("").applyAll(this),this.name=N(this.shortName,this.namespace),this.dataProperties=[],this.complexProperties=[],this.validators=[],this.concurrencyProperties=[],this.unmappedProperties=[]},n=t.prototype;return n.createInstance=function(t){var n=this._createInstanceCore();return t&&e(t,function(e,t){n.setProperty(e,t)}),n.complexAspect._postInitialize(),n},n._createInstanceCore=function(e,t){var n=this.getCtor(),r=new n;return new tt(r,e,t),e&&r.complexAspect._postInitialize(),r},n.addProperty=function(e){if(z(e,"dataProperty").isInstanceOf(dt).check(),this.metadataStore&&!e.isUnmapped)throw Error("The '"+this.name+"' ComplexType has already been added to a MetadataStore and therefore no additional properties may be added to it.");if(e.parentType){if(e.parentType!==this)throw Error("This dataProperty has already been added to "+property.parentType.name);return this}return this._addDataProperty(e),this},n.getProperties=function(){return this.dataProperties},n.addValidator=lt.prototype.addValidator,n.getProperty=lt.prototype.getProperty,n.getPropertyNames=lt.prototype.getPropertyNames,n._addDataProperty=lt.prototype._addDataProperty,n._updateProperty=lt.prototype._updateProperty,n.getCtor=lt.prototype.getEntityCtor,n._setCtor=lt.prototype._setCtor,n.toJSON=function(){return s(this,["dataProperties","validators"])},n._fixup=function(){var e=this;this.dataProperties.forEach(function(t){e._updateProperty(t)})},n._$typeName="ComplexType",t}(),dt=function(){var e=function(e){U(e).whereParam("name").isString().isOptional().whereParam("nameOnServer").isString().isOptional().whereParam("dataType").isEnumOf(K).isOptional().or().isInstanceOf(ut).whereParam("complexTypeName").isOptional().whereParam("isNullable").isBoolean().isOptional().withDefault(!0).whereParam("defaultValue").isOptional().whereParam("isPartOfKey").isBoolean().isOptional().whereParam("isUnmapped").isBoolean().isOptional().whereParam("concurrencyMode").isString().isOptional().whereParam("maxLength").isNumber().isOptional().whereParam("fixedLength").isBoolean().isOptional().whereParam("validators").isInstanceOf(Y).isArray().isOptional().withDefault([]).whereParam("enumType").isOptional().whereParam("rawTypeName").isOptional().applyAll(this);var t=!(!this.name&&!this.nameOnServer);if(!t)throw Error("A DataProperty must be instantiated with either a 'name' or a 'nameOnServer' property");if(this.complexTypeName?this.isComplexProperty=!0:this.dataType||(this.dataType=K.String),null==this.defaultValue)if(this.isNullable)this.defaultValue=null;else if(this.isComplexProperty);else if(this.dataType===K.Binary)this.defaultValue="AAAAAAAAJ3U=";else if(this.defaultValue=this.dataType.defaultValue,null==this.defaultValue)throw Error("A nonnullable DataProperty cannot have a null defaultValue. Name: "+this.name)},t=e.prototype;return t._$typeName="DataProperty",t.isDataProperty=!0,t.isNavigationProperty=!1,t.toJSON=function(){var e=s(this,["validators"]);return delete e.isComplexProperty,e},e.fromJSON=function(e,t){e.dataType=K.fromName(e.dataType),e.validators=e.validators.map(Y.fromJSON);var n=new dt(e);return t.addProperty(n),n},e}(),ht=function(){var e=function(e){U(e).whereParam("name").isString().isOptional().whereParam("nameOnServer").isString().isOptional().whereParam("entityTypeName").isString().whereParam("isScalar").isBoolean().whereParam("associationName").isString().isOptional().whereParam("foreignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("foreignKeyNamesOnServer").isArray().isString().isOptional().withDefault([]).whereParam("validators").isInstanceOf(Y).isArray().isOptional().withDefault([]).applyAll(this);var t=!(!this.name&&!this.nameOnServer);if(!t)throw Error("A Navigation property must be instantiated with either a 'name' or a 'nameOnServer' property")},t=e.prototype;return t._$typeName="NavigationProperty",t.isDataProperty=!1,t.isNavigationProperty=!0,t.toJSON=function(){return s(this,["validators","foreignKeyNames","foreignKeyNamesOnServer"])},e.fromJSON=function(e,t){e.validators=e.validators.map(Y.fromJSON);var n=new ht(e);return t.addProperty(n),n},e}(),pt=function(){var e=new W("AutoGeneratedKeyType");return e.None=e.addSymbol(),e.Identity=e.addSymbol(),e.KeyGenerator=e.addSymbol(),e.seal(),e}();(function(){function e(e,t){return null==t?!1:void 0!==t.entityType}function t(e,t){return null==t?!1:t.isDataProperty||t.isNavigationProperty}var n=j.prototype;n.isEntity=function(){return this._addContext({fn:e,msg:" must be an entity"})},n.isEntityProperty=function(){return this._addContext({fn:t,msg:" must be either a DataProperty or a NavigationProperty"})}})(),I.MetadataStore=at,I.DataService=st,I.JsonResultsAdapter=ct,I.EntityType=lt,I.ComplexType=ut,I.DataProperty=dt,I.NavigationProperty=ht,I.DataType=K,I.AutoGeneratedKeyType=pt,I.NamingConvention=ot;var gt=function(){function e(e){return e}function t(e){return z(e,"propertyPaths").isOptional().isString().or().isArray().isString().check(),"string"==typeof e&&(e=e.split(",")),e=e.map(function(e){return e.trim()})}function n(e){var t=e.entityType,n=t.keyProperties.map(function(t){return bt.create(t.name,_t.Equals,e.getProperty(t.name))}),r=bt.and(n);return r}function r(e,t,n){var r,i=e._clone();return t?(r=xt.create(t,n),i.orderByClause?i.orderByClause.addClause(r):i.orderByClause=r,i):(i.orderByClause=null,i)}function i(e,t){var n=e._clone();return t?(n.selectClause=new At(t),n):(n.selectClause=null,n)}function o(e,t){var n=e._clone();return t?(n.expandClause=new Ct(t),n):(n.expandClause=null,n)}function s(e,t){var n=e._clone();return n.parameters=t,n}function c(e){var t=e.entityType.keyProperties,n=d(t,e.values,function(e,t){return bt.create(e.name,_t.Equals,t)}),r=bt.and(n);return r}function l(e,t){if(t.isScalar){if(0===t.foreignKeyNames.length)return null;var n=t.foreignKeyNames.map(function(t){return e.getProperty(t)}),r=new nt(t.entityType,n);return c(r)}var i=t.inverse;if(!i)return null;var o=i.foreignKeyNames;if(0===o.length)return null;var a=e.entityAspect.getKey().values,s=d(o,a,function(e,t){return bt.create(e,_t.Equals,t)}),l=bt.and(s);return l}var u=function(t){z(t,"resourceName").isOptional().isString().check(),this.resourceName=e(t),this.entityType=null,this.wherePredicate=null,this.orderByClause=null,this.selectClause=null,this.skipCount=null,this.takeCount=null,this.expandClause=null,this.parameters={},this.inlineCountEnabled=!1,this.queryOptions=null,this.entityManager=null,this.dataService=null},h=u.prototype;return h.from=function(t){z(t,"resourceName").isString().check(),t=e(t);var n=this.resourceName;if(n&&n!==t)throw Error("This query already has an resourceName - the resourceName may only be set once per query");var r=this._clone();return r.resourceName=t,r},u.from=function(e){return z(e,"resourceName").isString().check(),new gt(e)},h.toType=function(e){z(e,"entityType").isString().or.isInstanceOf(lt).check();var t=this._clone();t.toEntityType=e},h.where=function(e){var t=this._clone();if(0===arguments.length)return t.wherePredicate=null,t;var n;return n=bt.isPredicate(e)?e:bt.create(Array.prototype.slice.call(arguments)),t.entityType&&n.validate(t.entityType),t.wherePredicate=t.wherePredicate?new wt("and",[t.wherePredicate,n]):n,t},h.orderBy=function(e){return r(this,t(e))},h.orderByDesc=function(e){return r(this,t(e),!0)},h.select=function(e){return i(this,t(e))},h.skip=function(e){z(e,"count").isOptional().isNumber().check();var t=this._clone();return t.skipCount=0===arguments.length?null:e,t},h.top=function(e){return this.take(e)},h.take=function(e){z(e,"count").isOptional().isNumber().check();var t=this._clone();return t.takeCount=0===arguments.length?null:e,t},h.expand=function(e){return o(this,t(e))},h.withParameters=function(e){return z(e,"parameters").isObject().check(),s(this,e)},h.inlineCount=function(e){void 0===e&&(e=!0);var t=this._clone();return t.inlineCountEnabled=e,t},h.using=function(e){var t=this._clone();if(e instanceof Ft)t.entityManager=e;else if(Dt.contains(e)||$t.contains(e)){var n=this.queryOptions||Lt.defaultInstance;t.queryOptions=n.using(e)}else if(e instanceof st)t.dataService=e;
else{if(!(e instanceof ct))throw Error("EntityQuery.using parameter must be either an EntityManager, a Query Strategy, a FetchStrategy, a DataService or a JsonResultsAdapter");t.jsonResultsAdapter=e}return t},h.execute=function(e,t){if(!this.entityManager)throw Error("An EntityQuery must have its EntityManager property set before calling 'execute'");return this.entityManager.executeQuery(this,e,t)},h.executeLocally=function(){if(!this.entityManager)throw Error("An EntityQuery must have its EntityManager property set before calling 'executeLocally'");return this.entityManager.executeQueryLocally(this)},u.fromEntities=function(e){z(e,"entities").isEntity().or().isNonEmptyArray().isEntity().check(),Array.isArray(e)||(e=Array.prototype.slice.call(arguments));var t=e[0],r=new gt(t.entityType.defaultResourceName),i=e.map(function(e){return n(e)}),o=bt.or(i);r=r.where(o);var a=t.entityAspect.entityManager;return a&&(r=r.using(a)),r},u.fromEntityKey=function(e){z(e,"entityKey").isInstanceOf(nt).check();var t=new gt(e.entityType.defaultResourceName),n=c(e);return t=t.where(n)},u.fromEntityNavigation=function(e,t){z(e,"entity").isEntity().check(),z(t,"navigationProperty").isInstanceOf(ht).check();var n=e.entityType._checkNavProperty(t),r=new gt(n.entityType.defaultResourceName),i=l(e,n);r=r.where(i);var o=e.entityAspect.entityManager;return o&&(r=r.using(o)),r},h._getFromEntityType=function(e,t){var n=this.entityType;if(!n){var r=this.resourceName;if(!r)throw Error("There is no resourceName for this query");if(e.isEmpty()){if(t)throw Error("There is no metadata available for this query");return null}var i=e.getEntityTypeNameForResourceName(r);if(!i){if(t)throw Error("Cannot find resourceName of: "+r);return null}if(n=e.getEntityType(i),!n){if(t)throw Error("Cannot find an entityType for an entityTypeName of: "+i);return null}this.entityType=n}return n},h._getToEntityType=function(e){return this.toEntityType instanceof lt?this.toEntityType:this.toEntityType?(this.toEntityType=e.getEntityType(this.toEntityType,!1),this.toEntityType):!this.selectClause&&this._getFromEntityType(e,!1)},h._clone=function(){var e=new gt;return e.resourceName=this.resourceName,e.entityType=this.entityType,e.wherePredicate=this.wherePredicate,e.orderByClause=this.orderByClause,e.selectClause=this.selectClause,e.skipCount=this.skipCount,e.takeCount=this.takeCount,e.expandClause=this.expandClause,e.inlineCountEnabled=this.inlineCountEnabled,e.parameters=a({},this.parameters),e.queryOptions=this.queryOptions,e.entityManager=this.entityManager,e},h._toUri=function(e){function t(){var e=d.wherePredicate;return e?(d.entityType&&e.validate(d.entityType),e.toOdataFragment(u)):""}function n(){return d.inlineCountEnabled?d.inlineCountEnabled?"allpages":"none":""}function r(){var e=d.orderByClause;return e?(d.entityType&&e.validate(d.entityType),e.toOdataFragment(u)):""}function i(){var e=d.selectClause;return e?(d.entityType&&e.validate(d.entityType),e.toOdataFragment(u)):""}function o(){var e=d.expandClause;return e?e.toOdataFragment(u):""}function s(){var e=d.skipCount;return e?""+e:""}function c(){var e=d.takeCount;return e?""+e:""}function l(e){var t=[];for(var n in e){var r=e[n];r&&t.push(n+"="+encodeURIComponent(r))}return t.length>0?"?"+t.join("&"):""}var u=this._getFromEntityType(e,!1);u||(u=new lt(e));var d=this,h={};h.$filter=t(),h.$orderby=r(),h.$skip=s(),h.$top=c(),h.$expand=o(),h.$select=i(),h.$inlinecount=n(),h=a(h,this.parameters);var p=l(h);return this.resourceName+p},h._toFilterFunction=function(e){var t=this.wherePredicate;return t?(t.validate(e),t.toFunction(e)):null},h._toOrderByComparer=function(e){var t=this.orderByClause;return t?(t.validate(e),t.getComparer()):null},u}(),ft=function(){var e={toupper:{fn:function(e){return e.toUpperCase()},dataType:K.String},tolower:{fn:function(e){return e.toLowerCase()},dataType:K.String},substring:{fn:function(e,t,n){return e.substring(t,n)},dataType:K.String},substringof:{fn:function(e,t){return t.indexOf(e)>=0},dataType:K.Boolean},length:{fn:function(e){return e.length},dataType:K.Int32},trim:{fn:function(e){return e.trim()},dataType:K.String},concat:{fn:function(e,t){return e.concat(t)},dataType:K.String},replace:{fn:function(e,t,n){return e.replace(t,n)},dataType:K.String},startswith:{fn:function(e,t){return S(e,t)},dataType:K.Boolean},endswith:{fn:function(e,t){return F(e,t)},dataType:K.Boolean},indexof:{fn:function(e,t){return e.indexOf(t)},dataType:K.Int32},round:{fn:function(e){return Math.round(e)},dataType:K.Int32},ceiling:{fn:function(e){return Math.ceil(e)},dataType:K.Int32},floor:{fn:function(e){return Math.floor(e)},dataType:K.Int32},second:{fn:function(e){return e.second},dataType:K.Int32},minute:{fn:function(e){return e.minute},dataType:K.Int32},day:{fn:function(e){return e.day},dataType:K.Int32},month:{fn:function(e){return e.month},dataType:K.Int32},year:{fn:function(e){return e.year},dataType:K.Int32}};return e}(),mt=function(){function e(e){var t=e.split(".");return 1===t.length?function(t){return t.getProperty(e)}:function(e){return B(e,t)}}var t=/^[a-z_][\w.$]*$/i,n=/('[^']*'|[^,]+)/g,r=/("[^"]*"|[^,]+)/g,i=function(i,o,a){var s=i.split(":");if(a&&(this.isValidated=!0),1==s.length){var c=s[0].trim();this.value=c;var l=c.substr(0,1),u="'"==l||'"'==l;if(u){var d=c.substr(1,c.length-2);this.fn=function(){return d},this.dataType=K.String}else{var h=t.test(c);if(h){if(a&&null==a.getProperty(c,!1))return this.isValidated=!1,void 0;this.propertyPath=c,this.fn=e(c)}else{if(a)return this.isValidated=!1,void 0;this.fn=function(){return c},this.dataType=K.fromValue(c)}}}else try{this.fnName=s[0].trim().toLowerCase();var p=ft[this.fnName];this.localFn=p.fn,this.dataType=p.dataType;var g=this;this.fn=function(e){var t=g.fnNodes.map(function(t){var n=t.fn(e);return n}),n=g.localFn.apply(null,t);return n};var f=o[s[1]].trim();"("==f.substr(0,1)&&(f=f.substr(1,f.length-2));var m=i.indexOf("'")>=0?n:r,_=f.match(m);this.fnNodes=_.map(function(e){return new mt(e,o)})}catch(y){this.isValidated=!1}},o=i.prototype;return i.create=function(e,t){if("string"!=typeof e)return null;for(var n,r=/\([^()]*\)/,i=[],o=0;n=r.exec(e);){var a=n[0];i.push(a);var s=":"+o++;e=e.replace(a,s)}var c=new mt(e,i,t);return c.isValidated===!1?null:c},o.toString=function(){if(this.fnName){var e=this.fnNodes.map(function(e){return""+e}),t=this.fnName+"("+e.join(",")+")";return t}return this.value},o.updateWithEntityType=function(e){if(this.propertyPath){if(e.isAnonymous)return;var t=e.getProperty(this.propertyPath);if(!t){var n=T("Unable to resolve propertyPath.  EntityType: '%1'   PropertyPath: '%2'",e.name,this.propertyPath);throw Error(n)}this.dataType=t.dataType}},o.toOdataFragment=function(e){if(this.updateWithEntityType(e),this.fnName){var t=this.fnNodes.map(function(t){return t.toOdataFragment(e)}),n=this.fnName+"("+t.join(",")+")";return n}var r=this.value.substr(0,1);return"'"===r||'"'===r?this.value:this.value==this.propertyPath?e._clientPropertyPathToServer(this.propertyPath):this.value},o.validate=function(e){if(void 0===this.isValidated)if(this.isValidated=!0,this.propertyPath){var t=e.getProperty(this.propertyPath,!0);this.dataType=t.isDataProperty?t.dataType:t.entityType}else this.fnNodes&&this.fnNodes.forEach(function(t){t.validate(e)})},i}(),_t=function(){var e=new W("FilterQueryOp");return e.Equals=e.addSymbol({operator:"eq",aliases:["=="]}),e.NotEquals=e.addSymbol({operator:"ne",aliases:["!="]}),e.GreaterThan=e.addSymbol({operator:"gt",aliases:[">"]}),e.LessThan=e.addSymbol({operator:"lt",aliases:["<"]}),e.GreaterThanOrEqual=e.addSymbol({operator:"ge",aliases:[">="]}),e.LessThanOrEqual=e.addSymbol({operator:"le",aliases:["<="]}),e.Contains=e.addSymbol({operator:"substringof",isFunction:!0}),e.StartsWith=e.addSymbol({operator:"startswith",isFunction:!0}),e.EndsWith=e.addSymbol({operator:"endswith",isFunction:!0}),e.seal(),e._map=function(){var t={};return e.getSymbols().forEach(function(e){t[e.name.toLowerCase()]=e,t[e.operator.toLowerCase()]=e,e.aliases&&e.aliases.forEach(function(n){t[n.toLowerCase()]=e})}),t}(),e.from=function(t){return e.contains(t)?t:e._map[t.toLowerCase()]},e}(),yt=function(){var e=new W("BooleanQueryOp");return e.And=e.addSymbol({operator:"and",aliases:["&&"]}),e.Or=e.addSymbol({operator:"or",aliases:["||"]}),e.Not=e.addSymbol({operator:"not",aliases:["~","!"]}),e.seal(),e._map=function(){var t={};return e.getSymbols().forEach(function(e){t[e.name.toLowerCase()]=e,t[e.operator.toLowerCase()]=e,e.aliases&&e.aliases.forEach(function(n){t[n.toLowerCase()]=e})}),t}(),e.from=function(t){return e.contains(t)?t:e._map[t.toLowerCase()]},e}(),bt=function(){function e(e){if(1===e.length&&Array.isArray(e[0]))return e[0];var t=Array.prototype.slice.call(e);return bt.isPredicate(t[0])?t:[bt.create(t)]}var t=function(e,t,n,r){return arguments[0].prototype===!0?this:new vt(e,t,n,r)},n=t.prototype;return t.isPredicate=function(e){return e instanceof bt},t.create=function(e,t,n,r){return Array.isArray(e)?(r=4===e.length?e[3]:!1,new vt(e[0],e[1],e[2],r)):new vt(e,t,n,r)},t.and=function(t){return t=e(arguments),1===t.length?t[0]:new wt("and",t)},t.or=function(t){return t=e(arguments),1===t.length?t[0]:new wt("or",t)},t.not=function(e){return new wt("not",[e])},n.and=function(n){return n=e(arguments),n.unshift(this),t.and(n)},n.or=function(n){return n=e(arguments),n.unshift(this),t.or(n)},n.not=function(){return new wt("not",[this])},t}(),vt=function(){function e(e,o,a){var s,c=e.metadataStore.localQueryComparisonOptions,l=M(a);switch(o){case _t.Equals:s=function(e,n){return e&&"string"==typeof e?t(e,n,c):l(e)==l(n)};break;case _t.NotEquals:s=function(e,n){return e&&"string"==typeof e?!t(e,n,c):l(e)!=l(n)};break;case _t.GreaterThan:s=function(e,t){return l(e)>l(t)};break;case _t.GreaterThanOrEqual:s=function(e,t){return l(e)>=l(t)};break;case _t.LessThan:s=function(e,t){return l(e)<l(t)};break;case _t.LessThanOrEqual:s=function(e,t){return l(e)<=l(t)};break;case _t.StartsWith:s=function(e,t){return n(e,t,c)};break;case _t.EndsWith:s=function(e,t){return r(e,t,c)};break;case _t.Contains:s=function(e,t){return i(e,t,c)};break;default:throw Error("Unknown FilterQueryOp: "+o)}return s}function t(e,t,n){return null==t?!1:("string"!=typeof t&&(t=""+t),n.usesSql92CompliantStringComparison&&(e=(e||"").trim(),t=(t||"").trim()),n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase()),e==t)}function n(e,t,n){return n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase()),S(e,t)}function r(e,t,n){return n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase()),F(e,t)}function i(e,t,n){return n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase()),e.indexOf(t)>=0}function o(e,t){if(null==e)return null;var n;if(t=t||K.fromValue(e),t.isNumeric)return"string"==typeof e&&(e=t.isInteger?parseInt(e):parseFloat(e)),e;if(t===K.String)return"'"+e+"'";if(t!==K.DateTime){if(t==K.Time){if(!E(e))throw n=T("'%1' is not a valid ISO 8601 duration",e),Error(n);return"time'"+e+"'"}if(t===K.Guid){if(!k(e))throw n=T("'%1' is not a valid guid",e),Error(n);return"guid'"+e+"'"}return t===K.Boolean?"string"==typeof e?"true"===e.trim().toLowerCase():e:e}try{return"datetime'"+e.toISOString()+"'"}catch(r){throw n=T("'%1' is not a valid dateTime",e),Error(n)}}var a=function(e,t,n,r){if(z(e,"propertyOrExpr").isString().check(),z(t,"operator").isEnumOf(_t).or().isString().check(),z(n,"value").isRequired(!0).check(),z(r).isOptional().isBoolean().check(),this._propertyOrExpr=e,this._fnNode1=mt.create(e,null),this._filterQueryOp=_t.from(t),!this._filterQueryOp)throw Error("Unknown query operation: "+t);this._value=n,this._valueIsLiteral=r},s=new bt({prototype:!0});return a.prototype=s,s.toOdataFragment=function(e){var t,n=this._fnNode1.toOdataFragment(e);return void 0!==this.fnNode2||this._valueIsLiteral||(this.fnNode2=mt.create(this._value,e)),t=this.fnNode2?this.fnNode2.toOdataFragment(e):o(this._value,this._fnNode1.dataType),this._filterQueryOp.isFunction?this._filterQueryOp==_t.Contains?this._filterQueryOp.operator+"("+t+","+n+") eq true":this._filterQueryOp.operator+"("+n+","+t+") eq true":n+" "+this._filterQueryOp.operator+" "+t},s.toFunction=function(t){var n=this._fnNode1.dataType||K.fromValue(this._value),r=e(t,this._filterQueryOp,n),i=this._fnNode1.fn;if(void 0!==this.fnNode2||this._valueIsLiteral||(this.fnNode2=mt.create(this._value,t)),this.fnNode2){var o=this.fnNode2.fn;return function(e){return r(i(e),o(e))}}var a=this._value;return function(e){return r(i(e),a)}},s.toString=function(){return T("{%1} %2 {%3}",this._propertyOrExpr,this._filterQueryOp.operator,this._value)},s.validate=function(e){this._fnNode1.validate(e),this.dataType=this._fnNode1.dataType},a}(),wt=function(){function e(e,t,n){var r,i;switch(t){case yt.Not:return r=n[0].toFunction(e),function(e){return!r(e)};case yt.And:return i=n.map(function(t){return t.toFunction(e)}),function(e){var t=i.reduce(function(t,n){return t&&n(e)},!0);return t};case yt.Or:return i=n.map(function(t){return t.toFunction(e)}),function(e){var t=i.reduce(function(t,n){return t||n(e)},!1);return t};default:throw Error("Invalid boolean operator:"+t)}}var t=function(e,t){if(!Array.isArray(t))throw Error("predicates parameter must be an array");if("not"===this.symbol&&1!==t.length)throw Error("Only a single predicate can be passed in with the 'Not' operator");if(this._booleanQueryOp=yt.from(e),!this._booleanQueryOp)throw Error("Unknown query operation: "+e);this._predicates=t},n=new bt({prototype:!0});return t.prototype=n,n.toOdataFragment=function(e){if(1==this._predicates.length)return this._booleanQueryOp.operator+" "+"("+this._predicates[0].toOdataFragment(e)+")";var t=this._predicates.map(function(t){return"("+t.toOdataFragment(e)+")"}).join(" "+this._booleanQueryOp.operator+" ");return t},n.toFunction=function(t){return e(t,this._booleanQueryOp,this._predicates)},n.toString=function(){if(1==this._predicates.length)return this._booleanQueryOp.operator+" "+"("+this._predicates[0]+")";var e=this._predicates.map(function(e){return"("+(""+e)+")"}).join(" "+this._booleanQueryOp.operator+" ");return e},n.validate=function(e){this._isValidated||(this._predicates.every(function(t){t.validate(e)}),this._isValidated=!0)},t}(),xt=function(){var e=function(t,n){return t.prototype===!0?this:e.create(t,n)},t=e.prototype;return e.create=function(e,t){if(e.length>1){var n=e.map(function(e){return new kt(e,t)});return new Et(n)}return new kt(e[0],t)},e.combine=function(e){return new Et(e)},e.isOrderByClause=function(e){return e instanceof xt},t.addClause=function(e){return new Et([this,e])},e}(),kt=function(){var e=function(e,t){if("string"!=typeof e)throw Error("propertyPath is not a string");e=e.trim();var n=e.split(" ");if(n.length>1&&t!==!0&&t!==!1&&(t=S(n[1].toLowerCase(),"desc"),!t)){var r=S(n[1].toLowerCase(),"asc");if(!r)throw Error("the second word in the propertyPath must begin with 'desc' or 'asc'")}this.propertyPath=n[0],this.isDesc=t},t=new xt({prototype:!0});return e.prototype=t,t.validate=function(e){e&&(this.lastProperty=e.getProperty(this.propertyPath,!0))},t.toOdataFragment=function(e){return e._clientPropertyPathToServer(this.propertyPath)+(this.isDesc?" desc":"")},t.getComparer=function(){var e=this.propertyPath,t=this.isDesc,n=this;return function(r,i){var o=B(r,e),a=B(i,e),s=(n.lastProperty||{}).dataType;if(s===K.String)n.lastProperty.parentType.metadataStore.localQueryComparisonOptions.isCaseSensitive||(o=(o||"").toLowerCase(),a=(a||"").toLowerCase());else{var c=M(s);o=c(o),a=c(a)}return o==a?0:o>a?t?-1:1:t?1:-1}},e}(),Et=function(){var e=function(e){var t=[];e.forEach(function(e){if(e instanceof Et)t=t.concat(e.orderByClauses);else{if(!(e instanceof kt))throw Error("Invalid argument to CompositeOrderByClause ctor.");t.push(e)}}),this._orderByClauses=t},t=new xt({prototype:!0});return e.prototype=t,t.validate=function(e){this._orderByClauses.forEach(function(t){t.validate(e)})},t.toOdataFragment=function(e){var t=this._orderByClauses.map(function(t){return t.toOdataFragment(e)});return t.join(",")},t.getComparer=function(){var e=this._orderByClauses.map(function(e){return e.getComparer()});return function(t,n){for(var r=0;e.length>r;r++){var i=e[r](t,n);if(0!=i)return i}return 0}},e}(),At=function(){var e=function(e){this.propertyPaths=e,this._pathNames=e.map(function(e){return e.replace(".","_")})},t=e.prototype;return t.validate=function(e){e&&this.propertyPaths.forEach(function(t){e.getProperty(t,!0)})},t.toOdataFragment=function(e){var t=this.propertyPaths.map(function(t){return e._clientPropertyPathToServer(t)}).join(",");return t},t.toFunction=function(){var e=this;return function(t){var n={};return e.propertyPaths.forEach(function(r,i){n[e._pathNames[i]]=B(t,r)}),n}},e}(),Ct=function(){var e=function(e){this.propertyPaths=e},t=e.prototype;return t.toOdataFragment=function(e){var t=this.propertyPaths.map(function(t){return e._clientPropertyPathToServer(t)}).join(",");return t},e}();et.prototype.loadNavigationProperty=function(e,t,n){var r=this.entity,i=r.entityType._checkNavProperty(e),o=gt.fromEntityNavigation(r,i,t,n);return r.entityAspect.entityManager.executeQuery(o,t,n)},I.FilterQueryOp=_t,I.Predicate=bt,I.EntityQuery=gt,I.FnNode=mt,I.OrderByClause=xt;var St=function(){function e(e,t,n){var r=t.name+".."+t.parentType.name,i=e._tempIdMap[r];return i||n&&(i={entityType:t.parentType,propertyName:t.name,keyMap:{}},e._tempIdMap[r]=i),i}function t(e,t){if(t.isNumeric)return n(e);if(t===K.String)return this.stringPrefix+(""+n(e));if(t===K.Guid)return y();if(t===K.DateTime)return Date.now();throw Error("Cannot use a property with a dataType of: "+(""+t)+" for id generation")}function n(e){var t=e.nextNumber;return e.nextNumber+=e.nextNumberIncrement,t}var r=function(){this._tempIdMap={},this.nextNumber=-1,this.nextNumberIncrement=-1,this.stringPrefix="K_"},i=r.prototype;return i.generateTempKeyValue=function(n){var r=n.keyProperties;if(r.length>1)throw Error("Ids can not be autogenerated for entities with multipart keys");var i=r[0],o=t(this,i.dataType),a=e(this,i,!0);return a.keyMap[""+o]=null,o},i.getTempKeys=function(){var e=[];for(var t in this._tempIdMap){var n=this._tempIdMap[t],r=n.entityType;for(var i in n.keyMap)e.push(new nt(r,[i]))}return e},i.isTempKey=function(t){var n=t.entityType.keyProperties;if(n.length>1)return!1;var r=n[0],i=e(this,r);return i?void 0!==i.keyMap[""+t.values[0]]:!1},V.registerType(r,"KeyGenerator"),r}();I.KeyGenerator=St,I.makeRelationArray=function(){function e(e,n){var r=t(e,n);if(!r.length)return r;var i=e.parentEntity,o=i.entityAspect.entityManager;return o&&!o.isLoading&&r.forEach(function(t){if(t.entityAspect.entityState.isDetached()){e._inProgress=!0;try{o.attachEntity(t,X.Added)}finally{e._inProgress=!1}}}),r}function t(e,t){var n=e.navigationProperty.inverse,r=t.filter(function(t){if(e._addsInProcess.indexOf(t)>=0)return!1;var r=t.getProperty(n.name);return r!=e.parentEntity});return r}function n(e,t){var n=e.navigationProperty.inverse;if(n){var i=e._addsInProcess,o=i.length;try{t.forEach(function(t){i.push(t),t.setProperty(n.name,e.parentEntity)})}finally{i.splice(o,t.length)}}r(e,"arrayChanged",{relationArray:e,added:t})}function r(e,t,n){var r=e._getPendingPubs();r?e._pendingArgs?i(e._pendingArgs,n):(e._pendingArgs=n,r.push(function(){e[t].publish(e._pendingArgs),e._pendingArgs=null})):e[t].publish(n)}function i(e,t){for(var n in t)if("relationArray"!==n&&e.hasOwnProperty(n)){var r=t[n],i=e[n];if(i){if(!Array.isArray(i))throw Error("Cannot combine non array args");Array.prototype.push.apply(i,r)}else e[n]=r}}function o(e,t){var n=e.navigationProperty.inverse;n&&t.forEach(function(e){e.setProperty(n.name,null)}),r(e,"arrayChanged",{relationArray:e,removed:t})}function s(e,t,n){return e.parentEntity=t,e.navigationProperty=n,e.arrayChanged=new G("arrayChanged_entityCollection",e),e._addsInProcess=[],a(e,c)}var c={};return c.push=function(){if(this._inProgress)return-1;var t=e(this,Array.prototype.slice.call(arguments));if(!t.length)return this.length;var r=Array.prototype.push.apply(this,t);return n(this,t),r},c.unshift=function(){var t=e(this,Array.prototype.slice.call(arguments));if(!t.length)return this.length;var r=Array.prototype.unshift.apply(this,t);return n(this,Array.prototype.slice.call(t)),r},c.pop=function(){var e=Array.prototype.pop.apply(this);return o(this,[e]),e},c.shift=function(){var e=Array.prototype.shift.apply(this);return o(this,[e]),e},c.splice=function(){var t=e(this,Array.prototype.slice.call(arguments,2)),r=Array.prototype.slice.call(arguments,0,2).concat(t),i=Array.prototype.splice.apply(this,r);return o(this,i),t.length&&n(this,t),i},c.load=function(e,t){var n=this.parentEntity,r=gt.fromEntityNavigation(this.parentEntity,this.navigationProperty),i=n.entityAspect.entityManager;return i.executeQuery(r,e,t)},c._getEventParent=function(){return this.parentEntity.entityAspect},c._getPendingPubs=function(){var e=this.parentEntity.entityAspect.entityManager;return e&&e._pendingPubs},s}();var Ft=function(){function t(e,t){if(e.length!=t.length)return!1;for(var n=0,r=e.length;r>n;n++)if(e[n]!==t[n])return!1;return!0}function n(e,t){return z(t,"entityTypes").isString().isOptional().or().isNonEmptyArray().isString().or().isInstanceOf(lt).or().isNonEmptyArray().isInstanceOf(lt).check(),"string"==typeof t?t=e.metadataStore.getEntityType(t,!1):Array.isArray(t)&&"string"==typeof t[0]&&(t=t.map(function(t){return e.metadataStore.getEntityType(t,!1)})),t}function r(e,t){if(t[0]instanceof nt)return{entityKey:t[0],remainingArgs:Array.prototype.slice.call(t,1)};if("string"==typeof t[0]&&t.length>=2){var n=e.metadataStore.getEntityType(t[0],!1);return{entityKey:new nt(n,t[1]),remainingArgs:Array.prototype.slice.call(t,2)}}throw Error("This method requires as its initial parameters either an EntityKey or an entityType name followed by a value or an array of values.")}function a(e,t){e.forEach(function(e){e.entityAspect.isBeingSaved=t})}function s(t,n){var r;n?(r={},n.forEach(function(e){var t=r[e.entityType.name];t||(t={},t.entityType=e.entityType,t._entities=[],r[e.entityType.name]=t),t._entities.push(e)})):r=t._entityGroupMap;var i=[],o={};return e(r,function(e,t){o[e]=l(t,i)}),{entityGroupMap:o,tempKeys:i}}function l(e,t){var n={},r=e.entityType,o=r.dataProperties.map(i("name"));n.dataPropertyNames=o;var a=[];return e._entities.forEach(function(e){if(e){var n=[];o.forEach(function(t){n.push(e.getProperty(t))});var r=e.entityAspect,i=r.entityState,s={tempNavPropNames:h(r,t),entityState:i.name};(i.isModified()||i.isDeleted())&&(s.originalValuesMap=r.originalValues),n.push(s),a.push(n)}}),n.entities=a,n}function h(e,t){var n=e.entity;e.hasTempKey&&t.push(e.getKey().toJSON());var r;return n.entityType.navigationProperties.forEach(function(e){if(e.relatedDataProperties){var t=n.getProperty(e.name);t&&t.entityAspect.hasTempKey&&(r=r||[],r.push(e.name))}}),r}function p(e,t,n){var r=n.tempKeyMap,i=e.entityType,o=n.mergeStrategy===Dt.OverwriteChanges,a=null,s=t.dataPropertyNames,c=s.map(function(e){return i.getProperty(e)}),l=i.keyProperties.map(function(e){return s.indexOf(e.name)}),u=s.length,d=e.entityManager.entityChanged;t.entities.forEach(function(t){var n,s=t[u],h=l.map(function(e){return t[e]}),p=new nt(i,h),g=X.fromName(s.entityState);if(g.isAdded()?(n=r[""+p],a=void 0===n?e.findEntityByKey(p):null):a=e.findEntityByKey(p),a){var f=a.entityAspect.entityState.isUnchanged();o||f?(c.forEach(function(e,n){e.dataType==K.DateTime?a.setProperty(e.name,new Date(Date.parse(t[n]))):a.setProperty(e.name,t[n])}),d.publish({entityAction:Z.MergeOnImport,entity:a}),f?g.isUnchanged()||e.entityManager._notifyStateChange(a,!0):g.isUnchanged()&&e.entityManager._notifyStateChange(a,!1)):a=null}else a=i._createEntityCore(),c.forEach(function(e,n){e.dataType==K.DateTime?a.setProperty(e.name,new Date(Date.parse(t[n]))):a.setProperty(e.name,t[n])}),void 0!==n&&(a.setProperty(i.keyProperties[0].name,n),s.tempNavPropNames&&s.tempNavPropNames.forEach(function(e){var t=i.getNavigationProperty(e),n=t.relatedDataProperties[0].name,o=a.getProperty(n),s=new nt(t.entityType,[o]),c=r[""+s];a.setProperty(n,c)})),a.entityAspect._postInitialize(),a=e.attachEntity(a,g),d&&(d.publish({entityAction:Z.AttachOnImport,entity:a}),g.isUnchanged()||e.entityManager._notifyStateChange(a,!0));a&&(a.entityAspect.entityState=g,g.isModified()&&(a.entityAspect.originalValuesMap=s.originalValues),e.entityManager._linkRelatedEntities(a))})}function g(e,t,n){return e=e.then(function(e){return t&&t(e),rt.resolve(e)}).fail(function(e){return n&&n(e),rt.reject(e)})}function _(e,t){var n;return n=t?t.filter(function(t){if(t.entityAspect.entityManager!==e)throw Error("Only entities in this entityManager may be saved");return!t.entityAspect.entityState.isDetached()}):e.getChanges()}function b(e,t){t.forEach(function(t){var n=lt._getNormalizedTypeName(t.EntityTypeName),r=e._entityGroupMap[n];r._fixupKey(t.TempValue,t.RealValue)})}function v(e,t){function n(){return Error("The EntityManager.getChanges() 'entityTypes' parameter must be either an entityType or an array of entityTypes or null")}var r=e._entityGroupMap;if(t){if(t instanceof lt)return[r[t.name]];if(Array.isArray(t))return t.map(function(e){if(e instanceof lt)return r[e.name];throw n()});throw n()}return o(r)}function x(e,t){var n=t.entityAspect.getKey(),r=d(t.entityType.keyProperties,n.values,function(e,t){return e.defaultValue===t?e:null}).filter(function(e){return null!==e});if(r.length)if(t.entityType.autoGeneratedKeyType!==pt.None)e.generateTempKeyValue(t);else if(r.length===n.values.length)throw Error("Cannot attach an object to an EntityManager without first setting its key or setting its entityType 'AutoGeneratedKeyType' property to something other than 'None'")}function k(e,t){function n(){return Error("The EntityManager.getChanges() 'entityStates' parameter must either be null, an entityState or an array of entityStates")}if(!t)return null;if(X.contains(t))t=[t];else{if(!Array.isArray(t))throw n();t.forEach(function(e){if(!X.contains(e))throw n()})}return t}function E(e,t,n){var r=J(e,t.entityType);r.attachEntity(t,n),e._linkRelatedEntities(t)}function C(e,t,n){var r=t.entityType.navigationProperties;r.forEach(function(r){var i=t.getProperty(r.name);if(r.isScalar){if(!i)return;e.attachEntity(i,n)}else i.forEach(function(t){e.attachEntity(t,n)})})}function S(e,t){try{var n=e.metadataStore,r=t.dataService||e.dataService;if(n.isEmpty()&&r.hasServerMetadata)throw Error("cannot execute _executeQueryCore until metadataStore is populated.");var i=t.queryOptions||e.queryOptions||Lt.defaultInstance;if(i.fetchStrategy==$t.FromLocalCache)return rt.fcall(function(){var n=e.executeQueryLocally(t);return{results:n,query:t}});var o=t._getJsonResultsAdapter&&t._getJsonResultsAdapter(e)||r.jsonResultsAdapter,a=W(t,n),s={query:t,entityManager:e,dataService:r,mergeStrategy:i.mergeStrategy,jsonResultsAdapter:o,refMap:{},deferredFns:[]},c=rt.defer(),l=e.validationOptions.validateOnQuery,u=c.promise;return r.adapterInstance.executeQuery(e,a,function(n){var r=m(function(){var t={isLoading:e.isLoading};return e.isLoading=!0,e._pendingPubs=[],t},function(n){e.isLoading=n.isLoading,e._pendingPubs.forEach(function(e){e()}),e._pendingPubs=null,t=null,s=null,n.error&&c.reject(n.error)},function(){var e=o.extractResults(n);Array.isArray(e)||(e=[e]);var r=e.map(function(e){var t=F(e,s,{nodeType:"root"});return l&&t.entityAspect&&t.entityAspect.validateEntity(),t});return s.deferredFns.length>0&&s.deferredFns.forEach(function(e){e()}),{results:r,query:t,XHR:n.XHR,inlineCount:n.inlineCount}});c.resolve(r)},function(e){e&&(e.query=t),c.reject(e)}),u}catch(d){return d&&(d.query=t),rt.reject(d)}}function F(e,t,n){n=n||{};var r=t.jsonResultsAdapter.visitNode(e,t,n);return t.query&&n.isTopLevel&&!r.entityType&&(r.entityType=t.query._getToEntityType&&t.query._getToEntityType(t.entityManager.metadataStore)),T(e,t,r)}function T(e,t,n,r){if(n.ignore||null==e)return null;if(n.nodeRefId){var i=D(n.nodeRefId,t);return"function"==typeof i?(t.deferredFns.push(function(){r(i)}),void 0):i}return n.entityType?$(e,t,n):(n.nodeId&&(t.refMap[n.nodeId]=e),"object"==typeof e?L(e,t):e)}function D(e,t){var n=t.refMap[e];return void 0===n?function(){return t.refMap[e]}:n}function $(e,t,n){e._$meta=n;var r=n.entityType;e.entityType=r;var i=t.entityManager,o=t.mergeStrategy,a=null==t.query,s=nt._fromRawEntity(e,r),c=i.findEntityByKey(s);if(c){if(a&&c.entityAspect.entityState.isDeleted())return i.detachEntity(c),c;var l=c.entityAspect.entityState;if(o===Dt.OverwriteChanges||l.isUnchanged()){N(c,e,t),c.entityAspect.wasLoaded=!0,c.entityAspect.entityState=X.Unchanged,c.entityAspect.originalValues={},c.entityAspect.propertyChanged.publish({entity:c,propertyName:null});var u=a?Z.MergeOnSave:Z.MergeOnQuery;i.entityChanged.publish({entityAction:u,entity:c}),l.isUnchanged||i._notifyStateChange(c,!1)}else O(t,c,e),r.navigationProperties.forEach(function(n){n.isScalar?B(e,n,t):P(e,n,t)})}else c=r._createEntityCore(),c.initializeFrom&&c.initializeFrom(e),N(c,e,t),c.entityAspect._postInitialize(),E(i,c,X.Unchanged),c.entityAspect.wasLoaded=!0,i.entityChanged.publish({entityAction:Z.AttachOnQuery,entity:c});return c}function L(t,n){var r=n.entityManager,i=n.jsonResultsAdapter,o=r.metadataStore.namingConvention.serverPropertyNameToClient,a={};return e(t,function(e,t){var r=i.visitNode(t,n,{nodeType:"anonProp",propertyName:e});if(!r.ignore){var s=o(e);a[s]=Array.isArray(t)?t.map(function(t,o){return r=i.visitNode(t,n,{nodeType:"anonPropItem",propertyName:e}),T(t,n,r,function(e){a[s][o]=e()})}):T(t,n,r,function(e){a[s]=e()})}}),a}function N(e,t,n){O(n,e,t);var r=e.entityType;r.dataProperties.forEach(function(n){if(!n.isUnmapped){var r=t[n.nameOnServer];if(n.dataType===K.DateTime&&r)w(r)||(r=K.parseDateFromServer(r));else if(n.dataType==K.Binary)r&&void 0!==r.$value&&(r=r.$value);else if(n.isComplexProperty&&void 0!=r){var i=e.getProperty(n.name);n.dataType.dataProperties.forEach(function(e){i.setProperty(e.name,r[e.nameOnServer])})}n.isComplexProperty||e.setProperty(n.name,r)}}),r.navigationProperties.forEach(function(r){r.isScalar?R(r,e,t,n):I(r,e,t,n)})}function O(e,t,n){var r=n._$meta.nodeId;null!=r&&(e.refMap[r]=t)}function R(e,t,n,r){var i=B(n,e,r);null!=i&&("function"==typeof i?r.deferredFns.push(function(){i=i(),M(i,t,e)}):M(i,t,e))}function B(e,t,n){var r=e[t.nameOnServer];if(!r)return null;var i=F(r,n,{nodeType:"navProp",navigationProperty:t});return i}function M(e,t,n){if(e){var r=n.name,i=t.getProperty(r);if(i!=e){t.setProperty(r,e);var o=n.inverse;if(!o)return;if(o.isScalar)e.setProperty(o.name,t);else{var a=e.getProperty(o.name);a.push(t)}}}}function I(e,t,n,r){var i=P(n,e,r);if(null!=i){var o=e.inverse;if(o){var a=t.getProperty(e.name);a.wasLoaded=!0,i.forEach(function(e){"function"==typeof e?r.deferredFns.push(function(){e=e(),q(e,a,t,o)}):q(e,a,t,o)})}}}function P(e,t,n){var r=e[t.nameOnServer];if(!r)return null;if(!Array.isArray(r))return null;var i=r.map(function(e){return F(e,n,{nodeType:"navPropItem",navigationProperty:t})});return i}function q(e,t,n,r){if(e){var i=e.getProperty(r.name);i!==n&&(t.push(e),e.setProperty(r.name,n))}}function j(e){var t=e.filter(function(e){return e.entityAspect.isBeingSaved=!0,e.entityAspect.entityState.isModified()&&e.entityType.concurrencyProperties.length>0});0!==t.length&&t.forEach(function(e){e.entityType.concurrencyProperties.forEach(function(t){H(e,t)})})}function H(e,t){if(!e.entityAspect.originalValues[t.name]){var n=e.getProperty(t.name);if(n||(n=t.dataType.defaultValue),t.dataType.isNumeric)e.setProperty(t.name,n+1);else if(t.dataType===K.DateTime){for(var r=new Date,i=new Date;r==i;)i=new Date;e.setProperty(t.name,i)}else{if(t.dataType!==K.Guid){if(t.dataType===K.Binary)return;throw Error("Unable to update the value of concurrency property before saving: "+t.name)}e.setProperty(t.name,y())}}}function W(e,t){if(!e)throw Error("query cannot be empty");if("string"==typeof e)return e;
if(e instanceof gt)return e._toUri(t);throw Error("unable to recognize query parameter as either a string or an EntityQuery")}function J(e,t){var n=e._entityGroupMap[t.name];return n||(n=new Tt(e,t),e._entityGroupMap[t.name]=n),n}function Y(e,t){var n=e.map(function(e){var n=Q(e),r=null;e.entityType.autoGeneratedKeyType!==pt.None&&(r={propertyName:e.entityType.keyProperties[0].nameOnServer,autoGeneratedKeyType:e.entityType.autoGeneratedKeyType.name});var i=tt(e,t);return n.entityAspect={entityTypeName:e.entityType.name,entityState:e.entityAspect.entityState.name,originalValuesMap:i,autoGeneratedKey:r},n});return n}function Q(e){var t={},n=e.entityType||e.complexType;return n.dataProperties.forEach(function(n){t[n.nameOnServer]=n.isComplexProperty?Q(e.getProperty(n.name)):e.getProperty(n.name)}),t}function tt(t,n){var r=t.entityType||t.complexType,i=t.entityAspect||t.complexAspect,o=n.namingConvention.clientPropertyNameToServer,a={};return e(i.originalValues,function(e,t){var n=r.getProperty(e);a[o(e,n)]=t}),r.complexProperties.forEach(function(e){var r=t.getProperty(e.name),i=tt(r,n);A(i)||(a[o(e.name,e)]=i)}),a}function it(){this.map={}}var ot=function(e){if(arguments.length>1)throw Error("The EntityManager ctor has a single optional argument that is either a 'serviceName' or a configuration object.");0===arguments.length?e={serviceName:""}:"string"==typeof e&&(e={serviceName:e}),U(e).whereParam("serviceName").isOptional().isString().whereParam("dataService").isOptional().isInstanceOf(st).whereParam("metadataStore").isInstanceOf(at).isOptional().withDefault(new at).whereParam("queryOptions").isInstanceOf(Lt).isOptional().withDefault(Lt.defaultInstance).whereParam("saveOptions").isInstanceOf(Nt).isOptional().withDefault(Nt.defaultInstance).whereParam("validationOptions").isInstanceOf(Ot).isOptional().withDefault(Ot.defaultInstance).whereParam("keyGeneratorCtor").isFunction().isOptional().withDefault(St).applyAll(this),e.serviceName&&(this.dataService=new st({serviceName:this.serviceName})),this.serviceName=this.dataService&&this.dataService.serviceName,this.entityChanged=new G("entityChanged_entityManager",this),this.hasChangesChanged=new G("hasChangesChanged_entityManager",this),this.clear()},ct=ot.prototype;return ct._$typeName="EntityManager",G.bubbleEvent(ct,null),ct.createEntity=function(e,t,n){n=n||X.Added;var r=this.metadataStore.getEntityType(e).createEntity(t);return n!==X.Detached&&this.attachEntity(r,n),r},ot.importEntities=function(e,t){var n=new Ft;return n.importEntities(e,t),n},ct.exportEntities=function(e){var t=s(this,e),n={metadataStore:this.metadataStore.exportMetadata(),dataService:this.dataService,saveOptions:this.saveOptions,queryOptions:this.queryOptions,validationOptions:this.validationOptions,tempKeys:t.tempKeys,entityGroupMap:t.entityGroupMap},r=JSON.stringify(n,null,V.stringifyPad);return r},ct.importEntities=function(t,n){n=n||{},U(n).whereParam("mergeStrategy").isEnumOf(Dt).isOptional().withDefault(this.queryOptions.mergeStrategy).applyAll(n);var r=this,i=JSON.parse(t);this.metadataStore.importMetadata(i.metadataStore),this.dataService=i.dataService&&st.fromJSON(i.dataService)||new st({serviceName:i.serviceName}),this.saveOptions=new Nt(i.saveOptions),this.queryOptions=Lt.fromJSON(i.queryOptions),this.validationOptions=new Ot(i.validationOptions);var o={};return i.tempKeys.forEach(function(e){var t=nt.fromJSON(e,r.metadataStore);o[""+t]=r.keyGenerator.generateTempKeyValue(t.entityType)}),n.tempKeyMap=o,m(function(){r._pendingPubs=[]},function(){r._pendingPubs.forEach(function(e){e()}),r._pendingPubs=null},function(){e(i.entityGroupMap,function(e,t){var i=r.metadataStore.getEntityType(e,!0),o=J(r,i);p(o,t,n)})}),this},ct.clear=function(){e(this._entityGroupMap,function(e,t){t._clear()}),this._entityGroupMap={},this._unattachedChildrenMap=new it,this.keyGenerator=new this.keyGeneratorCtor,this.entityChanged.publish({entityAction:Z.Clear}),this._hasChanges&&(this._hasChanges=!1,this.hasChangesChanged.publish({entityManager:this,hasChanges:!1}))},ct.setProperties=function(e){U(e).whereParam("serviceName").isString().isOptional().whereParam("dataService").isInstanceOf(st).isOptional().whereParam("queryOptions").isInstanceOf(Lt).isOptional().whereParam("saveOptions").isInstanceOf(Nt).isOptional().whereParam("validationOptions").isInstanceOf(Ot).isOptional().whereParam("keyGeneratorCtor").isOptional().applyAll(this),e.serviceName&&(this.dataService=new st({serviceName:this.serviceName})),this.serviceName=this.dataService&&this.dataService.serviceName,e.keyGeneratorCtor&&(this.keyGenerator=new this.keyGeneratorCtor)},ct.createEmptyCopy=function(){var e=new ot({dataService:this.dataService,metadataStore:this.metadataStore,queryOptions:this.queryOptions,saveOptions:this.saveOptions,validationOptions:this.validationOptions,keyGeneratorCtor:this.keyGeneratorCtor});return e},ct.addEntity=function(e){return this.attachEntity(e,X.Added)},ct.attachEntity=function(e,t){if(z(e,"entity").isRequired().check(),this.metadataStore._checkEntityType(e),t=z(t,"entityState").isEnumOf(X).isOptional().check(X.Unchanged),e.entityType.metadataStore!=this.metadataStore)throw Error("Cannot attach this entity because the EntityType and MetadataStore associated with this entity does not match this EntityManager's MetadataStore.");var n=e.entityAspect;n||(n=new et(e),n._postInitialize(e));var r=n.entityManager;if(r){if(r==this)return e;throw Error("This entity already belongs to another EntityManager")}var i=this;return f(this,"isLoading",!0,function(){t.isAdded()&&x(i,e),E(i,e,t),C(i,e,t)}),this.validationOptions.validateOnAttach&&e.entityAspect.validateEntity(),t.isUnchanged()||this._notifyStateChange(e,!0),this.entityChanged.publish({entityAction:Z.Attach,entity:e}),e},ct.detachEntity=function(e){z(e,"entity").isEntity().check();var t=e.entityAspect;if(!t)return!1;var n=t.entityGroup;if(!n)return!1;if(n.entityManager!==this)throw Error("This entity does not belong to this EntityManager.");return n.detachEntity(e),t._removeFromRelations(),this.entityChanged.publish({entityAction:Z.Detach,entity:e}),t._detach(),!0},ct.fetchMetadata=function(e,t){z(e,"callback").isFunction().isOptional().check(),z(t,"errorCallback").isFunction().isOptional().check();var n=this.metadataStore.fetchMetadata(this.dataService);return g(n,e,t)},ct.executeQuery=function(e,t,n){z(e,"query").isInstanceOf(gt).or().isString().check(),z(t,"callback").isFunction().isOptional().check(),z(n,"errorCallback").isFunction().isOptional().check();var r;if(!this.dataService.hasServerMetadata||this.metadataStore.hasMetadataFor(this.dataService.serviceName))r=S(this,e);else{var i=this;r=this.fetchMetadata().then(function(){return S(i,e)}).fail(function(e){return rt.reject(e)})}return g(r,t,n)},ct.executeQueryLocally=function(e){z(e,"query").isInstanceOf(gt).check();var t,n=this.metadataStore,r=e._getFromEntityType(n,!0),i=J(this,r),o=e._toFilterFunction(r);if(o){var a=function(e){return e&&!e.entityAspect.entityState.isDeleted()&&o(e)};t=i._entities.filter(a)}else t=i._entities.filter(function(e){return e&&!e.entityAspect.entityState.isDeleted()});var s=e._toOrderByComparer(r);s&&t.sort(s);var c=e.skipCount;c&&(t=t.slice(c));var l=e.takeCount;l&&(t=t.slice(0,l));var u=e.selectClause;if(u){var d=u.toFunction();t=t.map(function(e){return d(e)})}return t},ct.saveChanges=function(e,n,r,i){z(e,"entities").isOptional().isArray().isEntity().check(),z(n,"saveOptions").isInstanceOf(Nt).isOptional().check(),z(r,"callback").isFunction().isOptional().check(),z(i,"errorCallback").isFunction().isOptional().check(),n=n||this.saveOptions||Nt.defaultInstance;var o=null==e,s=_(this,e);if(0==s.length){var c={entities:[],keyMappings:[]};return r&&r(c),rt.resolve(c)}if(!n.allowConcurrentSaves){var l=s.some(function(e){return e.entityAspect.isBeingSaved});if(l){var u=Error("ConcurrentSaves not allowed - SaveOptions.allowConcurrentSaves is false");return i&&i(u),rt.reject(u)}}if(this.validationOptions.validateOnSave){var d=s.filter(function(e){var t=e.entityAspect,n=t.entityState.isDeleted()||t.validateEntity();return!n});if(d.length>0){var h=Error("Validation error");return h.entitiesWithErrors=d,i&&i(h),rt.reject(h)}}j(s);var p={entities:Y(s,this.metadataStore),saveOptions:n},g=JSON.stringify(p),f=rt.defer();this.dataService.adapterInstance.saveChanges(this,g,f.resolve,f.reject);var m=this;return f.promise.then(function(e){var n={entities:e.Entities,keyMappings:e.KeyMappings,XHR:e.XHR};b(m,n.keyMappings);var i={query:null,entityManager:m,jsonResultsAdapter:m.dataService.jsonResultsAdapter,mergeStrategy:Dt.OverwriteChanges,refMap:{},deferredFns:[]},c=n.entities.map(function(e){return F(e,i,{nodeType:"root"})});return a(s,!1),m._hasChanges=o&&t(s,c)?!1:m._hasChangesCore(),m._hasChanges||m.hasChangesChanged.publish({entityManager:m,hasChanges:!1}),n.entities=c,r&&r(n),rt.resolve(n)},function(e){return a(s,!1),i&&i(e),rt.reject(e)})},ct.findEntityGroup=function(e){return z(e,"entityType").isInstanceOf(lt).check(),this._entityGroupMap[e.name]},ct.getEntityByKey=function(){var e=r(this,arguments).entityKey,t=this.findEntityGroup(e.entityType);return t?t.findEntityByKey(e):null},ct.fetchEntityByKey=function(){var e,t=r(this,arguments),n=t.entityKey,i=0===t.remainingArgs.length?!1:!!t.remainingArgs[0],o=!1;return i&&(e=this.getEntityByKey(n),o=e&&e.entityAspect.entityState.isDeleted(),o&&(e=null,this.queryOptions.mergeStrategy===Dt.OverwriteChanges&&(o=!1))),e||o?rt.resolve({entity:e,entityKey:n,fromCache:!0}):gt.fromEntityKey(n).using(this).execute().then(function(t){return e=0===t.results.length?null:t.results[0],rt.resolve({entity:e,entityKey:n,fromCache:!1})})},ct.findEntityByKey=function(e){return this.getEntityByKey(e)},ct.generateTempKeyValue=function(e){z(e,"entity").isEntity().check();var t=e.entityType,n=this.keyGenerator.generateTempKeyValue(t),r=t.keyProperties[0];return e.setProperty(r.name,n),e.entityAspect.hasTempKey=!0,n},ct.hasChanges=function(e){return this._hasChanges?void 0===e?this._hasChanges:this._hasChangesCore(e):!1},ct._hasChangesCore=function(e){e=n(this,e);var t=v(this,e);return t.some(function(e){return e.hasChanges()})},ct.getChanges=function(e){e=n(this,e);var t=[X.Added,X.Modified,X.Deleted];return this._getEntitiesCore(e,t)},ct.rejectChanges=function(){if(!this._hasChanges)return[];var e=[X.Added,X.Modified,X.Deleted],t=this._getEntitiesCore(null,e);return this._hasChanges=!1,t.forEach(function(e){e.entityAspect.rejectChanges()}),this.hasChangesChanged.publish({entityManager:this,hasChanges:!1}),t},ct.getEntities=function(e,t){return e=n(this,e),z(t,"entityStates").isOptional().isEnumOf(X).or().isNonEmptyArray().isEnumOf(X).check(),t&&(t=k(this,t)),this._getEntitiesCore(e,t)},ct._notifyStateChange=function(e,t){this.entityChanged.publish({entityAction:Z.EntityStateChange,entity:e}),t?this._hasChanges||(this._hasChanges=!0,this.hasChangesChanged.publish({entityManager:this,hasChanges:!0})):this._hasChanges&&(this._hasChanges=this._hasChangesCore(),this._hasChanges||this.hasChangesChanged.publish({entityManager:this,hasChanges:!1}))},ct._getEntitiesCore=function(e,t){var n,r=v(this,e);return r.forEach(function(e){if(e){var r=e.getEntities(t);n?n.push.apply(n,r):n=r}}),n||[]},ct._addUnattachedChild=function(e,t,n){var r=""+e,i=this._unattachedChildrenMap[r];i||(i=[],this._unattachedChildrenMap[r]=i),i.push(n)},ct._linkRelatedEntities=function(e){var t=this,n=e.entityAspect;f(t,"isLoading",!0,function(){var r=e.entityType,i=r.navigationProperties,o=t._unattachedChildrenMap;i.forEach(function(r){if(r.isScalar){var i=e.getProperty(r.name);if(i)return}var a=n.getParentKey(r);if(a){if(a._isEmpty())return;var s=t.findEntityByKey(a);s?e.setProperty(r.name,s):o.addChild(a,r,e)}else{var c=n.getKey(),l=r.inverse;if(!l)return;var u=o.getChildren(c,l);if(!u)return;if(r.isScalar){var d=u[0];e.setProperty(r.name,d),d.setProperty(l.name,e)}else{var h=e.getProperty(r.name);u.forEach(function(t){h.push(t),t.setProperty(l.name,e)})}o.removeChildren(c,r)}})})},it.prototype.addChild=function(e,t,n){var r=this.getTuple(e,t);if(!r){var i=this.map[""+e];i||(i=[],this.map[""+e]=i),r={navigationProperty:t,children:[]},i.push(r)}r.children.push(n)},it.prototype.removeChildren=function(e,t){var n=this.map[""+e];n&&(u(n,function(e){return e.navigationProperty===t}),n.length||delete this.map[""+e])},it.prototype.getChildren=function(e,t){var n=this.getTuple(e,t);return n?n.children.filter(function(e){return!e.entityAspect.entityState.isDetached()}):null},it.prototype.getTuple=function(e,t){var n=this.map[""+e];if(!n)return null;var r=c(n,function(e){return e.navigationProperty===t});return r},ot}(),Tt=function(){function e(e){if(e){if(1===e.length){var t=e[0];return function(e){return e?e.entityAspect.entityState===t:!1}}return function(t){return t?e.some(function(e){return t.entityAspect.entityState===e}):!1}}return function(e){return!!e}}var t=e([X.Added,X.Modified,X.Deleted]),n=function(e,t){this.entityManager=e,this.entityType=t,this._indexMap={},this._entities=[],this._emptyIndexes=[]},r=n.prototype;return r.attachEntity=function(e,t){var n,r=e.entityAspect,i=r.getKey()._keyInGroup;if(n=this._indexMap[i],n>=0){if(this._entities[n]===e)return e;throw Error("This key is already attached: "+r.getKey())}return 0===this._emptyIndexes.length?n=this._entities.push(e)-1:(n=this._emptyIndexes.pop(),this._entities[n]=e),this._indexMap[i]=n,r.entityState=t,r.entityGroup=this,r.entityManager=this.entityManager,e},r.detachEntity=function(e){var t=e.entityAspect,n=t.getKey()._keyInGroup,r=this._indexMap[n];if(void 0===r)throw Error("internal error - entity cannot be found in group");return delete this._indexMap[n],this._emptyIndexes.push(r),this._entities[r]=null,e},r.findEntityByKey=function(e){var t;t=e instanceof nt?e._keyInGroup:nt.createKeyString(e);var n=this._indexMap[t];return void 0!==n?this._entities[n]:null},r.hasChanges=function(){return this._entities.some(t)},r.getEntities=function(t){var n=e(t),r=this._entities.filter(n);return r},r._clear=function(){this._entities.forEach(function(e){null!=e&&e.entityAspect._detach()}),this._entities=null,this._indexMap=null,this._emptyIndexes=null},r._fixupKey=function(e,t){var n=this._indexMap[e];if(void 0===n)throw Error("Internal Error in key fixup - unable to locate entity");var r=this._entities[n],i=r.entityType.keyProperties[0].name;r.setProperty(i,t),delete r.entityAspect.hasTempKey,delete this._indexMap[e],this._indexMap[t]=n},r._replaceKey=function(e,t){var n=this._indexMap[e._keyInGroup];delete this._indexMap[e._keyInGroup],this._indexMap[t._keyInGroup]=n},n}();I.EntityManager=Ft;var Dt=function(){var e=new W("MergeStrategy");return e.PreserveChanges=e.addSymbol(),e.OverwriteChanges=e.addSymbol(),e.seal(),e}(),$t=function(){var e=new W("FetchStrategy");return e.FromServer=e.addSymbol(),e.FromLocalCache=e.addSymbol(),e.seal(),e}(),Lt=function(){function e(e,t){return t&&U(t).whereParam("fetchStrategy").isEnumOf($t).isOptional().whereParam("mergeStrategy").isEnumOf(Dt).isOptional().applyAll(e),e}var t=function(t){this.fetchStrategy=$t.FromServer,this.mergeStrategy=Dt.PreserveChanges,e(this,t)},n=t.prototype;return n._$typeName="QueryOptions",t.defaultInstance=new t,n.using=function(t){var n=new Lt(this);return Dt.contains(t)?t={mergeStrategy:t}:$t.contains(t)&&(t={fetchStrategy:t}),e(n,t)},n.setAsDefault=function(){return t.defaultInstance=this,this},n.toJSON=function(){return s(this)},t.fromJSON=function(e){return new Lt({fetchStrategy:$t.fromName(e.fetchStrategy),mergeStrategy:Dt.fromName(e.mergeStrategy)})},t}(),Nt=function(){var e=function(e){e=e||{},U(e).whereParam("allowConcurrentSaves").isBoolean().isOptional().withDefault(!1).whereParam("tag").isOptional().applyAll(this)},t=e.prototype;return t._$typeName="SaveOptions",t.setAsDefault=function(){return e.defaultInstance=this,this},e.defaultInstance=new e,e}(),Ot=function(){function e(e,t){return t&&U(t).whereParam("validateOnAttach").isBoolean().isOptional().whereParam("validateOnSave").isBoolean().isOptional().whereParam("validateOnQuery").isBoolean().isOptional().whereParam("validateOnPropertyChange").isBoolean().isOptional().applyAll(e),e}var t=function(t){this.validateOnAttach=!0,this.validateOnSave=!0,this.validateOnQuery=!1,this.validateOnPropertyChange=!0,e(this,t)},n=t.prototype;return n._$typeName="ValidationOptions",n.using=function(t){var n=new Ot(this);return e(n,t),n},n.setAsDefault=function(){return t.defaultInstance=this,this},t.defaultInstance=new t,t}();I.QueryOptions=Lt,I.SaveOptions=Nt,I.ValidationOptions=Ot,I.FetchStrategy=$t,I.MergeStrategy=Dt,function(e){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?e(require("breeze")):"function"==typeof define&&define.amd?I?e(I):define(["breeze"],e):e(I)}(function(e){var t,n=e.core,r=function(){this.name="jQuery",this.defaultSettings={}};r.prototype.initialize=function(){t=n.requireLib("jQuery","needed for 'ajax_jQuery' pluggin")},r.prototype.ajax=function(e){if(n.isEmpty(this.defaultSettings))t.ajax(e);else{var r=n.extend({},this.defaultSettings);n.extend(r,e),t.ajax(r)}},e.config.registerAdapter("ajax",r)}),function(e){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?e(require("breeze")):"function"==typeof define&&define.amd&&!I?define(["breeze"],e):e(I)}(function(e){function t(e){var t=e;return i.stringEndsWith(t,"/")&&(t=t.substr(0,t.length-1)),i.stringEndsWith(t,"/$metadata")||(t+="/$metadata"),t}function n(e){var t=Error(),n=e.response;if(t.message=n.statusText,t.statusText=n.statusText,t.status=n.statusCode,t.body=n.body,t.requestUri=n.requestUri,n.body)try{var r=JSON.parse(n.body);t.detail=r,t.message=r.error.message.value}catch(i){}return t}var r,i=e.core,o=e.EntityType,a=e.JsonResultsAdapter,s=function(){this.name="OData"};s.prototype.initialize=function(){r=i.requireLib("OData","Needed to support remote OData services"),r.jsonHandler.recognizeDates=!0},s.prototype.executeQuery=function(e,t,i,o){var a=e.serviceName+t;r.read(a,function(e){i({results:e.results,inlineCount:e.__count})},function(e){o&&o(n(e))})},s.prototype.fetchMetadata=function(e,i,o,a){var s=i.serviceName,c=t(s);r.read(c,function(t){if(!t||!t.dataServices){var n=Error("Metadata query failed for: "+c);onError?onError(n):o(n)}var r=t.dataServices.schema;e.hasMetadataFor(s)||(e._parseODataMetadata(s,r),e.addDataService(i)),o&&o(r)},function(e){var t=n(e);t.message="Metadata query failed for: "+c+"; "+(t.message||""),a&&a(t)},r.metadataHandler)},s.prototype.saveChanges=function(){throw Error("Breeze does not yet support saving thru OData")},s.prototype.jsonResultsAdapter=new a({name:"OData_default",visitNode:function(e,t,n){var r={};if(null!=e.__metadata){var a=o._getNormalizedTypeName(e.__metadata.type),s=a&&t.entityManager.metadataStore.getEntityType(a,!0);s&&s._mappedPropertiesCount===Object.keys(e).length-1&&(r.entityType=s)}var c=n.propertyName;return r.ignore=null!=e.__deferred||"__metadata"==c||"EntityKey"==c&&e.$type&&i.stringStartsWith(e.$type,"System.Data"),r}}),e.config.registerAdapter("dataService",s)}),function(e){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?e(require("breeze")):"function"==typeof define&&define.amd&&!I?define(["breeze"],e):e(I)}(function(e){function t(e){var t=e;return o.stringEndsWith(t,"/")&&(t=t.substr(0,t.length-1)),o.stringEndsWith(t,"/Metadata")||(t+="/Metadata"),t}function n(e,t,n){if(t){var i=r(e);n&&(i.message=n+"; "+ +i.message),t(i),e.onreadystatechange=null,e.abort=null}}function r(e){var t=Error();if(t.XHR=e,t.message=e.statusText,t.responseText=e.responseText,t.status=e.status,t.statusText=e.statusText,t.responseText)try{var n=JSON.parse(e.responseText);t.detail=n;var r=n.InnerException||n;t.message=r.ExceptionMessage||r.Message||e.responseText}catch(i){}return t}var i,o=e.core,a=e.EntityType,s=e.JsonResultsAdapter,c=function(){this.name="webApi"};c.prototype.checkForRecomposition=function(e){"ajax"===e.interfaceName&&e.isDefault&&this.initialize()},c.prototype.initialize=function(){if(i=e.config.getAdapterInstance("ajax"),!i)throw Error("Unable to initialize ajax for WebApi.");var t=i.ajax;if(!t)throw Error("Breeze was unable to find an 'ajax' adapter")},c.prototype.fetchMetadata=function(e,r,o,a){var s=r.serviceName,c=t(s);i.ajax({url:c,dataType:"json",success:function(t,n,i){var l=JSON.parse(t);if(!l)return a&&a(Error("Metadata query failed for: "+c)),void 0;var u=l.schema;return u?(e.hasMetadataFor(s)||(e._parseODataMetadata(s,u),e.addDataService(r)),o&&o(u),i.onreadystatechange=null,i.abort=null,void 0):(a&&a(Error("Metadata query failed for "+c+"; Unable to locate 'schema' member in metadata")),void 0)},error:function(e){n(e,a,"Metadata query failed for: "+c)}})},c.prototype.executeQuery=function(e,t,o,a){var s=e.serviceName+t;i.ajax({url:s,dataType:"json",success:function(e,t,n){try{var i=n.getResponseHeader("X-InlineCount");i&&(i=parseInt(i,10)),o({results:e,XHR:n,inlineCount:i}),n.onreadystatechange=null,n.abort=null}catch(s){var c=s instanceof Error?s:r(n);a&&a(c),n.onreadystatechange=null,n.abort=null}},error:function(e){n(e,a)}})},c.prototype.saveChanges=function(e,t,o,a){var s=e.serviceName+"SaveChanges";i.ajax({url:s,type:"POST",dataType:"json",contentType:"application/json",data:t,success:function(e,t,n){if(e.Error){var i=r(n);i.message=e.Error,a(i)}else e.XHR=n,o(e)},error:function(e){n(e,a)}})},c.prototype.jsonResultsAdapter=new s({name:"webApi_default",visitNode:function(e,t,n){var r=a._getNormalizedTypeName(e.$type),i=r&&t.entityManager.metadataStore.getEntityType(r,!0),o=n.propertyName,s=o&&"$"===o.substr(0,1);return{entityType:i,nodeId:e.$id,nodeRefId:e.$ref,ignore:s}}}),e.config.registerAdapter("dataService",c)}),function(e){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?e(require("breeze")):"function"==typeof define&&define.amd&&!I?define(["breeze"],e):e(I)}(function(e){var t=e.core;e.ComplexAspect;var n,r,i,o,a=Object.prototype.hasOwnProperty,s=function(){this.name="backbone"};s.prototype.initialize=function(){n=t.requireLib("Backbone"),r=t.requireLib("_;underscore"),i=n.Model.prototype.set,o=n.Model.prototype.get},s.prototype.createCtor=function(t){var r={};t.dataProperties.forEach(function(e){r[e.name]=e.defaultValue});var i=n.Model.extend({defaults:r,initialize:function(){if(t.navigationProperties){var r=this;t.navigationProperties.forEach(function(t){if(!t.isScalar){var i=e.makeRelationArray([],r,t);n.Model.prototype.set.call(r,t.name,i)}})}}});return i},s.prototype.getTrackablePropertyNames=function(e){var t=[];for(var n in e.attributes)t.push(n);return t},s.prototype.initializeEntityPrototype=function(e){e.getProperty=function(e){return this.get(e)},e.setProperty=function(e,t){return this.set(e,t),this},e.set=function(e,t,n){var s=this.entityAspect||this.complexAspect;if(!s)return i.call(this,e,t,n);var c,l,u,d=this,h=this.entityType||this.complexType;if(r.isObject(e)||null==e){if(c=e,n=t,!this._validate(c,n))return!1;for(u in c)if(a.call(c,u)){if(l=h.getProperty(u),null==l)throw Error("Unknown property: "+e);this._$interceptor(l,c[u],function(e){return 0===arguments.length?o.call(d,u):i.call(d,u,e,n)})}}else{if(c={},c[e]=t,n||(n={}),!this._validate(c,n))return!1;if(l=h.getProperty(e),null==l)throw Error("Unknown property: "+e);u=e,this._$interceptor(l,t,function(e){return 0===arguments.length?o.call(d,u):i.call(d,u,e,n)})}return this}},s.prototype.startTracking=function(r){if(!(r instanceof n.Model))throw Error("This entity is not an Backbone.Model instance");var a=r.entityType||r.complexType,s=r.attributes;a.dataProperties.forEach(function(e){if(e.isComplexProperty){var t=e.dataType._createInstanceCore(r,e.name);i.call(r,e.name,t)}else e.name in s?void 0===o.call(r,e.name)&&void 0!==e.defaultValue&&i.call(r,e.name,e.defaultValue):i.call(r,e.name,e.defaultValue)}),a.navigationProperties&&a.navigationProperties.forEach(function(n){var a;if(n.name in s){var c=o.call(r,n.name);if(n.isScalar){if(c&&!c.entityType)throw a=t.formatString("The value of the '%1' property for entityType: '%2' must be either null or another entity",n.name,r.entityType.name),Error(a)}else if(c){if(!c.parentEntity)throw a=t.formatString("The value of the '%1' property for entityType: '%2' must be either null or a Breeze relation array",n.name,r.entityType.name),Error(a)}else c=e.makeRelationArray([],r,n),i.call(r,n.name,c)}else n.isScalar?i.call(r,n.name,null):(c=e.makeRelationArray([],r,n),i.call(r,n.name,c))})},e.config.registerAdapter("modelLibrary",s)}),function(e){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?e(require("breeze")):"function"==typeof define&&define.amd&&!I?define(["breeze"],e):e(I)}(function(e){function t(e){var t=e.entityType||e.complexType;t.getProperties().forEach(function(t){var n=t.name;e[n]||Object.defineProperty(e,n,r(t))})}function n(e){var t=Object.getPrototypeOf(e);e._backingStore||(e._backingStore={});var n=t.entityType||t.complexType;return n.getProperties().forEach(function(t){var n=t.name;if(e.hasOwnProperty(n)){var r=e[n];delete e[n],e[n]=r}}),e._backingStore}function r(e){var t=e.name,n=function(e){return function(){return 0==arguments.length?e[t]:(e[t]=arguments[0],void 0)}};return{get:function(){var e=this._backingStore;if(e||(this._pendingSets.process(),e=this._backingStore))return e[t]},set:function(r){var i=this._backingStore;if(!i)return this._pendingSets.schedule(this,t,r),void 0;var o=n(i);this._$interceptor?this._$interceptor(e,r,o):o(r)},enumerable:!0,configurable:!0}}var i=e.core;e.ComplexAspect;var o=function(){this.name="backingStore"};o.prototype.initialize=function(){},o.prototype.getTrackablePropertyNames=function(e){var t=[];for(var n in e)if("_$typeName"!==n){var r=e[n];i.isFunction(r)||t.push(n)}return t},o.prototype.initializeEntityPrototype=function(e){e.getProperty=function(e){return this[e]},e.setProperty=function(e,t){if(!this._backingStore.hasOwnProperty(e))throw Error("Unknown property name:"+e);return this[e]=t,this},e.initializeFrom=function(e){var t=this;this.entityType.unmappedProperties.forEach(function(n){var r=n.name;e[r]=t[r]}),this._backingStore||(this._backingStore={})},e._pendingSets=[],e._pendingSets.schedule=function(e,t,n){if(this.push({entity:e,propName:t,value:n}),!this.isPending){this.isPending=!0;var r=this;setTimeout(function(){r.process()})}},e._pendingSets.process=function(){0!==this.length&&(this.forEach(function(e){e.entity._backingStore||(e.entity._backingStore={}),e.entity._backingStore[e.propName]=e.value}),this.length=0,this.isPending=!1)},t(e)},o.prototype.startTracking=function(t,r){r._pendingSets.process();var i=n(t),o=t.entityType||t.complexType;o.getProperties().forEach(function(n){var r=n.name,o=t[r];if(n.isDataProperty)if(n.isComplexProperty){var a=n.dataType._createInstanceCore(t,n.name);i[r]=a}else void 0===o&&(i[r]=n.defaultValue);else{if(!n.isNavigationProperty)throw Error("unknown property: "+r);if(void 0!==o)throw Error("Cannot assign a navigation property in an entity ctor.: "+n.Name);i[r]=n.isScalar?null:e.makeRelationArray([],t,n)}})},e.config.registerAdapter("modelLibrary",o)}),function(e){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?e(require("breeze")):"function"==typeof define&&define.amd&&!I?define(["breeze"],e):e(I)}(function(e){function t(e){e._koObj._suppressBreeze=!0}function n(e){var t=e.relationArray._koObj;t._suppressBreeze?t._suppressBreeze=!1:t.valueHasMutated()}var r,i=e.core,o=function(){this.name="ko"};o.prototype.initialize=function(){r=i.requireLib("ko","The Knockout library"),r.extenders.intercept=function(e,t){var n,i=t.instance,o=t.property;return n=e.splice?r.computed({read:e}):r.computed({read:e,write:function(t){return i._$interceptor(o,t,e),i}})}},o.prototype.getTrackablePropertyNames=function(e){var t=[];for(var n in e)if("entityType"!==n&&"_$typeName"!==n){var o=e[n];r.isObservable(o)?t.push(n):i.isFunction(o)||t.push(n)}return t},o.prototype.initializeEntityPrototype=function(e){e.getProperty=function(e){return this[e]()},e.setProperty=function(e,t){return this[e](t),this}},o.prototype.startTracking=function(i){var o=i.entityType||i.complexType;o.getProperties().sort(function(e,t){var n=e.isUnmapped?1:0,r=t.isUnmapped?1:0;return n-r}).forEach(function(o){var a,s=o.name,c=i[s];if(r.isObservable(c)){if(o.isNavigationProperty)throw Error("Cannot assign a navigation property in an entity ctor.: "+o.Name);a=c}else if(o.isDataProperty)o.isComplexProperty?c=o.dataType._createInstanceCore(i,o.name):void 0===c&&(c=o.defaultValue),a=r.observable(c);else{if(!o.isNavigationProperty)throw Error("unknown property: "+s);if(void 0!==c)throw Error("Cannot assign a navigation property in an entity ctor.: "+o.Name);o.isScalar?a=r.observable(null):(c=e.makeRelationArray([],i,o),a=r.observableArray(c),c._koObj=a,a.subscribe(t,null,"beforeChange"),c.arrayChanged.subscribe(n),a.equalityComparer=function(){throw Error("Collection navigation properties may NOT be set.")})}if(o.isNavigationProperty&&!o.isScalar)i[s]=a;else{var l=a.extend({intercept:{instance:i,property:o}});i[s]=l}})},e.config.registerAdapter("modelLibrary",o)}),I.config.initializeAdapterInstances({ajax:"jQuery",dataService:"webApi"});var Rt=window.ko;return!Rt&&window.require&&(Rt=window.require("ko")),Rt?I.config.initializeAdapterInstance("modelLibrary","ko"):I.config.initializeAdapterInstance("modelLibrary","backingStore"),this.window.breeze=I,I});