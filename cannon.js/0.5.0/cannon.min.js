/*
 * Copyright (c) 2012 cannon.js Authors
 * 
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use, copy,
 * modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */((function(){function w(a){}var a=a||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),a.Broadphase=function(){this.world=null},a.Broadphase.prototype.constructor=a.BroadPhase,a.Broadphase.prototype.collisionPairs=function(a){throw"collisionPairs not implemented for this BroadPhase class!"},a.NaiveBroadphase=function(){this.temp={r:new a.Vec3,normal:new a.Vec3,quat:new a.Quaternion,relpos:new a.Vec3}},a.NaiveBroadphase.prototype=new a.Broadphase,a.NaiveBroadphase.prototype.constructor=a.NaiveBroadphase,a.NaiveBroadphase.prototype.collisionPairs=function(b){var c=[],d=[],e=b.numObjects(),f=b.bodies,g=a.Shape.types,h=g.SPHERE|g.BOX|g.COMPOUND|g.CONVEXPOLYHEDRON,i=g.PLANE,j=a.Body.STATIC|a.Body.KINEMATIC,k=this.temp,l=k.r,m=k.normal,n=k.quat,o=k.relpos;for(var p=0;p<e;p++)for(var q=0;q<p;q++){var r=f[p],s=f[q];if(!((r.motionstate&j)===0&&!r.isSleeping()||(s.motionstate&j)===0&&!s.isSleeping()))continue;var t=r.shape,u=s.shape;if(t&&u){var v=t.type,w=u.type;if(v&h&&w&h){s.position.vsub(r.position,l),t.boundingSphereRadiusNeedsUpdate&&t.computeBoundingSphereRadius(),u.boundingSphereRadiusNeedsUpdate&&u.computeBoundingSphereRadius();var x=t.boundingSphereRadius+u.boundingSphereRadius;l.norm2()<x*x&&(c.push(r),d.push(s))}else if(v&h&&w&g.PLANE||w&h&&v&g.PLANE){var y=v===i?p:q,z=v!==i?p:q;f[z].position.vsub(f[y].position,l),m.set(0,0,1),f[y].quaternion.vmult(m,m),f[z].shape.boundingSphereRadiusNeedsUpdate&&f[z].shape.computeBoundingSphereRadius();var A=l.dot(m)-f[z].shape.boundingSphereRadius;A<0&&(c.push(r),d.push(s))}}else if(!!t||!!u){var B=t?s:r,C=t?r:s,D=C.shape,E=D.type;if(E&h){if(E===g.SPHERE)B.position.vsub(C.position,o),D.radius*D.radius>=o.norm2()&&(c.push(B),d.push(C));else if(E===g.CONVEXPOLYHEDRON||E===g.BOX||E===g.COMPOUND){D.boundingSphereRadiusNeedsUpdate&&D.computeBoundingSphereRadius();var F=D.boundingSphereRadius;B.position.vsub(C.position,o),F*F>=o.norm2()&&(c.push(B),d.push(C))}}else if(E===g.PLANE){var G=C;m.set(0,0,1),G.quaternion.vmult(m,m),B.position.vsub(G.position,o),m.dot(o)<=0&&(c.push(B),d.push(C))}}}return[c,d]},a.Ray=function(b,c){function q(a,b,c){return c.vsub(a,m),o=m.dot(b),b.mult(o,n),n.vadd(a,n),p=c.distanceTo(n),p}function B(a,b,c,d){return d.vsub(b,m),c.vsub(b,z),a.vsub(b,A),r=m.dot(m),s=m.dot(z),t=m.dot(A),u=z.dot(z),v=z.dot(A),w=1/(r*u-s*s),x=(u*t-s*v)*w,y=(r*v-s*t)*w,x>=0&&y>=0&&x+y<1}this.origin=b||new a.Vec3,this.direction=c||new a.Vec3;var d=1e-4;this.setPrecision=function(a){d=a};var e=new a.Vec3,f=new a.Vec3,g=new a.Vec3,h=new a.Vec3,i=new a.Vec3,j=new a.Vec3,k=new a.Vec3,l=new a.Vec3;this.intersectBody=function(b){if(b.shape instanceof a.ConvexPolyhedron)return this.intersectShape(b.shape,b.quaternion,b.position,b);if(b.shape instanceof a.Box)return this.intersectShape(b.shape.convexPolyhedronRepresentation,b.quaternion,b.position,b);console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes.")},this.intersectShape=function(b,c,h,i){var m,n=[];if(b instanceof a.ConvexPolyhedron){var o=q(this.origin,this.direction,h);if(o>b.boundingSphereRadius())return n;var p,r,s=b.faces,t=b.vertices,u=b.faceNormals;for(fi=0;fi<s.length;fi++){var v=s[fi],w=u[fi],x=c,y=h;t[v[0]].copy(j),x.vmult(j,j),j.vadd(y,j),j.vsub(this.origin,j),x.vmult(w,k),p=this.direction.dot(k);if(Math.abs(p)<d)continue;r=k.dot(j)/p;if(r<0)continue;if(p<0){this.direction.mult(r,l),l.vadd(this.origin,l),t[v[0]].copy(e),x.vmult(e,e),y.vadd(e,e);for(var z=1;z<v.length-1;z++){t[v[z]].copy(f),t[v[z+1]].copy(g),x.vmult(f,f),x.vmult(g,g),y.vadd(f,f),y.vadd(g,g);if(B(l,e,f,g)){m={distance:this.origin.distanceTo(l),point:l.copy(),face:v,body:i},n.push(m);break}}}}}return n},this.intersectBodies=function(a){var b=[];for(var c=0,d=a.length;c<d;c++){var e=this.intersectBody(a[c]);Array.prototype.push.apply(b,e)}return b.sort(function(a,b){return a.distance-b.distance}),b};var m=new a.Vec3,n=new a.Vec3,o,p,r,s,t,u,v,w,x,y,z=new a.Vec3,A=new a.Vec3},a.Ray.prototype.constructor=a.Ray,a.Mat3=function(a){a?this.elements=a:this.elements=[0,0,0,0,0,0,0,0,0]},a.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},a.Mat3.prototype.setZero=function(){var a=this.elements;a[0]=0,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=0,a[6]=0,a[7]=0,a[8]=0},a.Mat3.prototype.setTrace=function(a){this.elements[0]=a.x,this.elements[4]=a.y,this.elements[8]=a.z},a.Mat3.prototype.vmult=function(b,c){c=c||new a.Vec3;var d=this.elements,e=b.x,f=b.y,g=b.z;return c.x=d[0]*e+d[1]*f+d[2]*g,c.y=d[3]*e+d[4]*f+d[5]*g,c.z=d[6]*e+d[7]*f+d[8]*g,c},a.Mat3.prototype.smult=function(a){for(var b=0;b<this.elements.length;b++)this.elements[b]*=a},a.Mat3.prototype.mmult=function(b){var c=new a.Mat3;for(var d=0;d<3;d++)for(var e=0;e<3;e++){var f=0;for(var g=0;g<3;g++)f+=b.elements[d+g*3]*this.elements[g+e*3];c.elements[d+e*3]=f}return c},a.Mat3.prototype.solve=function(b,c){c=c||new a.Vec3;var d=3,e=4,f=[];for(var g=0;g<d*e;g++)f.push(0);var g,h;for(g=0;g<3;g++)for(h=0;h<3;h++)f[g+e*h]=this.elements[g+3*h];f[3]=b.x,f[7]=b.y,f[11]=b.z;var i=3,j=i,k,l=4,m,n;do{g=j-i;if(f[g+e*g]===0)for(h=g+1;h<j;h++)if(f[g+e*h]!==0){k=l;do m=l-k,f[m+e*g]+=f[m+e*h];while(--k);break}if(f[g+e*g]!==0)for(h=g+1;h<j;h++){var o=f[g+e*h]/f[g+e*g];k=l;do m=l-k,f[m+e*h]=m<=g?0:f[m+e*h]-f[m+e*g]*o;while(--k)}}while(--i);c.z=f[2*e+3]/f[2*e+2],c.y=(f[1*e+3]-f[1*e+2]*c.z)/f[1*e+1],c.x=(f[0*e+3]-f[0*e+2]*c.z-f[0*e+1]*c.y)/f[0*e+0];if(isNaN(c.x)||isNaN(c.y)||isNaN(c.z)||c.x===Infinity||c.y===Infinity||c.z===Infinity)throw"Could not solve equation! Got x=["+c.toString()+"], b=["+b.toString()+"], A=["+this.toString()+"]";return c},a.Mat3.prototype.e=function(a,b,c){if(c===undefined)return this.elements[b+3*a];this.elements[b+3*a]=c},a.Mat3.prototype.copy=function(b){b=b||new a.Mat3;for(var c=0;c<this.elements.length;c++)b.elements[c]=this.elements[c];return b},a.Mat3.prototype.toString=function(){var a="",b=",";for(var c=0;c<9;c++)a+=this.elements[c]+b;return a},a.Mat3.prototype.reverse=function(b){b=b||new a.Mat3;var c=3,d=6,e=[];for(var f=0;f<c*d;f++)e.push(0);var f,g;for(f=0;f<3;f++)for(g=0;g<3;g++)e[f+d*g]=this.elements[f+3*g];e[3]=1,e[9]=0,e[15]=0,e[4]=0,e[10]=1,e[16]=0,e[5]=0,e[11]=0,e[17]=1;var h=3,i=h,j,k=d,l;do{f=i-h;if(e[f+d*f]===0)for(g=f+1;g<i;g++)if(e[f+d*g]!==0){j=k;do l=k-j,e[l+d*f]+=e[l+d*g];while(--j);break}if(e[f+d*f]!==0)for(g=f+1;g<i;g++){var m=e[f+d*g]/e[f+d*f];j=k;do l=k-j,e[l+d*g]=l<=f?0:e[l+d*g]-e[l+d*f]*m;while(--j)}}while(--h);f=2;do{g=f-1;do{var m=e[f+d*g]/e[f+d*f];j=d;do l=d-j,e[l+d*g]=e[l+d*g]-e[l+d*f]*m;while(--j)}while(g--)}while(--f);f=2;do{var m=1/e[f+d*f];j=d;do l=d-j,e[l+d*f]=e[l+d*f]*m;while(--j)}while(f--);f=2;do{g=2;do{l=e[c+g+d*f];if(isNaN(l)||l===Infinity)throw"Could not reverse! A=["+this.toString()+"]";b.e(f,g,l)}while(g--)}while(f--);return b};var b=0;a.Vec3=function(a,c,d){this.x=a||0,this.y=c||0,this.z=d||0,b++},a.Vec3.prototype.cross=function(b,c){var d=b.x,e=b.y,f=b.z,g=this.x,h=this.y,i=this.z;c=c||new a.Vec3;var j=[this.x,this.y,this.z],k=[b.x,b.y,b.z];return c.x=h*f-i*e,c.y=i*d-g*f,c.z=g*e-h*d,c},a.Vec3.prototype.set=function(a,b,c){return this.x=a,this.y=b,this.z=c,this},a.Vec3.prototype.vadd=function(b,c){if(c)c.x=b.x+this.x,c.y=b.y+this.y,c.z=b.z+this.z;else return new a.Vec3(this.x+b.x,this.y+b.y,this.z+b.z)},a.Vec3.prototype.vsub=function(b,c){if(c)c.x=this.x-b.x,c.y=this.y-b.y,c.z=this.z-b.z;else return new a.Vec3(this.x-b.x,this.y-b.y,this.z-b.z)},a.Vec3.prototype.crossmat=function(){return new a.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},a.Vec3.prototype.normalize=function(){var a=this.x,b=this.y,c=this.z,d=Math.sqrt(a*a+b*b+c*c);if(d>0){var e=1/d;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return d},a.Vec3.prototype.unit=function(b){b=b||new a.Vec3;var c=this.x,d=this.y,e=this.z,f=Math.sqrt(c*c+d*d+e*e);return f>0?(f=1/f,b.x=c*f,b.y=d*f,b.z=e*f):(b.x=1,b.y=0,b.z=0),b},a.Vec3.prototype.norm=function(){var a=this.x,b=this.y,c=this.z;return Math.sqrt(a*a+b*b+c*c)},a.Vec3.prototype.norm2=function(){return this.dot(this)},a.Vec3.prototype.distanceTo=function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z;return Math.sqrt((e-b)*(e-b)+(f-c)*(f-c)+(g-d)*(g-d))},a.Vec3.prototype.mult=function(b,c){return c||(c=new a.Vec3),c.x=b*this.x,c.y=b*this.y,c.z=b*this.z,c},a.Vec3.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},a.Vec3.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},a.Vec3.prototype.negate=function(b){return b=b||new a.Vec3,b.x=-this.x,b.y=-this.y,b.z=-this.z,b};var c=new a.Vec3,d=new a.Vec3;a.Vec3.prototype.tangents=function(a,b){var e=this.norm();if(e>0){var f=c,g=1/e;f.set(this.x*g,this.y*g,this.z*g);var h=d;Math.abs(f.x)<.9?(h.set(1,0,0),f.cross(h,a)):(h.set(0,1,0),f.cross(h,a)),f.cross(a,b)}else a.set(1,0,0).normalize(),b.set(0,1,0).normalize()},a.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},a.Vec3.prototype.copy=function(b){return b=b||new a.Vec3,b.x=this.x,b.y=this.y,b.z=this.z,b},a.Vec3.prototype.lerp=function(a,b,c){var d=this.x,e=this.y,f=this.z;c.x=d+(a.x-d)*b,c.y=e+(a.y-e)*b,c.z=f+(a.z-f)*b},a.Vec3.prototype.almostEquals=function(a,b){return b===undefined&&(b=1e-6),Math.abs(this.x-a.x)>b||Math.abs(this.y-a.y)>b||Math.abs(this.z-a.z)>b?!1:!0},a.Vec3.prototype.almostZero=function(a){return a===undefined&&(a=1e-6),Math.abs(this.x)>a||Math.abs(this.y)>a||Math.abs(this.z)>a?!1:!0},a.Quaternion=function(a,b,c,d){this.x=a!=undefined?a:0,this.y=b!=undefined?b:0,this.z=c!=undefined?c:0,this.w=d!=undefined?d:1},a.Quaternion.prototype.set=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.w=d},a.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},a.Quaternion.prototype.setFromAxisAngle=function(a,b){var c=Math.sin(b*.5);this.x=a.x*c,this.y=a.y*c,this.z=a.z*c,this.w=Math.cos(b*.5)},a.Quaternion.prototype.toAxisAngle=function(b){b=b||new a.Vec3,this.normalize();var c=2*Math.acos(this.w),d=Math.sqrt(1-this.w*this.w);return d<.001?(b.x=this.x,b.y=this.y,b.z=this.z):(b.x=this.x/d,b.y=this.y/d,b.z=this.z/d),[b,c]},a.Quaternion.prototype.setFromVectors=function(a,b){var c=a.cross(b);this.x=c.x,this.y=c.y,this.z=c.z,this.w=Math.sqrt(Math.pow(a.norm(),2)*Math.pow(b.norm(),2))+a.dot(b),this.normalize()};var e=new a.Vec3,f=new a.Vec3,g=new a.Vec3;a.Quaternion.prototype.mult=function(b,c){var d=this.w;return c==undefined&&(c=new a.Quaternion),e.set(this.x,this.y,this.z),f.set(b.x,b.y,b.z),c.w=d*b.w-e.dot(f),e.cross(f,g),c.x=d*f.x+b.w*e.x+g.x,c.y=d*f.y+b.w*e.y+g.y,c.z=d*f.z+b.w*e.z+g.z,c},a.Quaternion.prototype.inverse=function(b){var c=this.x,d=this.y,e=this.z,f=this.w;b==undefined&&(b=new a.Quaternion),this.conjugate(b);var g=1/(c*c+d*d+e*e+f*f);return b.x*=g,b.y*=g,b.z*=g,b.w*=g,b},a.Quaternion.prototype.conjugate=function(b){return b==undefined&&(b=new a.Quaternion),b.x=-this.x,b.y=-this.y,b.z=-this.z,b.w=this.w,b},a.Quaternion.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);a===0?(this.x=0,this.y=0,this.z=0,this.w=0):(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a)},a.Quaternion.prototype.normalizeFast=function(){var a=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;a===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=a,this.y*=a,this.z*=a,this.w*=a)},a.Quaternion.prototype.vmult=function(b,c){c=c||new a.Vec3;if(this.w==0)c.x=b.x,c.y=b.y,c.z=b.z;else{var d=b.x,e=b.y,f=b.z,g=this.x,h=this.y,i=this.z,j=this.w,k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;c.x=k*j+n*-g+l*-i-m*-h,c.y=l*j+n*-h+m*-g-k*-i,c.z=m*j+n*-i+k*-h-l*-g}return c},a.Quaternion.prototype.copy=function(a){a.x=this.x,a.y=this.y,a.z=this.z,a.w=this.w},a.Quaternion.prototype.toEuler=function(a,b){b=b||"YZX";var c,d,e,f=this.x,g=this.y,h=this.z,i=this.w;switch(b){case"YZX":var j=f*g+h*i;j>.499&&(c=2*Math.atan2(f,i),d=Math.PI/2,e=0),j<-0.499&&(c=-2*Math.atan2(f,i),d=-Math.PI/2,e=0);if(isNaN(c)){var k=f*f,l=g*g,m=h*h;c=Math.atan2(2*g*i-2*f*h,1-2*l-2*m),d=Math.asin(2*j),e=Math.atan2(2*f*i-2*g*h,1-2*k-2*m)}break;default:throw new Error("Euler order "+b+" not supported yet.")}a.y=c,a.z=d,a.x=e},a.Shape=function(){this.type=0,this.aabbmin=new a.Vec3,this.aabbmax=new a.Vec3,this.boundingSphereRadius=0,this.boundingSphereRadiusNeedsUpdate=!0},a.Shape.prototype.constructor=a.Shape,a.Shape.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},a.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},a.Shape.prototype.calculateLocalInertia=function(a,b){throw"calculateLocalInertia() not implemented for shape type "+this.type},a.Shape.prototype.calculateTransformedInertia=function(b,c,d){d==undefined&&(d=new a.Vec3),c.normalize();var e=new a.Vec3;this.calculateLocalInertia(b,e);var f=c.vmult(e);return d.x=Math.abs(f.x),d.y=Math.abs(f.y),d.z=Math.abs(f.z),d},a.Shape.calculateLocalAABB=function(){throw new Error(".calculateLocalAABB is not implemented for this Shape yet!")},a.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},a.Body=function(b){a.EventTarget.apply(this),this.type=b;var c=this;this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new a.Vec3},a.Body.DYNAMIC=1,a.Body.STATIC=2,a.Body.KINEMATIC=4,a.Particle=function(b,c){if(typeof b!="number")throw new Error("Argument 1 (mass) must be a number.");if(!(typeof c=="undefined"||c instanceof a.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");a.Body.call(this,"particle");var d=this;this.position=new a.Vec3,this.initPosition=new a.Vec3,this.velocity=new a.Vec3,this.initVelocity=new a.Vec3,this.force=new a.Vec3,this.mass=b,this.invMass=b>0?1/b:0,this.material=c,this.linearDamping=.01,this.motionstate=b<=0?a.Body.STATIC:a.Body.DYNAMIC,this.allowSleep=!0,this.sleepState=0,this.isAwake=function(){return d.sleepState==0},this.isSleepy=function(){return d.sleepState==1},this.isSleeping=function(){return d.sleepState==2},this.sleepSpeedLimit=.1,this.sleepTimeLimit=1,this.timeLastSleepy=0,this.wakeUp=function(){d.sleepState=0,d.dispatchEvent({type:"wakeup"})},this.sleep=function(){d.sleepState=2},this.sleepTick=function(a){if(d.allowSleep){var b=d.sleepState,c=d.velocity.norm2(),e=Math.pow(d.sleepSpeedLimit,2);b==0&&c<e?(d.sleepState=1,d.timeLastSleepy=a,d.dispatchEvent({type:"sleepy"})):b==1&&c>e?d.wakeUp():b==1&&a-d.timeLastSleepy>d.sleepTimeLimit&&(d.sleepState=2,d.dispatchEvent({type:"sleep"}))}}},a.RigidBody=function(b,c,d){if(typeof b!="number")throw new Error("Argument 1 (mass) must be a number.");if(!(typeof d=="undefined"||d instanceof a.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");a.Particle.call(this,b,d);var e=this;this.tau=new a.Vec3,this.quaternion=new a.Quaternion,this.initQuaternion=new a.Quaternion,this.angularVelocity=new a.Vec3,this.initAngularVelocity=new a.Vec3,this.shape=c,this.inertia=new a.Vec3,c.calculateLocalInertia(b,this.inertia),this.inertiaWorld=new a.Vec3,this.inertia.copy(this.inertiaWorld),this.inertiaWorldAutoUpdate=!1,this.invInertia=new a.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.invInertiaWorld=new a.Vec3,this.invInertia.copy(this.invInertiaWorld),this.invInertiaWorldAutoUpdate=!1,this.angularDamping=.01,this.aabbmin=new a.Vec3,this.aabbmax=new a.Vec3,this.calculateAABB(),this.wlambda=new a.Vec3},a.RigidBody.constructor=a.RigidBody,a.RigidBody.prototype.calculateAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax)},a.RigidBody.prototype.applyImpulse=function(b,c,d){d=d||1/60;var e=new a.Vec3,f=new a.Vec3;b.vsub(this.position,e),e.cross(c,f),this.velocity.vadd(c.mult(d),this.velocity),this.angularVelocity.vadd(f.mult(d),this.angularVelocity)},a.Sphere=function(b){a.Shape.call(this),this.radius=b!=undefined?Number(b):1,this.type=a.Shape.types.SPHERE},a.Sphere.prototype=new a.Shape,a.Sphere.prototype.constructor=a.Sphere,a.Sphere.prototype.calculateLocalInertia=function(b,c){c=c||new a.Vec3;var d=2*b*this.radius*this.radius/5;return c.x=d,c.y=d,c.z=d,c},a.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},a.Sphere.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=!1,this.boundingSphereRadius=this.radius},a.Sphere.prototype.calculateWorldAABB=function(a,b,c,d){var e=this.radius,f=["x","y","z"];for(var g=0;g<f.length;g++){var h=f[g];c[h]=a[h]-e,d[h]=a[h]+e}},a.Box=function(b){a.Shape.call(this),this.halfExtents=b,this.type=a.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},a.Box.prototype=new a.Shape,a.Box.prototype.constructor=a.Box,a.Box.prototype.updateConvexPolyhedronRepresentation=function(){var b=this.halfExtents.x,c=this.halfExtents.y,d=this.halfExtents.z,e=a.Vec3,f=new a.ConvexPolyhedron([new e(-b,-c,-d),new e(b,-c,-d),new e(b,c,-d),new e(-b,c,-d),new e(-b,-c,d),new e(b,-c,d),new e(b,c,d),new e(-b,c,d)],[[0,1,2,3],[4,5,6,7],[0,1,5,4],[2,3,7,6],[0,3,7,4],[1,2,6,5]],[new e(0,0,-1),new e(0,0,1),new e(0,-1,0),new e(0,1,0),new e(-1,0,0),new e(1,0,0)]);this.convexPolyhedronRepresentation=f},a.Box.prototype.calculateLocalInertia=function(b,c){c=c||new a.Vec3;var d=this.halfExtents;return c.x=1/12*b*(2*d.y*2*d.y+2*d.z*2*d.z),c.y=1/12*b*(2*d.x*2*d.x+2*d.z*2*d.z),c.z=1/12*b*(2*d.y*2*d.y+2*d.x*2*d.x),c},a.Box.prototype.getSideNormals=function(a,b){var c=a,d=this.halfExtents;c[0].set(d.x,0,0),c[1].set(0,d.y,0),c[2].set(0,0,d.z),c[3].set(-d.x,0,0),c[4].set(0,-d.y,0),c[5].set(0,0,-d.z);if(b!=undefined)for(var e=0;e<c.length;e++)b.vmult(c[e],c[e]);return c},a.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},a.Box.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm(),this.boundingSphereRadiusNeedsUpdate=!1};var h=new a.Vec3,k=new a.Vec3;a.Box.prototype.forEachWorldCorner=function(a,b,c){var d=this.halfExtents,e=[[d.x,d.y,d.z],[-d.x,d.y,d.z],[-d.x,-d.y,d.z],[-d.x,-d.y,-d.z],[d.x,-d.y,-d.z],[d.x,d.y,-d.z],[-d.x,d.y,-d.z],[d.x,-d.y,d.z]];for(var f=0;f<e.length;f++)h.set(e[f][0],e[f][1],e[f][2]),b.vmult(h,h),a.vadd(h,h),c(h.x,h.y,h.z)},a.Box.prototype.calculateWorldAABB=function(a,b,c,d){c.set(Infinity,Infinity,Infinity),d.set(-Infinity,-Infinity,-Infinity),this.forEachWorldCorner(a,b,function(a,b,e){a>d.x&&(d.x=a),b>d.y&&(d.y=b),e>d.z&&(d.z=e),a<c.x&&(c.x=a),b<c.y&&(c.y=b),e<c.z&&(c.z=e)})},a.Plane=function(){a.Shape.call(this),this.type=a.Shape.types.PLANE},a.Plane.prototype=new a.Shape,a.Plane.prototype.constructor=a.Plane,a.Plane.prototype.calculateLocalInertia=function(b,c){return c=c||new a.Vec3,c},a.Plane.prototype.volume=function(){return Infinity};var l=new a.Vec3(0,0,1);a.Plane.prototype.calculateWorldAABB=function(a,b,c,d){b.vmult(l,l),c.set(Infinity,Infinity,Infinity);var e=["x","y","z"];for(var f=0;f<e.length;f++){var g=e[f];l[g]==1&&(d[g]=a[g]),l[g]==-1&&(c[g]=a[g])}},a.Compound=function(){a.Shape.call(this),this.type=a.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},a.Compound.prototype=new a.Shape,a.Compound.prototype.constructor=a.Compound,a.Compound.prototype.addChild=function(b,c,d){c=c||new a.Vec3,d=d||new a.Quaternion,this.childShapes.push(b),this.childOffsets.push(c),this.childOrientations.push(d)},a.Compound.prototype.volume=function(){var a=0;for(var b=0;b<this.childShapes.length;b++)a+=this.childShapes[b].volume();return a};var m=new a.Vec3,n=new a.Vec3;a.Compound.prototype.calculateLocalInertia=function(b,c){c=c||new a.Vec3;var d=this.volume(),e=n;for(var f=0,g=this.childShapes.length;f!==g;f++){var h=this.childShapes[f],i=this.childOffsets[f],j=this.childOrientations[f],k=h.volume()/d*b;h.calculateLocalInertia(k,e),c.vadd(e,c);var l=m;l.set(k*i.x*i.x,k*i.y*i.y,k*i.z*i.z),c.vadd(l,c)}return c},a.Compound.prototype.computeBoundingSphereRadius=function(){var a=0;for(var b=0;b<this.childShapes.length;b++){var c=this.childShapes[b];c.boundingSphereRadiusNeedsUpdate&&c.computeBoundingSphereRadius();var d=this.childOffsets[b].norm()+c.boundingSphereRadius;a<d&&(a=d)}this.boundingSphereRadius=a,this.boundingSphereRadiusNeedsUpdate=!1};var o=new a.Vec3,p=new a.Vec3,q=new a.Vec3,r=new a.Quaternion;a.Compound.prototype.calculateWorldAABB=function(a,b,c,d){var e=this.childShapes.length;c.set(Infinity,Infinity,Infinity),d.set(-Infinity,-Infinity,-Infinity);for(var f=0;f<e;f++)this.childOffsets[f].copy(q),b.vmult(q,q),a.vadd(q,q),b.mult(this.childOrientations[f],r),this.childShapes[f].calculateWorldAABB(q,r,p,o),p.x<c.x&&(c.x=p.x),p.y<c.y&&(c.y=p.y),p.z<c.z&&(c.z=p.z),o.x>d.x&&(d.x=o.x),o.y>d.y&&(d.y=o.y),o.z>d.z&&(d.z=o.z)},a.ConvexPolyhedron=function(b,c,d){function r(a,b,c,d,e){var f=a.vertices.length,g=null,h=null,i=a.vertices;for(var j=0;j<f;j++){i[j].copy(q),d.vmult(q,q),q.vadd(c,q);var k=q.dot(b);if(g===null||k>g)g=k;if(h===null||k<h)h=k}if(h>g){var l=h;h=g,g=l}e[0]=g,e[1]=h}function H(a,b){var c=e.faces[a],d=e.vertices[c[0]],f=e.vertices[c[1]],g=e.vertices[c[2]];return L(d,f,g,b)}function I(a,b){var c=e.faces[a],d=e.faceNormals[a],f=e.vertices[c[0]],g=-d.dot(f);return g}function L(a,b,c,d){b.vsub(a,K),c.vsub(b,J),J.cross(K,d),d.isZero()||d.normalize()}function M(a){var b=e.faces[a],c="";for(var d=0;d<b.length;d++)c+=" ("+e.vertices[b[d]]+")";return c}function N(a,b){return a[0]===b[1]&&a[1]===b[0]}function O(){return(Math.random()-.5)*2*1e-6}var e=this;a.Shape.call(this),this.type=a.Shape.types.CONVEXPOLYHEDRON,this.vertices=b||[],this.faces=c||[],this.faceNormals=d||[];for(var f=0;f<this.faceNormals.length;f++)this.faceNormals[f].normalize();this.uniqueEdges=[];var g=this.vertices.length;for(var h=0;h<g;h++){var i=this.vertices[h];if(i instanceof a.Vec3)this.uniqueEdges.push(i);else throw"Argument 1 must be instance of CANNON.Vec3"}for(var f=0;f<this.faces.length;f++){var j=this.faces[f].length,k=j;for(var l=0;l<k;l++){var m=(l+1)%j,n=new a.Vec3;this.vertices[this.faces[f][l]].vsub(this.vertices[this.faces[f][m]],n),n.normalize();var o=!1;for(var i=0;i<this.uniqueEdges.length;i++)if(this.uniqueEdges[i].almostEquals(n)||this.uniqueEdges[i].almostEquals(n)){o=!0;break}o||this.uniqueEdges.push(n);if(n)n.face1=f;else{var p;p.m_face0=f,edges.insert(vp,p)}}}var q=new a.Vec3;this.testSepAxis=function(a,b,c,d,e,f){var g=[],h=[],i=this;r(i,a,c,d,g),r(b,a,e,f,h);var j=g[0],k=g[1],l=h[0],m=h[1];if(j<m||l<k)return!1;var n=j-m,o=l-k;return depth=n<o?n:o,depth};var s=new a.Vec3,t=new a.Vec3,u=new a.Vec3,v=new a.Vec3,w=new a.Vec3,x=new a.Vec3;this.findSeparatingAxis=function(a,b,c,d,e,f){var g=Infinity,h=this,i=0,j=h.faces.length;for(var k=0;k<j;k++){h.faceNormals[k].copy(s),c.vmult(s,s);var l=h.testSepAxis(s,a,b,c,d,e);if(l===!1)return!1;l<g&&(g=l,s.copy(f))}var m=a.faces.length;for(var k=0;k<m;k++){a.faceNormals[k].copy(t),e.vmult(t,t),i++;var l=h.testSepAxis(t,a,b,c,d,e);if(l===!1)return!1;l<g&&(g=l,t.copy(f))}var n,o,p,q,r=0;for(var y=0;y<h.uniqueEdges.length;y++){h.uniqueEdges[y].copy(v),c.vmult(v,v);for(var z=0;z<a.uniqueEdges.length;z++){a.uniqueEdges[z].copy(w),e.vmult(w,w),v.cross(w,x),r++;if(!x.almostZero()){x.normalize();var A=h.testSepAxis(x,a,b,c,d,e);if(A===!1)return!1;A<g&&(g=A,x.copy(f))}}}return d.vsub(b,u),u.dot(f)>0&&f.negate(f),!0};var y=new a.Vec3;this.clipAgainstHull=function(b,c,d,e,f,g,h,i,j){if(!(b instanceof a.Vec3))throw new Error("posA must be Vec3");if(!(c instanceof a.Quaternion))throw new Error("quatA must be Quaternion");var k=this,l=i,m=-1,n=-Infinity;for(var o=0;o<d.faces.length;o++){d.faceNormals[o].copy(y),f.vmult(y,y);var p=y.dot(g);p>n&&(n=p,m=o)}var q=[];polyB=d.faces[m];var r=polyB.length;for(var s=0;s<r;s++){var t=d.vertices[polyB[s]],u=new a.Vec3;t.copy(u),f.vmult(u,u),e.vadd(u,u),q.push(u)}m>=0&&this.clipFaceAgainstHull(g,b,c,q,h,i,j)};var z=new a.Vec3,A=new a.Vec3,B=new a.Vec3,C=new a.Vec3,D=new a.Vec3,E=new a.Vec3,F=new a.Vec3,G=new a.Vec3;this.clipFaceAgainstHull=function(b,c,d,e,f,g,h){if(!(b instanceof a.Vec3))throw new Error("sep normal must be vector");if(!(e instanceof Array))throw new Error("world verts must be array");f=Number(f),g=Number(g);var i=this,j=[],k=e,l=j,m=-1,n=Infinity;for(var o=0;o<i.faces.length;o++){i.faceNormals[o].copy(z),d.vmult(z,z);var p=z.dot(b);p<n&&(n=p,m=o)}if(m<0){console.log("--- did not find any closest face... ---");return}var q=i.faces[m];q.connectedFaces=[];for(var r=0;r<i.faces.length;r++)for(var s=0;s<i.faces[r].length;s++)q.indexOf(i.faces[r][s])!==-1&&r!==m&&q.connectedFaces.indexOf(r)===-1&&q.connectedFaces.push(r);var t=k.length,u=q.length,v=[];for(var w=0;w<u;w++){var x=i.vertices[q[w]],y=i.vertices[q[(w+1)%u]];x.vsub(y,A),A.copy(B),d.vmult(B,B),c.vadd(B,B),this.faceNormals[m].copy(C),d.vmult(C,C),c.vadd(C,C),B.cross(C,D),D.negate(D),x.copy(E),d.vmult(E,E),c.vadd(E,E);var H=-E.dot(D),J,K=q.connectedFaces[w];this.faceNormals[K].copy(F);var L=I(K);F.copy(G),d.vmult(G,G);var J=L-G.dot(c);this.clipFaceAgainstPlane(k,l,G,J);while(k.length)k.shift();while(l.length)k.push(l.shift())}this.faceNormals[m].copy(F);var L=I(m);F.copy(G),d.vmult(G,G);var J=L-G.dot(c);for(var r=0;r<k.length;r++){var M=G.dot(k[r])+J;M<=f&&(console.log("clamped: depth="+M+" to minDist="+(f+"")),M=f);if(M<=g){var N=k[r];if(M<=0){var O={point:N,normal:G,depth:M};h.push(O)}}}},this.clipFaceAgainstPlane=function(b,c,d,e){if(d instanceof a.Vec3){if(b instanceof Array){if(c instanceof Array){var f,g,h=b.length;if(h<2)return c;var i=b[b.length-1],j=b[0];f=d.dot(i)+e;for(var k=0;k<h;k++){j=b[k],g=d.dot(j)+e;if(f<0)if(g<0){var l=new a.Vec3;j.copy(l),c.push(l)}else{var l=new a.Vec3;i.lerp(j,f/(f-g),l),c.push(l)}else if(g<0){var l=new a.Vec3;i.lerp(j,f/(f-g),l),c.push(l),c.push(j)}i=j,f=g}return c}throw new Error("outvertices must be Array, "+c+" given")}throw new Error("invertices must be Array, "+b+" given")}throw new Error("planeNormal must be Vec3, "+d+" given")};var e=this,J=new a.Vec3,K=new a.Vec3;this.calculateLocalInertia=function(a,b){e.computeAABB();var c=this.aabbmax.x-this.aabbmin.x,d=this.aabbmax.y-this.aabbmin.y,f=this.aabbmax.z-this.aabbmin.z;b.x=1/12*a*(2*d*2*d+2*f*2*f),b.y=1/12*a*(2*c*2*c+2*f*2*f),b.z=1/12*a*(2*d*2*d+2*c*2*c)};var P=new a.Vec3;this.computeAABB=function(){var a=this.vertices.length,b=this.aabbmin,c=this.aabbmax,d=this.vertices;b.set(Infinity,Infinity,Infinity),c.set(-Infinity,-Infinity,-Infinity);for(var e=0;e<a;e++){var f=d[e];f.x<b.x?b.x=f.x:f.x>c.x&&(c.x=f.x),f.y<b.y?b.y=f.y:f.y>c.y&&(c.y=f.y),f.z<b.z?b.z=f.z:f.z>c.z&&(c.z=f.z)}}},a.ConvexPolyhedron.prototype=new a.Shape,a.ConvexPolyhedron.prototype.constructor=a.ConvexPolyhedron,a.ConvexPolyhedron.prototype.computeBoundingSphereRadius=function(){var a=0,b=this.vertices;for(var c=0,d=b.length;c!==d;c++){var e=b[c].norm2();e>a&&(a=e)}this.boundingSphereRadius=Math.sqrt(a),this.boundingSphereRadiusNeedsUpdate=!1};var s=new a.Vec3;a.ConvexPolyhedron.prototype.calculateWorldAABB=function(a,b,c,d){var e=this.vertices.length,f=this.vertices,g,h,i,j,k,l;for(var m=0;m<e;m++){f[m].copy(s),b.vmult(s,s),a.vadd(s,s);var n=s;if(n.x<g||g===undefined)g=n.x;else if(n.x>j||j===undefined)j=n.x;if(n.y<h||h===undefined)h=n.y;else if(n.y>k||k===undefined)k=n.y;if(n.z<i||i===undefined)i=n.z;else if(n.z>l||l===undefined)l=n.z}c.set(g,h,i),d.set(j,k,l)},a.ConvexPolyhedron.prototype.volume=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),4*Math.PI*this.boundingSphereRadius/3},a.ConvexPolyhedron.prototype.getAveragePointLocal=function(b){b=b||new a.Vec3;var c=this.vertices.length,d=this.vertices;for(var e=0;e<c;e++)b.vadd(d[e],b);return b.mult(1/c,b),b},a.ConvexPolyhedron.prototype.transformAllPoints=function(a,b){var c=this.vertices.length,d=this.vertices;if(b)for(var e=0;e<c;e++){var f=d[e];b.vmult(f,f)}if(a)for(var e=0;e<c;e++){var f=d[e];f.vadd(a,f)}};var t=new a.Vec3,u=new a.Vec3,v=new a.Vec3;a.ConvexPolyhedron.prototype.pointIsInside=function(a){var b=this.vertices.length,c=this.vertices,d=this.faces,e=this.faceNormals,f=null,g=this.faces.length,h=t;this.getAveragePointLocal(h);for(var i=0;i<g;i++){var j=this.faces[i].length,b=e[i],k=c[d[i][0]],l=u;a.vsub(k,l);var m=b.dot(l),n=v;h.vsub(k,n);var o=b.dot(n);if(m<0&&o>0||m>0&&o<0)return!1}return f?1:-1},a.Cylinder=function(b,c,d,e){var f=e,g=[],h=[],i=[],j=[],k=[],l=Math.cos,m=Math.sin;g.push(new a.Vec3(c*l(0),c*m(0),-d*.5)),j.push(0),g.push(new a.Vec3(b*l(0),b*m(0),d*.5)),k.push(1);for(var n=0;n<f;n++){var o=2*Math.PI/f*(n+1),p=2*Math.PI/f*(n+.5);n<f-1?(g.push(new a.Vec3(c*l(o),c*m(o),-d*.5)),j.push(2*(n+1)),g.push(new a.Vec3(b*l(o),b*m(o),d*.5)),k.push(2*(n+1)+1),h.push(new a.Vec3(l(p),m(p),0)),i.push([2*n,2*n+1,2*(n+1),2*(n+1)+1])):(i.push([2*n,2*n+1,0,1]),h.push(new a.Vec3(l(p),m(p),0)))}i.push(k),h.push(new a.Vec3(0,0,1)),i.push(j),h.push(new a.Vec3(0,0,-1)),this.type=a.Shape.types.CONVEXPOLYHEDRON,a.ConvexPolyhedron.call(this,g,i,h)},a.Cylinder.prototype=new a.ConvexPolyhedron,a.Solver=function(){this.equations=[]},a.Solver.prototype.solve=function(a,b){return 0},a.Solver.prototype.addEquation=function(a){this.equations.push(a)},a.Solver.prototype.removeEquation=function(a){var b=this.equations.indexOf(a);b!=-1&&this.equations.splice(b,1)},a.Solver.prototype.removeAllEquations=function(){this.equations=[]},a.GSSolver=function(){a.Solver.call(this),this.iterations=10,this.tolerance=0},a.GSSolver.prototype=new a.Solver,a.GSSolver.prototype.solve=function(a,b){var c=this.d,d=this.k,e=0,f=this.iterations,g=this.tolerance*this.tolerance,h=this.a,i=this.b,j=this.equations,k=j.length,l=b.bodies,m=b.bodies.length,n=a,o=[],p=[],q=[];for(var r=0;r!==k;r++){var s=j[r];s.spookParamsNeedsUpdate&&(s.updateSpookParams(n),s.spookParamsNeedsUpdate=!1),q.push(0),p.push(s.computeB(n)),o.push(1/s.computeC())}var t,u,s,v,w,x,y,z;if(k!==0){var r,A,B=Math.abs;for(r=0;r!==m;r++){var i=l[r],C=i.vlambda,D=i.wlambda;C.set(0,0,0),D&&D.set(0,0,0)}for(e=0;e!==f;e++){x=0;for(A=0;A!==k;A++)s=j[A],u=p[A],v=o[A],z=q[A],y=s.computeGWlambda(s.eps),w=v*(u-y-s.eps*z),z+w<s.minForce?w=s.minForce-z:z+w>s.maxForce&&(w=s.maxForce-z),q[A]+=w,x+=B(w),s.addToWlambda(w);if(x*x<g)break}for(r=0;r!==m;r++){var i=l[r],E=i.velocity,F=i.angularVelocity;E.vadd(i.vlambda,E),F&&F.vadd(i.wlambda,F)}}return errorTot=x,e},a.SplitSolver=function(b){a.Solver.call(this),this.subsolver=b},a.SplitSolver.prototype=new a.Solver,a.SplitSolver.prototype.solve=function(b,c){function q(a){var b=a.length;for(var c=0;c<b;c++){var d=a[c];if(!d.visited&&!(d.body.motionstate&p))return d}return!1}function r(a,b){var c=[];c.push(a),a.visited=!0,b(a);while(c.length){var d=c.pop(),e;while(e=q(d.children))e.visited=!0,b(e),c.push(e)}}var d=[],e=c.bodies,f=this.equations,g=f.length,h=e.length,i=this.subsolver;for(var j=0;j<h;j++)d.push({body:e[j],children:[],eqs:[],visited:!1});for(var k=0;k<g;k++){var l=f[k],j=e.indexOf(l.bi),m=e.indexOf(l.bj),n=d[j],o=d[m];n.children.push(o),n.eqs.push(l),o.children.push(n),o.eqs.push(l)}var p=a.Body.STATIC,s,t=0;while(s=q(d)){var u=[],v=[];r(s,function(a){v.push(a.body);for(var b=0;b<a.eqs.length;b++)u.indexOf(a.eqs[b])==-1&&u.push(a.eqs[b])});for(var j=0;j<u.length;j++)i.addEquation(u[j]);var w=i.solve(b,{bodies:v});i.removeAllEquations(),t++}return t},a.EventTarget=function(){var a={};this.addEventListener=function(b,c){a[b]==undefined&&(a[b]=[]),a[b].indexOf(c)===-1&&a[b].push(c)},this.dispatchEvent=function(b){for(var c in a[b.type])a[b.type][c](b)},this.removeEventListener=function(b,c){var d=
a[b].indexOf(c);d!==-1&&a[b].splice(d,1)}},a.ObjectPool=function(){this.objects=[],this.type=Object},a.ObjectPool.prototype.release=function(){for(var a in arguments)this.objects.push(arguments[a])},a.ObjectPool.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},a.ObjectPool.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this ObjectPool subclass yet!")},a.Vec3Pool=function(){a.ObjectPool.call(this),this.type=a.Vec3},a.Vec3Pool.prototype=new a.ObjectPool,a.Vec3Pool.prototype.constructObject=function(){return new a.Vec3},a.Material=function(a){this.name=a,this.id=-1},a.ContactMaterial=function(a,b,c,d){this.id=-1,this.materials=[a,b],this.friction=c!=undefined?Number(c):.3,this.restitution=d!=undefined?Number(d):.3,this.contactEquationStiffness=1e7,this.contactEquationRegularizationTime=3,this.frictionEquationStiffness=1e7,this.frictionEquationRegularizationTime=3},a.World=function(){a.EventTarget.apply(this),this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.frictionEquationPool=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new a.Vec3,this.broadphase=null,this.bodies=[];var b=this;this.solver=new a.GSSolver,this.constraints=[],this.contactgen=new a.ContactGenerator,this.collision_matrix=[],this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.defaultMaterial=new a.Material("default"),this.defaultContactMaterial=new a.ContactMaterial(this.defaultMaterial,this.defaultMaterial,.3,0),this.temp={gvec:new a.Vec3,vi:new a.Vec3,vj:new a.Vec3,wi:new a.Vec3,wj:new a.Vec3,t1:new a.Vec3,t2:new a.Vec3,rixn:new a.Vec3,rjxn:new a.Vec3,step_q:new a.Quaternion,step_w:new a.Quaternion,step_wq:new a.Quaternion},this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0}},a.World.prototype.getContactMaterial=function(b,c){if(b instanceof a.Material&&c instanceof a.Material){var d=b.id,e=c.id;if(d<e){var f=d;d=e,e=f}return this.contactmaterials[this.mats2cmat[d+e*this.materials.length]]}},a.World.prototype.numObjects=function(){return this.bodies.length},a.World.prototype.clearCollisionState=function(a){var b=this.numObjects(),c=a.id;for(var d=0;d<b;d++){var e=d;c>e?cm[e+c*b]=0:cm[c+e*b]=0}},a.World.prototype.collisionMatrixGet=function(a,b,c){var d=this.bodies.length;typeof c=="undefined"&&(c=!0);if(c&&a<b||!c&&a>b){var e=b;b=a,a=e}return this.collision_matrix[a+b*d]},a.World.prototype.collisionMatrixSet=function(a,b,c,d){var e=this.bodies.length;typeof d=="undefined"&&(d=!0);if(d&&a<b||!d&&a>b){var f=b;b=a,a=f}this.collision_matrix[a+b*e]=c},a.World.prototype.collisionMatrixTick=function(){var a=this.bodies.length;for(var b=0;b<a;b++)for(var c=0;c<b;c++){var d=this.collisionMatrixGet(b,c,!0);this.collisionMatrixSet(b,c,d,!1),this.collisionMatrixSet(b,c,0,!0)}},a.World.prototype.add=function(b){var c=this.numObjects();this.bodies.push(b),b.id=this.id(),b.world=this,b.position.copy(b.initPosition),b.velocity.copy(b.initVelocity),b.timeLastSleepy=this.time,b instanceof a.RigidBody&&(b.angularVelocity.copy(b.initAngularVelocity),b.quaternion.copy(b.initQuaternion));for(var d=0;d<2*c+1;d++)this.collision_matrix.push(0)},a.World.prototype.addConstraint=function(a){this.constraints.push(a),a.id=this.id()},a.World.prototype.removeConstraint=function(a){var b=this.constraints.indexOf(a);b!=-1&&this.constraints.splice(b,1)},a.World.prototype.id=function(){return this.nextId++},a.World.prototype.remove=function(a){a.world=null;var b=this.numObjects(),c=this.bodies;for(var d in c)c[d].id==a.id&&c.splice(d,1);for(var d=0;d<2*b-1;d++)this.collision_matrix.pop()},a.World.prototype.addMaterial=function(a){if(a.id==-1){var b=this.materials.length;this.materials.push(a),a.id=this.materials.length-1;for(var c=0;c<2*b+1;c++)this.mats2cmat.push(-1)}},a.World.prototype.addContactMaterial=function(a){this.addMaterial(a.materials[0]),this.addMaterial(a.materials[1]),a.materials[0].id>a.materials[1].id?(i=a.materials[0].id,j=a.materials[1].id):(j=a.materials[0].id,i=a.materials[1].id),this.contactmaterials.push(a),a.id=this.contactmaterials.length-1,this.mats2cmat[i+this.materials.length*j]=a.id},a.World.prototype._now=function(){return window.performance.webkitNow?window.performance.webkitNow():Date.now()},a.World.prototype.step=function(b){var c=this,d=this,e=this.numObjects(),f=this.bodies,g=this.solver,h=this.gravity,i=this.doProfiling,j=this.profile,k=a.Body.DYNAMIC,l=this._now,m,n=this.collision_matrix,o=this.constraints,p=a.FrictionEquation;i&&(m=l()),b===undefined&&(this.last_dt?b=this.last_dt:b=this.default_dt);var q=h.x,r=h.y,s=h.z;for(var t=0;t!==e;t++){var u=f[t];if(u.motionstate&k){var v=u.force,w=u.mass;v.x+=w*q,v.y+=w*r,v.z+=w*s}}i&&(m=l());var x=this.broadphase.collisionPairs(this),y=x[0],z=x[1];i&&(j.broadphase=l()-m),this.collisionMatrixTick(),i&&(m=l());var A=this.contacts;this.contacts=[],this.contactgen.getContacts(y,z,this,this.contacts,A),i&&(j.nearphase=l()-m),i&&(m=l());var B=this.temp,C=this.contacts,D=C.length;this.frictionEquationPool=this.frictionEquationPool.concat(this.frictionEquations),this.frictionEquations=[];for(var E=0;E!==D;E++){var F=C[E],u=F.bi,G=F.bj,t=f.indexOf(u),H=f.indexOf(G),n=this.getContactMaterial(u.material,G.material)||this.defaultContactMaterial,I=n.friction,J=n.restitution,K=B.gvec;K.set(G.position.x+F.rj.x-u.position.x-F.ri.x,G.position.y+F.rj.y-u.position.y-F.ri.y,G.position.z+F.rj.z-u.position.z-F.ri.z);var L=K.dot(F.ni);if(L<0){F.restitution=n.restitution,F.penetration=L,F.stiffness=n.contactEquationStiffness,F.regularizationTime=n.contactEquationRegularizationTime,g.addEquation(F);if(I>0){var M=I*h.norm(),N=u.invMass+G.invMass;N!=0&&(N=1/N);var O=this.frictionEquationPool,P=O.length?O.pop():new p(u,G,M*N),Q=O.length?O.pop():new p(u,G,M*N);this.frictionEquations.push(P),this.frictionEquations.push(Q),P.bi=Q.bi=u,P.bj=Q.bj=G,P.minForce=Q.minForce=-M*N,P.maxForce=Q.maxForce=M*N,F.ri.copy(P.ri),F.rj.copy(P.rj),F.ri.copy(Q.ri),F.rj.copy(Q.rj),F.ni.tangents(P.t,Q.t),g.addEquation(P),g.addEquation(Q)}this.collisionMatrixSet(t,H,1,!0),this.collisionMatrixGet(t,H,true)!=this.collisionMatrixGet(t,H,false)&&(u.dispatchEvent({type:"collide","with":G,contact:F}),G.dispatchEvent({type:"collide","with":u,contact:F}),u.wakeUp(),G.wakeUp())}}i&&(j.makeContactConstraints=l()-m);var u;i&&(m=l());for(var t=0,R=o.length;t!==R;t++){var F=o[t];F.update();for(var H=0,S=F.equations.length;H!==S;H++){var T=F.equations[H];g.addEquation(T)}}g.solve(b,c),i&&(j.solve=l()-m),g.removeAllEquations();var U=Math.pow;for(var t=0;t!==e;t++){u=f[t];if(u.motionstate&k){var V=U(1-u.linearDamping,b),W=u.velocity;W.mult(V,W);var X=u.angularVelocity;if(X){var Y=U(1-u.angularDamping,b);X.mult(Y,X)}}}d.dispatchEvent({type:"preStep"});for(var t=0;t!==e;t++){var u=f[t];u.preStep&&u.preStep.call(u)}i&&(m=l());var Z=B.step_q,$=B.step_w,_=B.step_wq,ba=c.stepnumber,bb=a.Body.DYNAMIC|a.Body.KINEMATIC,bc=ba%(this.quatNormalizeSkip+1)===0,bd=this.quatNormalizeFast,be=b*.5;for(var t=0;t!==e;t++){var bf=f[t],bg=bf.force,bh=bf.tau;if(bf.motionstate&bb){var bi=bf.velocity,bj=bf.angularVelocity,bk=bf.position,bl=bf.quaternion,bm=bf.invMass,bn=bf.invInertia;bi.x+=bg.x*bm*b,bi.y+=bg.y*bm*b,bi.z+=bg.z*bm*b,bf.angularVelocity&&(bj.x+=bh.x*bn.x*b,bj.y+=bh.y*bn.y*b,bj.z+=bh.z*bn.z*b),bf.isSleeping()||(bk.x+=bi.x*b,bk.y+=bi.y*b,bk.z+=bi.z*b,bf.angularVelocity&&($.set(bj.x,bj.y,bj.z,0),$.mult(bl,_),bl.x+=be*_.x,bl.y+=be*_.y,bl.z+=be*_.z,bl.w+=be*_.w,bc&&(bd?bl.normalizeFast():bl.normalize())))}bf.force.set(0,0,0),bf.tau&&bf.tau.set(0,0,0)}i&&(j.integrate=l()-m),this.time+=b,this.stepnumber+=1,d.dispatchEvent({type:"postStep"});for(var t=0;t!==e;t++){var u=f[t],bo=u.postStep;bo&&bo.call(u)}for(var t=0;t!==e;t++){var bf=f[t];bf.inertiaWorldAutoUpdate&&bf.quaternion.vmult(bf.inertia,bf.inertiaWorld),bf.invInertiaWorldAutoUpdate&&bf.quaternion.vmult(bf.invInertia,bf.invInertiaWorld)}if(c.allowSleep)for(var t=0;t!==e;t++)f[t].sleepTick(this.time)},a.ContactPoint=function(a,b,c,d,e,f){this.bi=a,this.bj=b,this.n=c,this.t1=e,this.t2=f,this.contactMaterial=d},a.ContactGenerator=function(){function d(c,d){if(b.length){var e=b.pop();return e.bi=c,e.bj=d,e}return new a.ContactEquation(c,d)}function e(a){var b;b=a.ri,a.ri=a.rj,a.rj=b,a.ni.negate(a.ni),b=a.bi,a.bi=a.bj,a.bj=b}function f(a,b,c,e,f,g,h,i,j){var k=d(i,j);j.position.vsub(e,k.ni),k.ni.normalize(),k.ni.copy(k.ri),k.ni.copy(k.rj),k.ri.mult(b.radius,k.ri),k.rj.mult(-c.radius,k.rj),a.push(k)}function i(a,b,c,e,f,i,j,k,l){var m=d(k,l);m.ni.set(0,0,1),j.vmult(m.ni,m.ni),m.ni.negate(m.ni),m.ni.normalize(),m.ni.mult(b.radius,m.ri),e.vsub(f,g),m.ni.mult(m.ni.dot(g),h),g.vsub(h,m.rj),h.norm2()<=b.radius*b.radius&&a.push(m)}function m(a,b,c){var d=null,e=a.length;for(var f=0;f<e;f++){var g=a[f],h=j;a[(f+1)%e].vsub(g,h);var i=k;h.cross(b,i);var m=l;c.vsub(g,m);var n=i.dot(m);if(d===null||n>0&&d===!0||n<=0&&d===!1){d===null&&(d=n>0);continue}return!1}return!0}function w(a,b,e,f,g,h,i,j,k){var l=r;f.vsub(g,n),e.getSideNormals(l,i);var m=b.radius,w=[],x=!1,y=t,z=u,A=v,B=null,C=0,D=0,E=0,F=null;for(var G=0,H=l.length;G!==H&&x===!1;G++){var I=o;l[G].copy(I);var J=I.norm();I.normalize();var K=n.dot(I);if(K<J+m&&K>0){var L=p,M=q;l[(G+1)%3].copy(L),l[(G+2)%3].copy(M);var N=L.norm(),O=M.norm();L.normalize(),M.normalize();var P=n.dot(L),Q=n.dot(M);if(P<N&&P>-N&&Q<O&&Q>-O){var R=Math.abs(K-J-m);if(F===null||R<F)F=R,D=P,E=Q,B=J,I.copy(y),L.copy(z),M.copy(A),C++}}}if(C){x=!0;var S=d(j,k);y.mult(-m,S.ri),y.copy(S.ni),S.ni.negate(S.ni),y.mult(B,y),z.mult(D,z),y.vadd(z,y),A.mult(E,A),y.vadd(A,S.rj),a.push(S)}var T=c.get(),U=s;for(var V=0;V!==2&&!x;V++)for(var W=0;W!==2&&!x;W++)for(var X=0;X!==2&&!x;X++){T.set(0,0,0),V?T.vadd(l[0],T):T.vsub(l[0],T),W?T.vadd(l[1],T):T.vsub(l[1],T),X?T.vadd(l[2],T):T.vsub(l[2],T),g.vadd(T,U),U.vsub(f,U);if(U.norm2()<m*m){x=!0;var S=d(j,k);U.copy(S.ri),S.ri.normalize(),S.ri.copy(S.ni),S.ri.mult(m,S.ri),T.copy(S.rj),a.push(S)}}c.release(T),T=null;var Y=c.get(),Z=c.get(),S=c.get(),$=c.get(),R=c.get(),_=l.length;for(var V=0;V<_&&!x;V++)for(var W=0;W<_&&!x;W++)if(V%3!=W%3){l[W].cross(l[V],Y),Y.normalize(),l[V].vadd(l[W],Z),f.copy(S),S.vsub(Z,S),S.vsub(g,S);var ba=S.dot(Y);Y.mult(ba,$);var X=0;while(X==V%3||X==W%3)X++;f.copy(R),R.vsub($,R),R.vsub(Z,R),R.vsub(g,R);var bb=Math.abs(ba),bc=R.norm();if(bb<l[X].norm()&&bc<m){x=!0;var bd=d(j,k);Z.vadd($,bd.rj),bd.rj.copy(bd.rj),R.negate(bd.ni),bd.ni.normalize(),bd.rj.copy(bd.ri),bd.ri.vadd(g,bd.ri),bd.ri.vsub(f,bd.ri),bd.ri.normalize(),bd.ri.mult(m,bd.ri),a.push(bd)}}c.release(Y,Z,S,$,R)}function H(a,b,e,f,g,h,i,j,k){f.vsub(g,x);var l=e.faceNormals,n=e.faces,o=e.vertices,p=b.radius,q=[];for(var r=0;r<o.length;r++){var s=o[r],t=B;i.vmult(s,t),g.vadd(t,t);var u=A;t.vsub(f,u);if(u.norm2()<p*p){w=!0;var v=d(j,k);u.copy(v.ri),v.ri.normalize(),v.ri.copy(v.ni),v.ri.mult(p,v.ri),t.vsub(g,v.rj),a.push(v);return}}var w=!1;for(var r=0,H=n.length;r!==H&&w===!1;r++){var I=l[r],J=n[r],K=C;i.vmult(I,K);var L=D;i.vmult(o[J[0]],L),L.vadd(g,L);var M=E;K.mult(-p,M),f.vadd(M,M);var N=F;M.vsub(L,N);var O=N.dot(K),P=G;f.vsub(L,P);if(O<0&&P.dot(K)>0){var Q=[];for(var R=0,S=J.length;R!==S;R++){var T=c.get();i.vmult(o[J[R]],T),g.vadd(T,T),Q.push(T)}if(m(Q,K,f)){w=!0;var v=d(j,k);K.mult(-p,v.ri),K.negate(v.ni);var U=c.get();K.mult(-O,U);var V=c.get();K.mult(-p,V),f.vsub(g,v.rj),v.rj.vadd(V,v.rj),v.rj.vadd(U,v.rj),c.release(U),c.release(V),a.push(v);return}for(var R=0;R<J.length;R++){var W=c.get(),X=c.get();i.vmult(o[J[(R+1)%J.length]],W),i.vmult(o[J[(R+2)%J.length]],X),g.vadd(W,W),g.vadd(X,X);var Y=y;X.vsub(W,Y),edgeUnit=z,Y.unit(edgeUnit);var Z=c.get(),$=c.get();f.vsub(W,$),edgeUnit.mult($.dot(edgeUnit),Z),Z.vadd(W,Z);var _=c.get();Z.vsub(f,_);if(_.norm2()<p*p){var v=d(j,k);Z.vsub(g,v.rj),Z.vsub(f,v.ni),v.ni.normalize(),v.ni.mult(p,v.ri),a.push(v);return}c.release(W),c.release(X),c.release(Z),c.release(_),c.release($)}for(var R=0,ba=Q.length;R!==ba;R++)c.release(Q[R])}}}function K(a,b,c,d,e,f,g,h,i){S(a,b,c.convexPolyhedronRepresentation,d,e,f,g,h,i)}function N(b,c,d,e,f,g,h,i,j){var k=L,l=M,m=0;for(var n=0,o=d.childShapes.length;n!==o;n++){var p=[],q=l.pop()||new a.Quaternion,r=k.pop()||new a.Vec3;h.mult(d.childOrientations[n],q),q.normalize(),h.vmult(d.childOffsets[n],r),f.vadd(r,r),bf(p,c,d.childShapes[n],e,r,g,q,i,j),l.push(q);var s=r;c||(m+=p.length);for(var t=0;t<p.length;t++)h.vmult(d.childOffsets[n],s),p[t].rj.vadd(s,p[t].rj),b.push(p[t]);k.push(r)}}function S(a,b,c,e,f,g,h,i,j){var k=O,l=P;l.set(0,0,1),g.vmult(l,l);var m=Q;for(var n=0;n<c.vertices.length;n++){c.vertices[n].copy(k),h.vmult(k,k),f.vadd(k,k),k.vsub(e,m);var o=l.dot(m);if(o<=0){var p=R;l.mult(l.dot(k),p),k.vsub(p,p);var q=d(i,j);l.copy(q.ni),p.copy(q.ri),k.vsub(f,q.rj),a.push(q)}}}function V(a,b,c,e,f,g,h,i,j){var k=T;if(b.findSeparatingAxis(c,e,g,f,h,k)){var l=[],m=U;b.clipAgainstHull(e,g,c,f,h,k,-100,100,l);for(var n=0;n<l.length;n++){var o=d(i,j);k.negate(o.ni),l[n].normal.negate(m),m.mult(l[n].depth,m),l[n].point.vadd(m,o.ri),l[n].point.copy(o.rj),o.rj.vsub(f,o.rj),o.ri.vsub(e,o.ri),a.push(o)}}}function Z(a,b,c,e,f,g,h,i,j){var k=W;k.set(0,0,1),j.quaternion.vmult(k,k);var l=X;e.vsub(j.position,l);var m=k.dot(l);if(m<=0){var n=d(i,j);k.copy(n.ni),n.ni.negate(n.ni),n.ri.set(0,0,0);var o=Y;k.mult(k.dot(e),o),e.vsub(o,o),o.copy(n.rj),a.push(n)}}function _(a,b,c,e,f,g,h,i,j){var k=$;k.set(0,0,1),e.vsub(f,k);var l=k.norm2();if(l<=c.radius*c.radius){var m=d(i,j);k.normalize(),k.copy(m.rj),m.rj.mult(c.radius,m.rj),k.copy(m.ni),m.ni.negate(m.ni),m.ri.set(0,0,0),a.push(m)}}function be(b,c,e,f,g,h,i,j,k){var l=-1,m=bd,n=null,o=0,p=bb;f.copy(p),p.vsub(g,p),i.conjugate(ba),ba.vmult(p,p);if(e.pointIsInside(p)){for(var q=0,r=e.faces.length;q!==r;q++){var s=[];for(var t=0,u=e.faces[q].length;t!==u;t++){var v=new a.Vec3;e.vertices[e.faces[q][t]].copy(v),i.vmult(v,v),v.vadd(g,v),s.push(v)}var w=bc;e.faceNormals[q].copy(w),w.normalize(),i.vmult(w,w);var x=-w.dot(f.vsub(s[0]));if(n===null||Math.abs(x)<Math.abs(n))n=x,l=q,w.copy(m),o++}if(l!==-1){var y=d(j,k),z=m.mult(n),A=f.vsub(g).vadd(z);A.copy(y.rj),m.negate(y.ni),y.ri.set(0,0,0),b.push(y)}else console.warn("Point found inside convex, but did not find penetrating face!")}}function bf(b,c,d,g,h,j,k,l,m){var n=!1,o=a.Shape.types;if(c&&d){if(c.type>d.type){var p;p=d,d=c,c=p,p=h,h=g,g=p,p=k,k=j,j=p,p=m,m=l,l=p,n=!0}}else if(c&&!d){var p;p=d,d=c,c=p,p=h,h=g,g=p,p=k,k=j,j=p,p=m,m=l,l=p,n=!0}if(c&&d){if(c.type==o.SPHERE)switch(d.type){case o.SPHERE:f(b,c,d,g,h,j,k,l,m);break;case o.PLANE:i(b,c,d,g,h,j,k,l,m);break;case o.BOX:w(b,c,d,g,h,j,k,l,m);break;case o.COMPOUND:N(b,c,d,g,h,j,k,l,m);break;case o.CONVEXPOLYHEDRON:H(b,c,d,g,h,j,k,l,m);break;default:console.warn("Collision between CANNON.Shape.types.SPHERE and "+d.type+" not implemented yet.")}else if(c.type==o.PLANE)switch(d.type){case o.PLANE:throw new Error("Plane-plane collision... wait, you did WHAT?");case o.BOX:K(b,c,d,g,h,j,k,l,m);break;case o.COMPOUND:N(b,c,d,g,h,j,k,l,m);break;case o.CONVEXPOLYHEDRON:S(b,c,d,g,h,j,k,l,m);break;default:console.warn("Collision between CANNON.Shape.types.PLANE and "+d.type+" not implemented yet.")}else if(c.type==o.BOX)switch(d.type){case o.BOX:bf(b,c.convexPolyhedronRepresentation,d.convexPolyhedronRepresentation,g,h,j,k,l,m);break;case o.COMPOUND:N(b,c,d,g,h,j,k,l,m);break;case o.CONVEXPOLYHEDRON:bf(b,c.convexPolyhedronRepresentation,d,g,h,j,k,l,m);break;default:console.warn("Collision between CANNON.Shape.types.BOX and "+d.type+" not implemented yet.")}else if(c.type==o.COMPOUND)switch(d.type){case o.COMPOUND:N(b,c,d,g,h,j,k,l,m);break;case o.CONVEXPOLYHEDRON:var q=[];N(q,d,c,h,g,k,j,m,l);for(var r=0;r<q.length;r++)e(q[r]),b.push(q[r]);break;default:console.warn("Collision between CANNON.Shape.types.COMPOUND and "+d.type+" not implemented yet.")}else if(c.type==o.CONVEXPOLYHEDRON)switch(d.type){case o.CONVEXPOLYHEDRON:V(b,c,d,g,h,j,k,l,m);break;default:console.warn("Collision between CANNON.Shape.types.CONVEXPOLYHEDRON and "+d.type+" not implemented yet.")}}else switch(d.type){case o.PLANE:Z(b,c,d,g,h,j,k,l,m);break;case o.SPHERE:_(b,c,d,g,h,j,k,l,m);break;case o.BOX:be(b,c,d.convexPolyhedronRepresentation,g,h,j,k,l,m);break;case o.CONVEXPOLYHEDRON:be(b,c,d,g,h,j,k,l,m);break;case o.COMPOUND:N(b,c,d,g,h,j,k,l,m);break;default:console.warn("Collision between CANNON.Particle and "+d.type+" not implemented yet.")}for(var s=0;n&&s<b.length;s++)e(b[s])}this.contactReduction=!1;var b=[],c=new a.Vec3Pool,g=new a.Vec3,h=new a.Vec3,j=new a.Vec3,k=new a.Vec3,l=new a.Vec3,n=new a.Vec3,o=new a.Vec3,p=new a.Vec3,q=new a.Vec3,r=[new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3],s=new a.Vec3,t=new a.Vec3,u=new a.Vec3,v=new a.Vec3,x=new a.Vec3,y=new a.Vec3,z=new a.Vec3,A=new a.Vec3,B=new a.Vec3,C=new a.Vec3,D=new a.Vec3,E=new a.Vec3,F=new a.Vec3,G=new a.Vec3,I=new a.Vec3,J=new a.Vec3,L=[],M=[],O=new a.Vec3,P=new a.Vec3,Q=new a.Vec3,R=new a.Vec3,T=new a.Vec3,U=new a.Vec3,W=new a.Vec3,X=new a.Vec3,Y=new a.Vec3,$=new a.Vec3,ba=new a.Quaternion,bb=new a.Vec3,bc=new a.Vec3,bd=new a.Vec3;this.reduceContacts=function(a){},this.getContacts=function(a,c,d,e,f){for(var g=0;f&&g<f.length;g++)b.push(f[g]);for(var h=0;h<a.length;h++){var i=a[h],j=c[h];bf(e,i.shape,j.shape,i.position,j.position,i.quaternion,j.quaternion,i,j)}}},a.Equation=function(a,b,c,d){this.id=-1,this.minForce=typeof c=="undefined"?-1e6:c,this.maxForce=typeof d=="undefined"?1e6:d,this.bi=a,this.bj=b,this.stiffness=1e7,this.regularizationTime=5,this.a=0,this.b=0,this.eps=0,this.spookParamsNeedsUpdate=!0},a.Equation.prototype.constructor=a.Equation,a.Equation.prototype.updateSpookParams=function(a){var b=this.regularizationTime,c=this.stiffness;this.a=4/(a*(1+4*b)),this.b=4*b/(1+4*b),this.eps=4/(a*a*c*(1+4*b))},a.ContactEquation=function(b,c){a.Equation.call(this,b,c,0,1e6),this.restitution=0,this.penetration=0,this.ri=new a.Vec3,this.penetrationVec=new a.Vec3,this.rj=new a.Vec3,this.ni=new a.Vec3,this.rixn=new a.Vec3,this.rjxn=new a.Vec3,this.rixw=new a.Vec3,this.rjxw=new a.Vec3,this.invIi=new a.Mat3,this.invIj=new a.Mat3,this.relVel=new a.Vec3,this.relForce=new a.Vec3},a.ContactEquation.prototype=new a.Equation,a.ContactEquation.prototype.constructor=a.ContactEquation;var x=new a.Vec3,y=new a.Vec3;a.ContactEquation.prototype.computeB=function(b){var c=this.a,d=this.b,e=this.bi,f=this.bj,g=this.ri,h=this.rj,i=this.rixn,j=this.rjxn,k=e.velocity,l=e.angularVelocity?e.angularVelocity:new a.Vec3,m=e.force,n=e.tau?e.tau:new a.Vec3,o=f.velocity,p=f.angularVelocity?f.angularVelocity:new a.Vec3,q=f.force,r=f.tau?f.tau:new a.Vec3,s=this.relVel,t=this.relForce,u=this.penetrationVec,v=e.invMass,w=f.invMass,z=this.invIi,A=this.invIj;e.invInertia?z.setTrace(e.invInertia):z.identity(),f.invInertia?A.setTrace(f.invInertia):A.identity();var B=this.ni;g.cross(B,i),h.cross(B,j);var u=this.penetrationVec;u.set(0,0,0),u.vadd(f.position,u),u.vadd(h,u),u.vsub(e.position,u),u.vsub(g,u);var C=B.dot(u),D=x,E=y;z.vmult(n,D),A.vmult(r,E);var F=this.restitution+1,G=F*o.dot(B)-F*k.dot(B)+p.dot(j)-l.dot(i),H=q.dot(B)*w-m.dot(B)*v+j.dot(E)-i.dot(D),I=-C*c-G*d-b*H;return I};var z=new a.Vec3,A=new a.Vec3;a.ContactEquation.prototype.computeC=function(){var a=this.bi,b=this.bj,c=this.rixn,d=this.rjxn,e=a.invMass,f=b.invMass,g=e+f+this.eps,h=this.invIi,i=this.invIj;return a.invInertia?h.setTrace(a.invInertia):h.identity(),b.invInertia?i.setTrace(b.invInertia):i.identity(),h.vmult(c,z),i.vmult(d,A),g+=z.dot(c),g+=A.dot(d),g};var B=new a.Vec3;a.ContactEquation.prototype.computeGWlambda=function(){var a=this.bi,b=this.bj,c=B,d=0;return b.vlambda.vsub(a.vlambda,c),d+=c.dot(this.ni),a.wlambda&&(d-=a.wlambda.dot(this.rixn)),b.wlambda&&(d+=b.wlambda.dot(this.rjxn)),d};var C=new a.Vec3,D=new a.Vec3;a.ContactEquation.prototype.addToWlambda=function(a){var b=this.bi,c=this.bj,d=this.rixn,e=this.rjxn,f=b.invMass,g=c.invMass,h=this.ni,i=C,j=D;h.mult(f*a,j),b.vlambda.vsub(j,b.vlambda),h.mult(g*a,j),c.vlambda.vadd(j,c.vlambda);if(b.wlambda){var k=this.invIi;k.vmult(d,i),i.mult(a,i),b.wlambda.vsub(i,b.wlambda)}if(c.wlambda){var k=this.invIj;k.vmult(e,i),i.mult(a,i),c.wlambda.vadd(i,c.wlambda)}},a.FrictionEquation=function(b,c,d){a.Equation.call(this,b,c,-d,d),this.ri=new a.Vec3,this.rj=new a.Vec3,this.t=new a.Vec3,this.rixt=new a.Vec3,this.rjxt=new a.Vec3,this.wixri=new a.Vec3,this.wjxrj=new a.Vec3,this.invIi=new a.Mat3,this.invIj=new a.Mat3,this.relVel=new a.Vec3,this.relForce=new a.Vec3},a.FrictionEquation.prototype=new a.Equation,a.FrictionEquation.prototype.constructor=a.FrictionEquation;var E=new a.Vec3,F=new a.Vec3;a.FrictionEquation.prototype.computeB=function(b){var c=this.a,d=this.b,e=this.bi,f=this.bj,g=this.ri,h=this.rj,i=this.rixt,j=this.rjxt,k=this.wixri,l=this.wjxrj,m=e.velocity,n=e.angularVelocity?e.angularVelocity:new a.Vec3,o=e.force,p=e.tau?e.tau:new a.Vec3,q=f.velocity,r=f.angularVelocity?f.angularVelocity:new a.Vec3,s=f.force,t=f.tau?f.tau:new a.Vec3,u=this.relVel,v=this.relForce,w=e.invMass,x=f.invMass,y=this.invIi,z=this.invIj;e.invInertia&&y.setTrace(e.invInertia),f.invInertia&&z.setTrace(f.invInertia);var A=this.t;g.cross(A,i),h.cross(A,j),n.cross(g,k),r.cross(h,l);var B=E,C=F;y.vmult(p,B),z.vmult(t,C);var D=0,G=q.dot(A)-m.dot(A)+l.dot(A)-k.dot(A),H=s.dot(A)*x-o.dot(A)*w+j.dot(C)-i.dot(B),I=-D*c-G*d-b*H;return I};var G=new a.Vec3,H=new a.Vec3;a.FrictionEquation.prototype.computeC=function(){var a=this.bi,b=this.bj,c=this.rixt,d=this.rjxt,e=a.invMass,f=b.invMass,g=e+f+this.eps,h=this.invIi,i=this.invIj;return a.invInertia&&h.setTrace(a.invInertia),b.invInertia&&i.setTrace(b.invInertia),h.vmult(c,G),i.vmult(d,H),g+=G.dot(c),g+=H.dot(d),g};var I=new a.Vec3;a.FrictionEquation.prototype.computeGWlambda=function(){var a=this.bi,b=this.bj,c=0,d=I;return b.vlambda.vsub(a.vlambda,d),c+=d.dot(this.t),a.wlambda&&(c-=a.wlambda.dot(this.rixt)),b.wlambda&&(c+=b.wlambda.dot(this.rjxt)),c};var J=new a.Vec3;a.FrictionEquation.prototype.addToWlambda=function(a){var b=this.bi,c=this.bj,d=this.rixt,e=this.rjxt,f=b.invMass,g=c.invMass,h=this.t,i=J;h.mult(f*a,i),b.vlambda.vsub(i,b.vlambda),h.mult(g*a,i),c.vlambda.vadd(i,c.vlambda);var j=b.wlambda;if(j){var k=this.invIi;k.vmult(d,i),i.mult(a,i),j.vsub(i,j)}var l=c.wlambda;if(l){var k=this.invIj;k.vmult(e,i),i.mult(a,i),l.vadd(i,l)}},a.RotationalEquation=function(b,c){a.Equation.call(this,b,c,-1e6,1e6),this.ni=new a.Vec3,this.nj=new a.Vec3,this.nixnj=new a.Vec3,this.njxni=new a.Vec3,this.invIi=new a.Mat3,this.invIj=new a.Mat3,this.relVel=new a.Vec3,this.relForce=new a.Vec3},a.RotationalEquation.prototype=new a.Equation,a.RotationalEquation.prototype.constructor=a.RotationalEquation,a.RotationalEquation.prototype.computeB=function(b){var c=this.a,d=this.b,e=this.bi,f=this.bj,g=this.ni,h=this.nj,i=this.nixnj,j=this.njxni,k=e.velocity,l=e.angularVelocity?e.angularVelocity:new a.Vec3,m=e.force,n=e.tau?e.tau:new a.Vec3,o=f.velocity,p=f.angularVelocity?f.angularVelocity:new a.Vec3,q=f.force,r=f.tau?f.tau:new a.Vec3,s=e.invMass,t=f.invMass,u=this.invIi,v=this.invIj;e.invInertia?u.setTrace(e.invInertia):u.identity(),f.invInertia?v.setTrace(f.invInertia):v.identity(),g.cross(h,i),h.cross(g,j);var w=-g.dot(h),x=j.dot(l)+i.dot(p),y=0,z=-w*c-x*d-b*y;return z},a.RotationalEquation.prototype.computeC=function(){var a=this.bi,b=this.bj,c=this.nixnj,d=this.njxni,e=a.invMass,f=b.invMass,g=this.eps,h=this.invIi,i=this.invIj;return a.invInertia?h.setTrace(a.invInertia):h.identity(),b.invInertia?i.setTrace(b.invInertia):i.identity(),g+=h.vmult(d).dot(d),g+=i.vmult(c).dot(c),g};var B=new a.Vec3;a.RotationalEquation.prototype.computeGWlambda=function(){var a=this.bi,b=this.bj,c=B,d=0;return a.wlambda&&(d+=a.wlambda.dot(this.njxni)),b.wlambda&&(d+=b.wlambda.dot(this.nixnj)),d},a.RotationalEquation.prototype.addToWlambda=function(a){var b=this.bi,c=this.bj,d=this.nixnj,e=this.njxni,f=b.invMass,g=c.invMass;if(b.wlambda){var h=this.invIi;b.wlambda.vsub(h.vmult(d).mult(a),b.wlambda)}if(c.wlambda){var h=this.invIj;c.wlambda.vadd(h.vmult(d).mult(a),c.wlambda)}},a.Constraint=function(a,b){this.equations=[],this.bodyA=a,this.bodyB=b},a.Constraint.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},a.DistanceConstraint=function(b,c,d,e){a.Constraint.call(this,b,c),typeof e=="undefined"&&(e=1e6);var f=this.equations=[new a.ContactEquation(b,c)],g=f[0];g.minForce=-e,g.maxForce=e,this.update=function(){c.position.vsub(b.position,g.ni),g.ni.normalize(),g.ni.mult(d*.5,g.ri),g.ni.mult(-d*.5,g.rj)}},a.DistanceConstraint.prototype=new a.Constraint,a.RotationalMotorEquation=function(b,c,d){d=d||1e6,a.Equation.call(this,b,c,-d,d),this.axisA=new a.Vec3,this.axisB=new a.Vec3,this.invIi=new a.Mat3,this.invIj=new a.Mat3,this.targetVelocity=0},a.RotationalMotorEquation.prototype=new a.Equation,a.RotationalMotorEquation.prototype.constructor=a.RotationalMotorEquation,a.RotationalMotorEquation.prototype.computeB=function(b){var c=this.a,d=this.b,e=this.bi,f=this.bj,g=this.axisA,h=this.axisB,i=e.velocity,j=e.angularVelocity?e.angularVelocity:new a.Vec3,k=e.force,l=e.tau?e.tau:new a.Vec3,m=f.velocity,n=f.angularVelocity?f.angularVelocity:new a.Vec3,o=f.force,p=f.tau?f.tau:new a.Vec3,q=e.invMass,r=f.invMass,s=this.invIi,t=this.invIj;e.invInertia?s.setTrace(e.invInertia):s.identity(),f.invInertia?t.setTrace(f.invInertia):t.identity();var u=0,v=g.dot(j)+h.dot(n)+this.targetVelocity,w=0,x=-u*c-v*d-b*w;return x},a.RotationalMotorEquation.prototype.computeC=function(){var a=this.bi,b=this.bj,c=this.axisA,d=this.axisB,e=a.invMass,f=b.invMass,g=this.eps,h=this.invIi,i=this.invIj;return a.invInertia?h.setTrace(a.invInertia):h.identity(),b.invInertia?i.setTrace(b.invInertia):i.identity(),g+=h.vmult(c).dot(d),g+=i.vmult(d).dot(d),g};var B=new a.Vec3;a.RotationalMotorEquation.prototype.computeGWlambda=function(){var a=this.bi,b=this.bj,c=B,d=this.axisA,e=this.axisB,f=0;return a.wlambda&&(f+=a.wlambda.dot(d)),b.wlambda&&(f+=b.wlambda.dot(e)),f},a.RotationalMotorEquation.prototype.addToWlambda=function(a){var b=this.bi,c=this.bj,d=this.axisA,e=this.axisB,f=b.invMass,g=c.invMass;if(b.wlambda){var h=this.invIi;b.wlambda.vsub(h.vmult(d).mult(a),b.wlambda)}if(c.wlambda){var h=this.invIj;c.wlambda.vadd(h.vmult(e).mult(a),c.wlambda)}},a.HingeConstraint=function(b,c,d,e,f,g,h){a.Constraint.call(this,b,e),h=h||1e6;var i=this,j=this.equations=[new a.RotationalEquation(b,e),new a.RotationalEquation(b,e),new a.ContactEquation(b,e),new a.ContactEquation(b,e),new a.ContactEquation(b,e)];this.getRotationalEquation1=function(){return j[0]},this.getRotationalEquation2=function(){return j[1]},this.getPointToPointEquation1=function(){return j[2]},this.getPointToPointEquation2=function(){return j[3]},this.getPointToPointEquation3=function(){return j[4]};var k=this.getRotationalEquation1(),l=this.getRotationalEquation2(),m=this.getPointToPointEquation1(),n=this.getPointToPointEquation2(),o=this.getPointToPointEquation3(),p;n.minForce=o.minForce=m.minForce=-h,n.maxForce=o.maxForce=m.maxForce=h;var q=c.unit(),r=f.unit(),s=d.cross(q),t=d.cross(s),u=g.cross(r);s.normalize(),u.normalize();var v=!1;this.motorTargetVelocity=0,this.motorMinForce=-h,this.motorMaxForce=h,this.enableMotor=function(){v||(p=new a.RotationalMotorEquation(b,e,h),j.push(p),v=!0)},this.disableMotor=function(){v&&(v=!1,p=null,j.pop())},this.update=function(){m.ni.set(1,0,0),n.ni.set(0,1,0),o.ni.set(0,0,1),b.quaternion.vmult(c,m.ri),e.quaternion.vmult(f,m.rj),m.ri.copy(n.ri),m.rj.copy(n.rj),m.ri.copy(o.ri),m.rj.copy(o.rj),b.quaternion.vmult(s,k.ni),e.quaternion.vmult(g,k.nj),b.quaternion.vmult(t,l.ni),e.quaternion.vmult(g,l.nj),v&&(b.quaternion.vmult(d,p.axisA),e.quaternion.vmult(g,p.axisB),p.targetVelocity=i.motorTargetVelocity,p.maxForce=i.motorMaxForce,p.minForce=i.motorMinForce)}},a.HingeConstraint.prototype=new a.Constraint,a.PointToPointConstraint=function(b,c,d,e,f){a.Constraint.call(this,b,d);var g=this.equations=[new a.ContactEquation(b,d),new a.ContactEquation(b,d),new a.ContactEquation(b,d)],h=g[0],i=g[1],j=g[2];i.minForce=j.minForce=h.minForce=-f,i.maxForce=j.maxForce=h.maxForce=f,this.update=function(){d.position.vsub(b.position,h.ni),h.ni.normalize(),b.quaternion.vmult(c,h.ri),d.quaternion.vmult(e,h.rj),h.ni.tangents(i.ni,j.ni),h.ri.copy(i.ri),h.rj.copy(i.rj),h.ri.copy(j.ri),h.rj.copy(j.rj)}},a.PointToPointConstraint.prototype=new a.Constraint,typeof module!="undefined"?module.exports=a:this.CANNON=a})).apply(this);