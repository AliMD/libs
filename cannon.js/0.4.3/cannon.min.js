/*
 * Copyright (c) 2012 cannon.js Authors
 * 
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use, copy,
 * modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */(function(){var a=a||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),a.Broadphase=function(){this.world=null},a.Broadphase.prototype.constructor=a.BroadPhase,a.Broadphase.prototype.collisionPairs=function(a){throw"collisionPairs not implemented for this BroadPhase class!"},a.NaiveBroadphase=function(){this.temp={r:new a.Vec3,normal:new a.Vec3,quat:new a.Quaternion}},a.NaiveBroadphase.prototype=new a.Broadphase,a.NaiveBroadphase.prototype.constructor=a.NaiveBroadphase,a.NaiveBroadphase.prototype.collisionPairs=function(b){var c=[],d=[],e=b.numObjects(),f=b.bodies,g=a.Shape.types,h=g.SPHERE|g.BOX|g.COMPOUND|g.CONVEXPOLYHEDRON,i=g.PLANE,j=a.Body.STATIC|a.Body.KINEMATIC,k=this.temp,l=k.r,m=k.normal,n=k.quat;for(var o=0;o<e;o++)for(var p=0;p<o;p++){var q=f[o],r=f[p];if(!((q.motionstate&j)===0&&!q.isSleeping()||(r.motionstate&j)===0&&!r.isSleeping()))continue;var s=q.shape,t=r.shape;if(s&&t){var u=s.type,v=t.type;if(u&h&&v&h){r.position.vsub(q.position,l);var w=s.boundingSphereRadius()+t.boundingSphereRadius();l.norm2()<w*w&&(c.push(q),d.push(r))}else if(u&h&&v&g.PLANE||v&h&&u&g.PLANE){var x=u===i?o:p,y=u!==i?o:p;f[y].position.vsub(f[x].position,l),f[x].quaternion.vmult(f[x].shape.normal,m);var z=l.dot(m)-f[y].shape.boundingSphereRadius();z<0&&(c.push(q),d.push(r))}}else if(!!s||!!t){var A=s?r:q,B=s?q:r,C=B.shape,D=C.type;if(!(D&h)&&D&g.PLANE){var E=new a.Vec3;A.position.vsub(B.position,E),C.normal.dot(E)<=0&&(c.push(A),d.push(B))}}}return[c,d]},a.Ray=function(b,c){function q(a,b,c){return c.vsub(a,m),o=m.dot(b),b.mult(o,n),n.vadd(a,n),p=c.distanceTo(n),p}function B(a,b,c,d){return d.vsub(b,m),c.vsub(b,z),a.vsub(b,A),r=m.dot(m),s=m.dot(z),t=m.dot(A),u=z.dot(z),v=z.dot(A),w=1/(r*u-s*s),x=(u*t-s*v)*w,y=(r*v-s*t)*w,x>=0&&y>=0&&x+y<1}this.origin=b||new a.Vec3,this.direction=c||new a.Vec3;var d=1e-4;this.setPrecision=function(a){d=a};var e=new a.Vec3,f=new a.Vec3,g=new a.Vec3,h=new a.Vec3,i=new a.Vec3,j=new a.Vec3,k=new a.Vec3,l=new a.Vec3;this.intersectBody=function(b){if(b.shape instanceof a.ConvexPolyhedron)return this.intersectShape(b.shape,b.quaternion,b.position,b);if(b.shape instanceof a.Box)return this.intersectShape(b.shape.convexPolyhedronRepresentation,b.quaternion,b.position,b);console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes.")},this.intersectShape=function(b,c,h,i){var m,n=[];if(b instanceof a.ConvexPolyhedron){var o=q(this.origin,this.direction,h);if(o>b.boundingSphereRadius())return n;var p,r,s=b.faces,t=b.vertices,u=b.faceNormals;for(fi=0;fi<s.length;fi++){var v=s[fi],w=u[fi],x=c,y=h;t[v[0]].copy(j),x.vmult(j,j),j.vadd(y,j),j.vsub(this.origin,j),x.vmult(w,k),p=this.direction.dot(k);if(Math.abs(p)<d)continue;r=k.dot(j)/p;if(r<0)continue;if(p<0){this.direction.mult(r,l),l.vadd(this.origin,l),t[v[0]].copy(e),x.vmult(e,e),y.vadd(e,e);for(var z=1;z<v.length-1;z++){t[v[z]].copy(f),t[v[z+1]].copy(g),x.vmult(f,f),x.vmult(g,g),y.vadd(f,f),y.vadd(g,g);if(B(l,e,f,g)){m={distance:this.origin.distanceTo(l),point:l.copy(),face:v,body:i},n.push(m);break}}}}}return n},this.intersectBodies=function(a){var b=[];for(var c=0,d=a.length;c<d;c++){var e=this.intersectBody(a[c]);Array.prototype.push.apply(b,e)}return b.sort(function(a,b){return a.distance-b.distance}),b};var m=new a.Vec3,n=new a.Vec3,o,p,r,s,t,u,v,w,x,y,z=new a.Vec3,A=new a.Vec3},a.Ray.prototype.constructor=a.Ray,a.Mat3=function(a){a?this.elements=new Float32Array(a):this.elements=new Float32Array(9)},a.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},a.Mat3.prototype.vmult=function(b,c){c===undefined&&(c=new a.Vec3);var d=[b.x,b.y,b.z],e=[0,0,0];for(var f=0;f<3;f++)for(var g=0;g<3;g++)e[f]+=this.elements[f+3*g]*d[f];return c.x=e[0],c.y=e[1],c.z=e[2],c},a.Mat3.prototype.smult=function(a){for(var b=0;b<this.elements.length;b++)this.elements[b]*=a},a.Mat3.prototype.mmult=function(b){var c=new a.Mat3;for(var d=0;d<3;d++)for(var e=0;e<3;e++){var f=0;for(var g=0;g<3;g++)f+=this.elements[d+g]*b.elements[g+e*3];c.elements[d+e*3]=f}return c},a.Mat3.prototype.solve=function(b,c){c=c||new a.Vec3;var d=3,e=4,f=new Float32Array(d*e),g,h;for(g=0;g<3;g++)for(h=0;h<3;h++)f[g+e*h]=this.elements[g+3*h];f[3]=b.x,f[7]=b.y,f[11]=b.z;var i=3,j=i,k,l=4,m,n;do{g=j-i;if(f[g+e*g]===0)for(h=g+1;h<j;h++)if(f[g+e*h]!==0){n=[],k=l;do m=l-k,n.push(f[m+e*g]+f[m+e*h]);while(--k);f[g+e*0]=n[0],f[g+e*1]=n[1],f[g+e*2]=n[2];break}if(f[g+e*g]!==0)for(h=g+1;h<j;h++){var o=f[g+e*h]/f[g+e*g];n=[],k=l;do m=l-k,n.push(m<=g?0:f[m+e*h]-f[m+e*g]*o);while(--k);f[h+e*0]=n[0],f[h+e*1]=n[1],f[h+e*2]=n[2]}}while(--i);c.z=f[2*e+3]/f[2*e+2],c.y=(f[1*e+3]-f[1*e+2]*c.z)/f[1*e+1],c.x=(f[0*e+3]-f[0*e+2]*c.z-f[0*e+1]*c.y)/f[0*e+0];if(isNaN(c.x)||isNaN(c.y)||isNaN(c.z)||c.x===Infinity||c.y===Infinity||c.z===Infinity)throw"Could not solve equation! Got x=["+c.toString()+"], b=["+b.toString()+"], A=["+this.toString()+"]";return c},a.Mat3.prototype.e=function(a,b,c){if(c===undefined)return this.elements[a+3*b];this.elements[a+3*b]=c},a.Mat3.prototype.copy=function(b){b=b||new a.Mat3;for(var c=0;c<this.elements.length;c++)b.elements[c]=this.elements[c];return b},a.Mat3.prototype.toString=function(){var a="",b=",";for(var c=0;c<9;c++)a+=this.elements[c]+b;return a},a.Vec3=function(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0},a.Vec3.prototype.cross=function(b,c){var d=b.x,e=b.y,f=b.z,g=this.x,h=this.y,i=this.z;c=c||new a.Vec3;var j=[this.x,this.y,this.z],k=[b.x,b.y,b.z];return c.x=h*f-i*e,c.y=i*d-g*f,c.z=g*e-h*d,c},a.Vec3.prototype.set=function(a,b,c){return this.x=a,this.y=b,this.z=c,this},a.Vec3.prototype.vadd=function(b,c){if(!c)return new a.Vec3(this.x+b.x,this.y+b.y,this.z+b.z);c.x=b.x+this.x,c.y=b.y+this.y,c.z=b.z+this.z},a.Vec3.prototype.vsub=function(b,c){if(!c)return new a.Vec3(this.x-b.x,this.y-b.y,this.z-b.z);c.x=this.x-b.x,c.y=this.y-b.y,c.z=this.z-b.z},a.Vec3.prototype.crossmat=function(){return new a.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},a.Vec3.prototype.normalize=function(){var a=this.x,b=this.y,c=this.z,d=Math.sqrt(a*a+b*b+c*c);if(d>0){var e=1/d;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return d},a.Vec3.prototype.unit=function(b){b=b||new a.Vec3;var c=this.x,d=this.y,e=this.z,f=Math.sqrt(c*c+d*d+e*e);return f>0?(f=1/f,b.x=c*f,b.y=d*f,b.z=e*f):(b.x=0,b.y=0,b.z=0),b},a.Vec3.prototype.norm=function(){var a=this.x,b=this.y,c=this.z;return Math.sqrt(a*a+b*b+c*c)},a.Vec3.prototype.norm2=function(){return this.dot(this)},a.Vec3.prototype.distanceTo=function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z;return Math.sqrt((e-b)*(e-b)+(f-c)*(f-c)+(g-d)*(g-d))},a.Vec3.prototype.mult=function(b,c){return c||(c=new a.Vec3),c.x=b*this.x,c.y=b*this.y,c.z=b*this.z,c},a.Vec3.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},a.Vec3.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},a.Vec3.prototype.negate=function(b){return b=b||new a.Vec3,b.x=-this.x,b.y=-this.y,b.z=-this.z,b},a.Vec3.prototype.tangents=function(b,c){var d=this.norm();if(d>0){var e=new a.Vec3(this.x/d,this.y/d,this.z/d);if(e.x<.9){var f=Math.random();e.cross((new a.Vec3(f,1e-7,0)).unit(),b)}else e.cross((new a.Vec3(1e-7,f,0)).unit(),b);e.cross(b,c)}else b.set(1,0,0).normalize(),c.set(0,1,0).normalize()},a.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},a.Vec3.prototype.copy=function(b){return b=b||new a.Vec3,b.x=this.x,b.y=this.y,b.z=this.z,b},a.Vec3.prototype.lerp=function(a,b,c){var d=this.x,e=this.y,f=this.z;c.x=d+(a.x-d)*b,c.y=e+(a.y-e)*b,c.z=f+(a.z-f)*b},a.Vec3.prototype.almostEquals=function(a,b){return b===undefined&&(b=1e-6),Math.abs(this.x-a.x)>b||Math.abs(this.y-a.y)>b||Math.abs(this.z-a.z)>b?!1:!0},a.Vec3.prototype.almostZero=function(a){return a===undefined&&(a=1e-6),Math.abs(this.x)>a||Math.abs(this.y)>a||Math.abs(this.z)>a?!1:!0},a.Quaternion=function(a,b,c,d){this.x=a!=undefined?a:0,this.y=b!=undefined?b:0,this.z=c!=undefined?c:0,this.w=d!=undefined?d:1},a.Quaternion.prototype.set=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.w=d},a.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},a.Quaternion.prototype.setFromAxisAngle=function(a,b){var c=Math.sin(b*.5);this.x=a.x*c,this.y=a.y*c,this.z=a.z*c,this.w=Math.cos(b*.5)},a.Quaternion.prototype.toAxisAngle=function(b){b=b||new a.Vec3,this.normalize();var c=2*Math.acos(this.w),d=Math.sqrt(1-this.w*this.w);return d<.001?(b.x=this.x,b.y=this.y,b.z=this.z):(b.x=this.x/d,b.y=this.y/d,b.z=this.z/d),[b,c]},a.Quaternion.prototype.setFromVectors=function(a,b){var c=a.cross(b);this.x=c.x,this.y=c.y,this.z=c.z,this.w=Math.sqrt(Math.pow(a.norm(),2)*Math.pow(b.norm(),2))+a.dot(b),this.normalize()};var b=new a.Vec3,d=new a.Vec3,e=new a.Vec3;a.Quaternion.prototype.mult=function(c,f){var g=this.w;return f==undefined&&(f=new a.Quaternion),b.set(this.x,this.y,this.z),d.set(c.x,c.y,c.z),f.w=g*c.w-b.dot(d),b.cross(d,e),f.x=g*d.x+c.w*b.x+e.x,f.y=g*d.y+c.w*b.y+e.y,f.z=g*d.z+c.w*b.z+e.z,f},a.Quaternion.prototype.inverse=function(b){var c=this.x,d=this.y,e=this.z,f=this.w;b==undefined&&(b=new a.Quaternion),this.conjugate(b);var g=1/(c*c+d*d+e*e+f*f);return b.x*=g,b.y*=g,b.z*=g,b.w*=g,b},a.Quaternion.prototype.conjugate=function(b){return b==undefined&&(b=new a.Quaternion),b.x=-this.x,b.y=-this.y,b.z=-this.z,b.w=this.w,b},a.Quaternion.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);a===0?(this.x=0,this.y=0,this.z=0,this.w=0):(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a)},a.Quaternion.prototype.normalizeFast=function(){var a=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;a===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=a,this.y*=a,this.z*=a,this.w*=a)},a.Quaternion.prototype.vmult=function(b,c){c=c||new a.Vec3;if(this.w==0)c.x=b.x,c.y=b.y,c.z=b.z;else{var d=b.x,e=b.y,f=b.z,g=this.x,h=this.y,i=this.z,j=this.w,k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;c.x=k*j+n*-g+l*-i-m*-h,c.y=l*j+n*-h+m*-g-k*-i,c.z=m*j+n*-i+k*-h-l*-g}return c},a.Quaternion.prototype.copy=function(a){a.x=this.x,a.y=this.y,a.z=this.z,a.w=this.w},a.Quaternion.prototype.toEuler=function(a,b){b=b||"YZX";var c,d,e,f=this.x,g=this.y,h=this.z,i=this.w;switch(b){case"YZX":var j=f*g+h*i;j>.499&&(c=2*Math.atan2(f,i),d=Math.PI/2,e=0),j<-0.499&&(c=-2*Math.atan2(f,i),d=-Math.PI/2,e=0);if(isNaN(c)){var k=f*f,l=g*g,m=h*h;c=Math.atan2(2*g*i-2*f*h,1-2*l-2*m),d=Math.asin(2*j),e=Math.atan2(2*f*i-2*g*h,1-2*k-2*m)}break;default:throw new Error("Euler order "+b+" not supported yet.")}a.y=c,a.z=d,a.x=e},a.Shape=function(){this.type=0,this.aabbmin=new a.Vec3,this.aabbmax=new a.Vec3},a.Shape.prototype.constructor=a.Shape,a.Shape.prototype.boundingSphereRadius=function(){throw"boundingSphereRadius() not implemented for shape type "+this.type},a.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},a.Shape.prototype.calculateLocalInertia=function(a,b){throw"calculateLocalInertia() not implemented for shape type "+this.type},a.Shape.prototype.calculateTransformedInertia=function(b,c,d){d==undefined&&(d=new a.Vec3),c.normalize();var e=this.calculateLocalInertia(b),f=c.vmult(e);return d.x=Math.abs(f.x),d.y=Math.abs(f.y),d.z=Math.abs(f.z),d},a.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},a.Body=function(b){a.EventTarget.apply(this),this.type=b;var c=this;this.world=null,this.preStep=null,this.postStep=null},a.Body.DYNAMIC=1,a.Body.STATIC=2,a.Body.KINEMATIC=4,a.Particle=function(b,c){if(typeof b!="number")throw new Error("Argument 1 (mass) must be a number.");if(!(typeof c=="undefined"||c instanceof a.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");a.Body.call(this,"particle");var d=this;this.position=new a.Vec3,this.initPosition=new a.Vec3,this.velocity=new a.Vec3,this.initVelocity=new a.Vec3,this.force=new a.Vec3,this.mass=b,this.invMass=b>0?1/b:0,this.material=c,this.linearDamping=.01,this.motionstate=b<=0?a.Body.STATIC:a.Body.DYNAMIC,this.allowSleep=!0;var e=0;this.isAwake=function(){return e==0},this.isSleepy=function(){return e==1},this.isSleeping=function(){return e==2},this.sleepSpeedLimit=.1,this.sleepTimeLimit=1e3;var f=(new Date).getTime();this.wakeUp=function(){e=0,d.dispatchEvent({type:"wakeup"})},this.sleep=function(){e=2},this.sleepTick=function(){d.allowSleep&&(e==0&&d.velocity.norm()<d.sleepSpeedLimit?(e=1,f=(new Date).getTime(),d.dispatchEvent({type:"sleepy"})):e==1&&d.velocity.norm()>d.sleepSpeedLimit?d.wakeUp():e==1&&(new Date).getTime()-f>d.sleepTimeLimit&&(e=2,d.dispatchEvent({type:"sleep"})))}},a.RigidBody=function(b,c,d){if(typeof b!="number")throw new Error("Argument 1 (mass) must be a number.");if(!(typeof c=="object"&&c instanceof a.Shape))throw new Error("Argument 2 (shape) must be an instance of CANNON.Shape.");if(!(typeof d=="undefined"||d instanceof a.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");a.Particle.call(this,b,d);var e=this;this.tau=new a.Vec3,this.quaternion=new a.Quaternion,this.initQuaternion=new a.Quaternion,this.angularVelocity=new a.Vec3,this.initAngularVelocity=new a.Vec3,this.shape=c,this.inertia=new a.Vec3,c.calculateLocalInertia(b,this.inertia),this.invInertia=new a.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.angularDamping=.01},a.Sphere=function(b){a.Shape.call(this),this.radius=b!=undefined?Number(b):1,this.type=a.Shape.types.SPHERE},a.Sphere.prototype=new a.Shape,a.Sphere.prototype.constructor=a.Sphere,a.Sphere.prototype.calculateLocalInertia=function(b,c){c=c||new a.Vec3;var d=2*b*this.radius*this.radius/5;return c.x=d,c.y=d,c.z=d,c},a.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},a.Sphere.prototype.boundingSphereRadius=function(){return this.radius},a.Box=function(b){a.Shape.call(this),this.halfExtents=b,this.type=a.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},a.Box.prototype=new a.Shape,a.Box.prototype.constructor=a.Box,a.Box.prototype.updateConvexPolyhedronRepresentation=function(){var b=this.halfExtents.x,c=this.halfExtents.y,d=this.halfExtents.z,e=a.Vec3,f=new a.ConvexPolyhedron([new e(-b,-c,-d),new e(b,-c,-d),new e(b,c,-d),new e(-b,c,-d),new e(-b,-c,d),new e(b,-c,d),new e(b,c,d),new e(-b,c,d)],[[0,1,2,3],[4,5,6,7],[0,1,4,5],[2,3,6,7],[0,3,4,7],[1,2,5,6]],[new e(0,0,-1),new e(0,0,1),new e(0,-1,0),new e(0,1,0),new e(-1,0,0),new e(1,0,0)]);this.convexPolyhedronRepresentation=f},a.Box.prototype.calculateLocalInertia=function(b,c){return c=c||new a.Vec3,c.x=1/12*b*(2*this.halfExtents.y*2*this.halfExtents.y+2*this.halfExtents.z*2*this.halfExtents.z),c.y=1/12*b*(2*this.halfExtents.x*2*this.halfExtents.x+2*this.halfExtents.z*2*this.halfExtents.z),c.z=1/12*b*(2*this.halfExtents.y*2*this.halfExtents.y+2*this.halfExtents.x*2*this.halfExtents.x),c},a.Box.prototype.getCorners=function(b){var c=[],d=this.halfExtents;c.push(new a.Vec3(d.x,d.y,d.z)),c.push(new a.Vec3(-d.x,d.y,d.z)),c.push(new a.Vec3(-d.x,-d.y,d.z)),c.push(new a.Vec3(-d.x,-d.y,-d.z)),c.push(new a.Vec3(d.x,-d.y,-d.z)),c.push(new a.Vec3(d.x,d.y,-d.z)),c.push(new a.Vec3(-d.x,d.y,-d.z)),c.push(new a.Vec3(d.x,-d.y,d.z));for(var e=0;b!=undefined&&e<c.length;e++)b.vmult(c[e],c[e]);return c},a.Box.prototype.getSideNormals=function(b,c){var d=[],e=this.halfExtents;d.push(new a.Vec3(e.x,0,0)),d.push(new a.Vec3(0,e.y,0)),d.push(new a.Vec3(0,0,e.z)),b!=undefined&&b&&(d.push(new a.Vec3(-e.x,0,0)),d.push(new a.Vec3(0,-e.y,0)),d.push(new a.Vec3(0,0,-e.z)));for(var f=0;c!=undefined&&f<d.length;f++)c.vmult(d[f],d[f]);return d},a.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},a.Box.prototype.boundingSphereRadius=function(){return this.halfExtents.norm()},a.Plane=function(b){a.Shape.call(this),b.normalize(),this.normal=b,this.type=a.Shape.types.PLANE},a.Plane.prototype=new a.Shape,a.Plane.prototype.constructor=a.Plane,a.Plane.prototype.calculateLocalInertia=function(b,c){return c=c||new a.Vec3,c},a.Plane.prototype.volume=function(){return Infinity},a.Compound=function(){a.Shape.call(this),this.type=a.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},a.Compound.prototype=new a.Shape,a.Compound.prototype.constructor=a.Compound,a.Compound.prototype.addChild=function(b,c,d){c=c||new a.Vec3,d=d||new a.Quaternion,this.childShapes.push(b),this.childOffsets.push(c),this.childOrientations.push(d)},a.Compound.prototype.volume=function(){var a=0;for(var b=0;b<this.childShapes.length;b++)a+=this.childShapes[b].volume();return a},a.Compound.prototype.calculateLocalInertia=function(b,c){c=c||new a.Vec3;var d=this.volume();for(var e=0;e<this.childShapes.length;e++){var f=this.childShapes[e],g=this.childOffsets[e],h=this.childOrientations[e],i=f.volume()/d*b,j=f.calculateTransformedInertia(i,h);c.vadd(j,c);var k=new a.Vec3(i*g.x*g.x,i*g.y*g.y,i*g.z*g.z);c.vadd(k,c)}return c},a.Compound.prototype.boundingSphereRadius=function(){var a=0;for(var b=0;b<this.childShapes.length;b++){var c=this.childOffsets[b].norm()+this.childShapes[b].boundingSphereRadius();a<c&&(a=c)}return a},a.ConvexPolyhedron=function(b,c,d){function q(a,b,c,d,e){var f=a.vertices.length,g=null,h=null,i=a.vertices;for(var j=0;j<f;j++){i[j].copy(p),d.vmult(p,p),p.vadd(c,p);var k=p.dot(b);if(g===null||k>g)g=k;if(h===null||k<h)h=k}if(h>g){var l=h;h=g,g=l}e[0]=g,e[1]=h}function G(b,c){var d=e.vertices[b[0]],f=e.vertices[b[1]],g=e.vertices[b[2]],h=new a.Vec3;L(d,f,g,h);var i=h.dot(d);return h.dot(c)>=i}function H(a,b){var c=e.faces[a],d=e.vertices[c[0]],f=e.vertices[c[1]],g=e.vertices[c[2]];return L(d,f,g,b)}function I(a,b){var c=e.faces[a],d=e.faceNormals[a],f=e.vertices[c[0]],g=-d.dot(f);return g}function L(a,b,c,d){b.vsub(a,K),c.vsub(b,J),J.cross(K,d),d.isZero()||d.normalize()}function M(a){var b=e.faces[a],c="";for(var d=0;d<b.length;d++)c+=" ("+e.vertices[b[d]]+")";return c}function N(a,b){return a[0]===b[1]&&a[1]===b[0]}function O(){return(Math.random()-.5)*2*1e-6}var e=this;a.Shape.call(this),this.type=a.Shape.types.CONVEXPOLYHEDRON,this.vertices=[],this.faces=c,this.faceNormals=d,this.uniqueEdges=[];for(var f=0;f<b.length;f++){var g=b[f];if(!(g instanceof a.Vec3))throw"Argument 1 must be instance of CANNON.Vec3";this.vertices.push(g)}for(var h=0;h<c.length;h++){var i=c[h].length,j=i;for(var k=0;k<j;k++){var l=(k+1)%i,m=new a.Vec3;this.vertices[c[h][k]].vsub(this.vertices[c[h][l]],m),m.normalize();var n=!1;for(var g=0;g<this.uniqueEdges.length;g++)if(this.uniqueEdges[g].almostEquals(m)||this.uniqueEdges[g].almostEquals(m)){n=!0;break}n||this.uniqueEdges.push(m);if(m)m.face1=h;else{var o;o.m_face0=h,edges.insert(vp,o)}}}var p=new a.Vec3;this.testSepAxis=function(a,b,c,d,e,f){var g=[],h=[],i=this;q(i,a,c,d,g),q(b,a,e,f,h);var j=g[0],k=g[1],l=h[0],m=h[1];if(j<m||l<k)return!1;var n=j-m,o=l-k;return depth=n<o?n:o,depth};var r=new a.Vec3,s=new a.Vec3,t=new a.Vec3,u=new a.Vec3,v=new a.Vec3,w=new a.Vec3;this.findSeparatingAxis=function(a,b,c,d,e,f){var g=Infinity,h=this,i=0,j=h.faces.length;for(var k=0;k<j;k++){h.faceNormals[k].copy(r),c.vmult(r,r);var l=h.testSepAxis(r,a,b,c,d,e);if(l===!1)return!1;l<g&&(g=l,r.copy(f))}var m=a.faces.length;for(var k=0;k<m;k++){a.faceNormals[k].copy(s),e.vmult(s,s),i++;var l=h.testSepAxis(s,a,b,c,d,e);if(l===!1)return!1;l<g&&(g=l,s.copy(f))}var n,o,p,q,x=0;for(var y=0;y<h.uniqueEdges.length;y++){h.uniqueEdges[y].copy(u),c.vmult(u,u);for(var z=0;z<a.uniqueEdges.length;z++){a.uniqueEdges[z].copy(v),e.vmult(v,v),u.cross(v,w),x++;if(!w.almostZero()){w.normalize();var A=h.testSepAxis(w,a,b,c,d,e);if(A===!1)return!1;A<g&&(g=A,w.copy(f))}}}return d.vsub(b,t),t.dot(f)>0&&f.negate(f),!0};var x=new a.Vec3;this.clipAgainstHull=function(b,c,d,e,f,g,h,i,j){if(!(b instanceof a.Vec3))throw new Error("posA must be Vec3");if(!(c instanceof a.Quaternion))throw new Error("quatA must be Quaternion");var k=this,l=i,m=-1,n=-Infinity;for(var o=0;o<d.faces.length;o++){d.faceNormals[o].copy(x),f.vmult(x,x),e.vadd(x,x);var p=x.dot(g);p>n&&(n=p,m=o)}var q=[];polyB=d.faces[m];var r=polyB.length;for(var s=0;s<r;s++){var t=d.vertices[polyB[s]],u=new a.Vec3;t.copy(u),f.vmult(u,u),e.vadd(u,u),q.push(u)}m>=0&&this.clipFaceAgainstHull(g,b,c,q,h,i,j)};var y=new a.Vec3,z=new a.Vec3,A=new a.Vec3,B=new a.Vec3,C=new a.Vec3,D=new a.Vec3,E=new a.Vec3,F=new a.Vec3;this.clipFaceAgainstHull=function(b,c,d,e,f,g,h){if(!(b instanceof a.Vec3))throw new Error("sep normal must be vector");if(!(e instanceof Array))throw new Error("world verts must be array");f=Number(f),g=Number(g);var i=this,j=[],k=e,l=j,m=-1,n=Infinity;for(var o=0;o<i.faces.length;o++){i.faceNormals[o].copy(y),d.vmult(y,y),c.vadd(y,y);var p=y.dot(b);p<n&&(n=p,m=o)}if(m<0){console.log("--- did not find any closest face... ---");return}var q=i.faces[m];q.connectedFaces=[];for(var r=0;r<i.faces.length;r++)for(var s=0;s<i.faces[r].length;s++)q.indexOf(i.faces[r][s])!==-1&&r!==m&&q.connectedFaces.indexOf(r)===-1&&q.connectedFaces.push(r);var t=k.length,u=q.length,v=[];for(var w=0;w<u;w++){var x=i.vertices[q[w]],G=i.vertices[q[(w+1)%u]];x.vsub(G,z),z.copy(A),d.vmult(A,A),c.vadd(A,A),this.faceNormals[m].copy(B),d.vmult(B,B),c.vadd(B,B),A.cross(B,C),C.negate(C),x.copy(D),d.vmult(D,D),c.vadd(D,D);var H=-D.dot(C),J,K=q.connectedFaces[w];this.faceNormals[K].copy(E);var L=I(K);E.copy(F),d.vmult(F,F);var J=L-F.dot(c);this.clipFaceAgainstPlane(k,l,F,J);while(k.length)k.shift();while(l.length)k.push(l.shift())}this.faceNormals[m].copy(E);var L=I(m);E.copy(F),d.vmult(F,F);var J=L-F.dot(c);for(var r=0;r<k.length;r++){var M=F.dot(k[r])+J;M<=f&&(console.log("clamped: depth="+M+" to minDist="+(f+"")),M=f);if(M<=g){var N=k[r];if(M<=0){var O={point:N,normal:F,depth:M};h.push(O)}}}},this.clipFaceAgainstPlane=function(b,c,d,e){if(d instanceof a.Vec3){if(b instanceof Array){if(c instanceof Array){var f,g,h=b.length;if(h<2)return c;var i=b[b.length-1],j=b[0];f=d.dot(i)+e;for(var k=0;k<h;k++){j=b[k],g=d.dot(j)+e;if(f<0)if(g<0){var l=new a.Vec3;j.copy(l),c.push(l)}else{var l=new a.Vec3;i.lerp(j,f/(f-g),l),c.push(l)}else if(g<0){var l=new a.Vec3;i.lerp(j,f/(f-g),l),c.push(l),c.push(j)}i=j,f=g}return c}throw new Error("outvertices must be Array, "+c+" given")}throw new Error("invertices must be Array, "+b+" given")}throw new Error("planeNormal must be Vec3, "+d+" given")};var e=this,J=new a.Vec3,K=new a.Vec3;this.calculateLocalInertia=function(a,b){var c=this.aabbmax.x-this.aabbmin.x,d=this.aabbmax.y-this.aabbmin.y,e=this.aabbmax.z-this.aabbmin.z;b.x=1/12*a*(2*d*2*d+2*e*2*e),b.y=1/12*a*(2*c*2*c+2*e*2*e),b.z=1/12*a*(2*d*2*d+2*c*2*c)},this.computeAABB=function(){var a=this.vertices.length,b=this.aabbmin,c=this.aabbmax,d=this.vertices;b.set(Infinity,Infinity,Infinity),c.set(-Infinity,-Infinity,-Infinity);for(var e=0;e<a;e++){var f=d[e];f.x<b.x?b.x=f.x:f.x>c.x&&(c.x=f.x),f.y<b.y?b.y=f.y:f.y>c.y&&(c.y=f.y),f.z<b.z?b.z=f.z:f.z>c.z&&(c.z=f.z)}},this.boundingSphereRadius=function(){var a=0;for(var b=0;b<this.vertices.length;b++){var c=this.vertices[b].norm2();c>a&&(a=c)}return Math.sqrt(a)},this.computeAABB()},a.ConvexPolyhedron.prototype=new a.Shape,a.ConvexPolyhedron.prototype.constructor=a.ConvexPolyhedron,a.Solver=function(){this.iterations=10,this.h=1/60,this.k=1e3,this.d=4,this.a=0,this.b=0,this.eps=0,this.setSpookParams(this.k,this.d),this.reset(0),this.debug=!1,this.debug&&console.log("a:",this.a,"b",this.b,"eps",this.eps,"k",this.k,"d",this.d)},a.Solver.prototype.setSpookParams=function(a,b){var c=this.h;this.k=a,this.d=b,this.a=4/(c*(1+4*b)),this.b=4*b/(1+4*b),this.eps=4/(c*c*a*(1+4*b))},a.Solver.prototype.reset=function(a){this.G=[],this.MinvTrace=[],this.Fext=[],this.q=[],this.qdot=[],this.n=0,this.upper=[],this.lower=[],this.hasupper=[],this.haslower=[],this.i=[],this.j=[],this.vxlambda=[],this.vylambda=[],this.vzlambda=[],this.wxlambda=[],this.wylambda=[],this.wzlambda=[];for(var b=0;b<a;b++)this.vxlambda.push(0),this.vylambda.push(0),this.vzlambda.push(0),this.wxlambda.push(0),this.wylambda.push(0),this.wzlambda.push(0)},a.Solver.prototype.addConstraint=function(a,b,c,d,e,f,g,h,i){this.debug&&(console.log("Adding constraint ",this.n," between body ",h," and ",i),console.log("G:",a),console.log("q:",c),console.log("qdot:",d),console.log("Fext:",e),console.log("lower:",f),console.log("upper:",g));for(var j=0;j<12;j++)this.q.push(c[j]),this.qdot.push(d[j]),this.MinvTrace.push(b[j]),this.G.push(a[j]),this.Fext.push(e[j]);return this.upper.push(g),this.hasupper.push(!isNaN(g)),this.lower.push(f),this.haslower.push(!isNaN(f)),this.i.push(h),this.j.push(i),this.n+=1,this.n-1},a.Solver.prototype.addConstraint2=function(a,b,c){a.update();for(var d=0;d<a.equations.length;d++){var e=a.equations[d];this.addConstraint([e.G1.x,e.G1.y,e.G1.z,e.G2.x,e.G2.y,e.G2.z,e.G3.x,e.G3.y,e.G3.z,e.G4.x,e.G4.y,e.G4.z],[e.iM1.x,e.iM1.y,e.iM1.z,e.iM2.x,e.iM2.y,e.iM2.z,e.iM3.x,e.iM3.y,e.iM3.z,e.iM4.x,e.iM4.y,e.iM4.z],[e.g1.x,e.g1.y,e.g1.z,e.g2.x,e.g2.y,e.g2.z,e.g3.x,e.g3.y,e.g3.z,e.g4.x,e.g4.y,e.g4.z],[e.W1.x,e.W1.y,e.W1.z,e.W2.x,e.W2.y,e.W2.z,e.W3.x,e.W3.y,e.W3.z,e.W4.x,e.W4.y,e.W4.z],[e.f1.x,e.f1.y,e.f1.z,e.f2.x,e.f2.y,e.f2.z,e.f3.x,e.f3.y,e.f3.z,e.f4.x,e.f4.y,e.f4.z],e.lambdamin,e.lambdamax,b,c)}},a.Solver.prototype.addNonPenetrationConstraint=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t=f.cross(e),u=m.vsub(l),v=d.vadd(g).vsub(c.vadd(f)),w=v.dot(e);w<0&&(this.debug&&(console.log("i:",a,"j",b,"xi",c.toString(),"xj",d.toString()),console.log("ni",e.toString(),"ri",f.toString(),"rj",g.toString()),console.log("iMi",h.toString(),"iMj",i.toString(),"iIi",j.toString(),"iIj",k.toString(),"vi",l.toString(),"vj",m.toString(),"wi",n.toString(),"wj",o.toString(),"fi",p.toString(),"fj",q.toString(),"taui",r.toString(),"tauj",s.toString())),this.addConstraint([-e.x,-e.y,-e.z,-t.x,-t.y,-t.z,e.x,e.y,e.z,t.x,t.y,t.z],[h.x,h.y,h.z,j.z,j.y,j.z,i.x,i.y,i.z,k.z,k.y,k.z],[-v.x,-v.y,-v.z,0,0,0,v.x,v.y,v.z,0,0,0],[-u.x,-u.y,-u.z,0,0,0,u.x,u.y,u.z,0,0,0],[p.x,p.y,p.z,r.x,r.y,r.z,q.x,q.y,q.z,s.x,s.y,s.z],0,"inf",a,b))},a.Solver.prototype.solve=function(){var a=this.n,b=[],c=[],d=[],e=[],f=[],g=[],h=this.iterations,i=this.G,j=this.debug,k=this.a,l=this.eps,m=this.lower,n=this.haslower,o=this.upper,p=this.hasupper,q=this.vxlambda,r=this.vylambda,s=this.vzlambda,t=this.wxlambda,u=this.wylambda,v=this.wzlambda,w=this.MinvTrace;for(var x=0;x<a;x++){b.push(0),c.push(0),e.push(0),f.push(0),g.push(0);for(var y=0;y<12;y++)c.push(0)}for(var z=0;z<h;z++)for(var A=0;A<a;A++){var B=this.i[A],C=this.j[A],D=12*A;if(!g[A]){var E=0,F=0,G=0,H=0;for(var x=0;x<12;x++){var I=D+x;E+=i[I]*w[I]*i[I],F+=i[I]*this.q[I],G+=i[I]*this.qdot[I],H+=i[I]*w[I]*this.Fext[I]}f[A]=1/(E+l),e[A]=-k*F-this.b*G-this.h*H,g[A]=1,j&&(console.log("G_Minv_Gt["+A+"]:",E),console.log("Gq["+A+"]:",F),console.log("GW["+A+"]:",G),console.log("GMinvf["+A+"]:",H))}var J=0;B>=0&&(J+=i[0+D]*q[B],J+=i[1+D]*r[B],J+=i[2+D]*s[B],J+=i[3+D]*t[B],J+=i[4+D]*u[B],J+=i[5+D]*v[B],j&&isNaN(J)&&console.log("found NaN Gulambda",q)),C!==-1&&(J+=i[6+D]*q[C],J+=i[7+D]*r[C],J+=i[8+D]*s[C],J+=i[9+D]*t[C],J+=i[10+D]*u[C],J+=i[11+D]*v[C]),c[A]=f[A]*(e[A]-J-l*b[A]),j&&console.log("dlambda["+A+"]=",c[A],"rest = ",f[A],e[A],J,l,b[A],A,B,C),b[A]=b[A]+c[A],n[A]&&b[A]<m[A]&&(j&&console.log("hit lower bound for constraint "+A+", truncating "+b[A]+" to the bound "+m[A]),b[A]=m[A],c[A]=m[A]-b[A]),p&&b[A]>o[A]&&(j&&console.log("hit upper bound for constraint "+A+", truncating "+b[A]+" to the bound "+o[A]),b[A]=o[A],c[A]=o[A]-b[A]),B!==-1&&(q[B]+=c[A]*w[D+0]*i[D+0],r[B]+=c[A]*w[D+1]*i[D+1],s[B]+=c[A]*w[D+2]*i[D+2],t[B]+=c[A]*w[D+3]*i[D+3],u[B]+=c[A]*w[D+4]*i[D+4],v[B]+=c[A]*w[D+5]*i[D+5]),C!==-1&&(q[C]+=c[A]*w[D+6]*i[D+6],r[C]+=c[A]*w[D+7]*i[D+7],s[C]+=c[A]*w[D+8]*i[D+8],t[C]+=c[A]*w[D+9]*i[D+9],u[C]+=c[A]*w[D+10]*i[D+10],v[C]+=c[A]*w[D+11]*i[D+11])}if(j)for(var x=0;x<this.vxlambda.length;x++)console.log("dv["+x+"]=",q[x],r[x],s[x],t[x],u[x],v[x])},a.EventTarget=function(){var a={};this.addEventListener=function(b,c){a[b]==undefined&&(a[b]=[]),a[b].indexOf(c)===-1&&a[b].push(c)},this.dispatchEvent=function(b){for(var c in a[b.type])a[b.type][c](b)},this.removeEventListener=function(b,c){var d=a[b].indexOf(c);d!==-1&&a[b].splice(d,1)}},a.ObjectPool=function(){this.objects=[],this.type=Object},a.ObjectPool.prototype.release=function(){for(var a in arguments)this.objects.push(arguments[a])},a.ObjectPool.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},a.ObjectPool.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this ObjectPool subclass yet!")},a.Vec3Pool=function(){a.ObjectPool.call(this),this.type=a.Vec3},a.Vec3Pool.prototype=new a.ObjectPool,a.Vec3Pool.prototype.constructObject=function(){return new a.Vec3},a.Material=function(a){this.name=a,this.id=-1},a.ContactMaterial=function(a,b,c,d){this.id=-1,this.materials=[a,b],this.friction=c!=undefined?Number(c):.3,this.restitution=d!=undefined?Number(d):.3},a.World=function(){a.EventTarget.apply(this),this.allowSleep=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new a.Vec3,this.broadphase=null,this.bodies=[];var b=this;this.solver=new a.Solver,this.constraints=[],this.contactgen=new a.ContactGenerator,this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.temp={gvec:new a.Vec3,vi:new a.Vec3,vj:new a.Vec3,wi:new a.Vec3,wj:new a.Vec3,t1:new a.Vec3,t2:new a.Vec3,rixn:new a.Vec3,rjxn:new a.Vec3,step_q:new a.Quaternion,step_w:new a.Quaternion,step_wq:new a.Quaternion}},a.World.prototype.getContactMaterial=function(b,c){if(b instanceof a.Material&&c instanceof a.Material){var d=b.id,e=c.id;if(d<e){var f=d;d=e,e=f}return this.contactmaterials[this.mats2cmat[d+e*this.materials.length]]}},a.World.prototype._addImpulse=function(b,c,d,e,f,g,h,i){var j=d.crossmat(),k=e.crossmat(),l=this.inertiax[b]>0?1/this.inertiax[b]:0,m=new a.Mat3([l,0,0,0,l,0,0,0,l]);l=this.inertiax[c]>0?1/this.inertiax[c]:0;var n=new a.Mat3([l,0,0,0,l,0,0,0,l]),o=this.invm[b]+this.invm[c],p=new a.Mat3([o,0,0,0,o,0,0,0,o]),q=j.mmult(m.mmult(j)),r=k.mmult(n.mmult(k)),s=g.mult(-h*f.dot(g)),t=p.solve(s.vsub(f)),i=0;if(i>0){var u=g.mult(t.dot(g)),v=t.vsub(u);if(v.norm()>u.mult(i).norm()){var w=f.vsub(g.mult(f.dot(g))),x=w.mult(1/(w.norm()+1e-4)),y=-(1+h)*f.dot(g)/g.dot(p.vmult(g.vsub(x.mult(i))));t=g.mult(y).vsub(x.mult(i*y))}}var z=this.invm[b],A=this.invm[c];this.vx[b]+=t.x*z-(this.vx[c]-f.x),this.vy[b]+=t.y*z-(this.vy[c]-f.y),this.vz[b]+=t.z*z-(this.vz[c]-f.z),this.vx[c]-=t.x*A+(this.vx[b]+f.x),this.vy[c]-=t.y*A+(this.vy[b]+f.y),this.vz[c]-=t.z*A+(this.vz[b]+f.z);var B=d.cross(t),C=B.mult(1/this.inertiax[b])},a.World.prototype.numObjects=function(){return this.bodies.length},a.World.prototype.clearCollisionState=function(a){var b=this.numObjects(),c=a.id;for(var d=0;d<b;d++){var e=d;c>e?this.collision_matrix[e+c*b]=0:this.collision_matrix[c+e*b]=0}},a.World.prototype.add=function(b){var c=this.numObjects();this.bodies.push(b),b.id=this.id(),b.world=this,b.position.copy(b.initPosition),b.velocity.copy(b.initVelocity),b instanceof a.RigidBody&&(b.angularVelocity.copy(b.initAngularVelocity),b.quaternion.copy(b.initQuaternion)),this.collision_matrix=new Int16Array((c+1)*(c+1))},a.World.prototype.addConstraint=function(b){b instanceof a.Constraint&&(this.constraints.push(b),b.id=this.id())},a.World.prototype.id=function(){return this.nextId++},a.World.prototype.remove=
function(a){a.world=null;var b=this.numObjects(),c=this.bodies;for(var d in c)c[d].id==a.id&&c.splice(d,1);this.collision_matrix=new Int16Array((b-1)*(b-1))},a.World.prototype.addMaterial=function(a){if(a.id==-1){this.materials.push(a),a.id=this.materials.length-1;var b=new Int16Array(this.materials.length*this.materials.length);for(var c=0;c<b.length;c++)b[c]=-1;for(var c=0;c<this.materials.length-1;c++)for(var d=0;d<this.materials.length-1;d++)b[c+this.materials.length*d]=this.mats2cmat[c+(this.materials.length-1)*d];this.mats2cmat=b}},a.World.prototype.addContactMaterial=function(a){this.addMaterial(a.materials[0]),this.addMaterial(a.materials[1]),a.materials[0].id>a.materials[1].id?(i=a.materials[0].id,j=a.materials[1].id):(j=a.materials[0].id,i=a.materials[1].id),this.contactmaterials.push(a),a.id=this.contactmaterials.length-1,this.mats2cmat[i+this.materials.length*j]=a.id},a.World.prototype._id2index=function(a){for(var b=0;b<this.bodies.length;b++)if(this.bodies[b].id===a)return b;return-1},a.World.prototype.step=function(b){function t(a,b,c){typeof c=="undefined"&&(c=!0);if(c&&a<b||!c&&a>b){var f=b;b=a,a=f}return d.collision_matrix[a+b*e]}function u(a,b,c,f){typeof f=="undefined"&&(f=!0);if(f&&a<b||!f&&a>b){var g=b;b=a,a=g}d.collision_matrix[a+b*e]=parseInt(c)}function v(){for(var a=0;a<f.length;a++)for(var b=0;b<a;b++){var c=t(a,b,!0);u(a,b,c,!1),u(a,b,0,!0)}}var c=this,d=this,e=this.numObjects(),f=this.bodies,g=this.solver,h=this.gravity;b==undefined&&(this.last_dt?b=this.last_dt:b=this.default_dt);for(var i=0;i<e;i++){var j=f[i];if(j.motionstate&a.Body.DYNAMIC){var k=f[i].force,l=f[i].mass;k.x+=h.x*l,k.y+=h.y*l,k.z+=h.z*l}}var m=this.broadphase.collisionPairs(this),n=m[0],o=m[1],p=a.Shape.types.SPHERE,q=a.Shape.types.PLANE,r=a.Shape.types.BOX,s=a.Shape.types.COMPOUND;v(),g.reset(e);var w=this.contacts;this.contacts=[],this.contactgen.getContacts(n,o,this,this.contacts,w);var x=this.temp,y=this.contacts,z=y.length;for(var A=0;A<z;A++){var B=y[A],j=B.bi,C=B.bj,i=this._id2index(j.id),D=this._id2index(C.id),E=t(i,D,!1),F=.3,G=.2,H=this.getContactMaterial(j.material,C.material);H&&(F=H.friction,G=H.restitution);var I=x.gvec;I.set(C.position.x+B.rj.x-j.position.x-B.ri.x,C.position.y+B.rj.y-j.position.y-B.ri.y,C.position.z+B.rj.z-j.position.z-B.ri.z);var J=I.dot(B.ni);if(J<0){u(i,D,1,!0),t(i,D,true)!=t(i,D,false)&&(j.dispatchEvent({type:"collide","with":C}),C.dispatchEvent({type:"collide","with":j}),j.wakeUp(),C.wakeUp());var K=j.velocity,L=j.angularVelocity,M=C.velocity,N=C.angularVelocity,O=B.ni,P=[x.t1,x.t2];O.tangents(P[0],P[1]);var Q;L?Q=K.vadd(L.cross(B.ri)):Q=K.copy();var R;N?R=M.vadd(N.cross(B.rj)):R=M.copy();var S=R.vsub(Q),T;N&&L?T=N.cross(B.rj).vsub(L.cross(B.ri)):L?T=L.cross(B.ri).negate():N&&(T=N.cross(B.rj));var U=M.vsub(K),V;N&&L?V=B.rj.cross(N).vsub(B.ri.cross(L)):L?V=B.ri.cross(L).negate():N&&(V=B.rj.cross(N)),U.vsub(V,U);var W=j.invMass,X=C.invMass,Y=j.invInertia?j.invInertia.x:0,Z=j.invInertia?j.invInertia.y:0,$=j.invInertia?j.invInertia.z:0,_=C.invInertia?C.invInertia.x:0,ab=C.invInertia?C.invInertia.y:0,bb=C.invInertia?C.invInertia.z:0,cb=x.rixn,db=x.rjxn;B.ri.cross(O,cb),B.rj.cross(O,db);var eb=O.mult(S.dot(O)*.5),fb=cb.unit().mult(T.dot(cb.unit())),gb=db.unit().mult(-T.dot(db.unit())),hb=B.ni.mult(J),ib,jb,kb;j.tau?(ib=j.tau.x,jb=j.tau.y,kb=j.tau.z):(ib=0,jb=0,kb=0);var lb,mb,nb;j.tau?(lb=C.tau.x,mb=C.tau.y,nb=C.tau.z):(lb=0,mb=0,nb=0),g.addConstraint([-O.x,-O.y,-O.z,-cb.x,-cb.y,-cb.z,O.x,O.y,O.z,db.x,db.y,db.z],[W,W,W,Y,Z,$,X,X,X,_,ab,bb],[-hb.x,-hb.y,-hb.z,0,0,0,hb.x,hb.y,hb.z,0,0,0],[-eb.x,-eb.y,-eb.z,0,0,0,eb.x,eb.y,eb.z,0,0,0],[j.force.x,j.force.y,j.force.z,ib,jb,kb,-C.force.x,-C.force.y,-C.force.z,-lb,-jb,-kb],0,"inf",i,D);if(F>0){var J=h.norm();for(var ob=0;ob<P.length;ob++){var pb=P[ob],qb=B.ri.cross(pb),rb=B.rj.cross(pb),sb=pb.mult(S.dot(pb)),tb=qb.unit().mult(S.dot(qb.unit())),ub=rb.unit().mult(-S.dot(rb.unit()));g.addConstraint([-pb.x,-pb.y,-pb.z,-qb.x,-qb.y,-qb.z,pb.x,pb.y,pb.z,rb.x,rb.y,rb.z],[W,W,W,Y,Z,$,X,X,X,_,ab,bb],[0,0,0,0,0,0,0,0,0,0,0,0],[-sb.x,-sb.y,-sb.z,0,0,0,sb.x,sb.y,sb.z,0,0,0],[j.force.x,j.force.y,j.force.z,ib,jb,kb,C.force.x,C.force.y,C.force.z,lb,mb,nb],-F*100*(j.mass+C.mass),F*100*(j.mass+C.mass),i,D)}}}}var vb=this.constraints,wb=vb.length;for(var i=0;i<wb;i++){var C=-1,j=-1;for(var D=0;D<e;D++)f[D].id===vb[i].body_i.id?j=D:f[D].id===vb[i].body_j.id&&(C=D);g.addConstraint2(vb[i],j,C)}var j;if(g.n){g.h=b,g.solve();var xb=g.vxlambda,yb=g.vylambda,zb=g.vzlambda,Ab=g.wxlambda,Bb=g.wylambda,Cb=g.wzlambda;for(var i=0;i<e;i++){j=f[i];if(j.motionstate&a.Body.DYNAMIC){var Db=f[i],Eb=Db.velocity,Fb=Db.angularVelocity;Eb.x+=xb[i],Eb.y+=yb[i],Eb.z+=zb[i],Db.angularVelocity&&(Fb.x+=Ab[i],Fb.y+=Bb[i],Fb.z+=Cb[i])}}}for(var i=0;i<e;i++){j=f[i];if(j.motionstate&a.Body.DYNAMIC){var Gb=1-j.linearDamping,Hb=1-j.angularDamping,Ib=j.velocity,Jb=j.angularVelocity;Ib.mult(Gb,Ib),Jb&&Jb.mult(Hb,Jb)}}d.dispatchEvent({type:"preStep"});for(var i in f){var j=f[i];j.preStep&&j.preStep.call(j)}var Kb=x.step_q,Lb=x.step_w,Mb=x.step_wq,Nb=c.stepnumber,Ob=a.Body.DYNAMIC|a.Body.KINEMATIC;for(var i=0;i<e;i++){var Db=f[i],Pb=Db.force,Qb=Db.tau;if(Db.motionstate&Ob){var Eb=Db.velocity,Rb=Db.angularVelocity,Sb=Db.position,Tb=Db.quaternion,Ub=Db.invMass,Vb=Db.invInertia;Eb.x+=Pb.x*Ub*b,Eb.y+=Pb.y*Ub*b,Eb.z+=Pb.z*Ub*b,Db.angularVelocity&&(Rb.x+=Qb.x*Vb.x*b,Rb.y+=Qb.y*Vb.y*b,Rb.z+=Qb.z*Vb.z*b),Db.isSleeping()||(Sb.x+=Eb.x*b,Sb.y+=Eb.y*b,Sb.z+=Eb.z*b,Db.angularVelocity&&(Lb.set(Rb.x,Rb.y,Rb.z,0),Lb.mult(Tb,Mb),Tb.x+=b*.5*Mb.x,Tb.y+=b*.5*Mb.y,Tb.z+=b*.5*Mb.z,Tb.w+=b*.5*Mb.w,Nb%3===0&&Tb.normalizeFast()))}Db.force.set(0,0,0),Db.tau&&Db.tau.set(0,0,0)}c.time+=b,c.stepnumber+=1,d.dispatchEvent({type:"postStep"});for(var i=0;i<e;i++){var j=f[i],Wb=j.postStep;Wb&&Wb.call(j)}if(c.allowSleep)for(var i=0;i<e;i++)f[i].sleepTick()},a.ContactPoint=function(b,c,d,e,f){this.ri=new a.Vec3,this.rj=new a.Vec3,this.ni=new a.Vec3,d&&d.copy(this.ri),e&&e.copy(this.rj),f&&f.copy(this.ni),this.bi=b,this.bj=c},a.ContactGenerator=function(){function f(g,h,i,j,k,l,m,n,o){function r(c,d){if(b.length){var e=b.pop();return e.bi=c,e.bj=d,e}return new a.ContactPoint(c,d)}function s(a){var b;b=a.ri,a.ri=a.rj,a.rj=b,a.ni.negate(a.ni),b=a.bi,a.bi=a.bj,a.bj=b}function t(a,b,c,d,e,g,h,i,j){for(var k=0;k<c.childShapes.length;k++){var l=[];f(l,b,c.childShapes[k],d,e.vadd(h.vmult(c.childOffsets[k])),g,h.mult(c.childOrientations[k]),i,j);for(var m=0;m<l.length;m++)l[m].rj.vadd(h.vmult(c.childOffsets[k]),l[m].rj),a.push(l[m])}}var p=!1;if(h&&i&&h.type>i.type){var q;q=i,i=h,h=q,q=k,k=j,j=q,q=m,m=l,l=q,q=o,o=n,n=q,p=!0}if(h&&i){if(h.type==a.Shape.types.SPHERE){if(i.type==a.Shape.types.SPHERE){var u=r(n,o);k.vsub(j,u.ni),u.ni.normalize(),u.ni.copy(u.ri),u.ni.copy(u.rj),u.ri.mult(h.radius,u.ri),u.rj.mult(-i.radius,u.rj),g.push(u)}else if(i.type==a.Shape.types.PLANE){var u=r(n,o);i.normal.copy(u.ni),m.vmult(u.ni,u.ni),u.ni.negate(u.ni),u.ni.normalize(),u.ni.mult(h.radius,u.ri);var v=j.vsub(k),w=u.ni.mult(u.ni.dot(v));u.rj=v.vsub(w),w.norm()<=h.radius&&g.push(u)}else if(i.type==a.Shape.types.BOX){var x=j.vsub(k),y=i.getSideNormals(!0,m),z=h.radius,A=[],B=!1;for(var C=0;C<y.length&&!B;C++){var D=y[C].copy(),E=D.norm();D.normalize();var F=x.dot(D);if(F<E+z&&F>0){var G=y[(C+1)%3].copy(),H=y[(C+2)%3].copy(),I=G.norm(),J=H.norm();G.normalize(),H.normalize();var K=x.dot(G),L=x.dot(H);if(K<I&&K>-I&&L<J&&L>-J){B=!0;var u=r(n,o);D.mult(-z,u.ri),D.copy(u.ni),u.ni.negate(u.ni),D.mult(E).vadd(G.mult(K)).vadd(H.mult(L),u.rj),g.push(u)}}}var M=c.get();for(var N=0;N<2&&!B;N++)for(var O=0;O<2&&!B;O++)for(var P=0;P<2&&!B;P++){M.set(0,0,0),N?M.vadd(y[0],M):M.vsub(y[0],M),O?M.vadd(y[1],M):M.vsub(y[1],M),P?M.vadd(y[2],M):M.vsub(y[2],M);var Q=k.vadd(M).vsub(j);if(Q.norm()<z){B=!0;var u=r(n,o);Q.copy(u.ri),u.ri.normalize(),u.ri.copy(u.ni),u.ri.mult(z,u.ri),M.copy(u.rj),g.push(u)}}c.release(M),M=null;var R=c.get(),S=c.get(),u=c.get(),T=c.get(),U=c.get();for(var N=0;N<y.length&&!B;N++)for(var O=0;O<y.length&&!B;O++)if(N%3!=O%3){y[O].cross(y[N],R),R.normalize(),y[N].vadd(y[O],S),j.copy(u),u.vsub(S,u),u.vsub(k,u);var V=u.dot(R);R.mult(V,T);var P=0;while(P==N%3||P==O%3)P++;j.copy(U),U.vsub(T,U),U.vsub(S,U),U.vsub(k,U);var W=Math.abs(V),X=U.norm();if(W<y[P].norm()&&X<z){B=!0;var Y=r(n,o);S.vadd(T,Y.rj),Y.rj.copy(Y.rj),U.negate(Y.ni),Y.ni.normalize(),Y.rj.copy(Y.ri),Y.ri.vadd(k,Y.ri),Y.ri.vsub(j,Y.ri),Y.ri.normalize(),Y.ri.mult(z,Y.ri),g.push(Y)}}c.release(R,S,u,T,U)}else if(i.type==a.Shape.types.COMPOUND)t(g,h,i,j,k,l,m,n,o);else if(i.type==a.Shape.types.CONVEXPOLYHEDRON)throw new Error("sphere/convexpolyhedron contacts not implemented yet.")}else if(h.type==a.Shape.types.PLANE){if(i.type==a.Shape.types.PLANE)throw"Plane-plane collision... wait, you did WHAT?";if(i.type==a.Shape.types.BOX){var Z=h.normal.copy(),$=0,_=i.getCorners(m);for(var C=0;C<_.length&&$<=4;C++){var u=r(n,o),ab=_[C].vadd(k);_[C].copy(u.rj);var bb=ab.vsub(j),cb=Z.dot(bb);if(cb<=0){$++;var db=Z.mult(cb);bb.vsub(db,u.ri),Z.copy(u.ni),g.push(u)}}}else if(i.type==a.Shape.types.COMPOUND)t(g,h,i,j,k,l,m,n,o);else if(i.type==a.Shape.types.CONVEXPOLYHEDRON){var eb=c.get(),fb=c.get();h.normal.tangents(eb,fb),eb.mult(1e5,eb),fb.mult(1e5,fb);var Z=c.get();h.normal.copy(Z),d[0].set(-eb.x-fb.x-Z.x,-eb.y-fb.y-Z.y,-eb.z-fb.z-Z.z),d[1].set(eb.x-fb.x+0*Z.x,eb.y-fb.y+0*Z.y,eb.z-fb.z+0*Z.z),d[2].set(eb.x+fb.x-Z.x,eb.y+fb.y-Z.y,eb.z+fb.z-Z.z),d[3].set(-eb.x+fb.x-Z.x,-eb.y+fb.y-Z.y,-eb.z+fb.z-Z.z),d[4].set(-eb.x-fb.x+0*Z.x,-eb.y-fb.y+0*Z.y,-eb.z-fb.z+0*Z.z),d[5].set(+eb.x-fb.x+0*Z.x,eb.y-fb.y+0*Z.y,eb.z-fb.z+0*Z.z),d[6].set(+eb.x+fb.x+0*Z.x,+eb.y+fb.y+0*Z.y,eb.z+fb.z+0*Z.z),d[7].set(-eb.x+fb.x+0*Z.x,-eb.y+fb.y+0*Z.y,-eb.z+fb.z+0*Z.z),eb.normalize(),fb.normalize(),e[0].set(-Z.x,-Z.y,-Z.z),e[1].set(Z.x,Z.y,Z.z),e[2].set(-fb.x,-fb.y,-fb.z),e[3].set(fb.x,fb.y,fb.z),e[4].set(-eb.x,-eb.y,-eb.z),e[5].set(eb.x,eb.y,eb.z);var gb=new a.ConvexPolyhedron(d,[[0,1,2,3],[4,5,6,7],[0,1,4,5],[2,3,6,7],[0,3,4,7],[1,2,5,6]],e),hb=c.get();Z.negate(hb);var ib=c.get();if(i.testSepAxis(hb,gb,k,m,j,l)!==!1){var Y=[];gb.clipAgainstHull(j,l,i,k,m,hb,-100,100,Y);for(var N=0;N<Y.length;N++){var u=r(n,o);hb.negate(u.ni),Y[N].normal.negate(ib),ib.mult(Y[N].depth,ib),u.ri.set(Y[N].point.x+ib.x,Y[N].point.y+ib.y,Y[N].point.z+ib.z),u.rj.set(Y[N].point.x,Y[N].point.y,Y[N].point.z),u.rj.vsub(k,u.rj),u.ri.vsub(j,u.ri),g.push(u)}}c.release(ib,eb,fb,hb,Z)}}else if(h.type==a.Shape.types.BOX)i.type==a.Shape.types.BOX?f(g,h.convexPolyhedronRepresentation,i.convexPolyhedronRepresentation,j,k,l,m,n,o):i.type==a.Shape.types.COMPOUND?t(g,h,i,j,k,l,m,n,o):i.type==a.Shape.types.CONVEXPOLYHEDRON&&f(g,h.convexPolyhedronRepresentation,i,j,k,l,m,n,o);else if(h.type==a.Shape.types.COMPOUND)i.type==a.Shape.types.COMPOUND?t(g,h,i,j,k,l,m,n,o):i.type==a.Shape.types.CONVEXPOLYHEDRON&&t(g,i,h,k,j,m,l,o,n);else if(h.type==a.Shape.types.CONVEXPOLYHEDRON&&i.type==a.Shape.types.CONVEXPOLYHEDRON){var hb=new a.Vec3;if(h.findSeparatingAxis(i,j,l,k,m,hb)){var Y=[],ib=new a.Vec3;h.clipAgainstHull(j,l,i,k,m,hb,-100,100,Y);for(var N=0;N<Y.length;N++){var u=r(n,o);hb.negate(u.ni),Y[N].normal.negate(ib),ib.mult(Y[N].depth,ib),u.ri.set(Y[N].point.x+ib.x,Y[N].point.y+ib.y,Y[N].point.z+ib.z),u.rj.set(Y[N].point.x,Y[N].point.y,Y[N].point.z),u.rj.vsub(k,u.rj),u.ri.vsub(j,u.ri),g.push(u)}}}}else{var jb=h?o:n,kb=h?n:o,lb=kb.shape,mb=lb.type;if(mb==a.Shape.types.PLANE){var nb=lb.normal,ob=new a.Vec3;jb.position.vsub(kb.position,ob);var F=nb.dot(ob);if(F<=0){var u=r(jb,kb);lb.normal.copy(u.ni),u.ni.negate(u.ni),u.ri.set(0,0,0);var pb=new a.Vec3;nb.mult(nb.dot(jb.position),pb),jb.position.vsub(pb,pb),pb.copy(u.rj),g.push(u)}}}for(var qb=0;p&&qb<g.length;qb++)s(g[qb])}this.contactReduction=!0;var b=[],c=new a.Vec3Pool,d=[new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3],e=[new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3,new a.Vec3];this.reduceContacts=function(a){},this.getContacts=function(a,c,d,e,g){for(var h=0;g&&h<g.length;h++)b.push(g[h]);for(var i=0;i<a.length;i++){var j=a[i],k=c[i];f(e,j.shape,k.shape,j.position,k.position,j.quaternion,k.quaternion,j,k)}}},a.Constraint=function(){this.equations=[],this.id=-1},a.Constraint.prototype.constructor=a.Constraint,a.Constraint.prototype.update=function(){throw"update() not implemented in this Constraint subclass!"},a.ContactConstraint=function(b,c,d){a.Constraint.call(this),this.body_i=b,this.body_j=c,this.contact=contact,this.slipForce=d,this.unused_equations=[],this.temp={rixn:new a.Vec3,rjxn:new a.Vec3,t1:new a.Vec3,t2:new a.Vec3}},a.ContactConstraint.prototype=new a.Constraint,a.ContactConstraint.prototype.constructor=a.ContactConstraint,a.ContactConstraint.prototype.update=function(){var a=this.body_i,b=this.body_j,d=a.velocity,e=a.angularVelocity,f=b.velocity,h=b.angularVelocity,i=[this.temp.t1,this.temp.t2];for(var j in a.contacts)for(var k in b.contacts)if(a.contacts[j].to.id==b.id&&b.contacts[k].to.id==a.id){var l=a.contacts[j].r,m=b.contacts[k].r,o=a.contacts[j].n;n.tangents(i[0],i[1]);var p=d.vadd(e.cross(c.ri)),q=f.vadd(h.cross(c.rj)),r=q.vsub(p),s=h.cross(c.rj).vsub(e.cross(c.ri)),t=f.vsub(d),u=c.rj.cross(h).vsub(c.ri.cross(e));t.vsub(u,t);var v=a.invMass,w=b.invMass,x=a.invInertia.x,y=a.invInertia.y,z=a.invInertia.z,A=b.invInertia.x,B=b.invInertia.y,C=b.invInertia.z,D=this.temp.rixn,E=this.temp.rjxn;c.ri.cross(n,D),c.rj.cross(n,E);var F=n.mult(r.dot(n)),G=D.unit().mult(s.dot(D.unit())),H=E.unit().mult(-s.dot(E.unit())),I=c.ni.mult(g);n.negate(eq.G1),D.negate(eq.G2),n.copy(eq.G3),E.copy(eq.G4),eq.setDefaultMassProps(),I.negate(eq.g1),I.copy(eq.g3),F.negate(eq.W1),F.copy(eq.W3),a.force.copy(eq.f1),a.tau.copy(eq.f2),b.force.copy(eq.f3),b.tau.copy(eq.f4),eq.lambdamin=0,eq.lambdamax="inf"}},a.DistanceConstraint=function(b,c,d){a.Constraint.call(this),this.body_i=b,this.body_j=c,this.distance=Number(d);var e=new a.Equation(b,c instanceof a.Vec3?null:c);this.equations.push(e)},a.DistanceConstraint.prototype=new a.Constraint,a.DistanceConstraint.prototype.constructor=a.DistanceConstraint,a.DistanceConstraint.prototype.update=function(){var a=this.equations[0],b=this.body_i,c=this.body_j,d=typeof c.mass=="number";d?c.position.vsub(b.position,a.G1):b.position.vsub(c,a.G1),a.G1.normalize(),a.G1.isZero()&&a.G1.set(1,0,0),a.G1.negate(a.G3),a.setDefaultMassProps(),a.setDefaultForce(),a.g1.set((d?c.position.x:c.x)-b.position.x-a.G1.x*this.distance,(d?c.position.y:c.y)-b.position.y-a.G1.y*this.distance,(d?c.position.z:c.z)-b.position.z-a.G1.z*this.distance),a.g1.negate(a.g1),a.g1.negate(a.g3)},a.DistanceConstraint.prototype.setMaxForce=function(a){this.equations[0].lambdamax=Math.abs(a),this.equations[0].lambdamin=-this.equations[0].lambdamax},a.Equation=function(b,c){this.G1=new a.Vec3,this.G2=new a.Vec3,this.G3=new a.Vec3,this.G4=new a.Vec3,this.iM1=new a.Vec3,this.iM2=new a.Vec3,this.iM3=new a.Vec3,this.iM4=new a.Vec3,this.g1=new a.Vec3,this.g2=new a.Vec3,this.g3=new a.Vec3,this.g4=new a.Vec3,this.W1=new a.Vec3,this.W2=new a.Vec3,this.W3=new a.Vec3,this.W4=new a.Vec3,this.f1=new a.Vec3,this.f2=new a.Vec3,this.f3=new a.Vec3,this.f4=new a.Vec3,this.lambdamax=1e6,this.lambdamin=-1e6,this.body_i=b,this.body_j=c},a.Equation.prototype.setDefaultMassProps=function(){var a=this.body_i,b=this.body_j;a&&(this.iM1.set(a.invMass,a.invMass,a.invMass),a.invInertia&&a.invInertia.copy(this.iM2)),b&&(this.iM3.set(b.invMass,b.invMass,b.invMass),b.invInertia&&b.invInertia.copy(this.iM4))},a.Equation.prototype.setDefaultForce=function(){var a=this.body_i,b=this.body_j;a&&(a.force.copy(this.f1),a.tau&&a.tau.copy(this.f2)),b&&(b.force.copy(this.f3),b.tau&&b.tau.copy(this.f4))},a.PointToPointConstraint=function(b,c,d,e){a.Constraint.call(this),this.body_i=b,this.body_j=d,this.pivot_i=c,this.pivot_j=e;for(var f=0;f<3;f++)this.equations.push(new Equation(b,d))},a.PointToPointConstraint.prototype=new a.Constraint,a.PointToPointConstraint.prototype.constructor=a.PointToPointConstraint,a.PointToPointConstraint.prototype.update=function(){},typeof module!="undefined"?module.exports=a:this.CANNON=a}).apply(this);