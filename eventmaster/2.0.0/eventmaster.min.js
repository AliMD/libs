define("eventmaster",["mo/lang/es5","mo/lang/mix","mo/lang/struct"],function(m,h,i){function e(a){var b=this;a&&(this.subject=a.subject,this.trace=a.trace,this.traceStack=a.traceStack||[]);this.doneHandlers=j();this.failHandlers=j();this.observeHandlers=j();this._alterQueue=j();this._lastDoneQueue=[];this._lastFailQueue=[];this.status=0;this._argsCache=[];this.pipe={};p.forEach(function(a){this[a]=function(){return b[a].call(b,n.call(arguments))}},this.pipe)}function g(){var a=[],b=[],c=new e;c._when=
[];c._count=c._total=arguments.length;Array.prototype.forEach.call(arguments,function(c,d){var e=this;e._when.push(c.bind(function(c){b[d]||(b[d]=!0,a[d]=c,0===--e._count&&(b.length=0,e._count=e._total,e.resolve.call(e,a)))}))},c);return c}function k(a,b){a&&a.then?a.then(b.pipe.resolve,b.pipe.reject).progress(b.pipe.notify):void 0!==a&&b.resolve([a]);return a}function q(a){return function(b){var c=this.lib[b];c||(c=this.lib[b]=new e({subject:b,trace:this.trace,traceStack:this.traceStack}));c[a].apply(c,
n.call(arguments,1));return this}}function l(a){a&&(this.trace=a.trace,this.traceStack=a.traceStack);this.lib={}}function f(a){return new l(a)}var j=i.fnQueue,n=Array.prototype.slice,p="notify fire error resolve reject reset disable enable".split(" "),m=e.prototype={then:function(a,b){var c=this.status;b?2===c?this._resultCache=b.apply(this,this._argsCache):c||(this.failHandlers.push(b),this._lastFailQueue=this.failHandlers):this._lastFailQueue=[];a?1===c?this._resultCache=a.apply(this,this._argsCache):
c||(this.doneHandlers.push(a),this._lastDoneQueue=this.doneHandlers):this._lastDoneQueue=[];return this},done:function(a){return this.then(a)},fail:function(a){return this.then(!1,a)},cancel:function(a,b){a&&this.doneHandlers.clear(a);b&&this.failHandlers.clear(b);return this},bind:function(a){this.status&&a.apply(this,this._argsCache);this.observeHandlers.push(a);return this},unbind:function(a){this.observeHandlers.clear(a);return this},progress:function(a){var b=this;this.observeHandlers.push(function(){b.status||
a.apply(this,arguments)});return this},notify:function(a){if(this._disalbed)return this;this.status=0;this.observeHandlers.apply(this,a||[]);return this},fire:function(a){if(this._disalbed)return this;this.trace&&this._trace();var a=a||[],b=this.doneHandlers;this.doneHandlers=this._alterQueue;this.failHandlers.length=0;this.observeHandlers.apply(this,a);b.apply(this,a);b.length=0;this._alterQueue=b;return this},error:function(a){if(this._disalbed)return this;this.trace&&this._trace();var a=a||[],
b=this.failHandlers;this.failHandlers=this._alterQueue;this.doneHandlers.length=0;this.observeHandlers.apply(this,a);b.apply(this,a);b.length=0;this._alterQueue=b;return this},resolve:function(a){this.status=1;this._argsCache=a||[];return this.fire(a)},reject:function(a){this.status=2;this._argsCache=a||[];return this.error(a)},reset:function(){this.status=0;this._argsCache=[];this.doneHandlers.length=0;this.failHandlers.length=0;return this},disable:function(){this._disalbed=!0},enable:function(){this._disalbed=
!1},merge:function(a){h.merge(this.doneHandlers,a.doneHandlers);h.merge(this.failHandlers,a.failHandlers);h.merge(this.observeHandlers,a.observeHandlers);var b=a.subject;h.mix(a,this);a.subject=b},_trace:function(){this.traceStack.unshift(this.subject);this.traceStack.length>this.trace&&this.traceStack.pop()},follow:function(){var a=new e;a._prevActor=this;if(this.status)k(this._resultCache,a);else{var b=this._lastDoneQueue.pop();b&&this._lastDoneQueue.push(function(){return k(b.apply(this,arguments),
a)});var c=this._lastFailQueue.pop();c&&this._lastFailQueue.push(function(){return k(c.apply(this,arguments),a)})}return a},end:function(){return this._prevActor},all:function(){return g.apply(this,this._when)},any:function(){var a=g.apply(this,this._when);a._count=a._total=1;return a},some:function(a){var b=g.apply(this,this._when);b._count=b._total=a;return b}},i={},d;for(d in m)i[d]=q(d);d=l.prototype=i;d.once=d.wait=d.then;d.on=d.bind;d.off=d.unbind;d.promise=function(a){var b=this.lib[a];b||
(b=this.lib[a]=new e({subject:a,trace:this.trace,traceStack:this.traceStack}));return b};d.when=function(){for(var a=[],b=0,c=arguments.length;b<c;b++)a.push(this.promise(arguments[b]));return g.apply(this,a)};f.Promise=e;f.Event=l;f.when=g;f.pipe=k;f.VERSION="2.0.0";return f});
