/**
 * Backbone-relational.js 0.7.0
 * (c) 2011-2013 Paul Uithol
 * 
 * Backbone-relational may be freely distributed under the MIT license; see the accompanying LICENSE.txt.
 * For details and documentation: https://github.com/PaulUithol/Backbone-relational.
 * Depends on Backbone (and thus on Underscore as well): https://github.com/documentcloud/backbone.
 */
(function(a){"use strict";var b,c,d;"undefined"==typeof window?(b=require("underscore"),c=require("backbone"),d=module.exports=c):(b=window._,c=window.Backbone,d=window),c.Relational={showWarnings:!0},c.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw Error("Max permits acquired");this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(a){if(this._permitsUsed>a)throw Error("Available permits cannot be less than used permits");this._permitsAvailable=a}},c.BlockingQueue=function(){this._queue=[]},b.extend(c.BlockingQueue.prototype,c.Semaphore,{_queue:null,add:function(a){this.isBlocked()?this._queue.push(a):a()},process:function(){for(;this._queue&&this._queue.length;)this._queue.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),c.Relational.eventQueue=new c.BlockingQueue,c.Store=function(){this._collections=[],this._reverseRelations=[],this._subModels=[],this._modelScopes=[d]},b.extend(c.Store.prototype,c.Events,{addModelScope:function(a){this._modelScopes.push(a)},addSubModels:function(a,b){this._subModels.push({superModelType:b,subModels:a})},setupSuperModel:function(c){b.find(this._subModels||[],function(d){return b.find(d.subModels||[],function(b,e){var f=this.getObjectByName(b);return c===f?(d.superModelType._subModels[e]=c,c._superModel=d.superModelType,c._subModelTypeValue=e,c._subModelTypeAttribute=d.superModelType.prototype.subModelTypeAttribute,!0):a},this)},this)},addReverseRelation:function(a){var c=b.any(this._reverseRelations||[],function(c){return b.all(a||[],function(a,b){return a===c[b]})});if(!c&&a.model&&a.type){this._reverseRelations.push(a);var d=function(a,c){a.prototype.relations||(a.prototype.relations=[]),a.prototype.relations.push(c),b.each(a._subModels||[],function(a){d(a,c)},this)};d(a.model,a),this.retroFitRelation(a)}},retroFitRelation:function(a){var b=this.getCollection(a.model);b.each(function(b){b instanceof a.model&&new a.type(b,a)},this)},getCollection:function(a){a instanceof c.RelationalModel&&(a=a.constructor);for(var d=a;d._superModel;)d=d._superModel;var e=b.detect(this._collections,function(a){return a.model===d});return e||(e=this._createCollection(d)),e},getObjectByName:function(c){var d=c.split("."),e=null;return b.find(this._modelScopes||[],function(c){return e=b.reduce(d||[],function(b,c){return b?b[c]:a},c),e&&e!==c?!0:a},this),e},_createCollection:function(a){var b;return a instanceof c.RelationalModel&&(a=a.constructor),a.prototype instanceof c.RelationalModel&&(b=new c.Collection,b.model=a,this._collections.push(b)),b},resolveIdForItem:function(a,d){var e=b.isString(d)||b.isNumber(d)?d:null;return null===e&&(d instanceof c.RelationalModel?e=d.id:b.isObject(d)&&(e=d[a.prototype.idAttribute])),e||0===e||(e=null),e},find:function(a,b){var c=this.resolveIdForItem(a,b),d=this.getCollection(a);if(d){var e=d.get(c);if(e instanceof a)return e}return null},register:function(a){var b=this.getCollection(a);if(b){if(b.get(a))throw Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!");var c=a.collection;b.add(a),a.bind("destroy",this.unregister,this),a.collection=c}},update:function(a){var b=this.getCollection(a);b._onModelEvent("change:"+a.idAttribute,a,b)},unregister:function(a){a.unbind("destroy",this.unregister);var b=this.getCollection(a);b&&b.remove(a)}}),c.Relational.store=new c.Store,c.Relation=function(a,d){if(this.instance=a,d=b.isObject(d)?d:{},this.reverseRelation=b.defaults(d.reverseRelation||{},this.options.reverseRelation),this.reverseRelation.type=b.isString(this.reverseRelation.type)?c[this.reverseRelation.type]||c.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.model=d.model||this.instance.constructor,this.options=b.defaults(d,this.options,c.Relation.prototype.options),this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.relatedModel=this.options.relatedModel,b.isString(this.relatedModel)&&(this.relatedModel=c.Relational.store.getObjectByName(this.relatedModel)),this.checkPreconditions()){if(a){var e=this.keySource;e!==this.key&&"object"==typeof this.instance.get(this.key)&&(e=this.key),this.keyContents=this.instance.get(e),this.keySource!==this.key&&this.instance.unset(this.keySource,{silent:!0}),this.instance._relations.push(this)}!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&c.Relational.store.addReverseRelation(b.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),b.bindAll(this,"_modelRemovedFromCollection","_relatedModelAdded","_relatedModelRemoved"),a&&(this.initialize(),d.autoFetch&&this.instance.fetchRelated(d.key,b.isObject(d.autoFetch)?d.autoFetch:{}),c.Relational.store.getCollection(this.instance).bind("relational:remove",this._modelRemovedFromCollection),c.Relational.store.getCollection(this.relatedModel).bind("relational:add",this._relatedModelAdded).bind("relational:remove",this._relatedModelRemoved))}},c.Relation.extend=c.Model.extend,b.extend(c.Relation.prototype,c.Events,c.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1},instance:null,key:null,keyContents:null,relatedModel:null,reverseRelation:null,related:null,_relatedModelAdded:function(a,b,c){var d=this;a.queue(function(){d.tryAddRelated(a,c)})},_relatedModelRemoved:function(a,b,c){this.removeRelated(a,c)},_modelRemovedFromCollection:function(a){a===this.instance&&this.destroy()},checkPreconditions:function(){var a=this.instance,d=this.key,e=this.model,f=this.relatedModel,g=c.Relational.showWarnings&&"undefined"!=typeof console;if(!e||!d||!f)return g&&console.warn("Relation=%o; no model, key or relatedModel (%o, %o, %o)",this,e,d,f),!1;if(!(e.prototype instanceof c.RelationalModel))return g&&console.warn("Relation=%o; model does not inherit from Backbone.RelationalModel (%o)",this,a),!1;if(!(f.prototype instanceof c.RelationalModel))return g&&console.warn("Relation=%o; relatedModel does not inherit from Backbone.RelationalModel (%o)",this,f),!1;if(this instanceof c.HasMany&&this.reverseRelation.type===c.HasMany)return g&&console.warn("Relation=%o; relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(a&&a._relations.length){var h=b.any(a._relations||[],function(a){var b=this.reverseRelation.key&&a.reverseRelation.key;return a.relatedModel===f&&a.key===d&&(!b||this.reverseRelation.key===a.reverseRelation.key)},this);if(h)return g&&console.warn("Relation=%o between instance=%o.%s and relatedModel=%o.%s already exists",this,a,d,f,this.reverseRelation.key),!1}return!0},setRelated:function(a,c){this.related=a,this.instance.acquire(),this.instance.set(this.key,a,b.defaults(c||{},{silent:!0})),this.instance.release()},_isReverseRelation:function(a){return a.instance instanceof this.relatedModel&&this.reverseRelation.key===a.key&&this.key===a.reverseRelation.key?!0:!1},getReverseRelations:function(a){var c=[],d=b.isUndefined(a)?this.related&&(this.related.models||[this.related]):[a];return b.each(d||[],function(a){b.each(a.getRelations()||[],function(a){this._isReverseRelation(a)&&c.push(a)},this)},this),c},sanitizeOptions:function(a){return a=a?b.clone(a):{},a.silent&&(a.silentChange=!0,delete a.silent),a},unsanitizeOptions:function(a){return a=a?b.clone(a):{},a.silentChange&&(a.silent=!0,delete a.silentChange),a},destroy:function(){c.Relational.store.getCollection(this.instance).unbind("relational:remove",this._modelRemovedFromCollection),c.Relational.store.getCollection(this.relatedModel).unbind("relational:add",this._relatedModelAdded).unbind("relational:remove",this._relatedModelRemoved),b.each(this.getReverseRelations()||[],function(a){a.removeRelated(this.instance)},this)}}),c.HasOne=c.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(){b.bindAll(this,"onChange"),this.instance.bind("relational:change:"+this.key,this.onChange);var a=this.findRelated({silent:!0});this.setRelated(a),b.each(this.getReverseRelations()||[],function(a){a.addRelated(this.instance)},this)},findRelated:function(){var b=this.keyContents,c=null;return b instanceof this.relatedModel?c=b:(b||0===b)&&(c=this.relatedModel.findOrCreate(b,{create:this.options.createModels})),c},onChange:function(a,d,e){if(!this.isLocked()){this.acquire(),e=this.sanitizeOptions(e);var f=b.isUndefined(e._related),g=f?this.related:e._related;if(f)if(this.keyContents=d,d instanceof this.relatedModel)this.related=d;else if(d){var h=this.findRelated(e);this.setRelated(h)}else this.setRelated(null);if(g&&this.related!==g&&b.each(this.getReverseRelations(g)||[],function(a){a.removeRelated(this.instance,e)},this),b.each(this.getReverseRelations()||[],function(a){a.addRelated(this.instance,e)},this),!e.silentChange&&this.related!==g){var i=this;c.Relational.eventQueue.add(function(){i.instance.trigger("update:"+i.key,i.instance,i.related,e)})}this.release()}},tryAddRelated:function(a,d){if(!this.related){d=this.sanitizeOptions(d);var e=this.keyContents;if(e||0===e){var f=c.Relational.store.resolveIdForItem(this.relatedModel,e);b.isNull(f)||a.id!==f||this.addRelated(a,d)}}},addRelated:function(a){if(a!==this.related){var c=this.related||null;this.setRelated(a),this.onChange(this.instance,a,{_related:c})}},removeRelated:function(a){if(this.related&&a===this.related){var c=this.related||null;this.setRelated(null),this.onChange(this.instance,a,{_related:c})}}}),c.HasMany=c.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:c.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(){if(b.bindAll(this,"onChange","handleAddition","handleRemoval","handleReset"),this.instance.bind("relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,b.isString(this.collectionType)&&(this.collectionType=c.Relational.store.getObjectByName(this.collectionType)),!this.collectionType.prototype instanceof c.Collection)throw Error("collectionType must inherit from Backbone.Collection");this.keyContents instanceof c.Collection?this.setRelated(this._prepareCollection(this.keyContents)):this.setRelated(this._prepareCollection()),this.findRelated({silent:!0})},_getCollectionOptions:function(){return b.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions},_prepareCollection:function(a){if(this.related&&this.related.unbind("relational:add",this.handleAddition).unbind("relational:remove",this.handleRemoval).unbind("relational:reset",this.handleReset),a&&a instanceof c.Collection||(a=new this.collectionType([],this._getCollectionOptions())),a.model=this.relatedModel,this.options.collectionKey){var b=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;a[b]&&a[b]!==this.instance?c.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,b,this.options.collectionKey):b&&(a[b]=this.instance)}return a.bind("relational:add",this.handleAddition).bind("relational:remove",this.handleRemoval).bind("relational:reset",this.handleReset),a},findRelated:function(a){if(this.keyContents){var d=[];this.keyContents instanceof c.Collection?d=this.keyContents.models:(this.keyContents=b.isArray(this.keyContents)?this.keyContents:[this.keyContents],b.each(this.keyContents||[],function(a){var b=null;a instanceof this.relatedModel?b=a:(a||0===a)&&(b=this.relatedModel.findOrCreate(a,{create:this.options.createModels})),b&&!this.related.get(b)&&d.push(b)},this)),d.length&&(a=this.unsanitizeOptions(a),this.related.add(d,a))}},onChange:function(d,e,f){if(f=this.sanitizeOptions(f),this.keyContents=e,e instanceof c.Collection)this._prepareCollection(e),this.related=e;else{var g={},h={};b.isArray(e)||e===a||(e=[e]),b.each(e,function(a){h[a.id]=!0});var i=this.related;i instanceof c.Collection?b.each(i.models.slice(0),function(a){f.keepNewModels&&a.isNew()||(g[a.id]=!0,i.remove(a,{silent:a.id in h}))}):i=this._prepareCollection(),b.each(e,function(a){var b=this.relatedModel.findOrCreate(a,{create:this.options.createModels});b&&i.add(b,{silent:a.id in g})},this),this.setRelated(i)}var j=this;c.Relational.eventQueue.add(function(){!f.silentChange&&j.instance.trigger("update:"+j.key,j.instance,j.related,f)})},tryAddRelated:function(a,d){if(d=this.sanitizeOptions(d),!this.related.get(a)){var e=b.any(this.keyContents||[],function(d){var e=c.Relational.store.resolveIdForItem(this.relatedModel,d);return!b.isNull(e)&&e===a.id},this);e&&this.related.add(a,d)}},handleAddition:function(a,d,e){if(a instanceof c.Model){e=this.sanitizeOptions(e),b.each(this.getReverseRelations(a)||[],function(a){a.addRelated(this.instance,e)},this);var f=this;c.Relational.eventQueue.add(function(){!e.silentChange&&f.instance.trigger("add:"+f.key,a,f.related,e)})}},handleRemoval:function(a,d,e){if(a instanceof c.Model){e=this.sanitizeOptions(e),b.each(this.getReverseRelations(a)||[],function(a){a.removeRelated(this.instance,e)},this);var f=this;c.Relational.eventQueue.add(function(){!e.silentChange&&f.instance.trigger("remove:"+f.key,a,f.related,e)})}},handleReset:function(a,b){b=this.sanitizeOptions(b);var d=this;c.Relational.eventQueue.add(function(){!b.silentChange&&d.instance.trigger("reset:"+d.key,d.related,b)})},addRelated:function(a,b){var c=this;b=this.unsanitizeOptions(b),a.queue(function(){c.related&&!c.related.get(a)&&c.related.add(a,b)})},removeRelated:function(a,b){b=this.unsanitizeOptions(b),this.related.get(a)&&this.related.remove(a,b)}}),c.RelationalModel=c.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(a,d){var e=this;if(d&&d.collection){this._deferProcessing=!0;var f=function(a){a===e&&(e._deferProcessing=!1,e.processQueue(),d.collection.unbind("relational:add",f))};d.collection.bind("relational:add",f),b.defer(function(){f(e)})}this._queue=new c.BlockingQueue,this._queue.block(),c.Relational.eventQueue.block(),c.Model.apply(this,arguments),c.Relational.eventQueue.unblock()},trigger:function(a){if(a.length>5&&"change"===a.substr(0,6)){var b=this,d=arguments;c.Relational.eventQueue.add(function(){c.Model.prototype.trigger.apply(b,d)})}else c.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(){this.acquire(),this._relations=[],b.each(this.relations||[],function(a){var d=b.isString(a.type)?c[a.type]||c.Relational.store.getObjectByName(a.type):a.type;d&&d.prototype instanceof c.Relation?new d(this,a):c.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; missing or invalid type!",a)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(a){this._isInitialized&&!this.isLocked()&&b.each(this._relations||[],function(b){var c=this.attributes[b.keySource]||this.attributes[b.key];b.related!==c&&this.trigger("relational:change:"+b.key,this,c,a||{})},this)},queue:function(a){this._queue.add(a)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(c){return b.detect(this._relations,function(b){return b.key===c?!0:a},this)},getRelations:function(){return this._relations},fetchRelated:function(a,d,e){d||(d={});var f,g=[],h=this.getRelation(a),i=h&&h.keyContents,j=i&&b.select(b.isArray(i)?i:[i],function(a){var d=c.Relational.store.resolveIdForItem(h.relatedModel,a);return!b.isNull(d)&&(e||!c.Relational.store.find(h.relatedModel,d))},this);if(j&&j.length){var k=b.map(j,function(a){var c;if(b.isObject(a))c=h.relatedModel.findOrCreate(a);else{var d={};d[h.relatedModel.prototype.idAttribute]=a,c=h.relatedModel.findOrCreate(d)}return c},this);if(h.related instanceof c.Collection&&b.isFunction(h.related.url)&&(f=h.related.url(k)),f&&f!==h.related.url()){var l=b.defaults({error:function(){var a=arguments;b.each(k||[],function(b){b.trigger("destroy",b,b.collection,d),d.error&&d.error.apply(b,a)})},url:f},d,{add:!0});g=[h.related.fetch(l)]}else g=b.map(k||[],function(a){var c=b.defaults({error:function(){a.trigger("destroy",a,a.collection,d),d.error&&d.error.apply(a,arguments)}},d);return a.fetch(c)},this)}return g},set:function(a,d,e){c.Relational.eventQueue.block();var f;b.isObject(a)||null==a?(f=a,e=d):(f={},f[a]=d);var g=c.Model.prototype.set.apply(this,arguments);return this._isInitialized||this.isLocked()?f&&this.idAttribute in f&&c.Relational.store.update(this):(this.constructor.initializeModelHierarchy(),c.Relational.store.register(this),this.initializeRelations()),f&&this.updateRelations(e),c.Relational.eventQueue.unblock(),g},unset:function(a,b){c.Relational.eventQueue.block();var d=c.Model.prototype.unset.apply(this,arguments);return this.updateRelations(b),c.Relational.eventQueue.unblock(),d},clear:function(a){c.Relational.eventQueue.block();var b=c.Model.prototype.clear.apply(this,arguments);return this.updateRelations(a),c.Relational.eventQueue.unblock(),b},change:function(){var b=this,d=arguments;c.Relational.eventQueue.add(function(){c.Model.prototype.change.apply(b,d)})},clone:function(){var a=b.clone(this.attributes);return b.isUndefined(a[this.idAttribute])||(a[this.idAttribute]=null),b.each(this.getRelations()||[],function(b){delete a[b.key]}),new this.constructor(a)},toJSON:function(a){if(this.isLocked())return this.id;this.acquire();var d=c.Model.prototype.toJSON.call(this,a);return!this.constructor._superModel||this.constructor._subModelTypeAttribute in d||(d[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),b.each(this._relations||[],function(e){var f=d[e.key];if(e.options.includeInJSON===!0)d[e.keyDestination]=f&&b.isFunction(f.toJSON)?f.toJSON(a):null;else if(b.isString(e.options.includeInJSON))d[e.keyDestination]=f instanceof c.Collection?f.pluck(e.options.includeInJSON):f instanceof c.Model?f.get(e.options.includeInJSON):null;else if(b.isArray(e.options.includeInJSON))if(f instanceof c.Collection){var g=[];f.each(function(a){var c={};b.each(e.options.includeInJSON,function(b){c[b]=a.get(b)}),g.push(c)}),d[e.keyDestination]=g}else if(f instanceof c.Model){var g={};b.each(e.options.includeInJSON,function(a){g[a]=f.get(a)}),d[e.keyDestination]=g}else d[e.keyDestination]=null;else delete d[e.key];e.keyDestination!==e.key&&delete d[e.key]}),this.release(),d}},{setup:function(){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?c.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,b.each(this.prototype.relations||[],function(a){if(a.model||(a.model=this),a.reverseRelation&&a.model===this){var d=!0;if(b.isString(a.relatedModel)){var e=c.Relational.store.getObjectByName(a.relatedModel);d=e&&e.prototype instanceof c.RelationalModel}var f=b.isString(a.type)?c[a.type]||c.Relational.store.getObjectByName(a.type):a.type;d&&f&&f.prototype instanceof c.Relation&&new f(null,a)}},this),this},build:function(a,b){var c=this;if(this.initializeModelHierarchy(),this._subModels&&this.prototype.subModelTypeAttribute in a){var d=a[this.prototype.subModelTypeAttribute],e=this._subModels[d];e&&(c=e)}return new c(a,b)},initializeModelHierarchy:function(){if(b.isUndefined(this._superModel)||b.isNull(this._superModel))if(c.Relational.store.setupSuperModel(this),this._superModel){if(this._superModel.prototype.relations){var a=b.any(this.prototype.relations||[],function(a){return a.model&&a.model!==this},this);a||(this.prototype.relations=this._superModel.prototype.relations.concat(this.prototype.relations))}}else this._superModel=!1;this.prototype.subModelTypes&&b.keys(this.prototype.subModelTypes).length!==b.keys(this._subModels).length&&b.each(this.prototype.subModelTypes||[],function(a){var b=c.Relational.store.getObjectByName(a);b&&b.initializeModelHierarchy()})},findOrCreate:function(a,d){d||(d={});var e=b.isObject(a)&&this.prototype.parse?this.prototype.parse(a):a,f=c.Relational.store.find(this,e);return b.isObject(a)&&(f&&d.update!==!1?f.set(e,d):f||d.create===!1||(f=this.build(a,d))),f}}),b.extend(c.RelationalModel.prototype,c.Semaphore),c.Collection.prototype.__prepareModel=c.Collection.prototype._prepareModel,c.Collection.prototype._prepareModel=function(b,d){var e;return b instanceof c.Model?(b.collection||(b.collection=this),e=b):(d||(d={}),d.collection=this,e=this.model.findOrCreate!==a?this.model.findOrCreate(b,d):new this.model(b,d),e._validate(b,d)||(e=!1)),e};var e=c.Collection.prototype.__add=c.Collection.prototype.add;c.Collection.prototype.add=function(a,d){d||(d={}),b.isArray(a)||(a=[a]);var f=[];return b.each(a||[],function(a){a instanceof c.Model||(a=c.Collection.prototype._prepareModel.call(this,a,d)),a instanceof c.Model&&!this.get(a)&&f.push(a)},this),f.length&&(e.call(this,f,d),b.each(f||[],function(a){this.trigger("relational:add",a,this,d)},this)),this};var f=c.Collection.prototype.__remove=c.Collection.prototype.remove;c.Collection.prototype.remove=function(a,d){return d||(d={}),a=b.isArray(a)?a.slice(0):[a],b.each(a||[],function(a){a=this.get(a),a instanceof c.Model&&(f.call(this,a,d),this.trigger("relational:remove",a,this,d))},this),this};var g=c.Collection.prototype.__reset=c.Collection.prototype.reset;c.Collection.prototype.reset=function(a,b){return g.call(this,a,b),this.trigger("relational:reset",this,b),this};var h=c.Collection.prototype.__sort=c.Collection.prototype.sort;c.Collection.prototype.sort=function(a){return h.call(this,a),this.trigger("relational:reset",this,a),this};var i=c.Collection.prototype.__trigger=c.Collection.prototype.trigger;c.Collection.prototype.trigger=function(a){if("add"===a||"remove"===a||"reset"===a){var d=this,e=arguments;"add"===a&&(e=b.toArray(e),b.isObject(e[3])&&(e[3]=b.clone(e[3]))),c.Relational.eventQueue.add(function(){i.apply(d,e)})}else i.apply(this,arguments);return this},c.RelationalModel.extend=function(){var d=c.Model.extend.apply(this,arguments);return d.setup(this),d}})();