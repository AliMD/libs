window.Proj4js&&!Proj4js.util&&(Proj4js.util={}),(window.Proj4js?Proj4js.util:window).MGRS=function(){function e(e,t){return t=t||5,a(r({lat:e.lat,lon:e.lon}),t)}function t(e){var t=s(u(e.toUpperCase()));return[t.left,t.bottom,t.right,t.top]}function i(e){return e*(Math.PI/180)}function n(e){return 180*(e/Math.PI)}function r(e){var t,n,r,s,a,l,h,c,u,d=e.lat,p=e.lon,f=6378137,m=.00669438,g=.9996,y=i(d),v=i(p);u=Math.floor((p+180)/6)+1,180==p&&(u=60),d>=56&&64>d&&p>=3&&12>p&&(u=32),d>=72&&84>d&&(p>=0&&9>p?u=31:p>=9&&21>p?u=33:p>=21&&33>p?u=35:p>=33&&42>p&&(u=37)),t=6*(u-1)-180+3,c=i(t),n=m/(1-m),r=f/Math.sqrt(1-m*Math.sin(y)*Math.sin(y)),s=Math.tan(y)*Math.tan(y),a=n*Math.cos(y)*Math.cos(y),l=Math.cos(y)*(v-c),h=f*((1-m/4-3*m*m/64-5*m*m*m/256)*y-(3*m/8+3*m*m/32+45*m*m*m/1024)*Math.sin(2*y)+(15*m*m/256+45*m*m*m/1024)*Math.sin(4*y)-35*m*m*m/3072*Math.sin(6*y));var b=g*r*(l+(1-s+a)*l*l*l/6+(5-18*s+s*s+72*a-58*n)*l*l*l*l*l/120)+5e5,L=g*(h+r*Math.tan(y)*(l*l/2+(5-s+9*a+4*a*a)*l*l*l*l/24+(61-58*s+s*s+600*a-330*n)*l*l*l*l*l*l/720));return 0>d&&(L+=1e7),{northing:Math.round(L),easting:Math.round(b),zoneNumber:u,zoneLetter:o(d)}}function s(e){var t=e.northing,i=e.easting,r=e.zoneLetter,o=e.zoneNumber;if(0>o||o>60)return null;var a,l,h,c,u,d,p,f,m,g,y=.9996,v=6378137,b=.00669438,L=(1-Math.sqrt(1-b))/(1+Math.sqrt(1-b)),x=i-5e5,C=t;"S"==r&&(C-=1e7),f=6*(o-1)-180+3,a=b/(1-b),p=C/y,m=p/(v*(1-b/4-3*b*b/64-5*b*b*b/256)),g=m+(3*L/2-27*L*L*L/32)*Math.sin(2*m)+(21*L*L/16-55*L*L*L*L/32)*Math.sin(4*m)+151*L*L*L/96*Math.sin(6*m),l=v/Math.sqrt(1-b*Math.sin(g)*Math.sin(g)),h=Math.tan(g)*Math.tan(g),c=a*Math.cos(g)*Math.cos(g),u=v*(1-b)/Math.pow(1-b*Math.sin(g)*Math.sin(g),1.5),d=x/(l*y);var w=g-l*Math.tan(g)/u*(d*d/2-(5+3*h+10*c-4*c*c-9*a)*d*d*d*d/24+(61+90*h+298*c+45*h*h-252*a-3*c*c)*d*d*d*d*d*d/720);w=n(w);var S=(d-(1+2*h+c)*d*d*d/6+(5-2*c+28*h-3*c*c+8*a+24*h*h)*d*d*d*d*d/120)/Math.cos(g);S=f+n(S);var O;if(e.accuracy){var _=s({northing:e.northing+e.accuracy,easting:e.easting+e.accuracy,zoneLetter:e.zoneLetter,zoneNumber:e.zoneNumber});O={top:_.lat,right:_.lon,bottom:w,left:S}}else O={lat:w,lon:S};return O}function o(e){var t="Z";return 84>=e&&e>=72?t="X":72>e&&e>=64?t="W":64>e&&e>=56?t="V":56>e&&e>=48?t="U":48>e&&e>=40?t="T":40>e&&e>=32?t="S":32>e&&e>=24?t="R":24>e&&e>=16?t="Q":16>e&&e>=8?t="P":8>e&&e>=0?t="N":0>e&&e>=-8?t="M":-8>e&&e>=-16?t="L":-16>e&&e>=-24?t="K":-24>e&&e>=-32?t="J":-32>e&&e>=-40?t="H":-40>e&&e>=-48?t="G":-48>e&&e>=-56?t="F":-56>e&&e>=-64?t="E":-64>e&&e>=-72?t="D":-72>e&&e>=-80&&(t="C"),t}function a(e,t){var i=""+e.easting,n=""+e.northing;return e.zoneNumber+e.zoneLetter+l(e.easting,e.northing,e.zoneNumber)+i.substr(i.length-5,t)+n.substr(n.length-5,t)}function l(e,t,i){var n=h(i),r=Math.floor(e/1e5),s=Math.floor(t/1e5)%20;return c(r,s,n)}function h(e){var t=e%m;return 0==t&&(t=m),t}function c(e,t,i){var n=i-1,r=g.charCodeAt(n),s=y.charCodeAt(n),o=r+e-1,a=s+t,l=!1;o>C&&(o=o-C+v-1,l=!0),(o==b||b>r&&o>b||(o>b||b>r)&&l)&&o++,(o==L||L>r&&o>L||(o>L||L>r)&&l)&&(o++,o==b&&o++),o>C&&(o=o-C+v-1),a>x?(a=a-x+v-1,l=!0):l=!1,(a==b||b>s&&a>b||(a>b||b>s)&&l)&&a++,(a==L||L>s&&a>L||(a>L||L>s)&&l)&&(a++,a==b&&a++),a>x&&(a=a-x+v-1);var h=String.fromCharCode(o)+String.fromCharCode(a);return h}function u(e){if(null==e||0==e.length)throw"MGRSPoint coverting from nothing";for(var t,i=e.length,n=null,r="",s=0;!/[A-Z]/.test(t=e.charAt(s));){if(s>=2)throw"MGRSPoint bad conversion from: "+e;r+=t,s++}var o=parseInt(r,10);if(0==s||s+3>i)throw"MGRSPoint bad conversion from: "+e;var a=e.charAt(s++);if("A">=a||"B"==a||"Y"==a||a>="Z"||"I"==a||"O"==a)throw"MGRSPoint zone letter "+a+" not handled: "+e;n=e.substring(s,s+=2);for(var l=h(o),c=d(n.charAt(0),l),u=p(n.charAt(1),l);f(a)>u;)u+=2e6;var m=i-s;if(0!=m%2)throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+e;var g=m/2,y=0,v=0;if(g>0){var b=1e5/Math.pow(10,g),L=e.substring(s,s+g);y=parseFloat(L)*b;var x=e.substring(s+g);v=parseFloat(x)*b}return easting=y+c,northing=v+u,{easting:easting,northing:northing,zoneLetter:a,zoneNumber:o,accuracy:b}}function d(e,t){for(var i=g.charCodeAt(t-1),n=1e5,r=!1;i!=e.charCodeAt(0);){if(i++,i==b&&i++,i==L&&i++,i>C){if(r)throw"Bad character: "+e;i=v,r=!0}n+=1e5}return n}function p(e,t){if(e>"V")throw"MGRSPoint given invalid Northing "+e;for(var i=y.charCodeAt(t-1),n=0,r=!1;i!=e.charCodeAt(0);){if(i++,i==b&&i++,i==L&&i++,i>x){if(r)throw"Bad character: "+e;i=v,r=!0}n+=1e5}return n}function f(e){var t;switch(e){case"C":t=11e5;break;case"D":t=2e6;break;case"E":t=28e5;break;case"F":t=37e5;break;case"G":t=46e5;break;case"H":t=55e5;break;case"J":t=64e5;break;case"K":t=73e5;break;case"L":t=82e5;break;case"M":t=91e5;break;case"N":t=0;break;case"P":t=8e5;break;case"Q":t=17e5;break;case"R":t=26e5;break;case"S":t=35e5;break;case"T":t=44e5;break;case"U":t=53e5;break;case"V":t=62e5;break;case"W":t=7e6;break;case"X":t=79e5;break;default:t=-1}if(t>=0)return t;throw"Invalid zone letter: "+e}var m=6,g="AJSAJS",y="AFAFAF",v=65,b=73,L=79,x=86,C=90;return{forward:e,inverse:t}}(),window.Proj4js&&Proj4js.Point&&(Proj4js.Point.fromMGRS=function(e){var t=Proj4js.util.MGRS.inverse(e);return new Proj4js.Point((t[2]+t[0])/2,(t[3]+t[1])/2)},Proj4js.Point.prototype.toMGRS=function(e){return Proj4js.util.MGRS.forward({lon:this.x,lat:this.y},e)});