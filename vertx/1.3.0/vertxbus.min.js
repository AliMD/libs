/*
 * Copyright 2011-2012 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var vertx=vertx||{};!function(e){typeof define=="function"&&define.amd?define("vertxbus",["sockjs"],e):e(SockJS)}(function(e){return vertx.EventBus=function(t,n){function a(e,t,n,r){l("address","string",t),l("message","object",n),l("replyHandler","function",r,!0),f();var s={type:e,address:t,body:n};if(r){var u=h();s.replyAddress=u,o[u]=r}var a=JSON.stringify(s);i.send(a)}function f(){if(u!=vertx.EventBus.OPEN)throw new Error("INVALID_STATE_ERR")}function l(e,t,n,r){if(!r&&!n)throw new Error("Parameter "+e+" must be specified");if(n&&typeof n!=t)throw new Error("Parameter "+e+" must be of type "+t)}function c(e){return!!(e&&e.constructor&&e.call&&e.apply)}function h(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e,t){return t=Math.random()*16,(e=="y"?t&3|8:t|0).toString(16)})}var r=this,i=new e(t,n),s={},o={},u=vertx.EventBus.CONNECTING;r.onopen=null,r.onclose=null,r.send=function(e,t,n){a("send",e,t,n)},r.publish=function(e,t,n){a("publish",e,t,n)},r.registerHandler=function(e,t){l("address","string",e),l("handler","function",t),f();var n=s[e];if(!n){n=[t],s[e]=n;var r={type:"register",address:e};i.send(JSON.stringify(r))}else n[n.length]=t},r.unregisterHandler=function(e,t){l("address","string",e),l("handler","function",t),f();var n=s[e];if(n){var r=n.indexOf(t);r!=-1&&n.splice(r,1);if(n.length==0){var o={type:"unregister",address:e};i.send(JSON.stringify(o)),delete s[e]}}},r.close=function(){f(),u=vertx.EventBus.CLOSING,i.close()},r.readyState=function(){return u},i.onopen=function(){u=vertx.EventBus.OPEN,r.onopen&&r.onopen()},i.onclose=function(){u=vertx.EventBus.CLOSED,r.onclose&&r.onclose()},i.onmessage=function(e){var t=e.data,n=JSON.parse(t),i=n.body,u=n.replyAddress,a=n.address,f;u&&(f=function(e,t){r.send(u,e,t)});var l=s[a];if(l){var c=l.slice(0);for(var h=0;h<c.length;h++)c[h](i,f)}else{var p=o[a];p&&(delete o[u],p(i,f))}}},vertx.EventBus.CONNECTING=0,vertx.EventBus.OPEN=1,vertx.EventBus.CLOSING=2,vertx.EventBus.CLOSED=3,vertx.EventBus});