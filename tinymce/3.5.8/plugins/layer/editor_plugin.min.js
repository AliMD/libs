(function(){function e(e){do if(e.className&&-1!=e.className.indexOf("mceItemLayer"))return e;while(e=e.parentNode)}tinymce.create("tinymce.plugins.Layer",{init:function(t){var i=this;i.editor=t,t.addCommand("mceInsertLayer",i._insertLayer,i),t.addCommand("mceMoveForward",function(){i._move(1)}),t.addCommand("mceMoveBackward",function(){i._move(-1)}),t.addCommand("mceMakeAbsolute",function(){i._toggleAbsolute()}),t.addButton("moveforward",{title:"layer.forward_desc",cmd:"mceMoveForward"}),t.addButton("movebackward",{title:"layer.backward_desc",cmd:"mceMoveBackward"}),t.addButton("absolute",{title:"layer.absolute_desc",cmd:"mceMakeAbsolute"}),t.addButton("insertlayer",{title:"layer.insertlayer_desc",cmd:"mceInsertLayer"}),t.onInit.add(function(){t.dom,tinymce.isIE&&t.getDoc().execCommand("2D-Position",!1,!0)}),t.onMouseUp.add(function(t,i){var n=e(i.target);n&&t.dom.setAttrib(n,"data-mce-style","")}),t.onMouseDown.add(function(t,i){var n,r=i.target,s=t.getDoc();tinymce.isGecko&&(e(r)?"on"!==s.designMode&&(s.designMode="on",r=s.body,n=r.parentNode,n.removeChild(r),n.appendChild(r)):"on"==s.designMode&&(s.designMode="off"))}),t.onNodeChange.add(i._nodeChange,i),t.onVisualAid.add(i._visualAid,i)},getInfo:function(){return{longname:"Layer",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/layer",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_nodeChange:function(e,t,i){var n,r;n=this._getParentLayer(i),r=e.dom.getParent(i,"DIV,P,IMG"),r?(t.setDisabled("absolute",0),t.setDisabled("moveforward",!n),t.setDisabled("movebackward",!n),t.setActive("absolute",n&&"absolute"==n.style.position.toLowerCase())):(t.setDisabled("absolute",1),t.setDisabled("moveforward",1),t.setDisabled("movebackward",1))},_visualAid:function(e,t,i){var n=e.dom;tinymce.each(n.select("div,p",t),function(e){/^(absolute|relative|fixed)$/i.test(e.style.position)&&(i?n.addClass(e,"mceItemVisualAid"):n.removeClass(e,"mceItemVisualAid"),n.addClass(e,"mceItemLayer"))})},_move:function(e){var t,i,n=this.editor,r=[],s=this._getParentLayer(n.selection.getNode()),o=-1,a=-1;for(i=[],tinymce.walk(n.getBody(),function(e){1==e.nodeType&&/^(absolute|relative|static)$/i.test(e.style.position)&&i.push(e)},"childNodes"),t=0;i.length>t;t++)r[t]=i[t].style.zIndex?parseInt(i[t].style.zIndex):0,0>o&&i[t]==s&&(o=t);if(0>e){for(t=0;r.length>t;t++)if(r[t]<r[o]){a=t;break}a>-1?(i[o].style.zIndex=r[a],i[a].style.zIndex=r[o]):r[o]>0&&(i[o].style.zIndex=r[o]-1)}else{for(t=0;r.length>t;t++)if(r[t]>r[o]){a=t;break}a>-1?(i[o].style.zIndex=r[a],i[a].style.zIndex=r[o]):i[o].style.zIndex=r[o]+1}n.execCommand("mceRepaint")},_getParentLayer:function(e){return this.editor.dom.getParent(e,function(e){return 1==e.nodeType&&/^(absolute|relative|static)$/i.test(e.style.position)})},_insertLayer:function(){var e=this.editor,t=e.dom,i=t.getPos(t.getParent(e.selection.getNode(),"*")),n=e.getBody();e.dom.add(n,"div",{style:{position:"absolute",left:i.x,top:i.y>20?i.y:20,width:100,height:100},"class":"mceItemVisualAid mceItemLayer"},e.selection.getContent()||e.getLang("layer.content")),tinymce.isIE&&t.setHTML(n,n.innerHTML)},_toggleAbsolute:function(){var e=this.editor,t=this._getParentLayer(e.selection.getNode());t||(t=e.dom.getParent(e.selection.getNode(),"DIV,P,IMG")),t&&("absolute"==t.style.position.toLowerCase()?(e.dom.setStyles(t,{position:"",left:"",top:"",width:"",height:""}),e.dom.removeClass(t,"mceItemVisualAid"),e.dom.removeClass(t,"mceItemLayer")):(""==t.style.left&&(t.style.left="20px"),""==t.style.top&&(t.style.top="20px"),""==t.style.width&&(t.style.width=t.width?t.width+"px":"100px"),""==t.style.height&&(t.style.height=t.height?t.height+"px":"100px"),t.style.position="absolute",e.dom.setAttrib(t,"data-mce-style",""),e.addVisual(e.getBody())),e.execCommand("mceRepaint"),e.nodeChanged())}}),tinymce.PluginManager.add("layer",tinymce.plugins.Layer)})();