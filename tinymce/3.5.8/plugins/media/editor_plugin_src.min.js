(function(){function e(e){return"string"==typeof e?e.replace(/[^0-9%]/g,""):e}function t(e){var t,i;if(e&&!e.splice){for(t=[],i=0;!0&&e[i];i++)t[i]=e[i];return t}return e}var i,n,r=tinymce.explode("id,name,width,height,style,align,class,hspace,vspace,bgcolor,type"),s=tinymce.makeMap(r.join(",")),o=tinymce.html.Node,a=tinymce.util.JSON;i=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"]],tinymce.create("tinymce.plugins.MediaPlugin",{init:function(e,t){function s(t){return t&&"IMG"===t.nodeName&&e.dom.hasClass(t,"mceItemMedia")}var o,l,h,c,u=this,d={};for(u.editor=e,u.url=t,n="",o=0;i.length>o;o++){for(c=i[o][0],h={name:c,clsids:tinymce.explode(i[o][1]||""),mimes:tinymce.explode(i[o][2]||""),codebase:i[o][3]},l=0;h.clsids.length>l;l++)d["clsid:"+h.clsids[l]]=h;for(l=0;h.mimes.length>l;l++)d[h.mimes[l]]=h;d["mceItem"+c]=h,d[c.toLowerCase()]=h,n+=(n?"|":"")+c}tinymce.each(e.getParam("media_types","video=mp4,m4v,ogv,webm;silverlight=xap;flash=swf,flv;shockwave=dcr;quicktime=mov,qt,mpg,mpeg;shockwave=dcr;windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;realmedia=rm,ra,ram;java=jar;audio=mp3,ogg").split(";"),function(e){var t,i,n;for(e=e.split(/=/),i=tinymce.explode(e[1].toLowerCase()),t=0;i.length>t;t++)n=d[e[0].toLowerCase()],n&&(d[i[t]]=n)}),n=RegExp("write("+n+")\\(([^)]+)\\)"),u.lookup=d,e.onPreInit.add(function(){e.schema.addValidElements("object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]"),e.parser.addNodeFilter("object,embed,video,audio,script,iframe",function(e){for(var t=e.length;t--;)u.objectToImg(e[t])}),e.serializer.addNodeFilter("img",function(e,t,i){for(var n,r=e.length;r--;)n=e[r],-1!==(n.attr("class")||"").indexOf("mceItemMedia")&&u.imgToObject(n,i)})}),e.onInit.add(function(){e.theme&&e.theme.onResolveName&&e.theme.onResolveName.add(function(t,i){"img"===i.name&&e.dom.hasClass(i.node,"mceItemMedia")&&(i.name="media")}),e&&e.plugins.contextmenu&&e.plugins.contextmenu.onContextMenu.add(function(e,t,i){"IMG"===i.nodeName&&-1!==i.className.indexOf("mceItemMedia")&&t.add({title:"media.edit",icon:"media",cmd:"mceMedia"})})}),e.addCommand("mceMedia",function(){var i,n;n=e.selection.getNode(),s(n)&&(i=e.dom.getAttrib(n,"data-mce-json"),i&&(i=a.parse(i),tinymce.each(r,function(t){var r=e.dom.getAttrib(n,t);r&&(i[t]=r)}),i.type=u.getType(n.className).name.toLowerCase())),i||(i={type:"flash",video:{sources:[]},params:{}}),e.windowManager.open({file:t+"/media.htm",width:430+parseInt(e.getLang("media.delta_width",0)),height:500+parseInt(e.getLang("media.delta_height",0)),inline:1},{plugin_url:t,data:i})}),e.addButton("media",{title:"media.desc",cmd:"mceMedia"}),e.onNodeChange.add(function(e,t,i){t.setActive("media",s(i))})},convertUrl:function(e,t){var i=this,n=i.editor,r=n.settings,s=r.url_converter,o=r.url_converter_scope||i;return e?t?n.documentBaseURI.toAbsolute(e):s.call(o,e,"src","object"):e},getInfo:function(){return{longname:"Media",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media",version:tinymce.majorVersion+"."+tinymce.minorVersion}},dataToImg:function(i,n){var r,s,o,l,h=this,c=h.editor;if(c.documentBaseURI,i.params.src=h.convertUrl(i.params.src,n),s=i.video.attrs,s&&(s.src=h.convertUrl(s.src,n)),s&&(s.poster=h.convertUrl(s.poster,n)),r=t(i.video.sources))for(l=0;r.length>l;l++)r[l].src=h.convertUrl(r[l].src,n);return o=h.editor.dom.create("img",{id:i.id,style:i.style,align:i.align,hspace:i.hspace,vspace:i.vspace,src:h.editor.theme.url+"/img/trans.gif","class":"mceItemMedia mceItem"+h.getType(i.type).name,"data-mce-json":a.serialize(i,"'")}),o.width=i.width=e(i.width||("audio"==i.type?"300":"320")),o.height=i.height=e(i.height||("audio"==i.type?"32":"240")),o},dataToHtml:function(e,t){return this.editor.serializer.serialize(this.dataToImg(e,t),{forced_root_block:"",force_absolute:t})},htmlToData:function(e){var t,i,n;return n={type:"flash",video:{sources:[]},params:{}},t=this.editor.parser.parse(e),i=t.getAll("img")[0],i&&(n=a.parse(i.attr("data-mce-json")),n.type=this.getType(i.attr("class")).name.toLowerCase(),tinymce.each(r,function(e){var t=i.attr(e);t&&(n[e]=t)})),n},getType:function(e){var t,i,n;for(i=tinymce.explode(e," "),t=0;i.length>t;t++)if(n=this.lookup[i[t]])return n},imgToObject:function(i,n){function s(e,t){var i,n,r,s,o;o=E.getParam("flash_video_player_url",S.convertUrl(S.url+"/moxieplayer.swf")),o&&(i=E.documentBaseURI,p.params.src=o,E.getParam("flash_video_player_absvideourl",!0)&&(e=i.toAbsolute(e||"",!0),t=i.toAbsolute(t||"",!0)),r="",n=E.getParam("flash_video_player_flashvars",{url:"$url",poster:"$poster"}),tinymce.each(n,function(i,n){i=i.replace(/\$url/,e||""),i=i.replace(/\$poster/,t||""),i.length>0&&(r+=(r?"&":"")+n+"="+escape(i))}),r.length&&(p.params.flashvars=r),s=E.getParam("flash_video_player_params",{allowfullscreen:!0,allowscriptaccess:!0}),tinymce.each(s,function(e,t){p.params[t]=""+e}))}var l,h,c,u,d,p,f,m,g,y,v,b,x,L,w,C,S=this,E=S.editor;if(p=i.attr("data-mce-json")){if(p=a.parse(p),y=this.getType(i.attr("class")),w=i.attr("data-mce-style"),w||(w=i.attr("style"),w&&(w=E.dom.serializeStyle(E.dom.parseStyle(w,"img")))),p.width=i.attr("width")||p.width,p.height=i.attr("height")||p.height,"Iframe"===y.name){x=new o("iframe",1),tinymce.each(r,function(e){var t=i.attr(e);"class"==e&&t&&(t=t.replace(/mceItem.+ ?/g,"")),t&&t.length>0&&x.attr(e,t)});for(u in p.params)x.attr(u,p.params[u]);return x.attr({style:w,src:p.params.src}),i.replace(x),void 0}if(this.editor.settings.media_use_script)return x=new o("script",1).attr("type","text/javascript"),d=new o("#text",3),d.value="write"+y.name+"("+a.serialize(tinymce.extend(p.params,{width:i.attr("width"),height:i.attr("height")}))+");",x.append(d),i.replace(x),void 0;if("Video"===y.name&&p.video.sources[0]){for(l=new o("video",1).attr(tinymce.extend({id:i.attr("id"),width:e(i.attr("width")),height:e(i.attr("height")),style:w},p.video.attrs)),p.video.attrs&&(L=p.video.attrs.poster),m=p.video.sources=t(p.video.sources),v=0;m.length>v;v++)/\.mp4$/.test(m[v].src)&&(b=m[v].src);for(m[0].type||(l.attr("src",m[0].src),m.splice(0,1)),v=0;m.length>v;v++)f=new o("source",1).attr(m[v]),f.shortEnded=!0,l.append(f);b?(s(b,L),y=S.getType("flash")):p.params.src=""}if("Audio"===y.name&&p.video.sources[0]){for(C=new o("audio",1).attr(tinymce.extend({id:i.attr("id"),width:e(i.attr("width")),height:e(i.attr("height")),style:w},p.video.attrs)),p.video.attrs&&(L=p.video.attrs.poster),m=p.video.sources=t(p.video.sources),m[0].type||(C.attr("src",m[0].src),m.splice(0,1)),v=0;m.length>v;v++)f=new o("source",1).attr(m[v]),f.shortEnded=!0,C.append(f);p.params.src=""}if("EmbeddedAudio"===y.name){c=new o("embed",1),c.shortEnded=!0,c.attr({id:i.attr("id"),width:e(i.attr("width")),height:e(i.attr("height")),style:w,type:i.attr("type")});for(u in p.params)c.attr(u,p.params[u]);tinymce.each(r,function(e){p[e]&&"type"!=e&&c.attr(e,p[e])}),p.params.src=""}if(p.params.src){/\.flv$/i.test(p.params.src)&&s(p.params.src,""),n&&n.force_absolute&&(p.params.src=E.documentBaseURI.toAbsolute(p.params.src)),h=new o("object",1).attr({id:i.attr("id"),width:e(i.attr("width")),height:e(i.attr("height")),style:w}),tinymce.each(r,function(e){var t=p[e];"class"==e&&t&&(t=t.replace(/mceItem.+ ?/g,"")),t&&"type"!=e&&h.attr(e,t)});for(u in p.params)g=new o("param",1),g.shortEnded=!0,d=p.params[u],"src"===u&&"WindowsMedia"===y.name&&(u="url"),g.attr({name:u,value:d}),h.append(g);if(this.editor.getParam("media_strict",!0))h.attr({data:p.params.src,type:y.mimes[0]});else{h.attr({classid:"clsid:"+y.clsids[0],codebase:y.codebase}),c=new o("embed",1),c.shortEnded=!0,c.attr({id:i.attr("id"),width:e(i.attr("width")),height:e(i.attr("height")),style:w,type:y.mimes[0]});for(u in p.params)c.attr(u,p.params[u]);tinymce.each(r,function(e){p[e]&&"type"!=e&&c.attr(e,p[e])}),h.append(c)}p.object_html&&(d=new o("#text",3),d.raw=!0,d.value=p.object_html,h.append(d)),l&&l.append(h)}l&&p.video_html&&(d=new o("#text",3),d.raw=!0,d.value=p.video_html,l.append(d)),C&&p.video_html&&(d=new o("#text",3),d.raw=!0,d.value=p.video_html,C.append(d));var _=l||C||h||c;_?i.replace(_):i.remove()}},objectToImg:function(t){function i(e){return new tinymce.html.Serializer({inner:!0,validate:!1}).serialize(e)}function l(e,t){return R[(e.attr(t)||"").toLowerCase()]}function h(e){var t=e.replace(/^.*\.([^.]+)$/,"$1");return R[t.toLowerCase()||""]}var c,u,d,p,f,m,g,y,v,b,x,L,w,C,S,E,_,O,T,k,P,A,M,N,R=this.lookup,D=this.editor.settings.url_converter,I=this.editor.settings.url_converter_scope;if(t.parent){if("script"===t.name){if(t.firstChild&&(T=n.exec(t.firstChild.value)),!T)return;O=T[1],_={video:{},params:a.parse(T[2])},y=_.params.width,v=_.params.height}if(_=_||{video:{},params:{}},f=new o("img",1),f.attr({src:this.editor.theme.url+"/img/trans.gif"}),m=t.name,"video"===m||"audio"==m){d=t,c=t.getAll("object")[0],u=t.getAll("embed")[0],y=d.attr("width"),v=d.attr("height"),g=d.attr("id"),_.video={attrs:{},sources:[]},k=_.video.attrs;for(m in d.attributes.map)k[m]=d.attributes.map[m];for(S=t.attr("src"),S&&_.video.sources.push({src:D.call(I,S,"src",t.name)}),E=d.getAll("source"),x=0;E.length>x;x++)S=E[x].remove(),_.video.sources.push({src:D.call(I,S.attr("src"),"src","source"),type:S.attr("type"),media:S.attr("media")});k.poster&&(k.poster=D.call(I,k.poster,"poster",t.name))}if("object"===t.name&&(c=t,u=t.getAll("embed")[0]),"embed"===t.name&&(u=t),"iframe"===t.name&&(p=t,O="Iframe"),c){for(y=y||c.attr("width"),v=v||c.attr("height"),b=b||c.attr("style"),g=g||c.attr("id"),P=P||c.attr("hspace"),A=A||c.attr("vspace"),M=M||c.attr("align"),N=N||c.attr("bgcolor"),_.name=c.attr("name"),C=c.getAll("param"),x=0;C.length>x;x++)w=C[x],m=w.remove().attr("name"),s[m]||(_.params[m]=w.attr("value"));_.params.src=_.params.src||c.attr("data")}if(u){y=y||u.attr("width"),v=v||u.attr("height"),b=b||u.attr("style"),g=g||u.attr("id"),P=P||u.attr("hspace"),A=A||u.attr("vspace"),M=M||u.attr("align"),N=N||u.attr("bgcolor");for(m in u.attributes.map)s[m]||_.params[m]||(_.params[m]=u.attributes.map[m])}if(p){y=e(p.attr("width")),v=e(p.attr("height")),b=b||p.attr("style"),g=p.attr("id"),P=p.attr("hspace"),A=p.attr("vspace"),M=p.attr("align"),N=p.attr("bgcolor"),tinymce.each(r,function(e){f.attr(e,p.attr(e))});for(m in p.attributes.map)s[m]||_.params[m]||(_.params[m]=p.attributes.map[m])}_.params.movie&&(_.params.src=_.params.src||_.params.movie,delete _.params.movie),_.params.src&&(_.params.src=D.call(I,_.params.src,"src","object")),d&&("video"===t.name?O=R.video.name:"audio"===t.name&&(O=R.audio.name)),c&&!O&&(O=(l(c,"clsid")||l(c,"classid")||l(c,"type")||{}).name),u&&!O&&(O=(l(u,"type")||h(_.params.src)||{}).name),u&&"EmbeddedAudio"==O&&(_.params.type=u.attr("type")),t.replace(f),u&&u.remove(),c&&(L=i(c.remove()),L&&(_.object_html=L)),d&&(L=i(d.remove()),L&&(_.video_html=L)),_.hspace=P,_.vspace=A,_.align=M,_.bgcolor=N,f.attr({id:g,"class":"mceItemMedia mceItem"+(O||"Flash"),style:b,width:y||("audio"==t.name?"300":"320"),height:v||("audio"==t.name?"32":"240"),hspace:P,vspace:A,align:M,bgcolor:N,"data-mce-json":a.serialize(_,"'")})}}}),tinymce.PluginManager.add("media",tinymce.plugins.MediaPlugin)})();