(function(){var e=tinymce.each,t=tinymce.html.Node;tinymce.create("tinymce.plugins.FullPagePlugin",{init:function(e,t){var i=this;i.editor=e,e.addCommand("mceFullPageProperties",function(){e.windowManager.open({file:t+"/fullpage.htm",width:430+parseInt(e.getLang("fullpage.delta_width",0)),height:495+parseInt(e.getLang("fullpage.delta_height",0)),inline:1},{plugin_url:t,data:i._htmlToData()})}),e.addButton("fullpage",{title:"fullpage.desc",cmd:"mceFullPageProperties"}),e.onBeforeSetContent.add(i._setContent,i),e.onGetContent.add(i._getContent,i)},getInfo:function(){return{longname:"Fullpage",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/fullpage",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_htmlToData:function(){function t(e,t){var i=e.attr(t);return i||""}var i,n,r=this._parseHeader(),s={},o=this.editor;return s.fontface=o.getParam("fullpage_default_fontface",""),s.fontsize=o.getParam("fullpage_default_fontsize",""),i=r.firstChild,7==i.type&&(s.xml_pi=!0,n=/encoding="([^"]+)"/.exec(i.value),n&&(s.docencoding=n[1])),i=r.getAll("#doctype")[0],i&&(s.doctype="<!DOCTYPE"+i.value+">"),i=r.getAll("title")[0],i&&i.firstChild&&(s.metatitle=i.firstChild.value),e(r.getAll("meta"),function(e){var t,i=e.attr("name"),n=e.attr("http-equiv");i?s["meta"+i.toLowerCase()]=e.attr("content"):"Content-Type"==n&&(t=/charset\s*=\s*(.*)\s*/gi.exec(e.attr("content")),t&&(s.docencoding=t[1]))}),i=r.getAll("html")[0],i&&(s.langcode=t(i,"lang")||t(i,"xml:lang")),i=r.getAll("link")[0],i&&"stylesheet"==i.attr("rel")&&(s.stylesheet=i.attr("href")),i=r.getAll("body")[0],i&&(s.langdir=t(i,"dir"),s.style=t(i,"style"),s.visited_color=t(i,"vlink"),s.link_color=t(i,"link"),s.active_color=t(i,"alink")),s},_dataToHtml:function(i){function n(e,t,i){e.attr(t,i?i:void 0)}function r(e){o.firstChild?o.insert(e,o.firstChild):o.append(e)}var s,o,a,l,h,c=this.editor.dom;s=this._parseHeader(),o=s.getAll("head")[0],o||(l=s.getAll("html")[0],o=new t("head",1),l.firstChild?l.insert(o,l.firstChild,!0):l.append(o)),l=s.firstChild,i.xml_pi?(h='version="1.0"',i.docencoding&&(h+=' encoding="'+i.docencoding+'"'),7!=l.type&&(l=new t("xml",7),s.insert(l,s.firstChild,!0)),l.value=h):l&&7==l.type&&l.remove(),l=s.getAll("#doctype")[0],i.doctype?(l||(l=new t("#doctype",10),i.xml_pi?s.insert(l,s.firstChild):r(l)),l.value=i.doctype.substring(9,i.doctype.length-1)):l&&l.remove(),l=s.getAll("title")[0],i.metatitle&&(l||(l=new t("title",1),l.append(new t("#text",3)).value=i.metatitle,r(l))),i.docencoding&&(l=null,e(s.getAll("meta"),function(e){"Content-Type"==e.attr("http-equiv")&&(l=e)}),l||(l=new t("meta",1),l.attr("http-equiv","Content-Type"),l.shortEnded=!0,r(l)),l.attr("content","text/html; charset="+i.docencoding)),e("keywords,description,author,copyright,robots".split(","),function(e){var n,o,a=s.getAll("meta"),h=i["meta"+e];for(n=0;a.length>n;n++)if(o=a[n],o.attr("name")==e)return h?o.attr("content",h):o.remove(),void 0;h&&(l=new t("meta",1),l.attr("name",e),l.attr("content",h),l.shortEnded=!0,r(l))}),l=s.getAll("link")[0],l&&"stylesheet"==l.attr("rel")?i.stylesheet?l.attr("href",i.stylesheet):l.remove():i.stylesheet&&(l=new t("link",1),l.attr({rel:"stylesheet",text:"text/css",href:i.stylesheet}),l.shortEnded=!0,r(l)),l=s.getAll("body")[0],l&&(n(l,"dir",i.langdir),n(l,"style",i.style),n(l,"vlink",i.visited_color),n(l,"link",i.link_color),n(l,"alink",i.active_color),c.setAttribs(this.editor.getBody(),{style:i.style,dir:i.dir,vLink:i.visited_color,link:i.link_color,aLink:i.active_color})),l=s.getAll("html")[0],l&&(n(l,"lang",i.langcode),n(l,"xml:lang",i.langcode)),a=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(s),this.head=a.substring(0,a.indexOf("</body>"))},_parseHeader:function(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(this.head)},_setContent:function(t,i){function n(e){return e.replace(/<\/?[A-Z]+/g,function(e){return e.toLowerCase()})}var r,s,o,a,l=this,h=i.content,c="",u=l.editor.dom;"raw"==i.format&&l.head||i.source_view&&t.getParam("fullpage_hide_in_source_view")||(h=h.replace(/<(\/?)BODY/gi,"<$1body"),r=h.indexOf("<body"),-1!=r?(r=h.indexOf(">",r),l.head=n(h.substring(0,r+1)),s=h.indexOf("</body",r),-1==s&&(s=h.length),i.content=h.substring(r+1,s),l.foot=n(h.substring(s))):(l.head=this._getDefaultHeader(),l.foot="\n</body>\n</html>"),o=l._parseHeader(),e(o.getAll("style"),function(e){e.firstChild&&(c+=e.firstChild.value)}),a=o.getAll("body")[0],a&&u.setAttribs(l.editor.getBody(),{style:a.attr("style")||"",dir:a.attr("dir")||"",vLink:a.attr("vlink")||"",link:a.attr("link")||"",aLink:a.attr("alink")||""}),u.remove("fullpage_styles"),c&&(u.add(l.editor.getDoc().getElementsByTagName("head")[0],"style",{id:"fullpage_styles"},c),a=u.get("fullpage_styles"),a.styleSheet&&(a.styleSheet.cssText=c)))},_getDefaultHeader:function(){var e,t="",i=this.editor,n="";return i.getParam("fullpage_default_xml_pi")&&(t+='<?xml version="1.0" encoding="'+i.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),t+=i.getParam("fullpage_default_doctype",'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">'),t+="\n<html>\n<head>\n",(e=i.getParam("fullpage_default_title"))&&(t+="<title>"+e+"</title>\n"),(e=i.getParam("fullpage_default_encoding"))&&(t+='<meta http-equiv="Content-Type" content="text/html; charset='+e+'" />\n'),(e=i.getParam("fullpage_default_font_family"))&&(n+="font-family: "+e+";"),(e=i.getParam("fullpage_default_font_size"))&&(n+="font-size: "+e+";"),(e=i.getParam("fullpage_default_text_color"))&&(n+="color: "+e+";"),t+="</head>\n<body"+(n?' style="'+n+'"':"")+">\n"},_getContent:function(e,t){var i=this;t.source_view&&e.getParam("fullpage_hide_in_source_view")||(t.content=tinymce.trim(i.head)+"\n"+tinymce.trim(t.content)+"\n"+tinymce.trim(i.foot))}}),tinymce.PluginManager.add("fullpage",tinymce.plugins.FullPagePlugin)})();