(function(){var e=tinymce.util.JSONRequest,t=tinymce.each,i=tinymce.DOM;tinymce.create("tinymce.plugins.SpellcheckerPlugin",{getInfo:function(){return{longname:"Spellchecker",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/spellchecker",version:tinymce.majorVersion+"."+tinymce.minorVersion}},init:function(e,i){var n=this;if(n.url=i,n.editor=e,n.rpcUrl=e.getParam("spellchecker_rpc_url","{backend}"),"{backend}"==n.rpcUrl){if(tinymce.isIE)return;n.hasSupport=!0,e.onContextMenu.addToTop(function(){return n.active?!1:void 0})}e.addCommand("mceSpellCheck",function(){return"{backend}"==n.rpcUrl?(n.editor.getBody().spellcheck=n.active=!n.active,void 0):(n.active?n._done():(e.setProgressState(1),n._sendRPC("checkWords",[n.selectedLang,n._getWords()],function(t){t.length>0?(n.active=1,n._markWords(t),e.setProgressState(0),e.nodeChanged()):(e.setProgressState(0),e.getParam("spellchecker_report_no_misspellings",!0)&&e.windowManager.alert("spellchecker.no_mpell"))})),void 0)}),e.settings.content_css!==!1&&e.contentCSS.push(i+"/css/content.css"),e.onClick.add(n._showMenu,n),e.onContextMenu.add(n._showMenu,n),e.onBeforeGetContent.add(function(){n.active&&n._removeWords()}),e.onNodeChange.add(function(e,t){t.setActive("spellchecker",n.active)}),e.onSetContent.add(function(){n._done()}),e.onBeforeGetContent.add(function(){n._done()}),e.onBeforeExecCommand.add(function(e,t){"mceFullScreen"==t&&n._done()}),n.languages={},t(e.getParam("spellchecker_languages","+English=en,Danish=da,Dutch=nl,Finnish=fi,French=fr,German=de,Italian=it,Polish=pl,Portuguese=pt,Spanish=es,Swedish=sv","hash"),function(e,t){0===t.indexOf("+")&&(t=t.substring(1),n.selectedLang=e),n.languages[t]=e})},createControl:function(e,i){var n,r=this;return r.editor,"spellchecker"==e?"{backend}"==r.rpcUrl?(r.hasSupport&&(n=i.createButton(e,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:r})),n):(n=i.createSplitButton(e,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:r}),n.onRenderMenu.add(function(e,i){i.add({title:"spellchecker.langs","class":"mceMenuItemTitle"}).setDisabled(1),t(r.languages,function(e,t){var n,s={icon:1};s.onclick=function(){e!=r.selectedLang&&(n.setSelected(1),r.selectedItem.setSelected(0),r.selectedItem=n,r.selectedLang=e)},s.title=t,n=i.add(s),n.setSelected(e==r.selectedLang),e==r.selectedLang&&(r.selectedItem=n)})}),n):void 0},_walk:function(e,t){var i,n=this.editor.getDoc();if(n.createTreeWalker)for(i=n.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);null!=(e=i.nextNode());)t.call(this,e);else tinymce.walk(e,t,"childNodes")},_getSeparators:function(){var e,t="",i=this.editor.getParam("spellchecker_word_separator_chars",'\\s!"#$%&()*+,-./:;<=>?@[]^_{|}����������������”“');for(e=0;i.length>e;e++)t+="\\"+i.charAt(e);return t},_getWords:function(){var e=this.editor,i=[],n="",r={},s=[];return this._walk(e.getBody(),function(e){3==e.nodeType&&(n+=e.nodeValue+" ")}),e.getParam("spellchecker_word_pattern")?s=n.match("("+e.getParam("spellchecker_word_pattern")+")","gi"):(n=n.replace(RegExp("([0-9]|["+this._getSeparators()+"])","g")," "),n=tinymce.trim(n.replace(/(\s+)/g," ")),s=n.split(" ")),t(s,function(e){r[e]||(i.push(e),r[e]=1)}),i},_removeWords:function(e){var i=this.editor,n=i.dom,r=i.selection,s=r.getRng(!0);t(n.select("span").reverse(),function(t){t&&(n.hasClass(t,"mceItemHiddenSpellWord")||n.hasClass(t,"mceItemHidden"))&&(e&&n.decode(t.innerHTML)!=e||n.remove(t,1))}),r.setRng(s)},_markWords:function(e){var i=this.editor,n=i.dom,r=i.getDoc(),s=i.selection,o=s.getRng(!0),a=[],l=e.join("|"),c=this._getSeparators(),h=RegExp("(^|["+c+"])("+l+")(?=["+c+"]|$)","g");this._walk(i.getBody(),function(e){3==e.nodeType&&a.push(e)}),t(a,function(e){var t,i,s,o,a=e.nodeValue;if(h.test(a)){if(a=n.encode(a),i=n.create("span",{"class":"mceItemHidden"}),tinymce.isIE){for(a=a.replace(h,"$1<mcespell>$2</mcespell>");-1!=(o=a.indexOf("<mcespell>"));)s=a.substring(0,o),s.length&&(t=r.createTextNode(n.decode(s)),i.appendChild(t)),a=a.substring(o+10),o=a.indexOf("</mcespell>"),s=a.substring(0,o),a=a.substring(o+11),i.appendChild(n.create("span",{"class":"mceItemHiddenSpellWord"},s));a.length&&(t=r.createTextNode(n.decode(a)),i.appendChild(t))}else i.innerHTML=a.replace(h,'$1<span class="mceItemHiddenSpellWord">$2</span>');n.replace(i,e)}}),s.setRng(o)},_showMenu:function(e,n){var r,s=this,e=s.editor,o=s._menu,a=e.dom,l=a.getViewPort(e.getWin()),c=n.target;return n=0,o||(o=e.controlManager.createDropMenu("spellcheckermenu",{"class":"mceNoIcons"}),s._menu=o),a.hasClass(c,"mceItemHiddenSpellWord")?(o.removeAll(),o.add({title:"spellchecker.wait","class":"mceMenuItemTitle"}).setDisabled(1),s._sendRPC("getSuggestions",[s.selectedLang,a.decode(c.innerHTML)],function(i){var n;o.removeAll(),i.length>0?(o.add({title:"spellchecker.sug","class":"mceMenuItemTitle"}).setDisabled(1),t(i,function(t){o.add({title:t,onclick:function(){a.replace(e.getDoc().createTextNode(t),c),s._checkDone()}})}),o.addSeparator()):o.add({title:"spellchecker.no_sug","class":"mceMenuItemTitle"}).setDisabled(1),e.getParam("show_ignore_words",!0)&&(n=s.editor.getParam("spellchecker_enable_ignore_rpc",""),o.add({title:"spellchecker.ignore_word",onclick:function(){var t=c.innerHTML;a.remove(c,1),s._checkDone(),n&&(e.setProgressState(1),s._sendRPC("ignoreWord",[s.selectedLang,t],function(){e.setProgressState(0)}))}}),o.add({title:"spellchecker.ignore_words",onclick:function(){var t=c.innerHTML;s._removeWords(a.decode(t)),s._checkDone(),n&&(e.setProgressState(1),s._sendRPC("ignoreWords",[s.selectedLang,t],function(){e.setProgressState(0)}))}})),s.editor.getParam("spellchecker_enable_learn_rpc")&&o.add({title:"spellchecker.learn_word",onclick:function(){var t=c.innerHTML;a.remove(c,1),s._checkDone(),e.setProgressState(1),s._sendRPC("learnWord",[s.selectedLang,t],function(){e.setProgressState(0)})}}),o.update()}),r=i.getPos(e.getContentAreaContainer()),o.settings.offset_x=r.x,o.settings.offset_y=r.y,e.selection.select(c),r=a.getPos(c),o.showMenu(r.x,r.y+c.offsetHeight-l.y),tinymce.dom.Event.cancel(n)):(o.hideMenu(),void 0)},_checkDone:function(){var e,i=this,n=i.editor,r=n.dom;t(r.select("span"),function(t){return t&&r.hasClass(t,"mceItemHiddenSpellWord")?(e=!0,!1):void 0}),e||i._done()},_done:function(){var e=this,t=e.active;e.active&&(e.active=0,e._removeWords(),e._menu&&e._menu.hideMenu(),t&&e.editor.nodeChanged())},_sendRPC:function(t,i,n){var r=this;e.sendRPC({url:r.rpcUrl,method:t,params:i,success:n,error:function(e,t){r.editor.setProgressState(0),r.editor.windowManager.alert(e.errstr||"Error response: "+t.responseText)}})}}),tinymce.PluginManager.add("spellchecker",tinymce.plugins.SpellcheckerPlugin)})();