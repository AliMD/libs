(function(e){var t,i,n="autosave",r="restoredraft",s=!0,o=e.util.Dispatcher;e.create("tinymce.plugins.AutoSave",{init:function(a){function l(e){var t={s:1e3,m:6e4};return e=/^(\d+)([ms]?)$/.exec(""+e),(e[2]?t[e[2]]:1)*parseInt(e)}var h=this,c=a.settings;h.editor=a,e.each({ask_before_unload:s,interval:"30s",retention:"20m",minlength:50},function(e,i){i=n+"_"+i,c[i]===t&&(c[i]=e)}),c.autosave_interval=l(c.autosave_interval),c.autosave_retention=l(c.autosave_retention),a.addButton(r,{title:n+".restore_content",onclick:function(){a.getContent({draft:!0}).replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length>0?a.windowManager.confirm(n+".warning_message",function(e){e&&h.restoreDraft()}):h.restoreDraft()}}),a.onNodeChange.add(function(){var e=a.controlManager;e.get(r)&&e.setDisabled(r,!h.hasDraft())}),a.onInit.add(function(){a.controlManager.get(r)&&(h.setupStorage(a),setInterval(function(){a.removed||(h.storeDraft(),a.nodeChanged())},c.autosave_interval))}),h.onStoreDraft=new o(h),h.onRestoreDraft=new o(h),h.onRemoveDraft=new o(h),i||(window.onbeforeunload=e.plugins.AutoSave._beforeUnloadHandler,i=s)},getInfo:function(){return{longname:"Auto save",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/autosave",version:e.majorVersion+"."+e.minorVersion}},getExpDate:function(){return new Date((new Date).getTime()+this.editor.settings.autosave_retention).toUTCString()},setupStorage:function(i){var r=this,o=n+"_test",a="OK";r.key=n+i.id,e.each([function(){return localStorage&&(localStorage.setItem(o,a),localStorage.getItem(o)===a)?(localStorage.removeItem(o),localStorage):t},function(){return sessionStorage&&(sessionStorage.setItem(o,a),sessionStorage.getItem(o)===a)?(sessionStorage.removeItem(o),sessionStorage):t},function(){return e.isIE?(i.getElement().style.behavior="url('#default#userData')",{autoExpires:s,setItem:function(e,t){var n=i.getElement();n.setAttribute(e,t),n.expires=r.getExpDate();try{n.save("TinyMCE")}catch(s){}},getItem:function(e){var t=i.getElement();try{return t.load("TinyMCE"),t.getAttribute(e)}catch(n){return null}},removeItem:function(e){i.getElement().removeAttribute(e)}}):t}],function(e){try{if(r.storage=e(),r.storage)return!1}catch(t){}})},storeDraft:function(){var e,t,i=this,n=i.storage,r=i.editor;if(n){if(!n.getItem(i.key)&&!r.isDirty())return;t=r.getContent({draft:!0}),t.length>r.settings.autosave_minlength&&(e=i.getExpDate(),i.storage.autoExpires||i.storage.setItem(i.key+"_expires",e),i.storage.setItem(i.key,t),i.onStoreDraft.dispatch(i,{expires:e,content:t}))}},restoreDraft:function(){var e,t=this,i=t.storage;i&&(e=i.getItem(t.key),e&&(t.editor.setContent(e),t.onRestoreDraft.dispatch(t,{content:e})))},hasDraft:function(){var e,t,i=this,n=i.storage;if(n&&(t=!!n.getItem(i.key))){if(i.storage.autoExpires)return s;if(e=new Date(n.getItem(i.key+"_expires")),(new Date).getTime()<e.getTime())return s;i.removeDraft()}return!1},removeDraft:function(){var e,t=this,i=t.storage,n=t.key;i&&(e=i.getItem(n),i.removeItem(n),i.removeItem(n+"_expires"),e&&t.onRemoveDraft.dispatch(t,{content:e}))},"static":{_beforeUnloadHandler:function(){var t;return e.each(tinyMCE.editors,function(e){e.plugins.autosave&&e.plugins.autosave.storeDraft(),e.getParam("fullscreen_is_enabled")||!t&&e.isDirty()&&e.getParam("autosave_ask_before_unload")&&(t=e.getLang("autosave.unload_msg"))}),t}}}),e.PluginManager.add("autosave",e.plugins.AutoSave)})(tinymce);